<!DOCTYPE html>
<html class="writer-html5" lang="zh" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CPU p-state 的Linux配置 &mdash; Cloud Atlas: Discovery beta 文档</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=8534f863"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../../copyright.html" />
    <link rel="next" title="Intel Turbo Boost技术和intel_pstate" href="intel_turbo_boost_pstate.html" />
    <link rel="prev" title="CPU p-state" href="cpu_p-state.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Cloud Atlas: Discovery
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../studio/index.html">Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devops/index.html">DevOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kvm/index.html">KVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ceph/index.html">Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gluster/index.html">Gluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ovirt/index.html">oVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openstack/index.html">OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../k8s_dev/index.html">Kubernetes Develop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rancher/index.html">Rancher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openshift/index.html">OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sql/index.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sqlite/index.html">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/index.html">MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pgsql/index.html">PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nosql/index.html">NoSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../network/index.html">Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_service/index.html">Infra-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_search/index.html">Infra-Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web/index.html">Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info_service/index.html">Info-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../big_data/index.html">Big Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../machine_learning/index.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../drone/index.html">Drone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../linux/index.html">Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Kernel</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../startup/index.html">Kernel起步</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">CPU</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../cpu_prefetch.html">CPU预取</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Intel CPU架构</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="index.html">CPU频率 性能伸缩(Performance Scaling)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../intel_rdt/index.html">Intel Resource Director Technology(RDT)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../intel_qat/index.html">Intel QuickAssist 技术(Intel QAT)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../intel_sgx/index.html">Intel Software Guard Extensions(SGX)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../intel_vroc/index.html">Intel Virtual RAID on CPU (Intel VROC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../intel_rst/index.html">Intel Rapid Storage Technology(Intel RST)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../xeon_e5/index.html">Intel XEON E5系列处理器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../xeon_e/index.html">Intel XEON E系列处理器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../intel_core/index.html">Intel Core处理器</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../amd/index.html">AMD CPU架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cpu_fan.html">CPU散热器</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../scheduler/index.html">Linux调度器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cgroup/index.html">Kernel Cgroup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../process/index.html">内核进程管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../core_api/index.html">kernel核心API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../flame_graph.html">火焰图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../kms.html">KMS (Kernel mode setting)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../accounting/index.html">内核记账</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../filesystem/index.html">内核文件系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../lsm/index.html">Linux 安全模块(Linux Security Modules, LSM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ebpf/index.html">eBPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../perf/index.html">Linux perf性能分析工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../admin/index.html">Linux内核管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../memory/index.html">Linux内存管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../network/index.html">Linux内核网络实现</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../power/index.html">内核电源管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tracing/index.html">Linux内核追踪</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../performance/index.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed_system/index.html">Distributed System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../shell/index.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django/index.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/index.html">JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nodejs/index.html">Node.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../clang/index.html">C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../golang/index.html">Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../swift/index.html">Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rust/index.html">Rust</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ruby/index.html">Ruby</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lua/index.html">Lua</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arm/index.html">ARM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../raspberry_pi/index.html">Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../android/index.html">Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bsd/index.html">BSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../freebsd/index.html">FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apple/index.html">Apple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../windows/index.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../real/index.html">Real</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../management/index.html">Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../life/index.html">Life</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Cloud Atlas: Discovery</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Kernel</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">CPU</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Intel CPU架构</a></li>
          <li class="breadcrumb-item"><a href="index.html">CPU频率 性能伸缩(Performance Scaling)</a></li>
      <li class="breadcrumb-item active">CPU p-state 的Linux配置</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/kernel/cpu/intel/cpufreq/cpu_p-state_linux.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cpu-p-state-linux">
<span id="id1"></span><h1>CPU p-state 的Linux配置<a class="headerlink" href="#cpu-p-state-linux" title="Link to this heading"></a></h1>
<p><strong>Intel Turbo Boost</strong>是Intel在系列处理器实现的技术，通过动态控制处理器的时钟率来激活处理器运行在超过基础操作主频。</p>
<p>支持不同Turbo Boost版本技术的处理器分为：</p>
<ul class="simple">
<li><p>Turbo Boost 1.0: Nehalem</p></li>
<li><p>Turbo Boost 2.0: Sandby Bridge</p></li>
<li><p>Turbo Boost Max 3.0: Ivy Bridge, Haswell, Broadwell, Skylake, Broadwell-E</p></li>
</ul>
<p>Turo Boost是在操作系统请求处理器的最高性能状态（highest performance state, pstate）时候激活。</p>
<p>处理器性能状态是通过高级配置和电源接口（Advanced Configuration and Power Interface, ACPI）规范来定义的，这是被所有主流操作系统所支持的开放标准。在Turbo Boost背后的设计概念也被称为”动态超频”。</p>
<p>时钟主频是由处理器电压，电流和热量所限制的，同时也受到当前CPU核心数量和激活核心的最高主频限制。当处理器上负载调用更快性能，并且此时处理器还没有达到上限，则处理器时钟将增加操作频率以满足需求。频率增长，在Nehalem处理器是133MHz，而在Sand Bridge, Ivy Bridge，Haswell和Skylake处理器是100MHz。</p>
<p>Intel Turbo Boost监控处理器当期使用情况，以及处理器是否接近最大 <code class="docutils literal notranslate"><span class="pre">热量设计功率</span></code> （thermal design power, TDP）。这个TDP是处理器支持的最大功率。</p>
<p>Turbo Boost是 <code class="docutils literal notranslate"><span class="pre">动态</span></code> 功能，Turbo Boost以133MHz步长增长，直到达到允许的最大Turbo Boost（和处理器型号相关）或者最大TDP。不过，Intel仍然建议处理器工作在基础时钟速度（base
clock speed），因为Intel不承诺处理器任何时候都能够达到最大Turbo Boost speed。</p>
<p>Turbo Boost允许一个或多个CPU核心运行在更高的P-states，这个最大P-state需要考虑以下因素：</p>
<ul class="simple">
<li><p>激活的核心数量（ C0 或 C1 状态）</p></li>
<li><p>评估当前处理器消耗（Imax）</p></li>
<li><p>评估处理器电能消耗（TDP - Thermal Design Power）</p></li>
<li><p>处理器稳定</p></li>
</ul>
<section id="turbo-boot-max-3-0">
<h2>Turbo Boot Max 3.0<a class="headerlink" href="#turbo-boot-max-3-0" title="Link to this heading"></a></h2>
<p>Intel Turbo Boost Max Technology 3.0 使用一个和CPU中存储信息相连的驱动。它标识并直接工作在最快的芯片内核上。驱动也允许通过白名单自定义配置以便让用户设置应用程序的优先级。这个驱动 <code class="docutils literal notranslate"><span class="pre">必须</span></code> 在系统中存在和正确配置，否则操作系统就不能有效路由工作负载到目标处理器核心。</p>
<p>要使用Intel Turbo Boost Max Technology 3.0需要同时满足条件：</p>
<ul class="simple">
<li><p>CPU处理器支持 （需要检查Intel CPU功能）</p></li>
<li><p>操作系统支持</p></li>
<li><p>驱动和相应的应用软件</p></li>
<li><p>X99或X299主板并使用激活BIOS/firmware支持</p></li>
</ul>
<p>和Intel Turbo Boost Technology 2.0不同的是，3.0版本允许单核心更高的主频。</p>
<p>Intel Turbo Boost Max技术的软件用户接口和驱动允许用户优先将负载直接调度到最快的CPU核心上。 支持 <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">List</span></code> 是处理器核心的顺序列表，最高性能的core位于最高。更改列表顺序可能会重新以对应性能来表述处理器核心。在操作系统的core序号体系和处理器序号体系相关。例如，Core 0对应逻辑处理器0和1，Core 1对应逻辑处理器2和3。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当每个CPU核心最大主频超过时钟 - <code class="docutils literal notranslate"><span class="pre">Overclocking</span> <span class="pre">Enabled</span></code> 显示了 <strong>Core List</strong> 的优先级。</p>
</div>
<p>Turbo Boost Max技术支持设置应用程序可以使用的CPU性能的百分比（阀值），以及评估时间间隔： 默认的评估时间间隔单位是100ms，默认值是10，也就是10x100ms=1s，即每秒评估一次；CPU使用阀值默认是90%，调整这个阀值会降低程序消耗的系统性能。</p>
<section id="intel-cpup-state-c-state-turbo-boost">
<h3>Intel CPU的P-state, C-state, Turbo Boost<a class="headerlink" href="#intel-cpup-state-c-state-turbo-boost" title="Link to this heading"></a></h3>
<p>Intel处理器从单核发展到多核提供了在同一个物理CPU核运行2个线程的 <a class="reference external" href="https://en.wikipedia.org/wiki/Hyper-threading">Hpyer-threading</a> 以及 <a class="reference external" href="https://en.wikipedia.org/wiki/Intel_Turbo_Boost">Turbo Boost</a> 来提供最大性能。处理器核型可以完全关闭（CPU HALT, 主频降到0）来节约电能消耗，并且根据很多因素，如工作负载和问题，来调整处理器核心的工作主频。能耗是现代处理器设计的重要组成。</p>
</section>
</section>
<section id="intel-p-state">
<h2>内核激活Intel P-state<a class="headerlink" href="#intel-p-state" title="Link to this heading"></a></h2>
<p>内核启动参数需要激活P-state驱动后才能使用Turbo Boost功能。</p>
<ul>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code> 配置行 <code class="docutils literal notranslate"><span class="pre">GRUB_CMDLINE_LINUX</span></code> 添加 <code class="docutils literal notranslate"><span class="pre">intel_idle.max_cstate=1</span> <span class="pre">intel_pstate=enable</span> <span class="pre">processor.max_cstate=1</span></code></p></li>
<li><p>执行配置生效:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grub2</span><span class="o">-</span><span class="n">mkconfig</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">grub2</span><span class="o">/</span><span class="n">grub</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id2">
<h2>安装工具<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<ul>
<li><p>CentOS/RHEL安装工具:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">util</span><span class="o">-</span><span class="n">linux</span> <span class="n">kernel</span><span class="o">-</span><span class="n">tools</span>
</pre></div>
</div>
</li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>程序</p></th>
<th class="head"><p>软件包</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>lscpu</p></td>
<td><p>util-linux</p></td>
<td><p>查看cpu拓扑</p></td>
</tr>
<tr class="row-odd"><td><p>cpupower</p></td>
<td><p>kernel-tools</p></td>
<td><p>检查和设置处理器能耗管理、主频等</p></td>
</tr>
<tr class="row-even"><td><p>turbostat</p></td>
<td><p>kernel-tools</p></td>
<td><p>监控处理器负载、主频、温度、内存使用等</p></td>
</tr>
<tr class="row-odd"><td><p>rdmsr / wrmsr</p></td>
<td><p>msr-tools</p></td>
<td><p>读写MSR寄存器</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p>Debian/Ubuntu安装工具:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">generic</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Debian/Ubuntu安装的内核工具是针对不同内核来安装的，所以有 <code class="docutils literal notranslate"><span class="pre">linux-tools-generic</span></code> 和 <code class="docutils literal notranslate"><span class="pre">linux-tools-generic-hwe</span></code> 以及 <code class="docutils literal notranslate"><span class="pre">linux-tools-virtual</span></code> 等等不同工具包。</p>
<p><code class="docutils literal notranslate"><span class="pre">cpupower</span></code> 属于 <code class="docutils literal notranslate"><span class="pre">linux-tools-common</span></code> 软件包，在安装 <code class="docutils literal notranslate"><span class="pre">linux-tools-generic</span></code> 会依赖安装。</p>
</div>
</section>
<section id="id3">
<h2>检查处理器信息<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>从 <code class="docutils literal notranslate"><span class="pre">/proc/cpuinfo</span></code> 可以获取处理器信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">cpuinfo</span>
</pre></div>
</div>
<p>输出案例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">processor</span>   <span class="p">:</span> <span class="mi">23</span>
<span class="n">vendor_id</span>   <span class="p">:</span> <span class="n">GenuineIntel</span>
<span class="n">cpu</span> <span class="n">family</span>  <span class="p">:</span> <span class="mi">6</span>
<span class="n">model</span>       <span class="p">:</span> <span class="mi">45</span>
<span class="n">model</span> <span class="n">name</span>  <span class="p">:</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Xeon</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">CPU</span> <span class="n">E5</span><span class="o">-</span><span class="mi">2630</span> <span class="mi">0</span> <span class="o">@</span> <span class="mf">2.30</span><span class="n">GHz</span>
<span class="n">stepping</span>    <span class="p">:</span> <span class="mi">7</span>
<span class="n">microcode</span>   <span class="p">:</span> <span class="mh">0x710</span>
<span class="n">cpu</span> <span class="n">MHz</span>     <span class="p">:</span> <span class="mf">2299.820</span>
<span class="n">cache</span> <span class="n">size</span>  <span class="p">:</span> <span class="mi">15360</span> <span class="n">KB</span>
<span class="n">physical</span> <span class="nb">id</span> <span class="p">:</span> <span class="mi">1</span>
<span class="n">siblings</span>    <span class="p">:</span> <span class="mi">12</span>
<span class="n">core</span> <span class="nb">id</span>     <span class="p">:</span> <span class="mi">5</span>
<span class="n">cpu</span> <span class="n">cores</span>   <span class="p">:</span> <span class="mi">6</span>
<span class="n">apicid</span>      <span class="p">:</span> <span class="mi">43</span>
<span class="n">initial</span> <span class="n">apicid</span>  <span class="p">:</span> <span class="mi">43</span>
<span class="n">fpu</span>     <span class="p">:</span> <span class="n">yes</span>
<span class="n">fpu_exception</span>   <span class="p">:</span> <span class="n">yes</span>
<span class="n">cpuid</span> <span class="n">level</span> <span class="p">:</span> <span class="mi">13</span>
<span class="n">wp</span>      <span class="p">:</span> <span class="n">yes</span>
<span class="n">flags</span>       <span class="p">:</span> <span class="n">fpu</span> <span class="n">vme</span> <span class="n">de</span> <span class="n">pse</span> <span class="n">tsc</span> <span class="n">msr</span> <span class="n">pae</span> <span class="n">mce</span> <span class="n">cx8</span> <span class="n">apic</span> <span class="n">sep</span> <span class="n">mtrr</span> <span class="n">pge</span> <span class="n">mca</span> <span class="n">cmov</span> <span class="n">pat</span> <span class="n">pse36</span> <span class="n">clflush</span> <span class="n">dts</span> <span class="n">acpi</span> <span class="n">mmx</span> <span class="n">fxsr</span> <span class="n">sse</span> <span class="n">sse2</span> <span class="n">ss</span> <span class="n">ht</span> <span class="n">tm</span> <span class="n">pbe</span> <span class="n">syscall</span> <span class="n">nx</span> <span class="n">pdpe1gb</span> <span class="n">rdtscp</span> <span class="n">lm</span> <span class="n">constant_tsc</span> <span class="n">arch_perfmon</span> <span class="n">pebs</span> <span class="n">bts</span> <span class="n">rep_good</span> <span class="n">nopl</span> <span class="n">xtopology</span> <span class="n">nonstop_tsc</span> <span class="n">aperfmperf</span> <span class="n">eagerfpu</span> <span class="n">pni</span> <span class="n">pclmulqdq</span> <span class="n">dtes64</span> <span class="n">ds_cpl</span> <span class="n">vmx</span> <span class="n">smx</span> <span class="n">est</span> <span class="n">tm2</span> <span class="n">ssse3</span> <span class="n">cx16</span> <span class="n">xtpr</span> <span class="n">pdcm</span> <span class="n">pcid</span> <span class="n">dca</span> <span class="n">sse4_1</span> <span class="n">sse4_2</span> <span class="n">x2apic</span> <span class="n">popcnt</span> <span class="n">tsc_deadline_timer</span> <span class="n">aes</span> <span class="n">xsave</span> <span class="n">avx</span> <span class="n">lahf_lm</span> <span class="n">arat</span> <span class="n">pln</span> <span class="n">pts</span> <span class="n">dtherm</span> <span class="n">tpr_shadow</span> <span class="n">vnmi</span> <span class="n">flexpriority</span> <span class="n">ept</span> <span class="n">vpid</span> <span class="n">xsaveopt</span>
<span class="n">bogomips</span>    <span class="p">:</span> <span class="mf">4603.81</span>
<span class="n">clflush</span> <span class="n">size</span>    <span class="p">:</span> <span class="mi">64</span>
<span class="n">cache_alignment</span> <span class="p">:</span> <span class="mi">64</span>
<span class="n">address</span> <span class="n">sizes</span>   <span class="p">:</span> <span class="mi">46</span> <span class="n">bits</span> <span class="n">physical</span><span class="p">,</span> <span class="mi">48</span> <span class="n">bits</span> <span class="n">virtual</span>
<span class="n">power</span> <span class="n">management</span><span class="p">:</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">name</span></code>: <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">name</span> <span class="pre">:</span> <span class="pre">Intel(R)</span> <span class="pre">Xeon(R)</span> <span class="pre">CPU</span> <span class="pre">E5-2630</span> <span class="pre">0</span> <span class="pre">&#64;</span> <span class="pre">2.30GHz</span></code> 表明处理器型号 <code class="docutils literal notranslate"><span class="pre">E5-2630</span></code> ，并且标称主频是 <code class="docutils literal notranslate"><span class="pre">2.3GHz</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">MHz</span></code> : <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">MHz</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">:</span> <span class="pre">2299.820</span></code>是当前处理器核心的主频，注意，单个CPU core有2个HT，CPU core的主频反映在两个HT上都是相同的。可以通过 <code class="docutils literal notranslate"><span class="pre">rdmsr</span></code> 从MSR寄存器 <code class="docutils literal notranslate"><span class="pre">198H</span></code> 读取处理器当前主频。</p></li>
</ul>
</section>
<section id="id4">
<h2>检查处理器拓扑<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">lscpu</span></code> 不带任何参数则显示处理器规格摘要：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Architecture</span><span class="p">:</span>          <span class="n">x86_64</span>
<span class="n">CPU</span> <span class="n">op</span><span class="o">-</span><span class="n">mode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>        <span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="p">,</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Byte</span> <span class="n">Order</span><span class="p">:</span>            <span class="n">Little</span> <span class="n">Endian</span>
<span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>                <span class="mi">24</span>
<span class="n">On</span><span class="o">-</span><span class="n">line</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="nb">list</span><span class="p">:</span>   <span class="mi">0</span><span class="o">-</span><span class="mi">23</span>
<span class="n">Thread</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">per</span> <span class="n">core</span><span class="p">:</span>    <span class="mi">2</span>
<span class="n">Core</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">per</span> <span class="n">socket</span><span class="p">:</span>    <span class="mi">6</span>
<span class="n">Socket</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>             <span class="mi">2</span>
<span class="n">NUMA</span> <span class="n">node</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>          <span class="mi">1</span>
<span class="n">Vendor</span> <span class="n">ID</span><span class="p">:</span>             <span class="n">GenuineIntel</span>
<span class="n">CPU</span> <span class="n">family</span><span class="p">:</span>            <span class="mi">6</span>
<span class="n">Model</span><span class="p">:</span>                 <span class="mi">45</span>
<span class="n">Model</span> <span class="n">name</span><span class="p">:</span>            <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Xeon</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">CPU</span> <span class="n">E5</span><span class="o">-</span><span class="mi">2630</span> <span class="mi">0</span> <span class="o">@</span> <span class="mf">2.30</span><span class="n">GHz</span>
<span class="n">Stepping</span><span class="p">:</span>              <span class="mi">7</span>
<span class="n">CPU</span> <span class="n">MHz</span><span class="p">:</span>               <span class="mf">2300.089</span>
<span class="n">BogoMIPS</span><span class="p">:</span>              <span class="mf">4603.81</span>
<span class="n">Virtualization</span><span class="p">:</span>        <span class="n">VT</span><span class="o">-</span><span class="n">x</span>
<span class="n">L1d</span> <span class="n">cache</span><span class="p">:</span>             <span class="mi">32</span><span class="n">K</span>
<span class="n">L1i</span> <span class="n">cache</span><span class="p">:</span>             <span class="mi">32</span><span class="n">K</span>
<span class="n">L2</span> <span class="n">cache</span><span class="p">:</span>              <span class="mi">256</span><span class="n">K</span>
<span class="n">L3</span> <span class="n">cache</span><span class="p">:</span>              <span class="mi">15360</span><span class="n">K</span>
<span class="n">NUMA</span> <span class="n">node0</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">0</span><span class="o">-</span><span class="mi">23</span>
</pre></div>
</div>
<ul>
<li><p>输出处理器表:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lscpu</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">e</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">NODE</span> <span class="n">SOCKET</span> <span class="n">CORE</span> <span class="n">L1d</span><span class="p">:</span><span class="n">L1i</span><span class="p">:</span><span class="n">L2</span><span class="p">:</span><span class="n">L3</span> <span class="n">ONLINE</span>
<span class="mi">0</span>   <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">0</span>    <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">1</span>   <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">1</span>    <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">2</span>   <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">2</span>    <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">3</span>   <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">3</span>    <span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">4</span>   <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">4</span>    <span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">5</span>   <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">5</span>    <span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">6</span>   <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">6</span>    <span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">7</span>   <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">7</span>    <span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">8</span>   <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">8</span>    <span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">9</span>   <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">9</span>    <span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">10</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">10</span>   <span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">0</span>    <span class="n">yes</span>
<span class="mi">11</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">11</span>   <span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">1</span>    <span class="n">yes</span>
<span class="mi">12</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">0</span>    <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">13</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">1</span>    <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">14</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">2</span>    <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">15</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">3</span>    <span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">16</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">4</span>    <span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">17</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">5</span>    <span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">18</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">6</span>    <span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">19</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">7</span>    <span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">20</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">8</span>    <span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">0</span>       <span class="n">yes</span>
<span class="mi">21</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">9</span>    <span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">1</span>       <span class="n">yes</span>
<span class="mi">22</span>  <span class="mi">0</span>    <span class="mi">0</span>      <span class="mi">10</span>   <span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">0</span>    <span class="n">yes</span>
<span class="mi">23</span>  <span class="mi">0</span>    <span class="mi">1</span>      <span class="mi">11</span>   <span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">1</span>    <span class="n">yes</span>
</pre></div>
</div>
<p>可以看到前述 <code class="docutils literal notranslate"><span class="pre">/proc/cpuinfo</span></code> 中显示的逻辑处理器24个，实际是12个CPU核心，通过Hyper-threading技术显示为24个逻辑处理器。</p>
<p>要注意处理器核心的物理位置，跨socket调用会延迟性能。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">L1d</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">L1</span> <span class="pre">data</span></code> 即一级数据缓存； <code class="docutils literal notranslate"><span class="pre">L1i</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">L1</span> <span class="pre">instruction</span></code> 即一级指令缓存。也就是一级缓存区分为数据缓存和指令缓存两种。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">L2</span></code> 也是CPU核心内使用缓存；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">L3</span></code> 缓存则是所有物理核心共享的缓存。</p></li>
</ul>
</section>
<section id="p-state">
<h2>P-state<a class="headerlink" href="#p-state" title="Link to this heading"></a></h2>
<p>从Linux Kernel 3.9(2009年4月)，一个新的 <a class="reference external" href="intel_pstate">intel_pstate</a> 加入到内核中，从SandbyBridge处理器开始，后续多代Intel处理器都得到了支持。</p>
<p><code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动支持现代Intel处理器的温控。</p>
<p>处理器 <code class="docutils literal notranslate"><span class="pre">P-state</span></code> 是支持处理器运行在不同电压 和/或 主频级别的能力。总的来说， <code class="docutils literal notranslate"><span class="pre">P0</span></code> 是最高性能级别，而 <code class="docutils literal notranslate"><span class="pre">P1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">P2</span></code> 等依次节约电能但是带来潜在的性能损失。</p>
<p>在Linux内核启动参数中设置 <code class="docutils literal notranslate"><span class="pre">intel_pstate=disable</span></code> 选项可以强制使用传统遗留的CPU驱动 <code class="docutils literal notranslate"><span class="pre">acpi_cpufreq</span></code> 。</p>
</section>
<section id="c-state">
<h2>C-state<a class="headerlink" href="#c-state" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">C-state</span></code> 是idle power saving状态，也就是P-state的相反状态，是执行节电的状态。</p>
<p>当处理器处于 <code class="docutils literal notranslate"><span class="pre">P-state</span></code> 状态时，处理器仍然在执行指令；当处理器处于 <code class="docutils literal notranslate"><span class="pre">C-state</span></code> 时（除了 <code class="docutils literal notranslate"><span class="pre">C0</span></code> ），则处理器是idle状态，也就是没有执行任何指令。</p>
<p><code class="docutils literal notranslate"><span class="pre">C-state</span></code> ：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">C0</span></code> 是操作状态，意味着CPU在做一些有效工作</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">C1</span></code> 是第一个idle状态</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">C2</span></code> 是第二个idle状态：外部I/O控制器Hub阻断发给处理器的中断</p></li>
<li><p>依次类推</p></li>
</ul>
<p>当一个逻辑处理器idle是（除了 <code class="docutils literal notranslate"><span class="pre">C0</span></code> 以外的 <code class="docutils literal notranslate"><span class="pre">C-state</span></code> ），它的主频通常是0（HALT）:</p>
<p><code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">idle-info</span></code> 命令列出支持的 <code class="docutils literal notranslate"><span class="pre">C-State</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPUidle</span> <span class="n">driver</span><span class="p">:</span> <span class="n">intel_idle</span>
<span class="n">CPUidle</span> <span class="n">governor</span><span class="p">:</span> <span class="n">menu</span>

<span class="n">Analyzing</span> <span class="n">CPU</span> <span class="mi">0</span><span class="p">:</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">idle</span> <span class="n">states</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Available</span> <span class="n">idle</span> <span class="n">states</span><span class="p">:</span> <span class="n">POLL</span> <span class="n">C1</span><span class="o">-</span><span class="n">SKX</span>
<span class="n">POLL</span><span class="p">:</span>
<span class="n">Flags</span><span class="o">/</span><span class="n">Description</span><span class="p">:</span> <span class="n">CPUIDLE</span> <span class="n">CORE</span> <span class="n">POLL</span> <span class="n">IDLE</span>
<span class="n">Latency</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Usage</span><span class="p">:</span> <span class="mi">2667</span>
<span class="n">Duration</span><span class="p">:</span> <span class="mi">296902700</span>
<span class="n">C1</span><span class="o">-</span><span class="n">SKX</span><span class="p">:</span>
<span class="n">Flags</span><span class="o">/</span><span class="n">Description</span><span class="p">:</span> <span class="n">MWAIT</span> <span class="mh">0x00</span>
<span class="n">Latency</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Usage</span><span class="p">:</span> <span class="mi">776606</span>
<span class="n">Duration</span><span class="p">:</span> <span class="mi">14056122480</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>注意：系统必须加载了 <code class="docutils literal notranslate"><span class="pre">intel_idle</span></code> 驱动之后才能使用 <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">Idle_Stats</span></code> 模块，才能列出支持的 <code class="docutils literal notranslate"><span class="pre">C-state</span></code> ，否则输出如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$sudo cpupower idle-info
CPUidle driver: none
CPUidle governor: menu

Analyzing CPU 0:
CPU 0: No idle states
</pre></div>
</div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">monitor</span> <span class="pre">-l</span></code> 可以列出所有可以监控的模块（也就是 <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">monitor</span></code> 输出的所有列可以按照模块来过滤选择）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Monitor</span> <span class="s2">&quot;Nehalem&quot;</span> <span class="p">(</span><span class="mi">4</span> <span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="n">Might</span> <span class="n">overflow</span> <span class="n">after</span> <span class="mi">922000000</span> <span class="n">s</span>
<span class="n">C3</span>  <span class="p">[</span><span class="n">C</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Processor</span> <span class="n">Core</span> <span class="n">C3</span>
<span class="n">C6</span>  <span class="p">[</span><span class="n">C</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Processor</span> <span class="n">Core</span> <span class="n">C6</span>
<span class="n">PC3</span> <span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Processor</span> <span class="n">Package</span> <span class="n">C3</span>
<span class="n">PC6</span> <span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Processor</span> <span class="n">Package</span> <span class="n">C6</span>
<span class="n">Monitor</span> <span class="s2">&quot;Mperf&quot;</span> <span class="p">(</span><span class="mi">3</span> <span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="n">Might</span> <span class="n">overflow</span> <span class="n">after</span> <span class="mi">922000000</span> <span class="n">s</span>
<span class="n">C0</span>  <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Processor</span> <span class="n">Core</span> <span class="ow">not</span> <span class="n">idle</span>
<span class="n">Cx</span>  <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Processor</span> <span class="n">Core</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">idle</span> <span class="n">state</span>
<span class="n">Freq</span>    <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">Average</span> <span class="n">Frequency</span> <span class="p">(</span><span class="n">including</span> <span class="n">boost</span><span class="p">)</span> <span class="ow">in</span> <span class="n">MHz</span>
<span class="n">Monitor</span> <span class="s2">&quot;Idle_Stats&quot;</span> <span class="p">(</span><span class="mi">2</span> <span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="n">Might</span> <span class="n">overflow</span> <span class="n">after</span> <span class="mi">4294967295</span> <span class="n">s</span>
<span class="n">POLL</span>    <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">CPUIDLE</span> <span class="n">CORE</span> <span class="n">POLL</span> <span class="n">IDLE</span>
<span class="n">C1</span><span class="o">-</span><span class="n">S</span>    <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">MWAIT</span> <span class="mh">0x00</span>
</pre></div>
</div>
</li>
</ul>
<p>例如，我要监控 <code class="docutils literal notranslate"><span class="pre">Idle_Stats</span></code> (注意大小写)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpupower</span> <span class="n">monitor</span> <span class="o">-</span><span class="n">m</span> <span class="n">Idle_Stats</span>
</pre></div>
</div>
<p>则输出 <code class="docutils literal notranslate"><span class="pre">C-state</span></code> 的情况:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>              <span class="o">|</span><span class="n">Idle_Stats</span>
<span class="n">PKG</span> <span class="o">|</span><span class="n">CORE</span><span class="o">|</span><span class="n">CPU</span> <span class="o">|</span> <span class="n">POLL</span> <span class="o">|</span> <span class="n">C1</span><span class="o">-</span><span class="n">S</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mi">48</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>  <span class="mi">49</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>Turbo Boost<a class="headerlink" href="#id5" title="Link to this heading"></a></h2>
<ul>
<li><p>检查处理器性能:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">cpuinfo</span>
</pre></div>
</div>
</li>
<li><p>检查处理器主频 <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">frequency-info</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cpupower frequency-info</span>
<span class="n">analyzing</span> <span class="n">CPU</span> <span class="mi">0</span><span class="p">:</span>
  <span class="n">driver</span><span class="p">:</span> <span class="n">intel_pstate</span>
  <span class="n">CPUs</span> <span class="n">which</span> <span class="n">run</span> <span class="n">at</span> <span class="n">the</span> <span class="n">same</span> <span class="n">hardware</span> <span class="n">frequency</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">CPUs</span> <span class="n">which</span> <span class="n">need</span> <span class="n">to</span> <span class="n">have</span> <span class="n">their</span> <span class="n">frequency</span> <span class="n">coordinated</span> <span class="n">by</span> <span class="n">software</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">maximum</span> <span class="n">transition</span> <span class="n">latency</span><span class="p">:</span> <span class="mf">0.97</span> <span class="n">ms</span><span class="o">.</span>
  <span class="n">hardware</span> <span class="n">limits</span><span class="p">:</span> <span class="mi">1000</span> <span class="n">MHz</span> <span class="o">-</span> <span class="mf">3.10</span> <span class="n">GHz</span>
  <span class="n">available</span> <span class="n">cpufreq</span> <span class="n">governors</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span> <span class="n">powersave</span>
  <span class="n">current</span> <span class="n">policy</span><span class="p">:</span> <span class="n">frequency</span> <span class="n">should</span> <span class="n">be</span> <span class="n">within</span> <span class="mi">1000</span> <span class="n">MHz</span> <span class="ow">and</span> <span class="mf">3.10</span> <span class="n">GHz</span><span class="o">.</span>
                  <span class="n">The</span> <span class="n">governor</span> <span class="s2">&quot;powersave&quot;</span> <span class="n">may</span> <span class="n">decide</span> <span class="n">which</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">use</span>
                  <span class="n">within</span> <span class="n">this</span> <span class="nb">range</span><span class="o">.</span>
  <span class="n">current</span> <span class="n">CPU</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="mf">2.70</span> <span class="n">GHz</span> <span class="p">(</span><span class="n">asserted</span> <span class="n">by</span> <span class="n">call</span> <span class="n">to</span> <span class="n">hardware</span><span class="p">)</span><span class="o">.</span>
  <span class="n">boost</span> <span class="n">state</span> <span class="n">support</span><span class="p">:</span>
    <span class="n">Supported</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">Active</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>注意：使用 <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">frequency-info</span></code> 显示的当前cpu 0主频是一个约数，不精确且有延迟。最好采用 <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">monitor</span> <span class="pre">-m</span> <span class="pre">Mperf</span></code> 检查能够获取精确的CPU主频，且即使没有使用 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动也能够准确获取频率。</p>
</div>
<ul>
<li><p>检查处理器主频 <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">monitor</span> <span class="pre">-m</span> <span class="pre">Mperf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$sudo cpupower monitor -m Mperf
              |Mperf
PKG |CORE|CPU | C0   | Cx   | Freq
   0|   0|   0|  7.85| 92.15|  2820
   0|   0|  32|  0.38| 99.62|  2825
   0|   1|   1| 42.75| 57.25|  2891
   0|   1|  33|  6.98| 93.02|  2890
...
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>可以看到 <code class="docutils literal notranslate"><span class="pre">Cx</span></code> 显示的就是处理器idle的状态</p>
</div>
</section>
<section id="turbo-boost-msr">
<h2>Turbo Boost MSR<a class="headerlink" href="#turbo-boost-msr" title="Link to this heading"></a></h2>
<p>MSR <code class="docutils literal notranslate"><span class="pre">0x1a0</span></code> 的第 <code class="docutils literal notranslate"><span class="pre">38</span></code> 位用于检查是否激活了Turbo Boost</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rdmsr</span> <span class="o">-</span><span class="n">f</span> <span class="mi">38</span><span class="p">:</span><span class="mi">38</span> <span class="mh">0x1a0</span>
</pre></div>
</div>
<p>这里输出值如果是 <code class="docutils literal notranslate"><span class="pre">0</span></code> 则表示激活了Turbo Boost，而数值 <code class="docutils literal notranslate"><span class="pre">1</span></code> 表示no turbo</p>
<p>如果上述命令不工作，可能需要加载 <code class="docutils literal notranslate"><span class="pre">msr</span></code> 内核模块，即执行 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">modprobe</span> <span class="pre">msr</span></code> 。</p>
</section>
<section id="intel-pstate-no-turbo">
<h2><code class="docutils literal notranslate"><span class="pre">intel_pstate/no_turbo</span></code><a class="headerlink" href="#intel-pstate-no-turbo" title="Link to this heading"></a></h2>
<p>可以在 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动中关闭 <code class="docutils literal notranslate"><span class="pre">turob</span></code> （设置 <code class="docutils literal notranslate"><span class="pre">intel_pstate/no_turbo</span></code> 值为1）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">1</span><span class="o">|</span><span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">intel_pstate</span><span class="o">/</span><span class="n">no_turbo</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>要检查是否启用和停止Turbo，可以通过 <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/sys/devices/system/cpu/intel_pstate/no_turbo</span></code> 来检查</p>
</div>
<p>Turbo Boost也可以在运行时通过禁止 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动来关闭：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">off</span> <span class="o">|</span><span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">intel_pstate</span><span class="o">/</span><span class="n">status</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>注意：这里禁用 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 之后，处理器主频会跌到物理主频的最小值，此时需要通过MSR寄存器 <code class="docutils literal notranslate"><span class="pre">199H</span></code> 来静态设置目标性能状态值（ <code class="docutils literal notranslate"><span class="pre">Target</span> <span class="pre">performance</span> <span class="pre">State</span> <span class="pre">Value</span></code> ）</p>
</div>
<p>也可以激活 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">active</span> <span class="o">|</span><span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">intel_pstate</span><span class="o">/</span><span class="n">status</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>注意：这个 <code class="docutils literal notranslate"><span class="pre">intel_pstate/status</span></code> 入口必须在激活Turbo Boost之后才会存在，</p>
</div>
</section>
<section id="cpu">
<h2>读取CPU主频<a class="headerlink" href="#cpu" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">cpupower</span></code> 提供了 <code class="docutils literal notranslate"><span class="pre">frequency-info</span></code> 指令可以读取CPU的主频</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpupower</span> <span class="n">frequency</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
<p>注意，默认没有指定cpu参数则读取 <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">0</span></code> 主频。要读取指定cpu的主频，需要使用 <code class="docutils literal notranslate"><span class="pre">-c</span></code> 参数，例如，读取 <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">31</span></code> 的主频</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpupower</span> <span class="o">-</span><span class="n">c</span> <span class="mi">31</span> <span class="n">frequency</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
<p>不过， <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">frequency-info</span></code> 是通过 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动来获取信息的，所以如果使用 <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">off</span> <span class="pre">|sudo</span> <span class="pre">tee</span> <span class="pre">/sys/devices/system/cpu/intel_pstate/status</span></code> 禁用了 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动，则该指令失效。</p>
<p>可以通过 <code class="docutils literal notranslate"><span class="pre">cpupower</span> <span class="pre">monitor</span></code> 指令来获取CPU主频，该指令是直接读取MSR <code class="docutils literal notranslate"><span class="pre">198H</span></code> 来直接获取CPU主频信息，所以即使禁用了 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动也可以获得准确的数据。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpupower</span> <span class="n">monitor</span>
</pre></div>
</div>
<p>输出显示类似</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>              <span class="o">|</span><span class="n">Nehalem</span>                    <span class="o">||</span> <span class="n">SandyBridge</span>        <span class="o">||</span> <span class="n">Mperf</span>
<span class="n">PKG</span> <span class="o">|</span><span class="n">CORE</span><span class="o">|</span><span class="n">CPU</span> <span class="o">|</span> <span class="n">C3</span>   <span class="o">|</span> <span class="n">C6</span>   <span class="o">|</span> <span class="n">PC3</span>  <span class="o">|</span> <span class="n">PC6</span>  <span class="o">||</span> <span class="n">C7</span>   <span class="o">|</span> <span class="n">PC2</span>  <span class="o">|</span> <span class="n">PC7</span>  <span class="o">||</span> <span class="n">C0</span>   <span class="o">|</span> <span class="n">Cx</span>   <span class="o">|</span> <span class="n">Freq</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">1.05</span><span class="o">|</span> <span class="mf">98.95</span><span class="o">|</span>  <span class="mi">2298</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mi">12</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span><span class="mf">100.00</span><span class="o">|</span>  <span class="mi">2337</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>   <span class="mi">2</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">1.05</span><span class="o">|</span> <span class="mf">98.95</span><span class="o">|</span>  <span class="mi">2298</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>  <span class="mi">14</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span>  <span class="mf">0.03</span><span class="o">|</span> <span class="mf">99.97</span><span class="o">|</span>  <span class="mi">2299</span>
   <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="turbostat">
<h2>使用 <code class="docutils literal notranslate"><span class="pre">turbostat</span></code> 读取主频<a class="headerlink" href="#turbostat" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">turbostat</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">turbostat</span></code> 默认10秒刷新一次，可以使用 <code class="docutils literal notranslate"><span class="pre">-i</span> <span class="pre">1</span></code> 可以 <code class="docutils literal notranslate"><span class="pre">1</span></code> 秒刷新一次</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">Avg_MHz</span>   <span class="o">%</span><span class="n">Busy</span> <span class="n">Bzy_MHz</span> <span class="n">TSC_MHz</span>     <span class="n">SMI</span>  <span class="n">CPU</span><span class="o">%</span><span class="n">c1</span>  <span class="n">CPU</span><span class="o">%</span><span class="n">c3</span>  <span class="n">CPU</span><span class="o">%</span><span class="n">c6</span>  <span class="n">CPU</span><span class="o">%</span><span class="n">c7</span> <span class="n">CoreTmp</span>  <span class="n">PkgTmp</span> <span class="n">PkgWatt</span> <span class="n">RAMWatt</span>   <span class="n">PKG_</span><span class="o">%</span>   <span class="n">RAM_</span><span class="o">%</span>
  <span class="o">-</span>      <span class="mi">31</span>    <span class="mf">1.37</span>    <span class="mi">2238</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">98.63</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">53</span>      <span class="mi">53</span>   <span class="mf">60.76</span>   <span class="mf">12.26</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>
  <span class="mi">0</span>     <span class="mi">140</span>    <span class="mf">6.12</span>    <span class="mi">2289</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">93.88</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">53</span>      <span class="mi">53</span>   <span class="mf">31.03</span>    <span class="mf">6.04</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>
 <span class="mi">12</span>       <span class="mi">0</span>    <span class="mf">0.01</span>    <span class="mi">1596</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.99</span>
  <span class="mi">2</span>      <span class="mi">55</span>    <span class="mf">2.42</span>    <span class="mi">2254</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">97.58</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">49</span>
 <span class="mi">14</span>       <span class="mi">5</span>    <span class="mf">0.22</span>    <span class="mi">2238</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.78</span>
  <span class="mi">4</span>      <span class="mi">11</span>    <span class="mf">0.48</span>    <span class="mi">2185</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.52</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">49</span>
 <span class="mi">16</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1564</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
  <span class="mi">6</span>       <span class="mi">8</span>    <span class="mf">0.34</span>    <span class="mi">2258</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.66</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">50</span>
 <span class="mi">18</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1579</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
  <span class="mi">8</span>     <span class="mi">153</span>    <span class="mf">6.70</span>    <span class="mi">2281</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">93.30</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">51</span>
 <span class="mi">20</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1582</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
 <span class="mi">10</span>       <span class="mi">1</span>    <span class="mf">0.05</span>    <span class="mi">1961</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.95</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">51</span>
 <span class="mi">22</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1537</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
  <span class="mi">1</span>      <span class="mi">34</span>    <span class="mf">1.53</span>    <span class="mi">2216</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">98.47</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">46</span>      <span class="mi">47</span>   <span class="mf">29.72</span>    <span class="mf">6.22</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>
 <span class="mi">13</span>       <span class="mi">2</span>    <span class="mf">0.10</span>    <span class="mi">2164</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.90</span>
  <span class="mi">3</span>      <span class="mi">47</span>    <span class="mf">2.17</span>    <span class="mi">2183</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">97.83</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">43</span>
 <span class="mi">15</span>       <span class="mi">2</span>    <span class="mf">0.10</span>    <span class="mi">2152</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.90</span>
  <span class="mi">5</span>     <span class="mi">136</span>    <span class="mf">6.18</span>    <span class="mi">2206</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">93.82</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">47</span>
 <span class="mi">17</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1683</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
  <span class="mi">7</span>      <span class="mi">51</span>    <span class="mf">2.29</span>    <span class="mi">2234</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">97.71</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">43</span>
 <span class="mi">19</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1588</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
  <span class="mi">9</span>      <span class="mi">52</span>    <span class="mf">2.34</span>    <span class="mi">2209</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">97.66</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">44</span>
 <span class="mi">21</span>       <span class="mi">0</span>    <span class="mf">0.02</span>    <span class="mi">1611</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.98</span>
 <span class="mi">11</span>      <span class="mi">35</span>    <span class="mf">1.57</span>    <span class="mi">2219</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">98.43</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>      <span class="mi">44</span>
 <span class="mi">23</span>       <span class="mi">2</span>    <span class="mf">0.10</span>    <span class="mi">1594</span>    <span class="mi">2300</span>       <span class="mi">0</span>   <span class="mf">99.90</span>
</pre></div>
</div>
<p>这里参数：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Avg_MHz</span></code> 是平均主频，基于 <code class="docutils literal notranslate"><span class="pre">APERF</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Busy%</span></code> 表示处理器繁忙百分比</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Bzy_MHz</span></code> 是实际的busy frequency，基于 <code class="docutils literal notranslate"><span class="pre">MPERF</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TSC_MHz</span></code> 是固定主频，TSC基于 <a class="reference external" href="https://en.wikipedia.org/wiki/Time_Stamp_Counter">Time Stamp Counter</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">APERF</span></code> (average) and <code class="docutils literal notranslate"><span class="pre">MPERF</span></code> (maximum) 是MSR寄存器可以提供当前CPU主频信息。</p>
</div>
</section>
<section id="proc-cpuinfo">
<h2><code class="docutils literal notranslate"><span class="pre">/proc/cpuinfo</span></code> 中的主频信息<a class="headerlink" href="#proc-cpuinfo" title="Link to this heading"></a></h2>
<p>在 <code class="docutils literal notranslate"><span class="pre">/proc/cpuinfo</span></code> 中有一个信息是 <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">MHz</span></code></p>
<p>在2016年4月，Len Brown发布的patch修改了cpuinfo中计算主频的方法，采用了 <code class="docutils literal notranslate"><span class="pre">APERF</span></code> 和 <code class="docutils literal notranslate"><span class="pre">MPERF</span></code> MSR来计算CPU主频： <a class="reference external" href="https://lkml.org/lkml/2016/4/1/7">Calculate MHz using APERF/MPERF for cpuinfo and scaling_cur_freq</a></p>
<p>操作系统启动时，在系统日志中记录了TSC主频：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dmesg</span><span class="o">|</span><span class="n">grep</span> <span class="s1">&#39;MHz processor&#39;</span>
</pre></div>
</div>
<p>显示输出</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>    <span class="mf">0.000000</span><span class="p">]</span> <span class="n">tsc</span><span class="p">:</span> <span class="n">Detected</span> <span class="mf">2493.598</span> <span class="n">MHz</span> <span class="n">processor</span>
</pre></div>
</div>
</section>
<section id="cpupower">
<h2><code class="docutils literal notranslate"><span class="pre">cpupower</span></code> 工具获取主频<a class="headerlink" href="#cpupower" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">cpupower</span></code> 工具提供了多种方法读取处理器主频：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cpupower</span> <span class="n">monitor</span> <span class="o">-</span><span class="n">m</span> <span class="s1">&#39;Mperf&#39;</span>
</pre></div>
</div>
<p>输出</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>              <span class="o">|</span><span class="n">Mperf</span>
<span class="n">PKG</span> <span class="o">|</span><span class="n">CORE</span><span class="o">|</span><span class="n">CPU</span> <span class="o">|</span> <span class="n">C0</span>   <span class="o">|</span> <span class="n">Cx</span>   <span class="o">|</span> <span class="n">Freq</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span> <span class="mf">99.54</span><span class="o">|</span>  <span class="mf">0.46</span><span class="o">|</span>  <span class="mi">2693</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mi">48</span><span class="o">|</span> <span class="mf">99.54</span><span class="o">|</span>  <span class="mf">0.46</span><span class="o">|</span>  <span class="mi">2693</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span> <span class="mf">99.54</span><span class="o">|</span>  <span class="mf">0.46</span><span class="o">|</span>  <span class="mi">2693</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>  <span class="mi">49</span><span class="o">|</span> <span class="mf">99.54</span><span class="o">|</span>  <span class="mf">0.46</span><span class="o">|</span>  <span class="mi">2693</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果启用了 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> ，也可以通过 <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">core</span> <span class="pre">in</span> <span class="pre">$(seq</span> <span class="pre">0</span> <span class="pre">31);</span> <span class="pre">do</span> <span class="pre">sudo</span> <span class="pre">cpupower</span> <span class="pre">-c</span> <span class="pre">$core</span> <span class="pre">frequency-info|grep</span> <span class="pre">'current</span> <span class="pre">CPU';</span> <span class="pre">done</span></code> （假设这里服务器是32个HT）</p>
</div>
<section id="rdmsr-wrmsr">
<h3>rdmsr/wrmsr<a class="headerlink" href="#rdmsr-wrmsr" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Intel处理器的MSR中性能状态值：目标性能状态值 <code class="docutils literal notranslate"><span class="pre">Target</span> <span class="pre">performance</span> <span class="pre">State</span> <span class="pre">Value</span></code> (199H)和当前性能状态值 <code class="docutils literal notranslate"><span class="pre">Current</span> <span class="pre">performance</span> <span class="pre">State</span> <span class="pre">Value</span></code></p></li>
</ul>
<figure class="align-default" id="id10">
<a class="reference internal image-reference" href="../../../../_images/msr_performance_state.png"><img alt="MSR Performance state" src="../../../../_images/msr_performance_state.png" style="width: 722.0px; height: 204.0px;" /></a>
<figcaption>
<p><span class="caption-text">MSR Performance state</span><a class="headerlink" href="#id10" title="Link to this image"></a></p>
</figcaption>
</figure>
<ul>
<li><p>读取MSR寄存器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 当前性能状态值</span>
<span class="n">sudo</span> <span class="n">rdmsr</span> <span class="o">--</span><span class="n">bitfield</span> <span class="mi">15</span><span class="p">:</span><span class="mi">0</span> <span class="o">-</span><span class="n">a</span> <span class="mh">0x199</span>
<span class="c1"># 设置的性能状态值</span>
<span class="n">sudo</span> <span class="n">rdmsr</span> <span class="o">--</span><span class="n">bitfield</span> <span class="mi">15</span><span class="p">:</span><span class="mi">0</span> <span class="o">-</span><span class="n">a</span> <span class="mh">0x198</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>读取的值需要乘以 <code class="docutils literal notranslate"><span class="pre">100</span></code> 才是实际的值。例如， <code class="docutils literal notranslate"><span class="pre">198H</span></code> 值 <code class="docutils literal notranslate"><span class="pre">1900</span></code> 表示值是 <code class="docutils literal notranslate"><span class="pre">(1x16+9)x100=2500</span></code> (2.5GHz)， <code class="docutils literal notranslate"><span class="pre">198H</span></code> 值 <code class="docutils literal notranslate"><span class="pre">1b00</span></code> 表示值是 <code class="docutils literal notranslate"><span class="pre">(1x16+11)x100=2700</span></code>
(2.7GHz)。</p>
</div>
<ul class="simple">
<li><p>禁用 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动：要通过 <code class="docutils literal notranslate"><span class="pre">wrmsr</span></code> 工具调整 <code class="docutils literal notranslate"><span class="pre">199H</span></code> MSR，需要确保停用 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动，否则调整值会被 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动自动覆盖无法生效。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">off</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">intel_pstate</span><span class="o">/</span><span class="n">status</span>
</pre></div>
</div>
<ul class="simple">
<li><p>要调整主频需要通过 <code class="docutils literal notranslate"><span class="pre">wrmsr</span></code> 写入MSR寄存器</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">wrmsr</span></code> 使用参考 <a class="reference external" href="https://01.org/msr-tools/overview">wrmsr</a></p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">wrmsr</span> <span class="o">-</span><span class="n">p</span> <span class="mi">0</span> <span class="mh">0x199</span> <span class="mh">0x1a00</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">wrmsr</span></code> 只支持 <code class="docutils literal notranslate"><span class="pre">-p</span></code> （指定处理器）和 <code class="docutils literal notranslate"><span class="pre">-a</span></code> (所有处理器)参数</p>
</div>
<ul>
<li><p>然后检查性能设置值:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#sudo $msr_cmd_dir/rdmsr --bitfield 15:0 -a 0x199</span>
<span class="mi">1</span><span class="n">a00</span>
<span class="mi">1900</span>
<span class="mi">1900</span>
</pre></div>
</div>
</li>
</ul>
<p>检查性能当前值可以看到和设置值一致:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#sudo $msr_cmd_dir/rdmsr --bitfield 15:0 -a 0x198</span>
<span class="mi">1</span><span class="n">a00</span>
<span class="mi">1900</span>
<span class="mi">1900</span>
</pre></div>
</div>
<p>检查主频，可以看到 <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">0/12</span></code> 增加了100MHz，达到了2.6GHz</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cpupower monitor</span>
              <span class="o">|</span><span class="n">Nehalem</span>                    <span class="o">||</span> <span class="n">Mperf</span>              <span class="o">||</span> <span class="n">Idle_Stats</span>
<span class="n">PKG</span> <span class="o">|</span><span class="n">CORE</span><span class="o">|</span><span class="n">CPU</span> <span class="o">|</span> <span class="n">C3</span>   <span class="o">|</span> <span class="n">C6</span>   <span class="o">|</span> <span class="n">PC3</span>  <span class="o">|</span> <span class="n">PC6</span>  <span class="o">||</span> <span class="n">C0</span>   <span class="o">|</span> <span class="n">Cx</span>   <span class="o">|</span> <span class="n">Freq</span> <span class="o">||</span> <span class="n">POLL</span> <span class="o">|</span> <span class="n">C1</span><span class="o">-</span><span class="n">S</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span> <span class="mf">99.92</span><span class="o">|</span>  <span class="mf">0.08</span><span class="o">|</span>  <span class="mi">2593</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">0</span><span class="o">|</span>  <span class="mi">12</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span> <span class="mf">99.92</span><span class="o">|</span>  <span class="mf">0.08</span><span class="o">|</span>  <span class="mi">2593</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span> <span class="mf">99.92</span><span class="o">|</span>  <span class="mf">0.08</span><span class="o">|</span>  <span class="mi">2494</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="mi">0</span><span class="o">|</span>   <span class="mi">1</span><span class="o">|</span>  <span class="mi">13</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span><span class="o">||</span> <span class="mf">99.92</span><span class="o">|</span>  <span class="mf">0.08</span><span class="o">|</span>  <span class="mi">2493</span><span class="o">||</span>  <span class="mf">0.00</span><span class="o">|</span>  <span class="mf">0.00</span>
   <span class="o">...</span>
</pre></div>
</div>
<p>此时可以不断通过修改 <code class="docutils literal notranslate"><span class="pre">199H</span></code> MSR实现处理器主频调整。</p>
<ul>
<li><p>最后，测试完成后恢复 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 驱动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">active</span> <span class="o">|</span><span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">intel_pstate</span><span class="o">/</span><span class="n">status</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id6">
<h3>电源管理策略<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<ul>
<li><p>检查当前电源管理可选的策略列表:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpupower</span> <span class="n">frequency</span><span class="o">-</span><span class="n">info</span> <span class="o">--</span><span class="n">governors</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到 <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> 支持的cpufreq策略只有两种 <code class="docutils literal notranslate"><span class="pre">performance</span></code> 和 <code class="docutils literal notranslate"><span class="pre">powersave</span></code> 。</p>
<ul>
<li><p>检查当前激活的电源管理策略:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">cpu0</span><span class="o">/</span><span class="n">cpufreq</span><span class="o">/</span><span class="n">scaling_governor</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">powersave</span>
</pre></div>
</div>
<ul>
<li><p>修改成 <code class="docutils literal notranslate"><span class="pre">performance</span></code> 策略：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cpupower</span> <span class="n">frequency</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span><span class="n">g</span> <span class="n">performance</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id7">
<h3>测试<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>在上述调整处理器主频过程中，可以通过脚本不断压测处理器，以得到处理器主频值。</p>
<ul>
<li><p>性能测试可以通过计算pi来实现，以下 <code class="docutils literal notranslate"><span class="pre">scale=20000</span></code> 表示计算pi的精度是2万位：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="n">echo</span> <span class="s2">&quot;scale=20000; 4*a(1)&quot;</span> <span class="o">|</span> <span class="n">bc</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">q</span>
</pre></div>
</div>
</li>
<li><p>如果要压所有的CPU满负荷，以确定Trubo Boost主频，可以采用如下 <code class="docutils literal notranslate"><span class="pre">yes.sh</span></code> 脚本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nohup</span> <span class="n">yes</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">&amp;</span>
</pre></div>
</div>
</li>
</ul>
<p>然后启用对 <code class="docutils literal notranslate"><span class="pre">24</span></code> 核服务器压测，每个脚本都通过 <code class="docutils literal notranslate"><span class="pre">taskset</span></code> 指令绑定到独立CPU上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in `seq 0 23`;do taskset -c $i sh ./yes.sh;done
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于进程pid，可以采用 <code class="docutils literal notranslate"><span class="pre">taskset</span> <span class="pre">-cp</span> <span class="pre">&lt;cpu</span> <span class="pre">N&gt;</span> <span class="pre">&lt;pid&gt;</span></code> 来设置进程 <code class="docutils literal notranslate"><span class="pre">&lt;pid&gt;</span></code> 到处理器 <code class="docutils literal notranslate"><span class="pre">&lt;cpu</span> <span class="pre">N&gt;</span></code> 运行。</p>
</div>
</section>
<section id="id8">
<h3>异常排查<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>系统内核明确设置了 <code class="docutils literal notranslate"><span class="pre">intel_pstate=enable</span></code> 但是启动之后，依然出现如下报错</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cpupower frequency-info</span>
<span class="n">analyzing</span> <span class="n">CPU</span> <span class="mi">0</span><span class="p">:</span>
  <span class="n">no</span> <span class="ow">or</span> <span class="n">unknown</span> <span class="n">cpufreq</span> <span class="n">driver</span> <span class="ow">is</span> <span class="n">active</span> <span class="n">on</span> <span class="n">this</span> <span class="n">CPU</span>

<span class="c1">#cpupower info</span>
<span class="n">System</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">support</span> <span class="n">Intel</span><span class="s1">&#39;s performance bias setting</span>
<span class="n">analyzing</span> <span class="n">CPU</span> <span class="mi">0</span><span class="p">:</span>
</pre></div>
</div>
<p>BIOS开启turbo没有成功导致。</p>
</section>
<section id="id9">
<h3>参考<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Intel_Turbo_Boost">Intel Turbo Boost</a></p></li>
<li><p><a class="reference external" href="https://www.intel.com/content/www/us/en/support/processors/000021587.html">Frequently Asked Questions about Intel® Turbo Boost Max Technology 3.0</a></p></li>
<li><p><a class="reference external" href="http://www.makeuseof.com/tag/forced-induction-intel-turbo-boost-works-technology-explained/">How Intel Turbo Boost Works</a></p></li>
<li><p><a class="reference external" href="https://haypo.github.io/intel-cpus.html">Intel CPUs: P-state, C-state, Turbo Boost, CPU frequency, etc.</a></p></li>
<li><p><a class="reference external" href="https://events.linuxfoundation.org/sites/events/files/slides/LinuxConEurope_2015.pdf">Balancing Power and Performance in the Linux Kernel</a> Intel开源中心提供的有关能耗和性能平衡的介绍文档</p></li>
<li><p><a class="reference external" href="https://doc.opensuse.org/documentation/leap/tuning/html/book.sle.tuning/cha.tuning.power.html">Suse doc: System Analysis and Tuning Guide &gt; Power Management</a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="cpu_p-state.html" class="btn btn-neutral float-left" title="CPU p-state" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="intel_turbo_boost_pstate.html" class="btn btn-neutral float-right" title="Intel Turbo Boost技术和intel_pstate" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../../copyright.html">版权所有</a> 2018 - now, Huatai Huang。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡 👈</a></p>
    <br>
    <p>网站采用 <a href="https://utteranc.es/">utterances</a> 评论系统，所有评论存储在<a href="https://github.com/huataihuang/cloud-atlas/issues">GitHub issues</a> 中，如果你看不到下方的评论框，那么可能需要<a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/security/vpn/index.html">自备梯子</a> 👈</p>
    <div class="articleComments">
        <comments>
  <script src="https://utteranc.es/client.js"
    repo="huataihuang/cloud-atlas"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
    </div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>