<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>添加Ceph OSDs (RAW磁盘) &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinxnotes-strike.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="添加Ceph OSDs (LVM卷)" href="add_ceph_osds_lvm.html" />
    <link rel="prev" title="安装 ceph-mgr" href="install_ceph_mgr.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Ceph Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduce_ceph.html">Ceph存储介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ceph_recommend.html">Ceph部署软硬件推荐</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rdma.html">Remote Direct Memory Access(RDMA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ceph_docker_in_studio.html">Stuido环境Docker容器运行Ceph</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Ceph 部署</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../install_ceph.html">安装Ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../centos_sig_ceph.html">CentOS SIG部署Ceph</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Ceph 手工部署</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="prepare.html">手工安装Ceph - 准备工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="install_ceph_mon.html">安装 ceph-mon</a></li>
<li class="toctree-l4"><a class="reference internal" href="install_ceph_mgr.html">安装 ceph-mgr</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">添加Ceph OSDs (RAW磁盘)</a></li>
<li class="toctree-l4"><a class="reference internal" href="add_ceph_osds_lvm.html">添加Ceph OSDs (LVM卷)</a></li>
<li class="toctree-l4"><a class="reference internal" href="add_ceph_mons.html">Ceph集群添加ceph-mon</a></li>
<li class="toctree-l4"><a class="reference internal" href="add_ceph_osds_more.html">Ceph集群添加更多ceph-osd</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../install_ceph_manual_zdata/index.html">Ceph 手工部署zdata集群(暂未成功)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../mgr/index.html">Ceph Manager Daemon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config/index.html">Ceph 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arm/index.html">ARM架构Ceph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch/index.html">Ceph 架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tunning/index.html">Ceph 优化</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Ceph Atlas</a> &raquo;</li>
          <li><a href="../index.html">Ceph 部署</a> &raquo;</li>
          <li><a href="index.html">Ceph 手工部署</a> &raquo;</li>
      <li>添加Ceph OSDs (RAW磁盘)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/ceph/deploy/install_ceph_manual/add_ceph_osds_raw.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ceph-osds-raw">
<span id="add-ceph-osds-raw"></span><h1>添加Ceph OSDs (RAW磁盘)<a class="headerlink" href="#ceph-osds-raw" title="永久链接至标题">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>我尝试通过默认集群名来避免 <a class="reference internal" href="../install_ceph_manual_zdata/add_ceph_osds_zdata.html#add-ceph-osds-zdata"><span class="std std-ref">添加Ceph OSDs (zdata)</span></a> 遇到的无法传递自定义集群名的问题，但是本次尝试依然失败(虽然也有一些经验积累)。所以我准备重新开始采用标准 <a class="reference internal" href="add_ceph_osds_lvm.html#add-ceph-osds-lvm"><span class="std std-ref">添加Ceph OSDs (LVM卷)</span></a> 部署，后续再准备虚拟机环境解决本文实践问题。`</p>
</div>
<p>在完成了初始 <a class="reference internal" href="install_ceph_mon.html#install-ceph-mon"><span class="std std-ref">安装 ceph-mon</span></a> 之后，就可以添加 OSDs。只有完成了足够的OSDs部署(满足对象数量，例如 <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">pool</span> <span class="pre">default</span> <span class="pre">size</span> <span class="pre">=2</span></code> 要求集群至少具备2个OSDs)才能达到 <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">clean</span></code> 状态。在完成了 <code class="docutils literal notranslate"><span class="pre">bootstap</span></code> Ceph monitor之后，集群就具备了一个默认的 <code class="docutils literal notranslate"><span class="pre">CRUSH</span></code> map，但是此时 <code class="docutils literal notranslate"><span class="pre">CRUSH</span></code> map还没有具备任何Ceph OSD Daemons map到一个Ceph节点。</p>
<p>Ceph提供了一个 <code class="docutils literal notranslate"><span class="pre">ceph-vlume</span></code> 工具，用来准备一个逻辑卷，磁盘或分区给Ceph使用，通过增加索引来创建OSD ID，并且将新的OSD添加到CRUSH map。需要在每个要添加OSD的节点上执行该工具。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我有3个服务器节点提供存储，需要分别在这3个节点上部署OSD服务。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Ceph官方文档的案例都是采用 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">lvm</span></code> 来完成的，这个命令可以在Ceph的OSD底层构建一个 <a class="reference internal" href="../../../linux/storage/lvm/index.html#linux-lvm"><span class="std std-ref">Linux LVM逻辑卷管理</span></a> ，带来的优势是可以随时扩容底层存储容量，对后续运维带来极大便利。在生产环境中部署，建议使用 <code class="docutils literal notranslate"><span class="pre">lvm</span></code> 卷。</p>
<p>我这里的测试环境，采用简化的 <code class="docutils literal notranslate"><span class="pre">磁盘分区</span></code> 来提供Ceph <a class="reference internal" href="../../arch/bluestore.html#bluestore"><span class="std std-ref">Ceph后端存储引擎BlueStore</span></a> 存储，原因是我需要简化配置，同时我的测试服务器也没有硬件进行后续扩容。</p>
</div>
<section id="bluestore">
<h2>bluestore<a class="headerlink" href="#bluestore" title="永久链接至标题">¶</a></h2>
<p><a class="reference internal" href="../../arch/bluestore.html#bluestore"><span class="std std-ref">Ceph后端存储引擎BlueStore</span></a> 是最新的Ceph采用的默认高性能存储引擎，底层不再使用OS的文件系统，可以直接管理磁盘硬件。</p>
<p>需要部署OSD的服务器首先准备存储，通常采用LVM卷作为底层存储块设备，这样可以通过LVM逻辑卷灵活调整块设备大小(有可能随着数据存储增长需要调整设备)。</p>
<p>作为我的实践环境 <a class="reference internal" href="../../../linux/server/hardware/hpe/hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 每个 <a class="reference internal" href="../../../kvm/iommu/ovmf.html#ovmf"><span class="std std-ref">Open Virtual Machine Firmware(OMVF)</span></a> 虚拟机仅有一个pass-through PCIe NVMe存储，所以我没有划分不同存储设备来分别存放 <code class="docutils literal notranslate"><span class="pre">block</span></code> / <code class="docutils literal notranslate"><span class="pre">block.db</span></code> 和 <code class="docutils literal notranslate"><span class="pre">block.wal</span></code> 。并且也因为无法扩展存储，我就尝试不使用LVM卷，而直接采用磁盘分区。</p>
<section id="rawbluestore">
<h3>使用raw分区作为bluestore底层(失败)<a class="headerlink" href="#rawbluestore" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">--help</span></code> 可以看到支持3种底层存储:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lvm</span>                      <span class="n">Use</span> <span class="n">LVM</span> <span class="ow">and</span> <span class="n">LVM</span><span class="o">-</span><span class="n">based</span> <span class="n">technologies</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">OSDs</span>
<span class="n">simple</span>                   <span class="n">Manage</span> <span class="n">already</span> <span class="n">deployed</span> <span class="n">OSDs</span> <span class="k">with</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span>
<span class="n">raw</span>                      <span class="n">Manage</span> <span class="n">single</span><span class="o">-</span><span class="n">device</span> <span class="n">OSDs</span> <span class="n">on</span> <span class="n">raw</span> <span class="n">block</span> <span class="n">devices</span>
</pre></div>
</div>
</li>
</ul>
<p>我这里构建实践采用 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span></code> ，直接采用 NVMe 存储分区</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>生产环境请使用LVM卷作为底层设备 - 参考 <a class="reference internal" href="../../config/bluestore_config.html#bluestore-config"><span class="std std-ref">Ceph BlueStore配置</span></a></p>
<p>我的部署实践是在3台虚拟机 <code class="docutils literal notranslate"><span class="pre">z-b-data-1</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-data-2</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-data-3</span></code> 上完成，分区完全一致</p>
</div>
<ul>
<li><p>准备底层块设备，这里划分 GPT 分区1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mklabel</span> <span class="n">gpt</span>
<span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mkpart</span> <span class="n">primary</span> <span class="mi">0</span><span class="o">%</span> <span class="mi">700</span><span class="n">GB</span>
</pre></div>
</div>
</li>
</ul>
<p>完成后检查 <code class="docutils literal notranslate"><span class="pre">fdisk</span> <span class="pre">-l</span></code> 可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mf">953.89</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024209543168</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000409264</span> <span class="n">sectors</span>
<span class="n">Disk</span> <span class="n">model</span><span class="p">:</span> <span class="n">SAMSUNG</span> <span class="n">MZVL21T0HCLR</span><span class="o">-</span><span class="mi">00</span><span class="n">B00</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="n">E131A860</span><span class="o">-</span><span class="mi">1</span><span class="n">EC8</span><span class="o">-</span><span class="mi">4</span><span class="n">F34</span><span class="o">-</span><span class="mi">8150</span><span class="o">-</span><span class="mi">2</span><span class="n">A2C312176A1</span>

<span class="n">Device</span>         <span class="n">Start</span>        <span class="n">End</span>    <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>  <span class="mi">2048</span> <span class="mi">1367187455</span> <span class="mi">1367185408</span> <span class="mf">651.9</span><span class="n">G</span> <span class="n">Linux</span> <span class="n">filesystem</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以上分区操作在3台存储虚拟机上完成</p>
</div>
<ul>
<li><p>创建第一个OSD，注意我使用了统一的 <code class="docutils literal notranslate"><span class="pre">data</span></code> 存储来存放所有数据，包括 <code class="docutils literal notranslate"><span class="pre">block.db</span></code> 和 <code class="docutils literal notranslate"><span class="pre">block.wal</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">prepare</span> <span class="o">--</span><span class="n">bluestore</span> <span class="o">--</span><span class="n">data</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">-h</span></code> 包含子命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span>                     <span class="nb">list</span> <span class="n">BlueStore</span> <span class="n">OSDs</span> <span class="n">on</span> <span class="n">raw</span> <span class="n">devices</span>
<span class="n">prepare</span>                  <span class="n">Format</span> <span class="n">a</span> <span class="n">raw</span> <span class="n">device</span> <span class="ow">and</span> <span class="n">associate</span> <span class="n">it</span> <span class="k">with</span> <span class="n">a</span> <span class="p">(</span><span class="n">BlueStore</span><span class="p">)</span> <span class="n">OSD</span>
<span class="n">activate</span>                 <span class="n">Discover</span> <span class="ow">and</span> <span class="n">prepare</span> <span class="n">a</span> <span class="n">data</span> <span class="n">directory</span> <span class="k">for</span> <span class="n">a</span> <span class="p">(</span><span class="n">BlueStore</span><span class="p">)</span> <span class="n">OSD</span> <span class="n">on</span> <span class="n">a</span> <span class="n">raw</span> <span class="n">device</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">lvm</span> <span class="pre">-h</span></code> 包含子命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">activate</span>                 <span class="n">Discover</span> <span class="ow">and</span> <span class="n">mount</span> <span class="n">the</span> <span class="n">LVM</span> <span class="n">device</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">an</span> <span class="n">OSD</span> <span class="n">ID</span> <span class="ow">and</span> <span class="n">start</span> <span class="n">the</span> <span class="n">Ceph</span> <span class="n">OSD</span>
<span class="n">deactivate</span>               <span class="n">Deactivate</span> <span class="n">OSDs</span>
<span class="n">batch</span>                    <span class="n">Automatically</span> <span class="n">size</span> <span class="n">devices</span> <span class="k">for</span> <span class="n">multi</span><span class="o">-</span><span class="n">OSD</span> <span class="n">provisioning</span> <span class="k">with</span> <span class="n">minimal</span> <span class="n">interaction</span>
<span class="n">prepare</span>                  <span class="n">Format</span> <span class="n">an</span> <span class="n">LVM</span> <span class="n">device</span> <span class="ow">and</span> <span class="n">associate</span> <span class="n">it</span> <span class="k">with</span> <span class="n">an</span> <span class="n">OSD</span>
<span class="n">create</span>                   <span class="n">Create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">OSD</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">LVM</span> <span class="n">device</span>
<span class="n">trigger</span>                  <span class="n">systemd</span> <span class="n">helper</span> <span class="n">to</span> <span class="n">activate</span> <span class="n">an</span> <span class="n">OSD</span>
<span class="nb">list</span>                     <span class="nb">list</span> <span class="n">logical</span> <span class="n">volumes</span> <span class="ow">and</span> <span class="n">devices</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">Ceph</span>
<span class="n">zap</span>                      <span class="n">Removes</span> <span class="nb">all</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">filesystems</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">logical</span> <span class="n">volume</span> <span class="ow">or</span> <span class="n">partition</span><span class="o">.</span>
<span class="n">migrate</span>                  <span class="n">Migrate</span> <span class="n">BlueFS</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">to</span> <span class="n">another</span> <span class="n">LVM</span> <span class="n">device</span>
<span class="n">new</span><span class="o">-</span><span class="n">wal</span>                  <span class="n">Allocate</span> <span class="n">new</span> <span class="n">WAL</span> <span class="n">volume</span> <span class="k">for</span> <span class="n">OSD</span> <span class="n">at</span> <span class="n">specified</span> <span class="n">Logical</span> <span class="n">Volume</span>
<span class="n">new</span><span class="o">-</span><span class="n">db</span>                   <span class="n">Allocate</span> <span class="n">new</span> <span class="n">DB</span> <span class="n">volume</span> <span class="k">for</span> <span class="n">OSD</span> <span class="n">at</span> <span class="n">specified</span> <span class="n">Logical</span> <span class="n">Volume</span>
</pre></div>
</div>
<p>对于 <code class="docutils literal notranslate"><span class="pre">raw</span></code> 命令需要分步骤完成，不像 <code class="docutils literal notranslate"><span class="pre">lvm</span></code> 命令提供了更为丰富的批量命令</p>
</div>
<p>我在执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">prepare</span> <span class="o">--</span><span class="n">data</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
<p>命令提示只支持 <code class="docutils literal notranslate"><span class="pre">--bluestore</span></code> 作为后端，但是提示 <code class="docutils literal notranslate"><span class="pre">/dev/nvme0n1p1:</span> <span class="pre">not</span> <span class="pre">a</span> <span class="pre">block</span> <span class="pre">device</span></code> 让我很疑惑，NVMe分区为何不是块设备？:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stderr</span><span class="p">:</span> <span class="n">lsblk</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span><span class="p">:</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">block</span> <span class="n">device</span>
<span class="n">stderr</span><span class="p">:</span> <span class="n">Unknown</span> <span class="n">device</span> <span class="s2">&quot;/dev/nvme0n1p1&quot;</span><span class="p">:</span> <span class="n">Inappropriate</span> <span class="n">ioctl</span> <span class="k">for</span> <span class="n">device</span>
<span class="o">--&gt;</span> <span class="n">must</span> <span class="n">specify</span> <span class="o">--</span><span class="n">bluestore</span> <span class="p">(</span><span class="n">currently</span> <span class="n">the</span> <span class="n">only</span> <span class="n">supported</span> <span class="n">backend</span><span class="p">)</span>
</pre></div>
</div>
<p>修订命令，添加 <code class="docutils literal notranslate"><span class="pre">--bluestore</span></code> 参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">prepare</span> <span class="o">--</span><span class="n">bluestore</span> <span class="o">--</span><span class="n">data</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>从 <code class="docutils literal notranslate"><span class="pre">lsblk</span></code> 输出来看 <code class="docutils literal notranslate"><span class="pre">/dev/nvme0n1p1</span></code> 没有显示为正常的块设备，原因我在下文会说明</p>
<blockquote>
<div><p># lsblk /dev/nvme0n1
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
nvme0n1     259:0    0 953.9G  0 disk
└─nvme0n1p1 259:1    0 651.9G  0 part</p>
<p># lsblk /dev/nvme0n1p1
lsblk: /dev/nvme0n1p1: not a block device</p>
</div></blockquote>
<p>但是对于 <code class="docutils literal notranslate"><span class="pre">vda</span></code> 设备却没有报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># lsblk /dev/vda
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
vda    252:0    0    6G  0 disk
├─vda1 252:1    0  243M  0 part /boot/efi
└─vda2 252:2    0  5.8G  0 part /

# lsblk /dev/vda2
NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
vda2 252:2    0  5.8G  0 part /
</pre></div>
</div>
</div>
<p>但是 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">prepare</span></code> 报错:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">ceph-volume raw 输出(错误)</span><a class="headerlink" href="#id9" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span> stderr: lsblk: /dev/nvme0n1p1: not a block device
<span class="linenos"> 2</span> stderr: Unknown device <span class="s2">&quot;/dev/nvme0n1p1&quot;</span>: Inappropriate ioctl <span class="k">for</span> device
<span class="linenos"> 3</span>Running command: /usr/bin/ceph-authtool --gen-print-key
<span class="linenos"> 4</span>Running command: /usr/bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring -i - osd new c3334a8e-e118-44c5-bcce-709a268e7438
<span class="linenos"> 5</span>Running command: /usr/bin/ceph-authtool --gen-print-key
<span class="linenos"> 6</span>Running command: /usr/bin/mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-0
<span class="linenos"> 7</span>--&gt; Executable selinuxenabled not <span class="k">in</span> PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
<span class="linenos"> 8</span>Running command: /usr/bin/chown -R ceph:ceph /dev/nvme0n1p1
<span class="linenos"> 9</span>Running command: /usr/bin/ln -s /dev/nvme0n1p1 /var/lib/ceph/osd/ceph-0/block
<span class="linenos">10</span>Running command: /usr/bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring mon getmap -o /var/lib/ceph/osd/ceph-0/activate.monmap
<span class="linenos">11</span> stderr: <span class="m">2021</span>-11-29T20:04:59.576+0800 7f906c775700 -1 auth: unable to find a keyring on /etc/ceph/ceph.client.bootstrap-osd.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: <span class="o">(</span><span class="m">2</span><span class="o">)</span> No such file or directory
<span class="linenos">12</span> stderr: <span class="m">2021</span>-11-29T20:04:59.576+0800 7f906c775700 -1 AuthRegistry<span class="o">(</span>0x7f90640592a0<span class="o">)</span> no keyring found at /etc/ceph/ceph.client.bootstrap-osd.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,, disabling cephx
<span class="linenos">13</span> stderr: got monmap epoch <span class="m">2</span>
<span class="linenos">14</span>Running command: /usr/bin/ceph-authtool /var/lib/ceph/osd/ceph-0/keyring --create-keyring --name osd.0 --add-key AQDrwaRhxXsbCBAAfKmbWFW4HSZwWnXIccm/Xg<span class="o">==</span>
<span class="linenos">15</span> stdout: creating /var/lib/ceph/osd/ceph-0/keyring
<span class="linenos">16</span>added entity osd.0 auth<span class="o">(</span><span class="nv">key</span><span class="o">=</span>AQDrwaRhxXsbCBAAfKmbWFW4HSZwWnXIccm/Xg<span class="o">==)</span>
<span class="linenos">17</span>Running command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-0/keyring
<span class="linenos">18</span>Running command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-0/
<span class="linenos">19</span>Running command: /usr/bin/ceph-osd --cluster ceph --osd-objectstore bluestore --mkfs -i <span class="m">0</span> --monmap /var/lib/ceph/osd/ceph-0/activate.monmap --keyfile - --osd-data /var/lib/ceph/osd/ceph-0/ --osd-uuid c3334a8e-e118-44c5-bcce-709a268e7438 --setuser ceph --setgroup ceph
<span class="linenos">20</span> stderr: <span class="m">2021</span>-11-29T20:05:00.680+0800 7fa1f4b0ad80 -1 bluestore<span class="o">(</span>/var/lib/ceph/osd/ceph-0/<span class="o">)</span> _read_fsid unparsable uuid
<span class="linenos">21</span> stderr: <span class="m">2021</span>-11-29T20:05:00.680+0800 7fa1f4b0ad80 -1 bdev<span class="o">(</span>0x55c7dcfec000 /var/lib/ceph/osd/ceph-0//block<span class="o">)</span> open open got: <span class="o">(</span><span class="m">22</span><span class="o">)</span> Invalid argument
<span class="linenos">22</span> stderr: <span class="m">2021</span>-11-29T20:05:00.680+0800 7fa1f4b0ad80 -1 bluestore<span class="o">(</span>/var/lib/ceph/osd/ceph-0/<span class="o">)</span> mkfs failed, <span class="o">(</span><span class="m">22</span><span class="o">)</span> Invalid argument
<span class="linenos">23</span> stderr: <span class="m">2021</span>-11-29T20:05:00.680+0800 7fa1f4b0ad80 -1 OSD::mkfs: ObjectStore::mkfs failed with error <span class="o">(</span><span class="m">22</span><span class="o">)</span> Invalid argument
<span class="linenos">24</span> stderr: <span class="m">2021</span>-11-29T20:05:00.680+0800 7fa1f4b0ad80 -1  ** ERROR: error creating empty object store <span class="k">in</span> /var/lib/ceph/osd/ceph-0/: <span class="o">(</span><span class="m">22</span><span class="o">)</span> Invalid argument
<span class="linenos">25</span>--&gt; Was unable to <span class="nb">complete</span> a new OSD, will rollback changes
<span class="linenos">26</span>Running command: /usr/bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring osd purge-new osd.0 --yes-i-really-mean-it
<span class="linenos">27</span> stderr: <span class="m">2021</span>-11-29T20:05:00.772+0800 7f953f72d700 -1 auth: unable to find a keyring on /etc/ceph/ceph.client.bootstrap-osd.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: <span class="o">(</span><span class="m">2</span><span class="o">)</span> No such file or directory
<span class="linenos">28</span> stderr: <span class="m">2021</span>-11-29T20:05:00.772+0800 7f953f72d700 -1 AuthRegistry<span class="o">(</span>0x7f95380592a0<span class="o">)</span> no keyring found at /etc/ceph/ceph.client.bootstrap-osd.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,, disabling cephx
<span class="linenos">29</span> stderr: purged osd.0
<span class="linenos">30</span>--&gt;  RuntimeError: Command failed with <span class="nb">exit</span> code <span class="m">250</span>: /usr/bin/ceph-osd --cluster ceph --osd-objectstore bluestore --mkfs -i <span class="m">0</span> --monmap /var/lib/ceph/osd/ceph-0/activate.monmap --keyfile - --osd-data /var/lib/ceph/osd/ceph-0/ --osd-uuid c3334a8e-e118-44c5-bcce-709a268e7438 --setuser ceph --setgroup ceph
</pre></div>
</div>
</div>
<section id="id1">
<h4>问题根源<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>实际我也发现即使采用 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">lvm</span> <span class="pre">create</span></code> 也是失败的，提示信息中也有:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stderr</span><span class="p">:</span> <span class="n">lsblk</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span><span class="p">:</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">block</span> <span class="n">device</span>
</pre></div>
</div>
<p>我仔细检查了设备文件，发现了异常:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls -lh /dev/nvme0n1
brw-rw---- 1 root disk 259, 0 Nov 29 20:19 /dev/nvme0n1

$ ls -lh /dev/nvme0n1p1
-rw-r--r-- 1 ceph ceph 10M Nov 29 17:00 /dev/nvme0n1p1
</pre></div>
</div>
<p>也就是说，设备分区 <code class="docutils literal notranslate"><span class="pre">nvme0n1p1</span></code> 异常，没有显示为块设备，我想起来之前做了一个 <code class="docutils literal notranslate"><span class="pre">/usr/bin/dd</span> <span class="pre">if=/dev/zero</span> <span class="pre">of=/dev/nvme0n1p1</span> <span class="pre">bs=1M</span> <span class="pre">count=10</span> <span class="pre">conv=fsync</span></code> 但当时没有注意到已经删除了分区 <code class="docutils literal notranslate"><span class="pre">nvme0n1p1</span></code> 所以导致 <code class="docutils literal notranslate"><span class="pre">dd</span></code> 命令直接作用于 <code class="docutils literal notranslate"><span class="pre">/dev</span></code> 目录下形成了上述文件。这就导致后续分区之后，实际上没有正确创建出 <code class="docutils literal notranslate"><span class="pre">/dev/nvme0n1p1</span></code> 块设备。</p>
<p>解决方法是重建分区表，并且重启一次操作系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mklabel</span> <span class="n">gpt</span>
<span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
</pre></div>
</div>
<p>重启以后再划分分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mkpart</span> <span class="n">primary</span> <span class="mi">0</span><span class="o">%</span> <span class="mi">700</span><span class="n">GB</span>
</pre></div>
</div>
<p>完成以后再检查设备文件就可以看到是正常的块设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls -lh /dev/nvme0*
crw------- 1 root root 241, 0 Nov 29 20:32 /dev/nvme0
brw-rw---- 1 root disk 259, 0 Nov 29 20:33 /dev/nvme0n1
brw-rw---- 1 root disk 259, 2 Nov 29 20:33 /dev/nvme0n1p1
</pre></div>
</div>
<p>然后重新执行创建OSD磁盘成功:</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">ceph-volume raw 输出(成功)</span><a class="headerlink" href="#id10" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Running command: /usr/bin/ceph-authtool --gen-print-key
<span class="linenos"> 2</span>Running command: /usr/bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring -i - osd new 8d889fc0-110c-45fa-a259-6a876183bc46
<span class="linenos"> 3</span>Running command: /usr/bin/ceph-authtool --gen-print-key
<span class="linenos"> 4</span>Running command: /usr/bin/mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-0
<span class="linenos"> 5</span>--&gt; Executable selinuxenabled not <span class="k">in</span> PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
<span class="linenos"> 6</span>Running command: /usr/bin/chown -R ceph:ceph /dev/nvme0n1p1
<span class="linenos"> 7</span>Running command: /usr/bin/ln -s /dev/nvme0n1p1 /var/lib/ceph/osd/ceph-0/block
<span class="linenos"> 8</span>Running command: /usr/bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring mon getmap -o /var/lib/ceph/osd/ceph-0/activate.monmap
<span class="linenos"> 9</span> stderr: <span class="m">2021</span>-11-29T20:40:23.416+0800 7f2f3e3c7700 -1 auth: unable to find a keyring on /etc/ceph/ceph.client.bootstrap-osd.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: <span class="o">(</span><span class="m">2</span><span class="o">)</span> No such file or directory
<span class="linenos">10</span><span class="m">2021</span>-11-29T20:40:23.416+0800 7f2f3e3c7700 -1 AuthRegistry<span class="o">(</span>0x7f2f380592a0<span class="o">)</span> no keyring found at /etc/ceph/ceph.client.bootstrap-osd.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,, disabling cephx
<span class="linenos">11</span> stderr: got monmap epoch <span class="m">2</span>
<span class="linenos">12</span>Running command: /usr/bin/ceph-authtool /var/lib/ceph/osd/ceph-0/keyring --create-keyring --name osd.0 --add-key <span class="nv">AQA2yqRhes0wORAAttpUh5aRZsr1pLdHeXRezg</span><span class="o">==</span>
<span class="linenos">13</span> stdout: creating /var/lib/ceph/osd/ceph-0/keyring
<span class="linenos">14</span>added entity osd.0 auth<span class="o">(</span><span class="nv">key</span><span class="o">=</span><span class="nv">AQA2yqRhes0wORAAttpUh5aRZsr1pLdHeXRezg</span><span class="o">==)</span>
<span class="linenos">15</span>Running command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-0/keyring
<span class="linenos">16</span>Running command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-0/
<span class="linenos">17</span>Running command: /usr/bin/ceph-osd --cluster ceph --osd-objectstore bluestore --mkfs -i <span class="m">0</span> --monmap /var/lib/ceph/osd/ceph-0/activate.monmap --keyfile - --osd-data /var/lib/ceph/osd/ceph-0/ --osd-uuid 8d889fc0-110c-45fa-a259-6a876183bc46 --setuser ceph --setgroup ceph
<span class="linenos">18</span> stderr: <span class="m">2021</span>-11-29T20:40:23.876+0800 7fc9a125dd80 -1 bluestore<span class="o">(</span>/var/lib/ceph/osd/ceph-0/<span class="o">)</span> _read_fsid unparsable uuid
<span class="linenos">19</span> stderr: <span class="m">2021</span>-11-29T20:40:23.940+0800 7fc9a125dd80 -1 freelist read_size_meta_from_db missing size meta <span class="k">in</span> DB
<span class="linenos">20</span>--&gt; ceph-volume raw clear prepare successful <span class="k">for</span>: /dev/nvme0n1p1
</pre></div>
</div>
</div>
<ul>
<li><p>检查raw设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="nb">list</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到设备文件如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ceph_fsid&quot;</span><span class="p">:</span> <span class="s2">&quot;39392603-fe09-4441-acce-1eb22b1391e1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/nvme0n1p1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;osd_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;osd_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;8d889fc0-110c-45fa-a259-6a876183bc46&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bluestore&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>激活OSD: 需要注意 <code class="docutils literal notranslate"><span class="pre">raw</span></code> 格式的设备激活和 lvm卷不同，采用如下格式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">activate</span> <span class="p">[</span><span class="o">--</span><span class="n">device</span> <span class="n">DEVICE</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
<p>也就是只要指定设备就可以:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">activate</span> <span class="o">--</span><span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
<p>提示报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--&gt;</span> <span class="n">systemd</span> <span class="n">support</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">implemented</span>
</pre></div>
</div>
<ul>
<li><p>这是因为需要先启动systemd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
<p>然后检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● ceph-osd@0.service - Ceph object storage daemon osd.0
     Loaded: loaded (/lib/systemd/system/ceph-osd@.service; disabled; vendor preset: enabled)
     Active: active (running) since Mon 2021-11-29 22:44:37 CST; 17s ago
    Process: 1370 ExecStartPre=/usr/lib/ceph/ceph-osd-prestart.sh --cluster ${CLUSTER} --id 0 (code=exited, status=0/SUCCESS)
   Main PID: 1382 (ceph-osd)
      Tasks: 69
     Memory: 25.0M
     CGroup: /system.slice/system-ceph\x2dosd.slice/ceph-osd@0.service
             └─1382 /usr/bin/ceph-osd -f --cluster ceph --id 0 --setuser ceph --setgroup ceph

Nov 29 22:44:37 z-b-data-1 systemd[1]: Starting Ceph object storage daemon osd.0...
Nov 29 22:44:37 z-b-data-1 systemd[1]: Started Ceph object storage daemon osd.0.
Nov 29 22:44:37 z-b-data-1 ceph-osd[1382]: 2021-11-29T22:44:37.656+0800 7f081f44ad80 -1 Falling back to public interface
Nov 29 22:44:38 z-b-data-1 ceph-osd[1382]: 2021-11-29T22:44:38.332+0800 7f081f44ad80 -1 osd.0 0 log_to_monitors {default=true}
Nov 29 22:44:40 z-b-data-1 ceph-osd[1382]: 2021-11-29T22:44:40.308+0800 7f0811535700 -1 osd.0 0 waiting for initial osdmap
Nov 29 22:44:40 z-b-data-1 ceph-osd[1382]: 2021-11-29T22:44:40.336+0800 7f081898c700 -1 osd.0 13 set_numa_affinity unable to identify public interface &#39;&#39; numa node: (2) No such file or directory
</pre></div>
</div>
<p>这里可以看到 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> 启动会找寻 NUMA 节点</p>
<p>没有报错的话，别忘记激活这个osd服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
<ul>
<li><p>然后再次激活 <code class="docutils literal notranslate"><span class="pre">ceph-0</span></code> 这个OSD磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">activate</span> <span class="o">--</span><span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<p>依然报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--&gt;</span> <span class="n">systemd</span> <span class="n">support</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">implemented</span>
</pre></div>
</div>
<p>似乎不需要手工激活，只需要启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd&#64;0.service</span></code> 就可以</p>
<ul>
<li><p>现在检查 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ceph</span> <span class="pre">-s</span></code> 状态已经看到激活了OSD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="p">:</span>
  <span class="nb">id</span><span class="p">:</span>     <span class="mi">39392603</span><span class="o">-</span><span class="n">fe09</span><span class="o">-</span><span class="mi">4441</span><span class="o">-</span><span class="n">acce</span><span class="o">-</span><span class="mi">1</span><span class="n">eb22b1391e1</span>
  <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
          <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span>
          <span class="n">Degraded</span> <span class="n">data</span> <span class="n">redundancy</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">undersized</span>
          <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">mon</span><span class="p">:</span> <span class="mi">1</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">age</span> <span class="mi">2</span><span class="n">h</span><span class="p">)</span>
  <span class="n">mgr</span><span class="p">:</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="mi">2</span><span class="n">h</span><span class="p">)</span>
  <span class="n">osd</span><span class="p">:</span> <span class="mi">1</span> <span class="n">osds</span><span class="p">:</span> <span class="mi">1</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="mi">16</span><span class="n">m</span><span class="p">),</span> <span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="n">since</span> <span class="mi">16</span><span class="n">m</span><span class="p">)</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">pools</span><span class="p">:</span>   <span class="mi">1</span> <span class="n">pools</span><span class="p">,</span> <span class="mi">1</span> <span class="n">pgs</span>
  <span class="n">objects</span><span class="p">:</span> <span class="mi">0</span> <span class="n">objects</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span>
  <span class="n">usage</span><span class="p">:</span>   <span class="mf">1.0</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="mi">651</span> <span class="n">GiB</span> <span class="o">/</span> <span class="mi">652</span> <span class="n">GiB</span> <span class="n">avail</span>
  <span class="n">pgs</span><span class="p">:</span>     <span class="mf">100.000</span><span class="o">%</span> <span class="n">pgs</span> <span class="ow">not</span> <span class="n">active</span>
           <span class="mi">1</span> <span class="n">undersized</span><span class="o">+</span><span class="n">peered</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>注意，此时可以看到 <code class="docutils literal notranslate"><span class="pre">data</span></code> 段落显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span>   <span class="mf">1.0</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="mi">651</span> <span class="n">GiB</span> <span class="o">/</span> <span class="mi">652</span> <span class="n">GiB</span> <span class="n">avail</span>
</pre></div>
</div>
</div>
<ul>
<li><p>检查OSD状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span>  <span class="n">CLASS</span>  <span class="n">WEIGHT</span>   <span class="n">TYPE</span> <span class="n">NAME</span>            <span class="n">STATUS</span>  <span class="n">REWEIGHT</span>  <span class="n">PRI</span><span class="o">-</span><span class="n">AFF</span>
<span class="o">-</span><span class="mi">1</span>         <span class="mf">0.63660</span>  <span class="n">root</span> <span class="n">default</span>
<span class="o">-</span><span class="mi">3</span>         <span class="mf">0.63660</span>      <span class="n">host</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span>
 <span class="mi">0</span>    <span class="n">ssd</span>  <span class="mf">0.63660</span>          <span class="n">osd</span><span class="mf">.0</span>            <span class="n">up</span>   <span class="mf">1.00000</span>  <span class="mf">1.00000</span>
</pre></div>
</div>
<p>请注意，现在只有一个OSD运行，不满足配置中要求3个副本的要求，我们需要添加OSD节点</p>
</section>
</section>
</section>
<section id="id2">
<h2>重启操作系统验证<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>重启操作系统 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">shutdown</span> <span class="pre">-r</span> <span class="pre">now</span></code></p>
<ul>
<li><p>启动后检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
</li>
</ul>
<p>发现服务启动，但是OSD空间是0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="p">:</span>
  <span class="nb">id</span><span class="p">:</span>     <span class="mi">39392603</span><span class="o">-</span><span class="n">fe09</span><span class="o">-</span><span class="mi">4441</span><span class="o">-</span><span class="n">acce</span><span class="o">-</span><span class="mi">1</span><span class="n">eb22b1391e1</span>
  <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
          <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span>
          <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">mon</span><span class="p">:</span> <span class="mi">1</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">age</span> <span class="mi">4</span><span class="n">m</span><span class="p">)</span>
  <span class="n">mgr</span><span class="p">:</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="mi">3</span><span class="n">m</span><span class="p">)</span>
  <span class="n">osd</span><span class="p">:</span> <span class="mi">1</span> <span class="n">osds</span><span class="p">:</span> <span class="mi">1</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="mi">45</span><span class="n">m</span><span class="p">),</span> <span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="n">since</span> <span class="mi">45</span><span class="n">m</span><span class="p">)</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">pools</span><span class="p">:</span>   <span class="mi">1</span> <span class="n">pools</span><span class="p">,</span> <span class="mi">1</span> <span class="n">pgs</span>
  <span class="n">objects</span><span class="p">:</span> <span class="mi">0</span> <span class="n">objects</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span>
  <span class="n">usage</span><span class="p">:</span>   <span class="mi">0</span> <span class="n">B</span> <span class="n">used</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span> <span class="o">/</span> <span class="mi">0</span> <span class="n">B</span> <span class="n">avail</span>
  <span class="n">pgs</span><span class="p">:</span>     <span class="mf">100.000</span><span class="o">%</span> <span class="n">pgs</span> <span class="n">unknown</span>
          <span class="mi">1</span> <span class="n">unknown</span>
</pre></div>
</div>
<p>也即是 OSD没有启动成功</p>
<section id="osd">
<h3>重新激活OSD<a class="headerlink" href="#osd" title="永久链接至标题">¶</a></h3>
<p>为何重启系统之前已经配置成功的OSD无法启动呢？</p>
<ul>
<li><p>检查OSD服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mi">0</span><span class="o">-</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● ceph-osd@0-service.service - Ceph object storage daemon osd.0-service
     Loaded: loaded (/lib/systemd/system/ceph-osd@.service; disabled; vendor preset: enabled)
     Active: inactive (dead)
</pre></div>
</div>
<ul>
<li><p>尝试启动 OSD服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
<p>提示失败:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Job</span> <span class="k">for</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span> <span class="n">failed</span> <span class="n">because</span> <span class="n">the</span> <span class="n">control</span> <span class="n">process</span> <span class="n">exited</span> <span class="k">with</span> <span class="n">error</span> <span class="n">code</span><span class="o">.</span>
<span class="n">See</span> <span class="s2">&quot;systemctl status ceph-osd@0.service&quot;</span> <span class="ow">and</span> <span class="s2">&quot;journalctl -xe&quot;</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
</pre></div>
</div>
<p>检查 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">ceph-osd&#64;0.service</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● ceph-osd@0.service - Ceph object storage daemon osd.0
     Loaded: loaded (/lib/systemd/system/ceph-osd@.service; enabled; vendor preset: enabled)
     Active: failed (Result: exit-code) since Mon 2021-11-29 23:26:58 CST; 24min ago
    Process: 968 ExecStartPre=/usr/lib/ceph/ceph-osd-prestart.sh --cluster ${CLUSTER} --id 0 (code=exited, status=0/SUCCESS)
    Process: 983 ExecStart=/usr/bin/ceph-osd -f --cluster ${CLUSTER} --id 0 --setuser ceph --setgroup ceph (code=exited, status=1/FAILURE)
   Main PID: 983 (code=exited, status=1/FAILURE)

Nov 29 23:26:58 z-b-data-1 systemd[1]: Failed to start Ceph object storage daemon osd.0.
Nov 29 23:35:32 z-b-data-1 systemd[1]: ceph-osd@0.service: Start request repeated too quickly.
Nov 29 23:35:32 z-b-data-1 systemd[1]: ceph-osd@0.service: Failed with result &#39;exit-code&#39;.
Nov 29 23:35:32 z-b-data-1 systemd[1]: Failed to start Ceph object storage daemon osd.0.
Nov 29 23:36:06 z-b-data-1 systemd[1]: ceph-osd@0.service: Start request repeated too quickly.
Nov 29 23:36:06 z-b-data-1 systemd[1]: ceph-osd@0.service: Failed with result &#39;exit-code&#39;.
Nov 29 23:36:06 z-b-data-1 systemd[1]: Failed to start Ceph object storage daemon osd.0.
Nov 29 23:50:17 z-b-data-1 systemd[1]: ceph-osd@0.service: Start request repeated too quickly.
Nov 29 23:50:17 z-b-data-1 systemd[1]: ceph-osd@0.service: Failed with result &#39;exit-code&#39;.
Nov 29 23:50:17 z-b-data-1 systemd[1]: Failed to start Ceph object storage daemon osd.0.
</pre></div>
</div>
<ul>
<li><p>查看 <code class="docutils literal notranslate"><span class="pre">inventory</span></code> 输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">inventory</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Device</span> <span class="n">Path</span>               <span class="n">Size</span>         <span class="n">rotates</span> <span class="n">available</span> <span class="n">Model</span> <span class="n">name</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span>              <span class="mf">953.87</span> <span class="n">GB</span>    <span class="kc">False</span>   <span class="kc">True</span>      <span class="n">SAMSUNG</span> <span class="n">MZVL21T0HCLR</span><span class="o">-</span><span class="mi">00</span><span class="n">B00</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda</span>                  <span class="mf">6.00</span> <span class="n">GB</span>      <span class="kc">True</span>    <span class="kc">False</span>
</pre></div>
</div>
<p>检查详情输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">inventory</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span>
</pre></div>
</div>
<p>可以看到报告:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">======</span> <span class="n">Device</span> <span class="n">report</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="o">======</span>

     <span class="n">path</span>                      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span>
     <span class="n">lsm</span> <span class="n">data</span>                  <span class="p">{}</span>
     <span class="n">available</span>                 <span class="kc">True</span>
     <span class="n">rejected</span> <span class="n">reasons</span>
     <span class="n">device</span> <span class="nb">id</span>                 <span class="n">SAMSUNG</span> <span class="n">MZVL21T0HCLR</span><span class="o">-</span><span class="mi">00</span><span class="n">B00_S676NF0R908202</span>
     <span class="n">removable</span>                 <span class="mi">0</span>
     <span class="n">ro</span>                        <span class="mi">0</span>
     <span class="n">vendor</span>
     <span class="n">model</span>                     <span class="n">SAMSUNG</span> <span class="n">MZVL21T0HCLR</span><span class="o">-</span><span class="mi">00</span><span class="n">B00</span>
     <span class="n">sas</span> <span class="n">address</span>
     <span class="n">rotational</span>                <span class="mi">0</span>
     <span class="n">scheduler</span> <span class="n">mode</span>            <span class="n">none</span>
     <span class="n">human</span> <span class="n">readable</span> <span class="n">size</span>       <span class="mf">953.87</span> <span class="n">GB</span>
</pre></div>
</div>
<ul>
<li><p>检查分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">inventory</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示 <code class="docutils literal notranslate"><span class="pre">inventory</span></code> 这个分区被拒绝，原因是已经具备了BlueStore设备标签:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">======</span> <span class="n">Device</span> <span class="n">report</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="o">======</span>

     <span class="n">path</span>                      <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
     <span class="n">lsm</span> <span class="n">data</span>                  <span class="p">{}</span>
     <span class="n">available</span>                 <span class="kc">False</span>
     <span class="n">rejected</span> <span class="n">reasons</span>          <span class="n">Has</span> <span class="n">BlueStore</span> <span class="n">device</span> <span class="n">label</span>
     <span class="n">device</span> <span class="nb">id</span>                 <span class="n">SAMSUNG</span> <span class="n">MZVL21T0HCLR</span><span class="o">-</span><span class="mi">00</span><span class="n">B00_S676NF0R908202</span>
     <span class="n">human</span> <span class="n">readable</span> <span class="n">size</span>       <span class="mf">651.92</span> <span class="n">GB</span>
</pre></div>
</div>
<ul class="simple">
<li><p>我发现 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0/</span></code> 目录完全是空的，之前的 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">prepare</span> <span class="pre">--data</span> <span class="pre">/dev/nvme0n1p1</span></code> 执行完成后，这个目录已经具备了初始化的内容，为何重启之后就丢失了呢？</p></li>
</ul>
<p>参考 <a class="reference external" href="https://docs.ceph.com/en/latest/ceph-volume/simple/systemd/">ceph systmed帮助</a> 可以看到， <code class="docutils literal notranslate"><span class="pre">systemd</span></code> 在启动时候，会检查 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/osd/{id}-{uuid}.json</span></code> 配置文件加载相对应的systemd unit的实例名称，然后根据对应的卷使用 OSD 目标转换处理挂载，也就是 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/{cluster</span> <span class="pre">name}-{osd</span> <span class="pre">id}</span></code> 挂载，即 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> (第一个OSD)。一旦进程处理完毕，就会调用启动OSD，即 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">ceph-osd&#64;0</span></code> 。</p>
<p>我检查发现我的服务器上没有 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/osd/</span></code> 目录，也就是说我之前的步骤动态激活了 OSD，但是没有创建 json 格式的配置文件，导致再次启动时 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> 无法读取配置来尊卑实例以及对应目录挂载，所以也就无法启动OSD。</p>
<ul>
<li><p>可以从 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">list</span></code> 获得json格式设备文件，输出到对应配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/osd/0-8d889fc0-110c-45fa-a259-6a876183bc46.json</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ceph_fsid&quot;</span><span class="p">:</span> <span class="s2">&quot;39392603-fe09-4441-acce-1eb22b1391e1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/nvme0n1p1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;osd_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;osd_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;8d889fc0-110c-45fa-a259-6a876183bc46&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bluestore&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>从文档看 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">simple</span> <span class="pre">activate</span></code> 可以激活已经构建过的OSD，所以我尝试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">simple</span> <span class="n">activate</span> <span class="p">{</span><span class="n">ID</span><span class="p">}</span> <span class="p">{</span><span class="n">FSID</span><span class="p">}</span>
</pre></div>
</div>
<p>或:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">simple</span> <span class="n">activate</span> <span class="o">--</span><span class="n">file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="p">{</span><span class="n">ID</span><span class="p">}</span><span class="o">-</span><span class="p">{</span><span class="n">FSID</span><span class="p">}</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>按照帮助提示，首先 <code class="docutils literal notranslate"><span class="pre">scan</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">simple</span> <span class="n">scan</span>
</pre></div>
</div>
<p>然后执行激活:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">simple</span> <span class="n">activate</span> <span class="o">--</span><span class="nb">all</span>
</pre></div>
</div>
<p>这里提示错误，显示确实根据 <code class="docutils literal notranslate"><span class="pre">--all</span></code> 参数去激活所有 <code class="docutils literal notranslate"><span class="pre">*.json</span></code> 文件，但是:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--&gt;</span> <span class="n">activating</span> <span class="n">OSD</span> <span class="n">specified</span> <span class="ow">in</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="mi">0</span><span class="o">-</span><span class="mi">8</span><span class="n">d889fc0</span><span class="o">-</span><span class="mi">110</span><span class="n">c</span><span class="o">-</span><span class="mi">45</span><span class="n">fa</span><span class="o">-</span><span class="n">a259</span><span class="o">-</span><span class="mi">6</span><span class="n">a876183bc46</span><span class="o">.</span><span class="n">json</span>
<span class="o">--&gt;</span> <span class="n">Required</span> <span class="n">devices</span> <span class="p">(</span><span class="n">block</span> <span class="ow">and</span> <span class="n">data</span><span class="p">)</span> <span class="ow">not</span> <span class="n">present</span> <span class="k">for</span> <span class="n">bluestore</span>
<span class="o">--&gt;</span> <span class="n">bluestore</span> <span class="n">devices</span> <span class="n">found</span><span class="p">:</span> <span class="p">[]</span>
<span class="o">--&gt;</span>  <span class="ne">AttributeError</span><span class="p">:</span> <span class="s1">&#39;RuntimeError&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;message&#39;</span>
</pre></div>
</div>
<ul>
<li><p>检查详情:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span> <span class="n">detail</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HEALTH_WARN</span> <span class="mi">1</span> <span class="n">osds</span> <span class="n">down</span><span class="p">;</span> <span class="mi">1</span> <span class="n">host</span> <span class="p">(</span><span class="mi">1</span> <span class="n">osds</span><span class="p">)</span> <span class="n">down</span><span class="p">;</span> <span class="mi">1</span> <span class="n">root</span> <span class="p">(</span><span class="mi">1</span> <span class="n">osds</span><span class="p">)</span> <span class="n">down</span><span class="p">;</span> <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span><span class="p">;</span> <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>
<span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">OSD_DOWN</span><span class="p">:</span> <span class="mi">1</span> <span class="n">osds</span> <span class="n">down</span>
    <span class="n">osd</span><span class="mf">.0</span> <span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">default</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="n">down</span>
<span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">OSD_HOST_DOWN</span><span class="p">:</span> <span class="mi">1</span> <span class="n">host</span> <span class="p">(</span><span class="mi">1</span> <span class="n">osds</span><span class="p">)</span> <span class="n">down</span>
    <span class="n">host</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">default</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="n">osds</span><span class="p">)</span> <span class="ow">is</span> <span class="n">down</span>
<span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">OSD_ROOT_DOWN</span><span class="p">:</span> <span class="mi">1</span> <span class="n">root</span> <span class="p">(</span><span class="mi">1</span> <span class="n">osds</span><span class="p">)</span> <span class="n">down</span>
    <span class="n">root</span> <span class="n">default</span> <span class="p">(</span><span class="mi">1</span> <span class="n">osds</span><span class="p">)</span> <span class="ow">is</span> <span class="n">down</span>
<span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">PG_AVAILABILITY</span><span class="p">:</span> <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span>
    <span class="n">pg</span> <span class="mf">1.0</span> <span class="ow">is</span> <span class="n">stuck</span> <span class="n">inactive</span> <span class="k">for</span> <span class="mi">3</span><span class="n">h</span><span class="p">,</span> <span class="n">current</span> <span class="n">state</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">last</span> <span class="n">acting</span> <span class="p">[]</span>
<span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">TOO_FEW_OSDS</span><span class="p">:</span> <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>
</pre></div>
</div>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">osd</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
</pre></div>
</div>
</li>
</ul>
<p>显示状态down:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span>  <span class="n">CLASS</span>  <span class="n">WEIGHT</span>   <span class="n">TYPE</span> <span class="n">NAME</span>            <span class="n">STATUS</span>  <span class="n">REWEIGHT</span>  <span class="n">PRI</span><span class="o">-</span><span class="n">AFF</span>
<span class="o">-</span><span class="mi">1</span>         <span class="mf">0.63660</span>  <span class="n">root</span> <span class="n">default</span>
<span class="o">-</span><span class="mi">3</span>         <span class="mf">0.63660</span>      <span class="n">host</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span>
 <span class="mi">0</span>    <span class="n">ssd</span>  <span class="mf">0.63660</span>          <span class="n">osd</span><span class="mf">.0</span>          <span class="n">down</span>   <span class="mf">1.00000</span>  <span class="mf">1.00000</span>
</pre></div>
</div>
<ul>
<li><p>我检查了之前 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">prepare</span> <span class="pre">--bluestore</span> <span class="pre">--data</span> <span class="pre">/dev/nvme0n1p1</span></code> 输出记录，发现其中有将设备文件设置为 <code class="docutils literal notranslate"><span class="pre">ceph</span></code> 用户的步骤:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">ceph</span><span class="p">:</span><span class="n">ceph</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<p>但是我发现服务器重启之后，这个设备文件恢复回root用户:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brw</span><span class="o">-</span><span class="n">rw</span><span class="o">----</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">disk</span> <span class="mi">259</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">16</span><span class="p">:</span><span class="mi">05</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
<p>我重试 <a class="reference internal" href="../../../linux/redhat_linux/systemd/udev.html#udev"><span class="std std-ref">Linux udev管理设备</span></a> 设置正确的ownership，但是重启系统依然没有正确启动OSD。</p>
</section>
</section>
<section id="id3">
<h2>重新开始<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>由于解决不了问题，我参考 <a class="reference external" href="https://docs.ceph.com/en/latest/rados/operations/add-or-rm-osds/">Adding/Removing OSDs</a> 删除掉osd，然后重新开始:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">stop</span> <span class="mi">0</span>
<span class="n">sudo</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">purge</span> <span class="mi">0</span> <span class="o">--</span><span class="n">yes</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">really</span><span class="o">-</span><span class="n">mean</span><span class="o">-</span><span class="n">it</span>
</pre></div>
</div>
<p>此时:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
</pre></div>
</div>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span>  <span class="n">CLASS</span>  <span class="n">WEIGHT</span>  <span class="n">TYPE</span> <span class="n">NAME</span>            <span class="n">STATUS</span>  <span class="n">REWEIGHT</span>  <span class="n">PRI</span><span class="o">-</span><span class="n">AFF</span>
<span class="o">-</span><span class="mi">1</span>              <span class="mi">0</span>  <span class="n">root</span> <span class="n">default</span>
<span class="o">-</span><span class="mi">3</span>              <span class="mi">0</span>      <span class="n">host</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>已经没有了 <code class="docutils literal notranslate"><span class="pre">osd.0</span></code></p>
<ul>
<li><p>重新创建OSD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">prepare</span> <span class="o">--</span><span class="n">bluestore</span> <span class="o">--</span><span class="n">data</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<p>但是非常奇怪的报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">osd</span> <span class="o">--</span><span class="n">cluster</span> <span class="n">ceph</span> <span class="o">--</span><span class="n">osd</span><span class="o">-</span><span class="n">objectstore</span> <span class="n">bluestore</span> <span class="o">--</span><span class="n">mkfs</span> <span class="o">-</span><span class="n">i</span> <span class="mi">0</span> <span class="o">--</span><span class="n">monmap</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">activate</span><span class="o">.</span><span class="n">monmap</span> <span class="o">--</span><span class="n">keyfile</span> <span class="o">-</span> <span class="o">--</span><span class="n">osd</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span> <span class="o">--</span><span class="n">osd</span><span class="o">-</span><span class="n">uuid</span> <span class="n">e4725c90</span><span class="o">-</span><span class="mi">9</span><span class="n">f08</span><span class="o">-</span><span class="mi">45</span><span class="n">fd</span><span class="o">-</span><span class="n">b063</span><span class="o">-</span><span class="mi">5807</span><span class="n">cc84e992</span> <span class="o">--</span><span class="n">setuser</span> <span class="n">ceph</span> <span class="o">--</span><span class="n">setgroup</span> <span class="n">ceph</span>
<span class="n">stderr</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mf">15.364</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f0464d78d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">bluestore</span><span class="p">(</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="p">)</span> <span class="n">_open_fsid</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="n">stderr</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mf">15.364</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f0464d78d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">bluestore</span><span class="p">(</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="p">)</span> <span class="n">mkfs</span> <span class="n">fsck</span> <span class="n">found</span> <span class="n">fatal</span> <span class="n">error</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="n">stderr</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mf">15.364</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f0464d78d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">OSD</span><span class="p">::</span><span class="n">mkfs</span><span class="p">:</span> <span class="n">ObjectStore</span><span class="p">::</span><span class="n">mkfs</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">error</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="n">stderr</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T17</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mf">15.364</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f0464d78d80</span> <span class="o">-</span><span class="mi">1</span>  <span class="o">**</span> <span class="n">ERROR</span><span class="p">:</span> <span class="n">error</span> <span class="n">creating</span> <span class="n">empty</span> <span class="nb">object</span> <span class="n">store</span> <span class="ow">in</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="o">--&gt;</span> <span class="n">Was</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">complete</span> <span class="n">a</span> <span class="n">new</span> <span class="n">OSD</span><span class="p">,</span> <span class="n">will</span> <span class="n">rollback</span> <span class="n">changes</span>
<span class="o">...</span>
</pre></div>
</div>
<p>似乎是因为没有清理么？</p>
<ul>
<li><p>增加一个清理分区前10M空间的命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="n">M</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span> <span class="n">conv</span><span class="o">=</span><span class="n">fsync</span>
</pre></div>
</div>
</li>
</ul>
<p>果然，重启系统后再次尝试创建OSD就能够正常完成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">prepare</span> <span class="o">--</span><span class="n">bluestore</span> <span class="o">--</span><span class="n">data</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
<ul>
<li><p>完成后检查 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0/</span></code> 可以看到以下内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="mi">48</span><span class="n">K</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span> <span class="mi">206</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">activate</span><span class="o">.</span><span class="n">monmap</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">14</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">block</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">2</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">bluefs</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">37</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">ceph_fsid</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">37</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">fsid</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">56</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">keyring</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">8</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">kv_backend</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">21</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">magic</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">4</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">mkfs_done</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">41</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">osd_key</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">6</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">ready</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">10</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="nb">type</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">2</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">20</span><span class="p">:</span><span class="mi">42</span> <span class="n">whoami</span>
</pre></div>
</div>
</li>
</ul>
<p>并且这个 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 已经挂载成 <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> ，通过 <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">-h</span></code> 检查可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tmpfs</span>           <span class="mf">7.9</span><span class="n">G</span>   <span class="mi">48</span><span class="n">K</span>  <span class="mf">7.9</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span>
</pre></div>
</div>
<ul>
<li><p>注意此时只是完成磁盘初始化，尚未激活，所以:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
</li>
</ul>
<p>看到如下输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="p">:</span>
  <span class="nb">id</span><span class="p">:</span>     <span class="mi">39392603</span><span class="o">-</span><span class="n">fe09</span><span class="o">-</span><span class="mi">4441</span><span class="o">-</span><span class="n">acce</span><span class="o">-</span><span class="mi">1</span><span class="n">eb22b1391e1</span>
  <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
          <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span>
          <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>

<span class="n">services</span><span class="p">:</span>
  <span class="n">mon</span><span class="p">:</span> <span class="mi">1</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">age</span> <span class="mi">5</span><span class="n">m</span><span class="p">)</span>
  <span class="n">mgr</span><span class="p">:</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="mi">4</span><span class="n">m</span><span class="p">)</span>
  <span class="n">osd</span><span class="p">:</span> <span class="mi">1</span> <span class="n">osds</span><span class="p">:</span> <span class="mi">0</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="mi">20</span><span class="n">h</span><span class="p">),</span> <span class="mi">0</span> <span class="ow">in</span> <span class="p">(</span><span class="n">since</span> <span class="mi">3</span><span class="n">h</span><span class="p">)</span>

<span class="n">data</span><span class="p">:</span>
  <span class="n">pools</span><span class="p">:</span>   <span class="mi">1</span> <span class="n">pools</span><span class="p">,</span> <span class="mi">1</span> <span class="n">pgs</span>
  <span class="n">objects</span><span class="p">:</span> <span class="mi">0</span> <span class="n">objects</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span>
  <span class="n">usage</span><span class="p">:</span>   <span class="mi">0</span> <span class="n">B</span> <span class="n">used</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span> <span class="o">/</span> <span class="mi">0</span> <span class="n">B</span> <span class="n">avail</span>
  <span class="n">pgs</span><span class="p">:</span>     <span class="mf">100.000</span><span class="o">%</span> <span class="n">pgs</span> <span class="n">unknown</span>
           <span class="mi">1</span> <span class="n">unknown</span>
</pre></div>
</div>
<ul>
<li><p>检查设备文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="nb">list</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ceph_fsid&quot;</span><span class="p">:</span> <span class="s2">&quot;39392603-fe09-4441-acce-1eb22b1391e1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/nvme0n1p1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;osd_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;osd_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;4f6f2db9-894a-455c-bdaf-f3324ab5efe1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bluestore&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意重新格式化之后 <code class="docutils literal notranslate"><span class="pre">osd_uuid</span></code> 是变化的</p>
<ul>
<li><p>激活磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">activate</span> <span class="o">--</span><span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<p>此时提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--&gt;</span> <span class="n">systemd</span> <span class="n">support</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">implemented</span>
</pre></div>
</div>
<ul>
<li><p>启动 systemd 的 <code class="docutils literal notranslate"><span class="pre">ceph-osd&#64;0.service</span></code> 服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
<li><p>检查服务状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
<p>状态如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● ceph-osd@0.service - Ceph object storage daemon osd.0
     Loaded: loaded (/lib/systemd/system/ceph-osd@.service; disabled; vendor preset: enabled)
     Active: active (running) since Tue 2021-11-30 20:52:51 CST; 5s ago
    Process: 1390 ExecStartPre=/usr/lib/ceph/ceph-osd-prestart.sh --cluster ${CLUSTER} --id 0 (code=exited, status=0/SUCCESS)
   Main PID: 1403 (ceph-osd)
      Tasks: 69
     Memory: 26.3M
     CGroup: /system.slice/system-ceph\x2dosd.slice/ceph-osd@0.service
             └─1403 /usr/bin/ceph-osd -f --cluster ceph --id 0 --setuser ceph --setgroup ceph

Nov 30 20:52:51 z-b-data-1 systemd[1]: Starting Ceph object storage daemon osd.0...
Nov 30 20:52:51 z-b-data-1 systemd[1]: Started Ceph object storage daemon osd.0.
Nov 30 20:52:51 z-b-data-1 ceph-osd[1403]: 2021-11-30T20:52:51.712+0800 7f7ea0ba8d80 -1 Falling back to public interface
Nov 30 20:52:52 z-b-data-1 ceph-osd[1403]: 2021-11-30T20:52:52.392+0800 7f7ea0ba8d80 -1 osd.0 0 log_to_monitors {default=true}
Nov 30 20:52:53 z-b-data-1 ceph-osd[1403]: 2021-11-30T20:52:53.840+0800 7f7e92c93700 -1 osd.0 0 waiting for initial osdmap
Nov 30 20:52:53 z-b-data-1 ceph-osd[1403]: 2021-11-30T20:52:53.896+0800 7f7e9a0ea700 -1 osd.0 111 set_numa_affinity unable to identify public interface &#39;&#39; numa node: (2) No such file or directory
</pre></div>
</div>
<ul>
<li><p>按照 <a class="reference external" href="https://docs.ceph.com/en/latest/ceph-volume/simple/systemd/">ceph systmed帮助</a> 文档，可以知道只要已经完成磁盘挂载，则启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd&#64;0.service</span></code> 就会激活磁盘(应该不需要手工 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">active</span></code> )。此时检查集群状态可以看到第一个OSD已经激活启用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="p">:</span>
  <span class="nb">id</span><span class="p">:</span>     <span class="mi">39392603</span><span class="o">-</span><span class="n">fe09</span><span class="o">-</span><span class="mi">4441</span><span class="o">-</span><span class="n">acce</span><span class="o">-</span><span class="mi">1</span><span class="n">eb22b1391e1</span>
  <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
          <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span>
          <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>

<span class="n">services</span><span class="p">:</span>
  <span class="n">mon</span><span class="p">:</span> <span class="mi">1</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">age</span> <span class="mi">13</span><span class="n">m</span><span class="p">)</span>
  <span class="n">mgr</span><span class="p">:</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="mi">13</span><span class="n">m</span><span class="p">)</span>
  <span class="n">osd</span><span class="p">:</span> <span class="mi">1</span> <span class="n">osds</span><span class="p">:</span> <span class="mi">1</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="mi">83</span><span class="n">s</span><span class="p">),</span> <span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="n">since</span> <span class="mi">83</span><span class="n">s</span><span class="p">)</span>

<span class="n">data</span><span class="p">:</span>
  <span class="n">pools</span><span class="p">:</span>   <span class="mi">1</span> <span class="n">pools</span><span class="p">,</span> <span class="mi">1</span> <span class="n">pgs</span>
  <span class="n">objects</span><span class="p">:</span> <span class="mi">0</span> <span class="n">objects</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span>
  <span class="n">usage</span><span class="p">:</span>   <span class="mf">1.0</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="mi">651</span> <span class="n">GiB</span> <span class="o">/</span> <span class="mi">652</span> <span class="n">GiB</span> <span class="n">avail</span>
  <span class="n">pgs</span><span class="p">:</span>     <span class="mf">100.000</span><span class="o">%</span> <span class="n">pgs</span> <span class="n">unknown</span>
           <span class="mi">1</span> <span class="n">unknown</span>
</pre></div>
</div>
<ul>
<li><p>激活系统启动时启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
<li><p>(这步应该不需要)参考 <a class="reference external" href="https://docs.ceph.com/en/latest/rados/configuration/osd-config-ref/">OSD Config Reference</a> 最小化的配置，在 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/ceph.conf</span></code> 添加OSD Daemon配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">osd</span><span class="mf">.0</span><span class="p">]</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/ceph.conf</span></code> 中添加 <code class="docutils literal notranslate"><span class="pre">osd.0</span></code> 配置可能是非常关键的一步，我第二次执行操作多增加了这步，然后重启服务器就能够正常启动所有服务，包括OSD也能正常启动</p>
</div>
<p>然后 <code class="docutils literal notranslate"><span class="pre">重启操作系统</span></code> 验证:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
<p>如我所料，这次重启操作系统后，可以看到已经正常激活OSD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="p">:</span>
  <span class="nb">id</span><span class="p">:</span>     <span class="mi">39392603</span><span class="o">-</span><span class="n">fe09</span><span class="o">-</span><span class="mi">4441</span><span class="o">-</span><span class="n">acce</span><span class="o">-</span><span class="mi">1</span><span class="n">eb22b1391e1</span>
  <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
          <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="mi">1</span> <span class="n">pg</span> <span class="n">inactive</span>
          <span class="n">OSD</span> <span class="n">count</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="mi">3</span>

<span class="n">services</span><span class="p">:</span>
  <span class="n">mon</span><span class="p">:</span> <span class="mi">1</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">age</span> <span class="mi">4</span><span class="n">m</span><span class="p">)</span>
  <span class="n">mgr</span><span class="p">:</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="mi">4</span><span class="n">m</span><span class="p">)</span>
  <span class="n">osd</span><span class="p">:</span> <span class="mi">1</span> <span class="n">osds</span><span class="p">:</span> <span class="mi">1</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="mi">29</span><span class="n">m</span><span class="p">),</span> <span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="n">since</span> <span class="mi">29</span><span class="n">m</span><span class="p">)</span>

<span class="n">data</span><span class="p">:</span>
  <span class="n">pools</span><span class="p">:</span>   <span class="mi">1</span> <span class="n">pools</span><span class="p">,</span> <span class="mi">1</span> <span class="n">pgs</span>
  <span class="n">objects</span><span class="p">:</span> <span class="mi">0</span> <span class="n">objects</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span>
  <span class="n">usage</span><span class="p">:</span>   <span class="mi">0</span> <span class="n">B</span> <span class="n">used</span><span class="p">,</span> <span class="mi">0</span> <span class="n">B</span> <span class="o">/</span> <span class="mi">0</span> <span class="n">B</span> <span class="n">avail</span>
  <span class="n">pgs</span><span class="p">:</span>     <span class="mf">100.000</span><span class="o">%</span> <span class="n">pgs</span> <span class="n">unknown</span>
           <span class="mi">1</span> <span class="n">unknown</span>
</pre></div>
</div>
<p>但是，发现 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">ceph-osd&#64;0</span></code> 是失败的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● ceph-osd@0.service - Ceph object storage daemon osd.0
     Loaded: loaded (/lib/systemd/system/ceph-osd@.service; enabled; vendor preset: enabled)
     Active: failed (Result: exit-code) since Tue 2021-11-30 21:18:06 CST; 4min 2s ago
    Process: 966 ExecStartPre=/usr/lib/ceph/ceph-osd-prestart.sh --cluster ${CLUSTER} --id 0 (code=exited, status=0/SUCCESS)
    Process: 987 ExecStart=/usr/bin/ceph-osd -f --cluster ${CLUSTER} --id 0 --setuser ceph --setgroup ceph (code=exited, status=1/FAILURE)
   Main PID: 987 (code=exited, status=1/FAILURE)

Nov 30 21:18:06 z-b-data-1 systemd[1]: ceph-osd@0.service: Scheduled restart job, restart counter is at 3.
Nov 30 21:18:06 z-b-data-1 systemd[1]: Stopped Ceph object storage daemon osd.0.
Nov 30 21:18:06 z-b-data-1 systemd[1]: ceph-osd@0.service: Start request repeated too quickly.
Nov 30 21:18:06 z-b-data-1 systemd[1]: ceph-osd@0.service: Failed with result &#39;exit-code&#39;.
Nov 30 21:18:06 z-b-data-1 systemd[1]: Failed to start Ceph object storage daemon osd.0.
</pre></div>
</div>
<p>我发现一个奇怪的问题，就是虽然 <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">-s</span></code> 显示OSD已经激活，但实际上系统中根本没有 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> 进程，在 <code class="docutils literal notranslate"><span class="pre">/var/run/ceph</span></code> 目录下也没有osd对应的socket。这说明 osd 实际没有启动。但是 <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">-s</span></code> 始终显示 <code class="docutils literal notranslate"><span class="pre">osd</span></code> 是正常up</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span>  <span class="n">CLASS</span>  <span class="n">WEIGHT</span>   <span class="n">TYPE</span> <span class="n">NAME</span>            <span class="n">STATUS</span>  <span class="n">REWEIGHT</span>  <span class="n">PRI</span><span class="o">-</span><span class="n">AFF</span>
<span class="o">-</span><span class="mi">1</span>         <span class="mf">0.63660</span>  <span class="n">root</span> <span class="n">default</span>
<span class="o">-</span><span class="mi">3</span>         <span class="mf">0.63660</span>      <span class="n">host</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span>
 <span class="mi">0</span>    <span class="n">ssd</span>  <span class="mf">0.63660</span>          <span class="n">osd</span><span class="mf">.0</span>            <span class="n">up</span>   <span class="mf">1.00000</span>  <span class="mf">1.00000</span>
</pre></div>
</div>
<p>从监控页面显示也是 OSDs : <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">total:</span> <span class="pre">1</span> <span class="pre">up,</span> <span class="pre">1</span> <span class="pre">in</span></code></p>
<p>但是显然 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">ceph-osd&#64;0.service</span></code> 状态表明启动失败:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Process: 983 ExecStart=/usr/bin/ceph-osd -f --cluster ${CLUSTER} --id 0 --setuser ceph --setgroup ceph (code=exited, status=1/FAILURE)
</pre></div>
</div>
<ul>
<li><p>手工执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">osd</span> <span class="o">-</span><span class="n">f</span> <span class="o">--</span><span class="n">cluster</span> <span class="n">ceph</span> <span class="o">--</span><span class="nb">id</span> <span class="mi">0</span> <span class="o">--</span><span class="n">setuser</span> <span class="n">ceph</span> <span class="o">--</span><span class="n">setgroup</span> <span class="n">ceph</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到错误原因:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">37.828</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f60db9f3d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">auth</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">keyring</span> <span class="n">on</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">keyring</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">37.828</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f60db9f3d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">AuthRegistry</span><span class="p">(</span><span class="mh">0x557f7fe96938</span><span class="p">)</span> <span class="n">no</span> <span class="n">keyring</span> <span class="n">found</span> <span class="n">at</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">keyring</span><span class="p">,</span> <span class="n">disabling</span> <span class="n">cephx</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">37.832</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f60db9f3d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">auth</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">keyring</span> <span class="n">on</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">keyring</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span><span class="n">T22</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">37.832</span><span class="o">+</span><span class="mi">0800</span> <span class="mi">7</span><span class="n">f60db9f3d80</span> <span class="o">-</span><span class="mi">1</span> <span class="n">AuthRegistry</span><span class="p">(</span><span class="mh">0x7fff676473f0</span><span class="p">)</span> <span class="n">no</span> <span class="n">keyring</span> <span class="n">found</span> <span class="n">at</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">keyring</span><span class="p">,</span> <span class="n">disabling</span> <span class="n">cephx</span>
<span class="n">failed</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">mon</span> <span class="n">config</span> <span class="p">(</span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">mon</span><span class="o">-</span><span class="n">config</span> <span class="n">to</span> <span class="n">skip</span><span class="p">)</span>
</pre></div>
</div>
<p>但是手工创建文件也不能解决( <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">prepare</span></code> 过程命令):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="n">authtool</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">keyring</span> <span class="o">--</span><span class="n">create</span><span class="o">-</span><span class="n">keyring</span> <span class="o">--</span><span class="n">name</span> <span class="n">osd</span><span class="mf">.0</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">key</span> <span class="n">AQA2yqRhes0wORAAttpUh5aRZsr1pLdHeXRezg</span><span class="o">==</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">ceph</span><span class="p">:</span><span class="n">ceph</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">keyring</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="n">block</span>
</pre></div>
</div>
<p>这个问题困扰了我两天，为何 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">prepare</span></code> 命令的子命令有:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">tmpfs</span> <span class="n">tmpfs</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span>
</pre></div>
</div>
<p>那么 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 岂不是一个内存中的存储，一旦重启数据就会丢失？ <code class="docutils literal notranslate"><span class="pre">keyring</span></code> 等文件在tmpfs中，是如何重启后继续存在的？</p>
<p><a class="reference external" href="http://lists.ceph.com/pipermail/ceph-users-ceph.com/2018-April/025914.html">how the files in /var/lib/ceph/osd/ceph-0 are generated</a> 讨论提到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bluestore</span> <span class="n">will</span> <span class="n">save</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">information</span> <span class="n">at</span> <span class="n">the</span> <span class="n">starting</span> <span class="n">of</span>
<span class="n">disk</span> <span class="p">(</span><span class="n">BDEV_LABEL_BLOCK_SIZE</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span>
<span class="n">this</span> <span class="n">area</span> <span class="ow">is</span> <span class="n">used</span> <span class="k">for</span> <span class="n">saving</span> <span class="n">labels</span><span class="p">,</span> <span class="n">including</span> <span class="n">keyring</span><span class="p">,</span> <span class="n">whoami</span> <span class="n">etc</span><span class="o">.</span>
</pre></div>
</div>
<p>通过以下命令检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">-</span><span class="n">bluestore</span><span class="o">-</span><span class="n">tool</span>  <span class="n">show</span><span class="o">-</span><span class="n">label</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span>
</pre></div>
</div>
<p>可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;/var/lib/ceph/osd/ceph-0/block&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;osd_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;d34a6c89-0c53-4378-ac43-108b47722abf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">699998928896</span><span class="p">,</span>
        <span class="s2">&quot;btime&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-30T23:35:24.910469+0800&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bfm_blocks&quot;</span><span class="p">:</span> <span class="s2">&quot;170898176&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bfm_blocks_per_key&quot;</span><span class="p">:</span> <span class="s2">&quot;128&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bfm_bytes_per_block&quot;</span><span class="p">:</span> <span class="s2">&quot;4096&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bfm_size&quot;</span><span class="p">:</span> <span class="s2">&quot;699998928896&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bluefs&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ceph_fsid&quot;</span><span class="p">:</span> <span class="s2">&quot;39392603-fe09-4441-acce-1eb22b1391e1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kv_backend&quot;</span><span class="p">:</span> <span class="s2">&quot;rocksdb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="s2">&quot;ceph osd volume v026&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mkfs_done&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;osd_key&quot;</span><span class="p">:</span> <span class="s2">&quot;AQC8RKZhuuYFCRAAAFhRXTyApcLIIsi1bZUxdA==&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ready&quot;</span><span class="p">:</span> <span class="s2">&quot;ready&quot;</span><span class="p">,</span>
        <span class="s2">&quot;require_osd_release&quot;</span><span class="p">:</span> <span class="s2">&quot;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;whoami&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>当挂载 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 时，ceph会dump这些内容到tmpfs目录。</p>
<p>根据之前 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">activate</span></code> 可以看到 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 挂载了 <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> 并获得了所有必须的 <code class="docutils literal notranslate"><span class="pre">keyring</span></code> 等文件，然后才能正确 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">ceph-osd&#64;0.service</span></code> 。也就是说，能够正常启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> 进程的前提条件是 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 目录正确挂载( <code class="docutils literal notranslate"><span class="pre">activate</span></code> )。操作系统重启，没有正确挂载和准备好这个目录，是导致无法启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> 的原因，那么是在哪里完成这个启动挂载配置呢？</p>
<p>应该有一个 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/osd/xxxx.json</span></code> 配置提供了ceph启动时准备好目录挂载，这样就能正确启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd&#64;0.service</span></code> …</p>
<p><a class="reference external" href="http://lists.ceph.com/pipermail/ceph-users-ceph.com/2018-April/025914.html">how the files in /var/lib/ceph/osd/ceph-0 are generated</a> 讨论，有人回答了这个准备 <code class="docutils literal notranslate"><span class="pre">osd</span></code> 目录的工具命令是 <code class="docutils literal notranslate"><span class="pre">ceph-bluestore-tool</span> <span class="pre">prime-osd-dir</span></code> ，可以重新创建所有的文件正确指向OSD block设备，所以我执行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">bluestore</span><span class="o">-</span><span class="n">tool</span> <span class="n">prime</span><span class="o">-</span><span class="n">osd</span><span class="o">-</span><span class="nb">dir</span> <span class="o">--</span><span class="n">dev</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span>
</pre></div>
</div>
<p>但是，上述命令只传递了部分文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="mi">24</span><span class="n">K</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">37</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span> <span class="n">ceph_fsid</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">37</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span> <span class="n">fsid</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">55</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span> <span class="n">keyring</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">6</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span> <span class="n">ready</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">10</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span> <span class="nb">type</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">2</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">10</span><span class="p">:</span><span class="mi">07</span> <span class="n">whoami</span>
</pre></div>
</div>
<p>完成后检查就可以看到 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ls</span> <span class="pre">-lh</span> <span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 终于出现了正确挂载 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 的 <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> 文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="mi">52</span><span class="n">K</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span> <span class="mi">206</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">activate</span><span class="o">.</span><span class="n">monmap</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">14</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">block</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">2</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">bluefs</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">37</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">08</span><span class="p">:</span><span class="mi">47</span> <span class="n">ceph_fsid</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">37</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">08</span><span class="p">:</span><span class="mi">47</span> <span class="n">fsid</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">55</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">08</span><span class="p">:</span><span class="mi">47</span> <span class="n">keyring</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">8</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">kv_backend</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">21</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">magic</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">4</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">mkfs_done</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">41</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span> <span class="n">osd_key</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">6</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">08</span><span class="p">:</span><span class="mi">47</span> <span class="n">ready</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">3</span> <span class="n">Nov</span> <span class="mi">30</span> <span class="mi">23</span><span class="p">:</span><span class="mi">40</span> <span class="n">require_osd_release</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>  <span class="mi">10</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">08</span><span class="p">:</span><span class="mi">47</span> <span class="nb">type</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">ceph</span> <span class="n">ceph</span>   <span class="mi">2</span> <span class="n">Dec</span>  <span class="mi">1</span> <span class="mi">08</span><span class="p">:</span><span class="mi">47</span> <span class="n">whoami</span>
</pre></div>
</div>
<ul>
<li><p>此时就能够正确启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd&#64;0.service</span></code> 服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>完整 <code class="docutils literal notranslate"><span class="pre">activate</span></code> BlueStore的过程见文档 <a class="reference external" href="https://docs.ceph.com/en/latest/ceph-volume/lvm/activate/#summary">ceph-volume » activate</a></p>
</div>
<section id="id6">
<h3>总结<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>删除掉OSD.0 准备重新开始:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">purge</span> <span class="mi">0</span> <span class="o">--</span><span class="n">yes</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">really</span><span class="o">-</span><span class="n">mean</span><span class="o">-</span><span class="n">it</span>
</pre></div>
</div>
</li>
<li><p>清理理分区前10M空间(重要，否则 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span> <span class="pre">raw</span> <span class="pre">prepare</span></code> 失败:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="n">M</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span> <span class="n">conv</span><span class="o">=</span><span class="n">fsync</span>
</pre></div>
</div>
</li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">raw</span></code> 模式其实只有2个命令步骤:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">prepare</span> <span class="o">--</span><span class="n">bluestore</span> <span class="o">--</span><span class="n">data</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
<span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="n">activate</span> <span class="o">--</span><span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
</pre></div>
</div>
</li>
</ul>
<p>此时 <code class="docutils literal notranslate"><span class="pre">/var/lib/ceph/osd/ceph-0</span></code> 会挂载 <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> 正确生成指向 <code class="docutils literal notranslate"><span class="pre">/dev/nvme0n1p1</span></code> BlueStore的文件，具备了启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> 的条件</p>
<ul>
<li><p>启动 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> 服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ceph</span><span class="o">-</span><span class="n">osd</span><span class="o">@</span><span class="mf">0.</span><span class="n">service</span>
</pre></div>
</div>
</li>
<li><p>此时检查 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ceph</span> <span class="pre">-s</span></code> 就可以看到OSD 0已经激活启用</p></li>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">ceph-volume</span></code> 输出的 <code class="docutils literal notranslate"><span class="pre">osd_id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">osd_uuid</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span> <span class="n">raw</span> <span class="nb">list</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ceph_fsid&quot;</span><span class="p">:</span> <span class="s2">&quot;39392603-fe09-4441-acce-1eb22b1391e1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/nvme0n1p1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;osd_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;osd_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;d34a6c89-0c53-4378-ac43-108b47722abf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bluestore&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>激活对应的卷服务(似乎应该有这个步骤，但是还是没有成功):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ceph</span><span class="o">-</span><span class="n">volume</span><span class="nd">@raw</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">d34a6c89</span><span class="o">-</span><span class="mi">0</span><span class="n">c53</span><span class="o">-</span><span class="mi">4378</span><span class="o">-</span><span class="n">ac43</span><span class="o">-</span><span class="mi">108</span><span class="n">b47722abf</span>
</pre></div>
</div>
</li>
</ul>
<p>输出提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Created symlink /etc/systemd/system/multi-user.target.wants/ceph-volume@raw-0-d34a6c89-0c53-4378-ac43-108b47722abf.service → /lib/systemd/system/ceph-volume@.service.
</pre></div>
</div>
<p><span class="sphinxnotes-strike">这样启动才能够挂载好卷</span> 不过我重启还是没有解决挂载</p>
<ul>
<li><p>如果不能正确挂载，则手工处理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">tmpfs</span> <span class="n">tmpfs</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span>
<span class="n">sudo</span> <span class="n">ceph</span><span class="o">-</span><span class="n">bluestore</span><span class="o">-</span><span class="n">tool</span> <span class="n">prime</span><span class="o">-</span><span class="n">osd</span><span class="o">-</span><span class="nb">dir</span> <span class="o">--</span><span class="n">dev</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">osd</span><span class="o">/</span><span class="n">ceph</span><span class="o">-</span><span class="mi">0</span>
</pre></div>
</div>
</li>
</ul>
<p>这里进展了一步，生成了一些必要文件，但还不完整，所以 <code class="docutils literal notranslate"><span class="pre">ceph-osd&#64;0.service</span></code> 还不能正常运行</p>
<ul>
<li><p>检查分区uuid(这个步骤待参考，是为了解决块设备属主，有可能不需要):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">udevadm</span> <span class="n">info</span> <span class="o">--</span><span class="n">query</span><span class="o">=</span><span class="nb">all</span> <span class="o">--</span><span class="n">name</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">uuid</span>
</pre></div>
</div>
</li>
</ul>
<p>将输出的 <code class="docutils literal notranslate"><span class="pre">E:</span> <span class="pre">ID_PART_ENTRY_UUID</span></code> 修订 <code class="docutils literal notranslate"><span class="pre">/etc/udev/rules.d/99-perm.rules</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ACTION</span><span class="o">==</span><span class="s2">&quot;add|change&quot;</span><span class="p">,</span> <span class="n">ENV</span><span class="p">{</span><span class="n">ID_PART_ENTRY_UUID</span><span class="p">}</span><span class="o">==</span><span class="s2">&quot;4a7db7a7-90fc-47cb-b473-8774db0c392f&quot;</span><span class="p">,</span> <span class="n">OWNER</span><span class="o">=</span><span class="s2">&quot;ceph&quot;</span><span class="p">,</span> <span class="n">GROUP</span><span class="o">=</span><span class="s2">&quot;ceph&quot;</span>
</pre></div>
</div>
<ul>
<li><p>修订 <code class="docutils literal notranslate"><span class="pre">/etc/ceph/ceph.conf</span></code> 配置文件添加最简化的OSD配置(可能不需要):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">osd</span><span class="mf">.0</span><span class="p">]</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
</li>
</ul>
<p>这个配置可以确保操作系统重启后自动启动 <code class="docutils literal notranslate"><span class="pre">osd.0</span></code></p>
</section>
</section>
<section id="id7">
<h2>添加OSD<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>需要满足3副本要求，我们需要在服务器本地或者其他服务器上添加OSD。为了能够冗余，我采用集群3个服务器上每个服务器都启动 <code class="docutils literal notranslate"><span class="pre">ceph-mon</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> ，所以下面我们来完成:</p>
<ul class="simple">
<li><p><a class="reference internal" href="add_ceph_mons.html#add-ceph-mons"><span class="std std-ref">Ceph集群添加ceph-mon</span></a></p></li>
</ul>
<p>然后再执行:</p>
<ul class="simple">
<li><p><a class="reference internal" href="add_ceph_osds_more.html#add-ceph-osds-more"><span class="std std-ref">Ceph集群添加更多ceph-osd</span></a></p></li>
</ul>
</section>
<section id="id8">
<h2>参考<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.ceph.com/docs/master/install/">Ceph document - Installation (Manual)</a></p></li>
<li><p><a class="reference external" href="https://tracker.ceph.com/issues/48783">raw osd’s are not started on boot after upgrade from 14.2.11 to 14.2.16 ; ceph-volume raw activate claim systemd support not yet implemented</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install_ceph_mgr.html" class="btn btn-neutral float-left" title="安装 ceph-mgr" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="add_ceph_osds_lvm.html" class="btn btn-neutral float-right" title="添加Ceph OSDs (LVM卷)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>