<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>部署DNSmasq &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/documentation_options.js?v=7c91f8fd"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/translations.js?v=beaddf03"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="配置DNSmasq对不同子网提供不同域名扩展(expand-hosts)" href="dnsmasq_domains_for_subnets.html" />
    <link rel="prev" title="dnsmasq简介" href="introduce_dnsmasq.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes_from_scratch/index.html">Kubernetes From Scratch (KFS) Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rancher/index.html">Rancher Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/index.html">SQLite Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../clickhouse/index.html">ClickHouse Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nosql/index.html">NoSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Infra-Service Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../ntp/index.html">ntp服务</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">DNS服务</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../compare_dns_software.html">DNS软件比较</a></li>
<li class="toctree-l3"><a class="reference internal" href="../wpad_protocol.html">Web代理自动发现(Web Proxy Auto-Discovery,WPAD)协议</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bind/index.html">BIND</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">DNSmasq</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="introduce_dnsmasq.html">dnsmasq简介</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">部署DNSmasq</a></li>
<li class="toctree-l4"><a class="reference internal" href="dnsmasq_domains_for_subnets.html">配置DNSmasq对不同子网提供不同域名扩展(expand-hosts)</a></li>
<li class="toctree-l4"><a class="reference internal" href="dnsmasq_multi_interfaces.html">DNSmasq多网卡</a></li>
<li class="toctree-l4"><a class="reference internal" href="dnsmasq_dns_wpad.html">DNSmasq部署DNS WPAD(WEB代理自动发现)</a></li>
<li class="toctree-l4"><a class="reference internal" href="dnsmasq_dhcp_wpad.html">DNSmasq部署DHCP WPAD(WEB代理自动发现)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tls/index.html">TLS(Transport Layer Security)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ssh/index.html">ssh服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mosh/index.html">Mosh(mobile shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../syslog/index.html">syslog服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samba/index.html">Samba服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nfs/index.html">nfs服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../asciinema/index.html">asciinema:终端会话记录和分享</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guacamole/index.html">Apache Guacamole:无客户端远程桌面网关</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_search/index.html">Search Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../info_service/index.html">Info-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flask/index.html">Flask Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../clang/index.html">C Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ruby/index.html">Ruby Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Infra-Service Atlas</a></li>
          <li class="breadcrumb-item"><a href="../index.html">DNS服务</a></li>
          <li class="breadcrumb-item"><a href="index.html">DNSmasq</a></li>
      <li class="breadcrumb-item active">部署DNSmasq</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/infra_service/dns/dnsmasq/deploy_dnsmasq.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dnsmasq">
<span id="deploy-dnsmasq"></span><h1>部署DNSmasq<a class="headerlink" href="#dnsmasq" title="Link to this heading">¶</a></h1>
<section id="id1">
<h2>安装dnsmasq<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>各发行版都包含了dnsmasq，安装十分方便便捷：</p></li>
</ul>
<p><a class="reference internal" href="../../../linux/arch_linux/index.html#arch-linux"><span class="std std-ref">Arch Linux</span></a> 安装dnsmasq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 安装dnsmasq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../../linux/redhat_linux/index.html#redhat-linux"><span class="std std-ref">RedHat Linux</span></a> 安装dnsmasq (fedora或centos/rhel 8):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>配置dnsmasq<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<ul>
<li><p>检查配置语法，这个基本步骤可以确保配置没有基础的语法错误:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnsmasq</span> <span class="o">--</span><span class="n">test</span>
</pre></div>
</div>
</li>
<li><p>现代发行版，在 <code class="docutils literal notranslate"><span class="pre">/etc/default/dnsmasq</span></code> 提供了对dnsmasq服务对基本控制，例如:</p>
<ul class="simple">
<li><p>启用或关闭dnsmasq: <code class="docutils literal notranslate"><span class="pre">ENABLED=1</span></code> （关闭是设置 <code class="docutils literal notranslate"><span class="pre">0</span></code>)</p></li>
<li><p>设置DNS后缀(默认域名): <code class="docutils literal notranslate"><span class="pre">DOMAIN_SUFFIX=`dnsdomainname</span></code></p></li>
<li><p>选择一个替代配置文件: <code class="docutils literal notranslate"><span class="pre">DNSMASQ_OPTS=&quot;--conf-file=/etc/dnsmasq.alt&quot;</span></code></p></li>
<li><p>告知dnsmasq读取配置文件目录: <code class="docutils literal notranslate"><span class="pre">CONFIG_DIR=/etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new</span></code> (默认启用，配置集中在 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq.d</span></code> )</p></li>
<li><p>如果系统安装了 <code class="docutils literal notranslate"><span class="pre">resolvconf</span></code> 软件包，dnsmasq就会使用 <code class="docutils literal notranslate"><span class="pre">resolvconf</span></code> 的输出而不是 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 配置来 <code class="docutils literal notranslate"><span class="pre">查找</span> <span class="pre">upstream</span> <span class="pre">nameservers</span></code> 。如果要关闭这个特性，就激活 <code class="docutils literal notranslate"><span class="pre">IGNORE_RESOLVCONF=yes</span></code></p></li>
</ul>
</li>
<li><p>在我的 <code class="docutils literal notranslate"><span class="pre">zcloud</span></code> 服务器上，安装了多个网卡，其中内网采用有线网络，网段是 <code class="docutils literal notranslate"><span class="pre">192.168.6.x</span></code> ，所以需要设置dnsmasq监听特定地址，只监听内部网络网段和回环地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">listen</span><span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="mf">192.168.6.200</span><span class="p">,</span><span class="mf">192.168.7.200</span><span class="p">,</span><span class="mf">192.168.8.200</span><span class="p">,</span><span class="mf">127.0.0.1</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="../../../kvm/libvirt/index.html#libvirt"><span class="std std-ref">Libvirt虚拟机管理器</span></a> 已经启动了 <code class="docutils literal notranslate"><span class="pre">/usr/sbin/dnsmasq</span> <span class="pre">--conf-file=/var/lib/libvirt/dnsmasq/default.conf</span> <span class="pre">...</span></code> 专用于 <code class="docutils literal notranslate"><span class="pre">virbr0</span></code> (NAT网络)的服务，提供KVM虚拟机的DHCP IP分配。这个dnsmasq是专门监听 <code class="docutils literal notranslate"><span class="pre">interface=virbr0</span></code> ，和本文配置不冲突</p>
</div>
<p>也可以通过设置监听接口来确保限制在指定网口上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span><span class="o">=</span><span class="n">enp0s25</span><span class="p">,</span><span class="n">anbox0</span>
</pre></div>
</div>
<p>或者仅指定不包括哪些接口 <code class="docutils literal notranslate"><span class="pre">except-interface=</span></code></p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我这里采用 <code class="docutils literal notranslate"><span class="pre">listen-address=192.168.6.200,192.168.7.200,192.168.8.200,127.0.0.1</span></code> 是因为我这个服务将针对整个 <a class="reference internal" href="../../../real/priv_cloud/priv_cloud_infra.html#priv-cloud-infra"><span class="std std-ref">私有云架构</span></a> ，并且我会在多个接口上使用这个网段的IP</p>
</div>
<ul>
<li><p>设置缓存大小：通常dnsmasq是作为本地局域网的DNS缓存服务器运行，并且默认只缓存150条DNS记录，可以将这个缓存扩大:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span><span class="o">-</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span>
</pre></div>
</div>
</li>
</ul>
<section id="dns">
<h3>DNS地址文件和转发<a class="headerlink" href="#dns" title="Link to this heading">¶</a></h3>
<p>在配置了dnsmasq之后，你需要添加一个localhost地址到 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> ，这样本机的DNS请求才会发送被本机运行的dnsmasq。</p>
<p>由于dnsmasq是一个stub解析器(resolver)但不是一个recusive解析器，所以你必须设置一个转发解析到外部DNS服务器。这个设置可以使用 <code class="docutils literal notranslate"><span class="pre">openresolv</span></code> 自动实现(也可以在dnsmasq的配置文件中手工设置，但我们通常都使用openresolv)。</p>
<ul class="simple">
<li><p>resolvconf</p></li>
<li><p><a class="reference internal" href="../../../linux/redhat_linux/systemd/systemd_resolved.html#systemd-resolved"><span class="std std-ref">systemd-resolved</span></a> 是目前主流操作系统默认配置，例如我在 <code class="docutils literal notranslate"><span class="pre">zcloud</span></code> 上部署的 <a class="reference internal" href="../../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 服务器版本就采用 <code class="docutils literal notranslate"><span class="pre">systemd-resolved</span></code></p></li>
</ul>
<section id="openresolv">
<h4>openresolv<a class="headerlink" href="#openresolv" title="Link to this heading">¶</a></h4>
<p>如果你的network manager支持 <code class="docutils literal notranslate"><span class="pre">resolvconf</span></code> ，就不需要直接修改 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> ，可以使用 <code class="docutils literal notranslate"><span class="pre">openresolv</span></code> 来为dnsmasq生成配置文件。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>注意， <code class="docutils literal notranslate"><span class="pre">resolvconf</span></code> 的基础配置 <code class="docutils literal notranslate"><span class="pre">DOMAINNAME</span></code> 是从 NetworkManager 获取的，会影响下面所有的 domain 配置。所以如果要修订域名搜索，需要修改Network Manager的配置。这块我还没有实践，待后续补充</p>
</div>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/resolvconf.conf</span></code> 添加一个回环地址作为域名解析服务器，并配置 openresolv 来输出dnsmasq配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resolv_conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
<span class="c1"># If you run a local name server, you should uncomment the below line and</span>
<span class="c1"># configure your subscribers configuration files below.</span>
<span class="n">name_servers</span><span class="o">=</span><span class="mf">127.0.0.1</span>

<span class="c1"># Write out dnsmasq extended configuration and resolv files</span>
<span class="n">dnsmasq_conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">dnsmasq</span><span class="o">-</span><span class="n">conf</span><span class="o">.</span><span class="n">conf</span>
<span class="n">dnsmasq_resolv</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">dnsmasq</span><span class="o">-</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">resolvconf</span> <span class="pre">-u</span></code> 命令生成上述配置文件。注意，如果没有上述文件存在， <code class="docutils literal notranslate"><span class="pre">dnsmasq.service</span></code> 启动会失败。</p></li>
</ul>
<p>请注意，此时原先 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 配置文件会修订成使用本机dns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">domain</span> <span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>
<span class="n">nameserver</span> <span class="mf">127.0.0.1</span>
</pre></div>
</div>
<p>而 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq-resolv.conf</span></code> 配置则是之前 <code class="docutils literal notranslate"><span class="pre">resolv.conf</span></code> 内容，也就是说DNSmasq会使用这个 <code class="docutils literal notranslate"><span class="pre">dnsmasq-resolv.conf</span></code> 来请求外部DNS服务器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">nameserver</span> <span class="mf">202.96.209.133</span>  <span class="c1"># 注意：之后这个外部DNS将修改成我部署的bind服务器IP</span>
</pre></div>
</div>
<p>而 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq-conf.conf</span></code> 配置是dnsmasq的配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">server</span><span class="o">=/</span><span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="mf">202.96.209.133</span>
</pre></div>
</div>
</section>
<section id="manual-forwarding">
<h4>Manual forwarding<a class="headerlink" href="#manual-forwarding" title="Link to this heading">¶</a></h4>
<ul>
<li><p>首先需要确保 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 配置中只设置 localhost 作为唯一的nameserver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">domain</span> <span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>
<span class="n">nameserver</span> <span class="mf">127.0.0.1</span>
<span class="c1"># 如果是IPv6还需要如下行</span>
<span class="c1"># nameserver ::1</span>
</pre></div>
</div>
</li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq.conf</span></code> 配置 <code class="docutils literal notranslate"><span class="pre">server=server_address</span></code> 指定上级DNS，并且添加 <code class="docutils literal notranslate"><span class="pre">no-resolv</span></code> 这样dnsmasq就不会读取 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> ，因为这个配置中实际只包含了它自己的localhost地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">no</span><span class="o">-</span><span class="n">resolv</span>
<span class="o">...</span>
<span class="c1"># Google&#39;s nameservers, for example</span>
<span class="n">server</span><span class="o">=</span><span class="mf">8.8.8.8</span>
<span class="n">server</span><span class="o">=</span><span class="mf">8.8.4.4</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>一定要配置 <code class="docutils literal notranslate"><span class="pre">server=</span></code> ，将所有非本地域名的DNS解析都通过上一级DNS来提供</p>
</div>
</section>
</section>
</section>
<section id="id3">
<h2>添加定制域名<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p>可以为本地局域网添加一个domain，也就是我们内部域名:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span><span class="o">=/</span><span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span><span class="o">/</span>
<span class="n">domain</span><span class="o">=</span><span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>
<span class="n">expand</span><span class="o">-</span><span class="n">hosts</span>
</pre></div>
</div>
<p>完整 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq.conf</span></code> 配置:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">dnsmasq简易配置</span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># 本地默认域名</span>
<span class="na">local</span><span class="o">=</span><span class="s">/staging.huatai.me/</span>
<span class="c1"># 转发上游域名解析服务器，请求DNS解析</span>
<span class="na">server</span><span class="o">=</span><span class="s">8.8.8.8</span>
<span class="c1"># 监听DNS请求的网卡接口(br0上使用了IP Alias，但是ifconfig只看到一个br0，所以这里配置一个接口)</span>
<span class="na">interface</span><span class="o">=</span><span class="s">br0,eno4</span>
<span class="c1"># 监听DNS请求的IP地址(注意eno4接口是DHCP动态获取IP，所以使用上面的interface配置)</span>
<span class="na">listen-address</span><span class="o">=</span><span class="s">192.168.6.200,192.168.7.200,192.168.8.200,127.0.0.1</span>
<span class="c1"># 扩展主机域名，也就是请求 zcloud 默认扩展成 zcloud.staging.huatai.me</span>
<span class="na">expand-hosts</span>
<span class="c1"># 服务器提供解析的域名，可以为多个网段提供不同的域名解析</span>
<span class="na">domain</span><span class="o">=</span><span class="s">staging.huatai.me,192.168.6.0/24</span>
<span class="na">domain</span><span class="o">=</span><span class="s">edge.cloud-atlas.io,192.168.7.0/24</span>
<span class="na">domain</span><span class="o">=</span><span class="s">staging.cloud-atlas.io,192.168.8.0/24</span>
<span class="c1"># DNS解析缓存</span>
<span class="na">cache-size</span><span class="o">=</span><span class="s">1000</span>
<span class="c1"># DHCP</span>
<span class="na">dhcp-range</span><span class="o">=</span><span class="s">192.168.6.21,192.168.6.50,255.255.255.0,12h</span>
<span class="na">dhcp-option</span><span class="o">=</span><span class="s">option:router,192.168.6.200</span>
<span class="na">dhcp-option</span><span class="o">=</span><span class="s">option:dns-server,192.168.6.200</span>
<span class="na">dhcp-authoritative</span>
</pre></div>
</div>
</div>
<p>上述域名就是我们用于DHCP和内部域名，这样我们在 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 中配置主机名解析时候就只需要配置短域名主机名就可以了，会自动扩展成FQDN完整域名。例如， <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168.6.9</span>  <span class="n">zcloud</span>
<span class="mf">192.168.6.10</span> <span class="n">jetson</span>
<span class="mf">192.168.6.11</span> <span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
<span class="mf">192.168.6.12</span> <span class="n">pi</span><span class="o">-</span><span class="n">master2</span>
<span class="mf">192.168.6.13</span> <span class="n">pi</span><span class="o">-</span><span class="n">master3</span>
<span class="mf">192.168.6.15</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>
<span class="mf">192.168.6.16</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>
<span class="mf">192.168.6.17</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker3</span>
</pre></div>
</div>
<p>则自动会被加上 <code class="docutils literal notranslate"><span class="pre">.staging.huatai.me</span></code> 后缀域名，形成完成的域名 <code class="docutils literal notranslate"><span class="pre">192.168.6.9</span> <span class="pre">zcloud.staging.huatai.me</span></code></p>
</section>
<section id="id4">
<h2>多域名解析<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<ul>
<li><p>可以为不同网段设置不同的域名，例如我构建了 <code class="docutils literal notranslate"><span class="pre">huatai.me</span></code> 和 <code class="docutils literal notranslate"><span class="pre">cloud-atlas.io</span></code> 两个域名(3个):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">domain</span><span class="o">=</span><span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span><span class="p">,</span><span class="mf">192.168.6.0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">domain</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">cloud</span><span class="o">-</span><span class="n">atlas</span><span class="o">.</span><span class="n">io</span><span class="p">,</span><span class="mf">192.168.7.0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">domain</span><span class="o">=</span><span class="n">staging</span><span class="o">.</span><span class="n">cloud</span><span class="o">-</span><span class="n">atlas</span><span class="o">.</span><span class="n">io</span><span class="p">,</span><span class="mf">192.168.8.0</span><span class="o">/</span><span class="mi">24</span>
</pre></div>
</div>
</li>
</ul>
<p>这样我在 <a class="reference internal" href="../../../real/priv_cloud/priv_cloud_infra.html#priv-cloud-infra"><span class="std std-ref">私有云架构</span></a> 构建了 <code class="docutils literal notranslate"><span class="pre">z-k8s</span></code> (192.168.6.x) 和 <code class="docutils literal notranslate"><span class="pre">y-k8s</span></code> (192.168.8.x) 分别位于 <code class="docutils literal notranslate"><span class="pre">staging.huatia.me</span></code> 和 <code class="docutils literal notranslate"><span class="pre">staging.cloud-atlas.io</span></code> 两个域名下</p>
</section>
<section id="id5">
<h2>启动DNSmasq<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<ul>
<li><p>启动dnsmasq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
</li>
<li><p>查询测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">host</span> <span class="n">zcloud</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到输出的域名解析被自动展开:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zcloud</span><span class="o">.</span><span class="n">staging</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span> <span class="n">has</span> <span class="n">address</span> <span class="mf">192.168.6.9</span>
</pre></div>
</div>
</section>
<section id="dhcp">
<h2>DHCP服务器(推荐配置)<a class="headerlink" href="#dhcp" title="Link to this heading">¶</a></h2>
<p>我在 <a class="reference internal" href="../../../real/priv_cloud/priv_cloud_infra.html#priv-cloud-infra"><span class="std std-ref">私有云架构</span></a> 采用的DNSmasq实现DNS解析，以及对局域网内部提供DHCP，提供 <a class="reference internal" href="../../../apple/airport/airport_express_with_dnsmasq_ics.html#airport-express-with-dnsmasq-ics"><span class="std std-ref">结合DNSmasq+iptables使用AirPort Express实现无线访问因特网</span></a> ，配置添加:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">-</span><span class="nb">range</span><span class="o">=</span><span class="mf">192.168.6.21</span><span class="p">,</span><span class="mf">192.168.6.50</span><span class="p">,</span><span class="mf">255.255.255.0</span><span class="p">,</span><span class="mi">12</span><span class="n">h</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">router</span><span class="p">,</span><span class="mf">192.168.6.200</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">ntp</span><span class="o">-</span><span class="n">server</span><span class="p">,</span><span class="mf">192.168.6.200</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">dns</span><span class="o">-</span><span class="n">server</span><span class="p">,</span><span class="mf">192.168.6.200</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">authoritative</span>
</pre></div>
</div>
<p>解析配置:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dhcp-range</span></code> 设置了分配IP地址范围，注意，配置中结合了上文DNS配置，上文中已经配置 <code class="docutils literal notranslate"><span class="pre">listen-address=192.168.6.200,127.0.0.1</span></code> ，也就是只监听局域网内部IP以及回环地址，所以不会和无线网络(另一个DHCP)冲突</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dhcp-option</span></code> 提供了DHCP的选项:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">dhcp-option=option:router,192.168.6.200</span></code> 指定DHCP客户端的默认路由</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dhcp-option=option:ntp-server,192.168.6.200</span></code> 指定DHCP客户端的NTP服务器</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dhcp-option=option:dns-server,192.168.6.200</span></code> 指定DHCP客户端的DNS服务器</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dhcp-authoritative</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="dhcp-anbox">
<h2>DHCP服务器(anbox案例)<a class="headerlink" href="#dhcp-anbox" title="Link to this heading">¶</a></h2>
<p>默认情况下，dnsmasq是关闭DHCP功能的，需要在配置中开启才可以使用dhcp。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你的局域网内部已经使用了DHCP服务，例如宽带路由器对局域网就默认启用了DHCP。所以，一定要避免DHCP冲突，需要小心设置dnsmasq所使用对接口(参数 <code class="docutils literal notranslate"><span class="pre">interface=</span></code> )</p>
</div>
<p>在我的案例中，我启用了多个接口的DNS服务 ( <code class="docutils literal notranslate"><span class="pre">enp0s25,anbox0</span></code> ) 但是只在内网接口 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 启用DHCP服务。</p>
<ul>
<li><p>重要配置案例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you want dnsmasq to listen for DHCP and DNS requests only on</span>
<span class="c1"># specified interfaces (and the loopback) give the name of the</span>
<span class="c1"># interface (eg eth0) here.</span>
<span class="c1"># Repeat the line for more than one interface.</span>
<span class="n">interface</span><span class="o">=</span><span class="n">enp0s25</span><span class="p">,</span><span class="n">anbox0</span>

<span class="c1"># If you want dnsmasq to provide only DNS service on an interface,</span>
<span class="c1"># configure it as shown above, and then use the following line to</span>
<span class="c1"># disable DHCP and TFTP on it.</span>
<span class="n">no</span><span class="o">-</span><span class="n">dhcp</span><span class="o">-</span><span class="n">interface</span><span class="o">=</span><span class="n">anbox0</span>

<span class="c1"># On systems which support it, dnsmasq binds the wildcard address,</span>
<span class="c1"># even when it is listening on only some interfaces. It then discards</span>
<span class="c1"># requests that it shouldn&#39;t reply to. This has the advantage of</span>
<span class="c1"># working even when interfaces come and go and change address. If you</span>
<span class="c1"># want dnsmasq to really bind only the interfaces it is listening on,</span>
<span class="c1"># uncomment this option. About the only time you may need this is when</span>
<span class="c1"># running another nameserver on the same machine.</span>
<span class="n">bind</span><span class="o">-</span><span class="n">interfaces</span>

<span class="c1"># Uncomment this to enable the integrated DHCP server, you need</span>
<span class="c1"># to supply the range of addresses available for lease and optionally</span>
<span class="c1"># a lease time. If you have more than one network, you will need to</span>
<span class="c1"># repeat this for each network on which you want to supply DHCP</span>
<span class="c1"># service.</span>
<span class="c1"># This is an example of a DHCP range where the netmask is given.</span>
<span class="n">dhcp</span><span class="o">-</span><span class="nb">range</span><span class="o">=</span><span class="mf">192.168.6.201</span><span class="p">,</span><span class="mf">192.168.6.254</span><span class="p">,</span><span class="mf">255.255.255.0</span><span class="p">,</span><span class="mi">12</span><span class="n">h</span>

<span class="c1"># 也支持根据以太网MAC地址来分配IP地址，适合需要固定IP地址分配场景</span>
<span class="c1"># 在企业内部网络，可以通过这种方式来。</span>
<span class="c1"># 以下为举例(设置主机名以及对应IP地址，并且45分钟释放):</span>
<span class="c1"># dhcp-host=11:22:33:44:55:66,fred,192.168.6.254,45m</span>

<span class="c1"># DHCP有很多重要选项，以下是一些常用案例：</span>

<span class="c1"># 设置默认网关，以下2种配置都可以，任选一种</span>
<span class="c1">#dhcp-option=3,192.168.6.9</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">router</span><span class="p">,</span><span class="mf">192.168.6.9</span>

<span class="c1"># 设置NTP服务器地址:</span>
<span class="c1">#dhcp-option=option:ntp-server,192.168.6.9</span>

<span class="c1"># 可以通过DHCP设置静态路由，注意要配置网络netmask</span>
<span class="c1">#dhcp-option=121,192.168.7.0/24,192.168.6.10,10.0.0.0/8,192.168.6.8</span>

<span class="c1"># 设置DNS服务器(待验证，配置文件只显示DHCPv6的dns-server)</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">dns</span><span class="o">-</span><span class="n">server</span><span class="p">,</span><span class="mf">192.168.6.9</span>
</pre></div>
</div>
</li>
</ul>
<p>完整的配置需要查看 <code class="docutils literal notranslate"><span class="pre">dnsmasq.conf</span></code> 配置注释，后面我会在部署 <a class="reference internal" href="../../../arm/raspberry_pi/pi_cluster/index.html#pi-cluster"><span class="std std-ref">Raspberry Pi Cluster</span></a> 的diskless集群尝试实践。</p>
<ul>
<li><p>启动dnsmasq之后，要观察有哪些DHCP地址被分配出去，请检查 <code class="docutils literal notranslate"><span class="pre">/var/lib/misc/dnsmasq.leases</span></code></p></li>
<li><p>启动dnsmasq之后，请检查 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">dnsmasq</span></code> 输出，正常情况下显示类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/usr/lib/systemd/system/dnsmasq.service; enabled; vendor preset: disabled)
     Active: active (running) since Thu 2020-10-08 22:23:52 CST; 14min ago
       Docs: man:dnsmasq(8)
    Process: 36760 ExecStartPre=/usr/bin/dnsmasq --staging.(code=exited, status=0/SUCCESS)
   Main PID: 36761 (dnsmasq)
      Tasks: 1 (limit: 19050)
     Memory: 1.3M
     CGroup: /system.slice/dnsmasq.service
             └─36761 /usr/bin/dnsmasq -k --enable-dbus --user=dnsmasq --pid-file

Oct 08 22:23:52 zcloud dnsmasq[36760]: dnsmasq: syntax check OK.
Oct 08 22:23:52 zcloud systemd[1]: Started dnsmasq - A lightweight DHCP and caching DNS server.
Oct 08 22:23:52 zcloud dnsmasq[36761]: started, version 2.82 cachesize 1000
Oct 08 22:23:52 zcloud dnsmasq[36761]: compile time options: IPv6 GNU-getopt DBus no-UBus i18n IDN2 DHCP DHCPv6 no-Lua TFTP conntrack ipset auth DNSSEC loop-&gt;
Oct 08 22:23:52 zcloud dnsmasq[36761]: DBus support enabled: connected to system bus
Oct 08 22:23:52 zcloud dnsmasq-dhcp[36761]: DHCP, IP range 192.168.6.201 -- 192.168.6.254, lease time 12h
Oct 08 22:23:52 zcloud dnsmasq-dhcp[36761]: DHCP, sockets bound exclusively to interface enp0s25
Oct 08 22:23:52 zcloud dnsmasq[36761]: using only locally-known addresses for domain staging.huatai.me
Oct 08 22:23:52 zcloud dnsmasq[36761]: using nameserver 202.96.209.133#53
Oct 08 22:23:52 zcloud dnsmasq[36761]: read /etc/hosts - 12 addresses
</pre></div>
</div>
</li>
</ul>
<p>请注意，这里输出的信息都反映了我们上述配置中的设置参数</p>
</section>
<section id="tftp">
<h2>TFTP服务器<a class="headerlink" href="#tftp" title="Link to this heading">¶</a></h2>
<p>dnsmasq内建了TFTP服务器。也准备在 <a class="reference internal" href="../../../arm/raspberry_pi/pi_cluster/index.html#pi-cluster"><span class="std std-ref">Raspberry Pi Cluster</span></a> 的diskless集群实践。</p>
</section>
<section id="id6">
<h2>参考<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Dnsmasq">archlinux doc - dnsmasq</a></p></li>
<li><p><a class="reference external" href="https://netbeez.net/blog/how-to-set-up-dns-server-dnsmasq-part-4/">Linux for Network Engineers: How to set up a DHCP server with Dnsmasq Part 4</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="introduce_dnsmasq.html" class="btn btn-neutral float-left" title="dnsmasq简介" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dnsmasq_domains_for_subnets.html" class="btn btn-neutral float-right" title="配置DNSmasq对不同子网提供不同域名扩展(expand-hosts)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html">Copyright</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>