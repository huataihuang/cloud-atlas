

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>部署简单GlusterFS集群 &mdash; Cloud Atlas 0.1 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="GlusterFS管理" href="../admin/index.html" />
    <link rel="prev" title="GlusterFS架构" href="gluster_architecture.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Gluster Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduce_gluster.html">Gluster分布式存储简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gluster_vs_ceph.html">Gluster和Ceph对比</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">GlusterFS起步</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="gluster_architecture.html">GlusterFS架构</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">部署简单GlusterFS集群</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">服务器准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">安装GlusterFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">配置GlusterFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">使用GlusterFS卷</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">参考</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin/index.html">GlusterFS管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html">GlusterFS性能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tendrl/index.html">Tendrl 软件定义存储(SDS)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../macos_ios/index.html">macOS &amp; iOS Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Gluster Atlas</a> &raquo;</li>
        
          <li><a href="index.html">GlusterFS起步</a> &raquo;</li>
        
      <li>部署简单GlusterFS集群</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/gluster/startup/deploy_simple_gluster.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="glusterfs">
<span id="deploy-simple-gluster"></span><h1>部署简单GlusterFS集群<a class="headerlink" href="#glusterfs" title="永久链接至标题">¶</a></h1>
<p>正如 <a class="reference internal" href="../gluster_vs_ceph.html#gluster-vs-ceph"><span class="std std-ref">Gluster和Ceph对比</span></a> 辨析，GlusterFS是在文件系统之上构建的分布式文件系统，所以 <a class="reference internal" href="../../linux/storage/filesystem/index.html#linux-filesystem"><span class="std std-ref">Linux文件系统</span></a> 的构建会给GlusterFS带来更多的特性和功能。例如，结合卷管理可以实现快照。本文实践是快速部署一个简化版本的GlusterFS集群，在文件系统存储层采用直接基于磁盘设备创建XFS文件系统。这种简洁的文件系统虽然灵活性受到限制，但是架构简洁也使得出现错误的可能性降低。</p>
<div class="section" id="id1">
<h2>服务器准备<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>至少需要3台服务器组建稳定的GlusterFS集群(2台虽然也能构建，但是缺乏quotum容易导致脑裂)，在我的这个演示案例中，我采用6个KVM虚拟机(最初我以为奇数服务器可以构建更为稳定，但是参考 <a class="reference internal" href="../admin/gluster_split_brain_deal.html#gluster-split-brain-deal"><span class="std std-ref">GlusterFS脑裂和解决方案</span></a> 修正了方案)，目的是构建分布式多副本集群</p></li>
<li><p>每个虚拟机使用一个附加的 <cite>/dev/vdb</cite> 设备(见下文磁盘分区和文件系统构建)</p></li>
</ul>
<div class="section" id="id2">
<h3>环境准备<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>所有服务器节点的时间必须同步，所以，请安装并运行ntp客户端，当前主流推荐采用 chrony - <a class="reference external" href="https://www.thegeekdiary.com/centos-rhel-7-chrony-vs-ntp-differences-between-ntpd-and-chronyd/">CentOS / RHEL 7 : Chrony V/s NTP (Differences Between ntpd and chronyd)</a></p></li>
<li><p>所有服务器需要彼此能够DNS解析，所以建议采用统一的DNS服务器进行维护主机名解析，比较简化的方法是所有服务器采用一致的 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 提供静态主机名解析。</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>磁盘分区<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">parted</span></code> 对磁盘进行分区，分区vdb1占用250G(没有使用这个vdb是因为我还准备用vdb构建复杂的 <a class="reference internal" href="../../linux/storage/stratis/index.html#stratis"><span class="std std-ref">Stratis - Linux存储系统</span></a> ):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb</span>
<span class="n">mklabel</span> <span class="n">gpt</span>
<span class="n">unit</span> <span class="n">GB</span>
<span class="n">mkpart</span> <span class="n">primary</span> <span class="mi">0</span> <span class="mi">250</span>
<span class="n">name</span> <span class="mi">1</span> <span class="n">gluster_brick1</span>
<span class="nb">print</span>
</pre></div>
</div>
</li>
</ul>
<p>如果磁盘之前已经有分区表，但是分区表没有对齐，你没有执行 <code class="docutils literal notranslate"><span class="pre">mklabel</span> <span class="pre">gpt</span></code> 就执行 <code class="docutils literal notranslate"><span class="pre">mkpart</span></code> 就可能会提示磁盘分区从0开始对齐需要接近扇区，这个警告需要通过使用 <code class="docutils literal notranslate"><span class="pre">-a</span> <span class="pre">optimal</span></code> 参数来修正:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Warning: You requested a partition from 0.00GB to 3840GB (sectors 0..7500000000).
The closest location we can manage is 0.00GB to 0.00GB (sectors 34..2047).
Is this still acceptable to you?
Yes/No?
</pre></div>
</div>
<p>对于原先有分区的磁盘，覆盖原先的分区表，默认是会提示WARNING的，对于脚本执行命令，需要关闭提示，则使用参数 <code class="docutils literal notranslate"><span class="pre">-s</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">--script</span></code> 就不会有提示了。举例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb</span> <span class="n">mklabel</span> <span class="n">gpt</span>
<span class="n">parted</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb</span> <span class="n">mkpart</span> <span class="n">primary</span> <span class="mi">0</span><span class="o">%</span> <span class="mi">100</span><span class="o">%</span>
<span class="n">parted</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb</span> <span class="n">name</span> <span class="mi">1</span> <span class="n">gluster_brick1</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">xfs</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">i</span> <span class="n">size</span><span class="o">=</span><span class="mi">512</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb1</span>
</pre></div>
</div>
<p>此时显示分区信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">Virtio</span> <span class="n">Block</span> <span class="n">Device</span> <span class="p">(</span><span class="n">virtblk</span><span class="p">)</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb</span><span class="p">:</span> <span class="mi">537</span><span class="n">GB</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span><span class="n">B</span><span class="o">/</span><span class="mi">512</span><span class="n">B</span>
<span class="n">Partition</span> <span class="n">Table</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">Flags</span><span class="p">:</span>

<span class="n">Number</span>  <span class="n">Start</span>   <span class="n">End</span>    <span class="n">Size</span>   <span class="n">File</span> <span class="n">system</span>  <span class="n">Name</span>           <span class="n">Flags</span>
 <span class="mi">1</span>      <span class="mf">0.00</span><span class="n">GB</span>  <span class="mi">250</span><span class="n">GB</span>  <span class="mi">250</span><span class="n">GB</span>               <span class="n">gluster_brick1</span>
</pre></div>
</div>
<p>退出parted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quit</span>
</pre></div>
</div>
<ul>
<li><p>使用lsblk检查磁盘设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsblk</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
vda    253:0    0    40G  0 disk
`-vda1 253:1    0    40G  0 part /
vdb    253:16   0   500G  0 disk
`-vdb1 253:17   0 232.9G  0 part
</pre></div>
</div>
</div>
<div class="section" id="xfs">
<h3>XFS文件系统<a class="headerlink" href="#xfs" title="永久链接至标题">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>GlusterFS底层的XFS’文件系统根据不同的硬件(RAID条带化)或者存储的内容不同，可以采用不同的优化策略。我准备在 <a class="reference internal" href="../../linux/storage/stratis/xfs_performance.html#xfs-performance"><span class="std std-ref">XFS性能</span></a> 做详细的测试和对比。这里仅做简化的配置，采用比较通用的参数。</p>
<p>GlusterFS可以使用任何支持扩展属性的文件系统，例如XFS或者Ext4。</p>
</div>
<ul>
<li><p>格式化bricks并挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="o">.</span><span class="n">xfs</span> <span class="o">-</span><span class="n">i</span> <span class="n">size</span><span class="o">=</span><span class="mi">512</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb1</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span>
<span class="n">echo</span> <span class="s1">&#39;/dev/vdb1 /data/brick1 xfs defaults 1 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">mount</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>挂载XFS的参数建议: <code class="docutils literal notranslate"><span class="pre">rw,inode64,noatime,nouuid</span></code> 所以上述命令可以修改:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;/dev/vdb1 /data/brick1 xfs rw,inode64,noatime,nouuid 1 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
</pre></div>
</div>
<p>我对比了默认的 <code class="docutils literal notranslate"><span class="pre">defaults</span></code> 参数，实际上就是 <code class="docutils literal notranslate"><span class="pre">rw,relatime,attr2,inode64,noquota</span></code> ，则上述 <code class="docutils literal notranslate"><span class="pre">rw,inode64,noatime,nouuid</span></code> 实际效果仅仅是将默认的 <code class="docutils literal notranslate"><span class="pre">relatime</span></code> 修改成了 <code class="docutils literal notranslate"><span class="pre">noatime</span></code></p>
</div>
<p>此时可以看到 vdb1 挂载到 <code class="docutils literal notranslate"><span class="pre">/data/brick1</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb1</span> <span class="n">on</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span> <span class="nb">type</span> <span class="n">xfs</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">attr2</span><span class="p">,</span><span class="n">inode64</span><span class="p">,</span><span class="n">noquota</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>批量创建文件系统脚本<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>服务器有多块nvme磁盘，从 <code class="docutils literal notranslate"><span class="pre">/dev/nvme0n1</span></code> 到 <code class="docutils literal notranslate"><span class="pre">/dev/nvme11n1</span></code> 共计12块磁盘，则采用如下脚本快速完成格式化挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in {0..11};do
    if [ ! -d /data/brick${i} ];then mkdir -p /data/brick${i};fi
    parted -s -a optimal /dev/nvme${i}n1 mklabel gpt
    parted -s -a optimal /dev/nvme${i}n1 mkpart primary xfs 0% 100%
    parted -s -a optimal /dev/nvme${i}n1 name 1 gluster_brick${i}
    sleep 1
    mkfs.xfs -f -i size=512 /dev/nvme${i}n1p1
    fstab_line=`grep &quot;/dev/nvme${i}n1p1&quot; /etc/fstab`
    if [ ! -n &quot;$fstab_line&quot;  ];then echo &quot;/dev/nvme${i}n1p1 /data/brick${i} xfs rw,inode64,noatime,nouuid 1 2&quot; &gt;&gt; /etc/fstab;fi
    mount /data/brick${i}
done
</pre></div>
</div>
<p>完成后磁盘挂载如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick0</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme1n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme2n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick2</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme3n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick3</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme4n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick4</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme5n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick5</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme6n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick6</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme7n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick7</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme8n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick8</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme9n1p1</span>   <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick9</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme10n1p1</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick10</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme11n1p1</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">33</span><span class="n">M</span>  <span class="mf">3.5</span><span class="n">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick11</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>安装GlusterFS<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以前安装GlusterFS的方法是先下载repo仓库配置文件，例如 <a class="reference external" href="https://download.gluster.org/pub/gluster/glusterfs/LATEST/CentOS/glusterfs-rhel8.repo">glusterfs-rhel8.repo</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span>  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">gluster</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">gluster</span><span class="o">/</span><span class="n">glusterfs</span><span class="o">/</span><span class="n">LATEST</span><span class="o">/</span><span class="n">CentOS</span><span class="o">/</span><span class="n">glusterfs</span><span class="o">-</span><span class="n">rhel8</span><span class="o">.</span><span class="n">repo</span>
</pre></div>
</div>
<p>也可以通过dnf命令管理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">repo</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">gluster</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">gluster</span><span class="o">/</span><span class="n">glusterfs</span><span class="o">/</span><span class="n">LATEST</span><span class="o">/</span><span class="n">CentOS</span><span class="o">/</span><span class="n">glusterfs</span><span class="o">-</span><span class="n">rhel8</span><span class="o">.</span><span class="n">repo</span>
</pre></div>
</div>
</div>
<ul>
<li><p>现在CentOS已经把开源的多个存储项目集中到一个统一的 <a class="reference external" href="https://wiki.centos.org/SpecialInterestGroup">CentOS Storage Special Interest Group (SIG)</a> ，所以安装对应存储软件的软件仓库非常简单:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster</span>
</pre></div>
</div>
</li>
<li><p>激活PowerTools repo - 必须激活PowerTools软件仓库，否则安装 <code class="docutils literal notranslate"><span class="pre">glusterfs-server</span></code> 会提示报错 <code class="docutils literal notranslate"><span class="pre">python3-pyxattr</span> <span class="pre">is</span> <span class="pre">needed</span> <span class="pre">by</span> <span class="pre">glusterfs-srver</span> <span class="pre">which</span> <span class="pre">is</span> <span class="pre">provded</span> <span class="pre">by</span> <span class="pre">powertools</span> <span class="pre">repo</span> <span class="pre">from</span> <span class="pre">centOS</span> <span class="pre">8</span> <span class="pre">so</span> <span class="pre">this</span> <span class="pre">also</span> <span class="pre">needs</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">enabled</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enabled</span> <span class="n">PowerTools</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>可以通过 <code class="docutils literal notranslate"><span class="pre">dnf</span> <span class="pre">repolist</span> <span class="pre">all</span></code> 检查可用的repo，并且通过上述命令激活需要的仓库。</p>
<p>在CentOS 7上安装旧版本 GlusterFS 6.10 则不需要激活PowerTools</p>
</div>
<ul>
<li><p>安装GlusterFS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="n">glusterfs</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><p>启动GlusterFS管理服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">glusterd</span>
</pre></div>
</div>
</li>
<li><p>检查服务状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">status</span> <span class="n">glusterd</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="centos-7glusterfs">
<h3>在CentOS 7上安装GlusterFS<a class="headerlink" href="#centos-7glusterfs" title="永久链接至标题">¶</a></h3>
<p>如果在标准的CentOS 7上，当前也是可以直接使用 SIG Yum Repos进行安装的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster</span>
</pre></div>
</div>
<p>然后安装方式同上。</p>
<p>不过，如果你的CentOS安装没有升级到最新版本，或者是采用了CentOS的自制版本，则需要独立分发仓库配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/CentOS-Gluster-7.repo</span></code> 和软件包签名证书文件 <code class="docutils literal notranslate"><span class="pre">/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Storage</span></code> ，这两个文件分别是通过如下rpm包可以通过CentOS的发行版extras仓库获得:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="mf">163.</span><span class="n">com</span><span class="o">/</span><span class="n">centos</span><span class="o">/</span><span class="mf">7.8</span><span class="o">.</span><span class="mi">2003</span><span class="o">/</span><span class="n">extras</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">Packages</span><span class="o">/</span><span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster7</span><span class="o">-</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.</span><span class="n">el7</span><span class="o">.</span><span class="n">centos</span><span class="o">.</span><span class="n">noarch</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="mf">163.</span><span class="n">com</span><span class="o">/</span><span class="n">centos</span><span class="o">/</span><span class="mf">7.8</span><span class="o">.</span><span class="mi">2003</span><span class="o">/</span><span class="n">extras</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">Packages</span><span class="o">/</span><span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">common</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="n">el7</span><span class="o">.</span><span class="n">centos</span><span class="o">.</span><span class="n">noarch</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>centos-release-gluster7-1.0-2.el7.centos.noarch 要求 centos-release &gt;= 7-5.1804.el7.centos.2</p>
</div>
<p>如果由于业务原因，无法升级操作系统，则可以考虑安装较低版本的GlusterFS，通过以下命令搜索可能的GlusterFS版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">search</span> <span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster</span>
</pre></div>
</div>
<p>提示可选版本如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="n">N</span><span class="o">/</span><span class="n">S</span> <span class="n">Matched</span><span class="p">:</span> <span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster</span> <span class="o">======================</span>
<span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster</span><span class="o">-</span><span class="n">legacy</span><span class="o">.</span><span class="n">noarch</span> <span class="p">:</span> <span class="n">Disable</span> <span class="n">unmaintained</span> <span class="n">Gluster</span> <span class="n">repositories</span>
                                     <span class="p">:</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CentOS</span> <span class="n">Storage</span> <span class="n">SIG</span>
<span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster312</span><span class="o">.</span><span class="n">noarch</span> <span class="p">:</span> <span class="n">Gluster</span> <span class="mf">3.12</span> <span class="p">(</span><span class="n">Long</span> <span class="n">Term</span> <span class="n">Stable</span><span class="p">)</span> <span class="n">packages</span> <span class="kn">from</span>
                                 <span class="p">:</span> <span class="n">the</span> <span class="n">CentOS</span> <span class="n">Storage</span> <span class="n">SIG</span> <span class="n">repository</span>
<span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster41</span><span class="o">.</span><span class="n">x86_64</span> <span class="p">:</span> <span class="n">Gluster</span> <span class="mf">4.1</span> <span class="p">(</span><span class="n">Long</span> <span class="n">Term</span> <span class="n">Stable</span><span class="p">)</span> <span class="n">packages</span> <span class="kn">from</span>
                                <span class="p">:</span> <span class="n">the</span> <span class="n">CentOS</span> <span class="n">Storage</span> <span class="n">SIG</span> <span class="n">repository</span>
<span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster5</span><span class="o">.</span><span class="n">noarch</span> <span class="p">:</span> <span class="n">Gluster</span> <span class="mi">5</span> <span class="n">packages</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CentOS</span> <span class="n">Storage</span> <span class="n">SIG</span>
                               <span class="p">:</span> <span class="n">repository</span>
<span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster6</span><span class="o">.</span><span class="n">noarch</span> <span class="p">:</span> <span class="n">Gluster</span> <span class="mi">6</span> <span class="n">packages</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CentOS</span> <span class="n">Storage</span> <span class="n">SIG</span>
                               <span class="p">:</span> <span class="n">repository</span>
<span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">gluster7</span><span class="o">.</span><span class="n">noarch</span> <span class="p">:</span> <span class="n">Gluster</span> <span class="mi">7</span> <span class="n">packages</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CentOS</span> <span class="n">Storage</span> <span class="n">SIG</span>
                               <span class="p">:</span> <span class="n">repository</span>
</pre></div>
</div>
<p>旧版本CentOS 7.x可以安装GlusterFS 6系列，对操作系统版本要求较低。可以直接复制 <code class="docutils literal notranslate"><span class="pre">centos-release-gluster6</span></code> 安装包的 <code class="docutils literal notranslate"><span class="pre">CentOS-Gluster-6.repo</span></code> 到需要装的服务器上作为配置进行安装。</p>
</div>
<div class="section" id="centos-6glusterfs">
<h3>在CentOS 6上安装GlusterFS<a class="headerlink" href="#centos-6glusterfs" title="永久链接至标题">¶</a></h3>
<p>生产环境也有非常古老的CentOS 6系统，安装GlusterFS旧版本客户端，测试和GlusterFS 7的兼容性。首先通过 <code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">search</span> <span class="pre">centos-release-gluster</span></code> 检查可用版本，然后安装对应的GlusterFS。</p>
</div>
</div>
<div class="section" id="id6">
<h2>配置GlusterFS<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>在第一台服务器上执行以下命令配置信任存储池，将7台服务器组成一个信任存储池:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">peer</span> <span class="n">probe</span> <span class="n">worker2</span>
<span class="n">gluster</span> <span class="n">peer</span> <span class="n">probe</span> <span class="n">worker3</span>
<span class="o">...</span>
<span class="n">gluster</span> <span class="n">peer</span> <span class="n">probe</span> <span class="n">worker7</span> <span class="c1">#这里多加了一台服务器，实际应该剔除</span>
</pre></div>
</div>
</li>
<li><p>然后检查peer status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">peer</span> <span class="n">status</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">Peers</span><span class="p">:</span> <span class="mi">6</span>

<span class="n">Hostname</span><span class="p">:</span> <span class="n">worker2</span>
<span class="n">Uuid</span><span class="p">:</span> <span class="mi">48350</span><span class="n">a85</span><span class="o">-</span><span class="mi">3</span><span class="n">c2c</span><span class="o">-</span><span class="mi">43</span><span class="n">f3</span><span class="o">-</span><span class="n">aca7</span><span class="o">-</span><span class="n">b99c7043d7af</span>
<span class="n">State</span><span class="p">:</span> <span class="n">Peer</span> <span class="ow">in</span> <span class="n">Cluster</span> <span class="p">(</span><span class="n">Connected</span><span class="p">)</span>

<span class="n">Hostname</span><span class="p">:</span> <span class="n">worker3</span>
<span class="n">Uuid</span><span class="p">:</span> <span class="mi">96</span><span class="n">a821b3</span><span class="o">-</span><span class="mi">6232</span><span class="o">-</span><span class="mi">4</span><span class="n">b8b</span><span class="o">-</span><span class="mi">99</span><span class="n">a6</span><span class="o">-</span><span class="mi">830</span><span class="n">b4fd17110</span>
<span class="n">State</span><span class="p">:</span> <span class="n">Peer</span> <span class="ow">in</span> <span class="n">Cluster</span> <span class="p">(</span><span class="n">Connected</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">Hostname</span><span class="p">:</span> <span class="n">worker7</span>
<span class="n">Uuid</span><span class="p">:</span> <span class="n">c9262857</span><span class="o">-</span><span class="mi">7</span><span class="n">f56</span><span class="o">-</span><span class="mi">4500</span><span class="o">-</span><span class="n">a2d4</span><span class="o">-</span><span class="mi">5</span><span class="n">c81767a27cf</span>
<span class="n">State</span><span class="p">:</span> <span class="n">Peer</span> <span class="ow">in</span> <span class="n">Cluster</span> <span class="p">(</span><span class="n">Connected</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="id7">
<h3>设置GlusterFS卷<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>在 <strong>所有服务器</strong> 上执行以下命令创建一个GlusterFS卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
<li><p>然后在 <strong>任意一台服务器</strong> 上执行创建卷命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">create</span> <span class="n">gv0</span> <span class="n">replica</span> <span class="mi">3</span> \
   <span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker3</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker4</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker5</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker6</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker7</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>这里报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">number</span> <span class="n">of</span> <span class="n">bricks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">multiple</span> <span class="n">of</span> <span class="n">replica</span> <span class="n">count</span>

<span class="n">Usage</span><span class="p">:</span>
<span class="n">volume</span> <span class="n">create</span> <span class="o">&lt;</span><span class="n">NEW</span><span class="o">-</span><span class="n">VOLNAME</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">stripe</span> <span class="o">&lt;</span><span class="n">COUNT</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[[</span><span class="n">replica</span> <span class="o">&lt;</span><span class="n">COUNT</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">arbiter</span> <span class="o">&lt;</span><span class="n">COUNT</span><span class="o">&gt;</span><span class="p">]]</span><span class="o">|</span><span class="p">[</span><span class="n">replica</span> <span class="mi">2</span> <span class="n">thin</span><span class="o">-</span><span class="n">arbiter</span> <span class="mi">1</span><span class="p">]]</span> <span class="p">[</span><span class="n">disperse</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">COUNT</span><span class="o">&gt;</span><span class="p">]]</span> <span class="p">[</span><span class="n">disperse</span><span class="o">-</span><span class="n">data</span> <span class="o">&lt;</span><span class="n">COUNT</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">redundancy</span> <span class="o">&lt;</span><span class="n">COUNT</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">transport</span> <span class="o">&lt;</span><span class="n">tcp</span><span class="o">|</span><span class="n">rdma</span><span class="o">|</span><span class="n">tcp</span><span class="p">,</span><span class="n">rdma</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">NEW</span><span class="o">-</span><span class="n">BRICK</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">TA</span><span class="o">-</span><span class="n">BRICK</span><span class="o">&gt;...</span> <span class="p">[</span><span class="n">force</span><span class="p">]</span>
</pre></div>
</div>
<p>也就是说，要求bricks数量必须是replica数量的整数倍。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请参考 <a class="reference internal" href="../admin/gluster_split_brain_deal.html#gluster-split-brain-deal"><span class="std std-ref">GlusterFS脑裂和解决方案</span></a> 的实现原理：对于稳定的分布式文件系统，需要采用3副本(3 replicas)或者2副本+1个仲裁卷来确保客户端写入时能够根据quorum来判断集群的可用性，避免脑裂。</p>
<p>不管怎样，每个文件的存储都需要3个卷来负责，所以构建brick的数量必须是3的倍数。</p>
<p>如果你的资金有限(需要节约存储空间)，则可以采用2个数据卷+1个仲裁卷(仲裁卷可以大幅节约存储空间)；但是对于数据安全性要求较高的场景，依然建议采用3副本数据卷方案。</p>
</div>
<p>但是，需要注意需要把一个文件的多个副本存放到不同服务器上，就需要特别注意 <strong>brick的顺序</strong> 。正确的方式是首先依次列出所有服务器的第一个brick，然后再列出所有服务器的第二个brick，依次类推。这样GlusterFS才能正确把文件的副本存放到不同的服务器上。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果你使用的是非常高端的多存储设备服务器，尤其需要在构建glusterfs时采用正确的gluster brick顺序，避免多副本数据都集中到少数服务器上导致无法容灾。</p>
</div>
<p>由于这里采用了错误的bricks数量(必须是3的整数倍)，所以我这里修订，剔除掉 <code class="docutils literal notranslate"><span class="pre">worker7</span></code> 节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">peer</span> <span class="n">detach</span> <span class="n">worker7</span>
</pre></div>
</div>
<p>此时提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>All clients mounted through the peer which is getting detached need to be remounted using one of the other active peers in the trusted storage pool to ensure client gets notification on any changes done on the gluster configuration and if the same has been done do you want to proceed? (y/n)
</pre></div>
</div>
<p>输入 <code class="docutils literal notranslate"><span class="pre">y</span></code> 剔除掉节点 <code class="docutils literal notranslate"><span class="pre">worker7</span></code> ，这样集群中只保留6个服务器节点，每个节点有一个 <code class="docutils literal notranslate"><span class="pre">brick1</span></code> 。</p>
<ul>
<li><p>然后重新构建存储卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">create</span> <span class="n">gv0</span> <span class="n">replica</span> <span class="mi">3</span> \
   <span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker3</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker4</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker5</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
   <span class="n">worker6</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>此时提示数据卷建立:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volume</span> <span class="n">create</span><span class="p">:</span> <span class="n">gv0</span><span class="p">:</span> <span class="n">success</span><span class="p">:</span> <span class="n">please</span> <span class="n">start</span> <span class="n">the</span> <span class="n">volume</span> <span class="n">to</span> <span class="n">access</span> <span class="n">data</span>
</pre></div>
</div>
<ul>
<li><p>启动存储卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">start</span> <span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volume</span> <span class="n">start</span><span class="p">:</span> <span class="n">gv0</span><span class="p">:</span> <span class="n">success</span>
</pre></div>
</div>
<ul>
<li><p>现在可以检查卷状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">info</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Volume</span> <span class="n">Name</span><span class="p">:</span> <span class="n">gv0</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">Distributed</span><span class="o">-</span><span class="n">Replicate</span>
<span class="n">Volume</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5842</span><span class="n">afec</span><span class="o">-</span><span class="n">f6c9</span><span class="o">-</span><span class="mi">4530</span><span class="o">-</span><span class="n">bc90</span><span class="o">-</span><span class="mi">7</span><span class="n">f92705d3bdd</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Started</span>
<span class="n">Snapshot</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">Bricks</span><span class="p">:</span> <span class="mi">2</span> <span class="n">x</span> <span class="mi">3</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">Transport</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">tcp</span>
<span class="n">Bricks</span><span class="p">:</span>
<span class="n">Brick1</span><span class="p">:</span> <span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick2</span><span class="p">:</span> <span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick3</span><span class="p">:</span> <span class="n">worker3</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick4</span><span class="p">:</span> <span class="n">worker4</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick5</span><span class="p">:</span> <span class="n">worker5</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick6</span><span class="p">:</span> <span class="n">worker6</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Options</span> <span class="n">Reconfigured</span><span class="p">:</span>
<span class="n">transport</span><span class="o">.</span><span class="n">address</span><span class="o">-</span><span class="n">family</span><span class="p">:</span> <span class="n">inet</span>
<span class="n">storage</span><span class="o">.</span><span class="n">fips</span><span class="o">-</span><span class="n">mode</span><span class="o">-</span><span class="n">rchecksum</span><span class="p">:</span> <span class="n">on</span>
<span class="n">nfs</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span> <span class="n">on</span>
<span class="n">performance</span><span class="o">.</span><span class="n">client</span><span class="o">-</span><span class="n">io</span><span class="o">-</span><span class="n">threads</span><span class="p">:</span> <span class="n">off</span>
</pre></div>
</div>
<p>注意上述卷信息中需要显示状态 <code class="docutils literal notranslate"><span class="pre">Status:</span> <span class="pre">Started</span></code> ，如果状态不是启动状态，则需要检查 <code class="docutils literal notranslate"><span class="pre">/var/log/glusterfs/glusterd.log</span></code> 排查。</p>
<ul>
<li><p>启动存储卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">start</span> <span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volume</span> <span class="n">start</span><span class="p">:</span> <span class="n">gv0</span><span class="p">:</span> <span class="n">success</span>
</pre></div>
</div>
<ul>
<li><p>现在可以检查卷状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">info</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Volume</span> <span class="n">Name</span><span class="p">:</span> <span class="n">gv0</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">Distributed</span><span class="o">-</span><span class="n">Replicate</span>
<span class="n">Volume</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5842</span><span class="n">afec</span><span class="o">-</span><span class="n">f6c9</span><span class="o">-</span><span class="mi">4530</span><span class="o">-</span><span class="n">bc90</span><span class="o">-</span><span class="mi">7</span><span class="n">f92705d3bdd</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Started</span>
<span class="n">Snapshot</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">Bricks</span><span class="p">:</span> <span class="mi">2</span> <span class="n">x</span> <span class="mi">3</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">Transport</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">tcp</span>
<span class="n">Bricks</span><span class="p">:</span>
<span class="n">Brick1</span><span class="p">:</span> <span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick2</span><span class="p">:</span> <span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick3</span><span class="p">:</span> <span class="n">worker3</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick4</span><span class="p">:</span> <span class="n">worker4</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick5</span><span class="p">:</span> <span class="n">worker5</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick6</span><span class="p">:</span> <span class="n">worker6</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Options</span> <span class="n">Reconfigured</span><span class="p">:</span>
<span class="n">transport</span><span class="o">.</span><span class="n">address</span><span class="o">-</span><span class="n">family</span><span class="p">:</span> <span class="n">inet</span>
<span class="n">storage</span><span class="o">.</span><span class="n">fips</span><span class="o">-</span><span class="n">mode</span><span class="o">-</span><span class="n">rchecksum</span><span class="p">:</span> <span class="n">on</span>
<span class="n">nfs</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span> <span class="n">on</span>
<span class="n">performance</span><span class="o">.</span><span class="n">client</span><span class="o">-</span><span class="n">io</span><span class="o">-</span><span class="n">threads</span><span class="p">:</span> <span class="n">off</span>
</pre></div>
</div>
<p>注意上述卷信息中需要显示状态 <code class="docutils literal notranslate"><span class="pre">Status:</span> <span class="pre">Started</span></code> ，如果状态不是启动状态，则需要检查 <code class="docutils literal notranslate"><span class="pre">/var/log/glusterfs/glusterd.log</span></code> 排查。</p>
<ul>
<li><p>启动存储卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">start</span> <span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volume</span> <span class="n">start</span><span class="p">:</span> <span class="n">gv0</span><span class="p">:</span> <span class="n">success</span>
</pre></div>
</div>
<ul>
<li><p>现在可以检查卷状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">info</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Volume</span> <span class="n">Name</span><span class="p">:</span> <span class="n">gv0</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">Distributed</span><span class="o">-</span><span class="n">Replicate</span>
<span class="n">Volume</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5842</span><span class="n">afec</span><span class="o">-</span><span class="n">f6c9</span><span class="o">-</span><span class="mi">4530</span><span class="o">-</span><span class="n">bc90</span><span class="o">-</span><span class="mi">7</span><span class="n">f92705d3bdd</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Started</span>
<span class="n">Snapshot</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">Bricks</span><span class="p">:</span> <span class="mi">2</span> <span class="n">x</span> <span class="mi">3</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">Transport</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">tcp</span>
<span class="n">Bricks</span><span class="p">:</span>
<span class="n">Brick1</span><span class="p">:</span> <span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick2</span><span class="p">:</span> <span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick3</span><span class="p">:</span> <span class="n">worker3</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick4</span><span class="p">:</span> <span class="n">worker4</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick5</span><span class="p">:</span> <span class="n">worker5</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick6</span><span class="p">:</span> <span class="n">worker6</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Options</span> <span class="n">Reconfigured</span><span class="p">:</span>
<span class="n">transport</span><span class="o">.</span><span class="n">address</span><span class="o">-</span><span class="n">family</span><span class="p">:</span> <span class="n">inet</span>
<span class="n">storage</span><span class="o">.</span><span class="n">fips</span><span class="o">-</span><span class="n">mode</span><span class="o">-</span><span class="n">rchecksum</span><span class="p">:</span> <span class="n">on</span>
<span class="n">nfs</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span> <span class="n">on</span>
<span class="n">performance</span><span class="o">.</span><span class="n">client</span><span class="o">-</span><span class="n">io</span><span class="o">-</span><span class="n">threads</span><span class="p">:</span> <span class="n">off</span>
</pre></div>
</div>
<p>注意上述卷信息中需要显示状态 <code class="docutils literal notranslate"><span class="pre">Status:</span> <span class="pre">Started</span></code> ，如果状态不是启动状态，则需要检查 <code class="docutils literal notranslate"><span class="pre">/var/log/glusterfs/glusterd.log</span></code> 排查。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>GlusterFS支持多种 <a class="reference internal" href="../admin/gluster_volume.html#gluster-volume"><span class="std std-ref">GlusterFS卷</span></a> ，通常对于生产环境，建议使用数据高可用的 <code class="docutils literal notranslate"><span class="pre">Replicated</span></code> 卷，或者 <code class="docutils literal notranslate"><span class="pre">Distributed</span> <span class="pre">Replicated</span></code> 卷。</p>
<p>这里的案例指定 <code class="docutils literal notranslate"><span class="pre">replica</span> <span class="pre">3</span></code> 也就是多副本卷，但是由于同时提供了多个3x数量的brick，所以就自然形成了分布式多副本卷( <code class="docutils literal notranslate"><span class="pre">Distributed</span> <span class="pre">Replicated</span></code> )。这种场景非常适合大规模的海量存储。</p>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>使用GlusterFS卷<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<p>通常为了结构清晰和便于维护，GlusterFS客户端和服务器是采用分离部署的。这里我们把刚才剔除掉的 <code class="docutils literal notranslate"><span class="pre">worker7</span></code> 作为客户端来测试刚才构建的数据卷。当然，客户端和服务器端部署在相同服务器上也是可以的，但是需要确保GlusterFS服务端比客户端先启动并就绪，否则可能会导致客户端异常。</p>
<div class="section" id="id9">
<h3>客户端GlusterFS软件安装<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>在客户端不需要安装完整的glusterfs软件包，只需要安装 <code class="docutils literal notranslate"><span class="pre">gluster-fuse</span></code> 软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="n">glusterfs</span><span class="o">-</span><span class="n">fuse</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>客户端挂载GlusterFS卷<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">worker7</span></code> 上创建挂载目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">glusterfs</span></code> 类型挂载存储卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">glusterfs</span> <span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
<li><p>检查挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filesystem</span>      <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="o">...</span>
<span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span>    <span class="mi">466</span><span class="n">G</span>  <span class="mf">8.0</span><span class="n">G</span>  <span class="mi">458</span><span class="n">G</span>   <span class="mi">2</span><span class="o">%</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
<ul>
<li><p>检查挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span> <span class="n">on</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gv0</span> <span class="nb">type</span> <span class="n">fuse</span><span class="o">.</span><span class="n">glusterfs</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">user_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">default_permissions</span><span class="p">,</span><span class="n">allow_other</span><span class="p">,</span><span class="n">max_read</span><span class="o">=</span><span class="mi">131072</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在实际生产环境，可以采用DNS轮询的方式，通过DNS解析到多个服务器节点，这样挂载时即使有服务器节点故障，依然可以通过正常工作的服务器节点获得glusterfs的挂载信息配置。实际上 <code class="docutils literal notranslate"><span class="pre">worker1</span></code> 只是提供客户端下载GlusterFS卷配置信息的服务器节点，客户端实际上是和集群的所有服务器进行通讯和读写数据。</p>
</div>
<ul>
<li><p>测试文件存储:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in `seq -w 1 100`; do cp -rp /var/log/messages /data/gv0/copy-test-$i;done
</pre></div>
</div>
</li>
</ul>
<p>我估算了一下，12秒钟复制了 27MB*100 = 2.7GB 数据，大约写入速度是 245MB/s (连续大文件写入)</p>
</div>
<div class="section" id="id11">
<h3>GlusterFS文件分布<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>上述6个brick，按照顺序排列，可以在 <code class="docutils literal notranslate"><span class="pre">worker1</span></code> 节点 <code class="docutils literal notranslate"><span class="pre">/data/brick1/gv0</span></code> 目录下看到文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">001</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">004</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">006</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">008</span>
<span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">worker2</span></code> 对应目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">001</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">004</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">006</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">008</span>
<span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">worker3</span></code> 对应目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">001</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">004</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">006</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">008</span>
<span class="o">...</span>
</pre></div>
</div>
<p>从 <code class="docutils literal notranslate"><span class="pre">worker4</span></code> 对应目录开始分布第二个文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">002</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">003</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">005</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">007</span>
<span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">worker5</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">002</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">003</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">005</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">007</span>
<span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">worker6</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">002</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">003</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">005</span>
<span class="n">copy</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">007</span>
<span class="o">...</span>
</pre></div>
</div>
<p>可以看到文件分布是按照文件名进行hash后存放到对应brick上，每个brick是一个完整的文件，所以如果出现某些异常情况，是可以通过直接复制brick中文件来恢复的。</p>
<p>这种 <code class="docutils literal notranslate"><span class="pre">replica</span></code> 卷中存储的文件是每个原始文件的完整副本，所以比较容易恢复。如果是采用 <code class="docutils literal notranslate"><span class="pre">dispersed</span></code> 卷(纠错卷)(dispersed英文原意是色散)，则基于ErasureCodes（纠错码），类似RAID5/6。通过配置Redundancy（冗余）级别提高可靠性，在保证较高的可靠性同时，可以提升物理存储空间的利用率。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>参考 <a class="reference external" href="https://blog.csdn.net/xdgouzongmei/article/details/52748812">GlusterFS Dispersed Volume(纠错卷)总结</a></p>
</div>
</div>
</div>
<div class="section" id="id12">
<h2>参考<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.gluster.org/en/latest/Quick-Start-Guide/Quickstart/">Getting started with GlusterFS - Quick Start Guide</a></p></li>
<li><p><a class="reference external" href="https://linuxhint.com/creating-and-resizing-xfs-partitions/">Creating and Resizing XFS Partitions</a></p></li>
<li><p><a class="reference external" href="https://www.golinuxcloud.com/glusterfs-distributed-volume-centos-rhel-8/">Install &amp; configure glusterfs distributed volume RHEL/CentOS 8</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../admin/index.html" class="btn btn-neutral float-right" title="GlusterFS管理" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="gluster_architecture.html" class="btn btn-neutral float-left" title="GlusterFS架构" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../copyright.html">Copyright</a> 2019, Huatai Huang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>