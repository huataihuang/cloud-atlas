<!DOCTYPE html>
<html class="writer-html5" lang="zh" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PCIe bifurcation &mdash; Cloud Atlas: Discovery beta 文档</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=8534f863"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../../copyright.html" />
    <link rel="next" title="PLX 8747硬件PCIe bifurcation" href="plx_8747_pcie_bifurcation.html" />
    <link rel="prev" title="HPE DL360 Gen9服务器内存配置" href="dl360_config_mem.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Cloud Atlas: Discovery
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../studio/index.html">Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devops/index.html">DevOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kvm/index.html">KVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ceph/index.html">Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gluster/index.html">Gluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ovirt/index.html">oVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openstack/index.html">OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../k8s_dev/index.html">Kubernetes Develop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rancher/index.html">Rancher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openshift/index.html">OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sql/index.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sqlite/index.html">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/index.html">MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pgsql/index.html">PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nosql/index.html">NoSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../network/index.html">Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_service/index.html">Infra-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_search/index.html">Infra-Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web/index.html">Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info_service/index.html">Info-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../big_data/index.html">Big Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../machine_learning/index.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../drone/index.html">Drone</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../best_linux.html">最佳Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../admin/index.html">Linux系统管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../redhat_linux/index.html">RedHat Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../arch_linux/index.html">Arch Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../asahi_linux/index.html">Asahi Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gentoo_linux/index.html">Gentoo Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../lfs/index.html">LFS(Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../blfs/index.html">BLFS(Beyond Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../alfs/index.html">ALFS(Automated Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pilfs/index.html">PiLFS(Automated Linux from scratch on the Raspberry Pi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../yocto/index.html">Yocto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ubuntu_linux/index.html">Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../suse_linux/index.html">SUSE Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../kali_linux/index.html">Kali Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tails_linux/index.html">Tails Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../qubes_os/index.html">Qubes OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../postmarketos/index.html">postmarketOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../container_os/index.html">容器化操作系统(Container OS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../fedora_coreos/index.html">Fedora CoreOS容器操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../chromeos/index.html">ChromeOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../alpine_linux/index.html">Alpine Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../subgraph_os/index.html">Subgraph OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../kaios/index.html">KaiOS - 世界第三手机操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../compute/index.html">Linux计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../storage/index.html">Linux存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../network/index.html">Linux网络</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Linux服务器</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">服务器硬件</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../edac.html">EDAC 诊断系统硬件故障</a></li>
<li class="toctree-l4"><a class="reference internal" href="../lm_sensor.html">lm_sensors(Linux监控传感器)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../hwinfo.html">Linux系统硬件信息检测工具hwinfo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../lspci.html">lspci</a></li>
<li class="toctree-l4"><a class="reference internal" href="../check_server_temp.html">服务器温度检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="../lackpack.html">LackPack</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dell/index.html">Dell服务器</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">HPE服务器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../fanless/index.html">无风扇服务器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../chipset/index.html">服务器主板芯片</a></li>
<li class="toctree-l4"><a class="reference internal" href="../storage/index.html">服务器存储</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../uefi/index.html">Linux UEFI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ipmi/index.html">IPMI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cockpit/index.html">Cockpit服务器统一管理平台</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../collectd/index.html">collectd - 系统信息采集服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../osquery/index.html">osquery</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../security/index.html">Linux安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../desktop/index.html">Linux桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../linux_tablet/index.html">Linux平板</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernel/index.html">Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../performance/index.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed_system/index.html">Distributed System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../shell/index.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django/index.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/index.html">JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nodejs/index.html">Node.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../clang/index.html">C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../golang/index.html">Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../swift/index.html">Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rust/index.html">Rust</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ruby/index.html">Ruby</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lua/index.html">Lua</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arm/index.html">ARM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../raspberry_pi/index.html">Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../android/index.html">Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bsd/index.html">BSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../freebsd/index.html">FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apple/index.html">Apple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../windows/index.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../real/index.html">Real</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../management/index.html">Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../life/index.html">Life</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Cloud Atlas: Discovery</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Linux</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Linux服务器</a></li>
          <li class="breadcrumb-item"><a href="../index.html">服务器硬件</a></li>
          <li class="breadcrumb-item"><a href="index.html">HPE服务器</a></li>
      <li class="breadcrumb-item active">PCIe bifurcation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/linux/server/hardware/hpe/pcie_bifurcation.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pcie-bifurcation">
<span id="id1"></span><h1>PCIe bifurcation<a class="headerlink" href="#pcie-bifurcation" title="Link to this heading"></a></h1>
<p><a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 支持PCIe直接使用NVMe存储，这样可以在服务器上实现高性能存储集群。(原厂的 U.2 接口NVMe SSD存储升级套件实在成本太高)</p>
<section id="pcie">
<h2>PCIe拆分卡<a class="headerlink" href="#pcie" title="Link to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>请注意， <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 只支持第一个PCIe 3.0 x16的bifurcation功能，并且只支持 <code class="docutils literal notranslate"><span class="pre">Dual</span> <span class="pre">PCIe</span> <span class="pre">x8</span> <span class="pre">slot</span></code> ，也就是只能切分成2个 <code class="docutils literal notranslate"><span class="pre">x8</span></code> 。所以最多只能在Slot 1上支持2块NVMe SSD。</p>
<p>对于 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 最好使用 <code class="docutils literal notranslate"><span class="pre">双盘NVMe扩展卡</span></code> ，我购买4盘位NVMe扩展卡实际上上浪费了资源，并不是很好的选择。</p>
</div>
<section id="pcie-x16-nvme">
<h3>PCIe X16 四盘NVMe扩展卡<a class="headerlink" href="#pcie-x16-nvme" title="Link to this heading"></a></h3>
<p>在淘宝上可以购买到 PCIe X16 四盘NVMe扩展卡:</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_nvme_extendcard.png"><img alt="../../../../_images/pcie_nvme_extendcard.png" src="../../../../_images/pcie_nvme_extendcard.png" style="width: 333.6px; height: 333.6px;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_nvme_extendcard-1.png"><img alt="../../../../_images/pcie_nvme_extendcard-1.png" src="../../../../_images/pcie_nvme_extendcard-1.png" style="width: 586.4px; height: 422.40000000000003px;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_nvme_extendcard-2.png"><img alt="../../../../_images/pcie_nvme_extendcard-2.png" src="../../../../_images/pcie_nvme_extendcard-2.png" style="width: 623.2px; height: 646.4000000000001px;" /></a>
</figure>
</section>
<section id="pcie-x16x8-x4-x4">
<span id="pcie-bifurcation-x4x4x8-card"></span><h3>PCIe X16转x8+x4+x4拆分卡<a class="headerlink" href="#pcie-x16x8-x4-x4" title="Link to this heading"></a></h3>
<p>我在2025年购置组装的主机使用了 <a class="reference internal" href="../chipset/nasse_c246.html#nasse-c246"><span class="std std-ref">纳斯NASSE C246 ITX主板</span></a> ，这种台式机主板(通常)支持将PCIe X16拆分成 <code class="docutils literal notranslate"><span class="pre">X8X8</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">X4X4X8</span></code> ，也就是最多可以转接3个设备。为了能够充分利用硬件，我购买了一块 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">X16转x8+x4+x4拆分卡</span></code> :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">X16转x8+x4+x4拆分卡</span></code> 正反两面各提供一个 M.2 <a class="reference internal" href="../../../storage/nvme/nvme.html#nvme"><span class="std std-ref">NVMe存储</span></a> ，这样可以安装2块存储</p></li>
<li><p>拆分后还有一个 <code class="docutils literal notranslate"><span class="pre">X8</span></code> 信号PCIe插槽(X16接口形式)，用来安装我的 <a class="reference internal" href="../../../../machine_learning/hardware/nvidia_gpu/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a></p></li>
</ul>
<p>这样我的台式主机不仅可以继续使用 <a class="reference internal" href="../../../../machine_learning/hardware/nvidia_gpu/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a> ，又增加了2个存储，加上主板自带的2个存储，总共有4个 M.2 <a class="reference internal" href="../../../storage/nvme/nvme.html#nvme"><span class="std std-ref">NVMe存储</span></a> 存储，大大方便我组件 <a class="reference internal" href="../../../storage/zfs/index.html#zfs"><span class="std std-ref">ZFS</span></a> RAIDZ来模拟演练和学习实践</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_nvme_extendcard.jpg"><img alt="../../../../_images/pcie_nvme_extendcard.jpg" src="../../../../_images/pcie_nvme_extendcard.jpg" style="width: 320.0px; height: 739.2px;" /></a>
</figure>
</section>
</section>
<section id="id2">
<h2>PCIe bifurcation<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>需要注意，扩展卡是 PCIe x16 规格的，为了能够支持4个NVMe m.2 存储，需要将这个 X16 分成4个 X4 才能支持4个NVMe盘。需要主板支持一种称为 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 技术，这样在主板BIOS中可以将 PCIe X16 改成 <code class="docutils literal notranslate"><span class="pre">x4x4x4x4</span></code></p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_bifurcation-1.png"><img alt="../../../../_images/pcie_bifurcation-1.png" src="../../../../_images/pcie_bifurcation-1.png" style="width: 612.8000000000001px; height: 648.0px;" /></a>
</figure>
<p>参考HP官方文档，DL360 gen10 是支持 PCIe Bifurcation 的:</p>
<p><code class="docutils literal notranslate"><span class="pre">System</span> <span class="pre">Configuration</span> <span class="pre">&gt;</span> <span class="pre">BIOS/Platform</span> <span class="pre">Configuration</span> <span class="pre">(RBSU)</span> <span class="pre">&gt;</span> <span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span> <span class="pre">&gt;</span> <span class="pre">PCIe</span> <span class="pre">Bifurcation</span> <span class="pre">Options</span></code></p>
<p>对于 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 我执行完成 <a class="reference internal" href="dl360_bios_upgrade.html#dl360-bios-upgrade"><span class="std std-ref">HPE DL360 BIOS升级</span></a> 然后经过多方验证，发现 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 对 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 支持有限，见下文。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 的第一个 <code class="docutils literal notranslate"><span class="pre">主PCIe3.0</span> <span class="pre">x16</span></code> 只支持对半分，如果不想投入太高成本，则可以选择购买 双盘位NVMe直通扩展卡，配合 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">2</span></code> 的第3个NVMe SSD，也能够实现成本最低性能最好的存储扩展方案。</p>
</div>
</section>
<section id="pciebifuration">
<h2>PCIe设备和bifuration<a class="headerlink" href="#pciebifuration" title="Link to this heading"></a></h2>
<p>参考 <a class="reference external" href="https://community.hpe.com/t5/Servers-General/HPE-Proliant-dl160-gen9-bifurcation/td-p/7133232#.YXdM-y8RppQ">HPE Proliant dl160 gen9 bifurcation</a> 提到:</p>
<ul>
<li><p>有人提出 DL360和DL380更新到最新的Bios 2.90也没有出现 <code class="docutils literal notranslate"><span class="pre">pcie</span> <span class="pre">options</span></code> 选项，不过， <code class="docutils literal notranslate"><span class="pre">dual</span> <span class="pre">bifuration</span></code> 支持是从 2016 年开始的，在 <a class="reference external" href="https://support.hpe.com/hpesc/public/docDisplay?docLocale=en_US&amp;docId=c05060771">HPE UEFI System Utilities and Shell Release Notes for HPE ProLiant Gen9 Servers</a> 文档第5页(2016年文档)有说明:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Addedsupportto</span> <span class="n">configurethe</span> <span class="n">systemto</span> <span class="n">bifurcatePCIe</span> <span class="n">Slot</span> <span class="mi">1</span> <span class="n">on</span> <span class="n">the</span> <span class="n">DL360Gen9</span> <span class="ow">or</span> <span class="n">PCIeSlot</span> <span class="mi">2</span> <span class="n">on</span> <span class="n">the</span> <span class="n">DL380Gen9</span>
</pre></div>
</div>
</li>
</ul>
<p>也就是说对于 DL360 Gen9 是支持Slot 1的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> ，对于 DL380 Gen9 则支持 Slot 2的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bitfurcaton</span></code></p>
<ul class="simple">
<li><p>HP的人说DL360和DL380 Gen9是支持，但是需要PCIe扩展卡厂商的部件适配bifurcate，部件需要和firmware和驱动适配正确的速率才能实现 x8 / x4 。所以，这可能是没有插入PCIe扩展卡就看不到 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuratio</span></code> 选项的原因？</p></li>
</ul>
<p>参考 <a class="reference external" href="https://linustechtips.com/topic/1279595-hpe-gen9-with-asus-hyper-m2-x16-card-v2/">HPE Gen9 with asus hyper m.2 x16 card v2</a> 提到有人购买了 Asus hyper m.2 x16 card v2 以及 4块 Samsung 970 plus:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 需要CPU和主板同时支持，Intel E5 v3处理器支持 <code class="docutils literal notranslate"><span class="pre">40个</span></code> PCIe 路径(lanes)</p></li>
</ul>
<p>参考 <a class="reference external" href="https://www.manualslib.com/manual/1391841/Hpe-Proliant-Gen10.html?page=120">Setting Gpu Configurations; Selecting Pcie Bifurcation Options; Configuring Specific Pcie Devices - HPE ProLiant Gen10 User Manual</a> 说明了对于GPU设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">System</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">BIOS</span><span class="o">/</span><span class="n">Platform</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">RBSU</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PCIe</span> <span class="n">Device</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">GPU</span> <span class="n">CFG</span>
</pre></div>
</div>
<p>有2个选项:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>4:1—Maps 4 PCIe slots to each installed processor
8:1—Maps all slots to a single processor
</pre></div>
</div>
</section>
<section id="id3">
<h2>我的选择<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<section id="bifurcation">
<h3>直通扩展卡(部分实现bifurcation)<a class="headerlink" href="#bifurcation" title="Link to this heading"></a></h3>
<p>我购买了 3个 <a class="reference internal" href="../../../storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> 以及 佳翼M2X16四盘NVMe扩展卡( 宣传称 <code class="docutils literal notranslate"><span class="pre">支持PCIE</span> <span class="pre">4.0</span> <span class="pre">GEN4，</span> <span class="pre">向下兼容PCIE3.0</span> <span class="pre">GEN3</span></code> )。我比较担心能否配合DL 360 Gen9实现 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code></p>
<ul class="simple">
<li><p>我最初尝试将 NVMe扩展卡 安装在 Slot 3上(因为我想能在 Slot 1上安装显卡，然后可以还留出空间在Slot 2上安装第二个NVMe扩展卡)，但是确实启动以后没有找到PCIe配置选项</p></li>
<li><p>将 NVMe 扩展卡 改到安装到 Slot 1，重新启动系统，检查 <code class="docutils literal notranslate"><span class="pre">BIOS/Platform</span> <span class="pre">Configuration(RBSU)</span></code> 配置选项，依然没有看到 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span></code> 配置入口(只看到 <code class="docutils literal notranslate"><span class="pre">PCI</span> <span class="pre">Device</span> <span class="pre">Enable/Disable</span></code> 激活关闭设置):</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/rbsu_no_pcie_config.png"><img alt="../../../../_images/rbsu_no_pcie_config.png" src="../../../../_images/rbsu_no_pcie_config.png" style="width: 630.4000000000001px; height: 320.0px;" /></a>
</figure>
<p><a class="reference external" href="https://community.hpe.com/t5/Servers-General/HPE-Proliant-dl160-gen9-bifurcation/td-p/7133232#.YXdM-y8RppQ">HPE Proliant dl160 gen9 bifurcation</a> 中答复中也提到了，这个功能需要扩展卡厂商支持firmware，有人换了6个扩展卡都没有看到BIOS能够显示出 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span></code> 配置项。</p>
<p>看起来我购买的 <code class="docutils literal notranslate"><span class="pre">佳翼M2X16四盘NVMe扩展卡</span></code> 也同样没有适配成功???</p>
<p>真是让人非常沮丧，折腾这么久，查询很多资料都没有明确的 HPE Gen9 解决 PCIe bifurction 的解释和适配方法，虽然2016年 <a class="reference external" href="https://support.hpe.com/hpesc/public/docDisplay?docLocale=en_US&amp;docId=c05060771">HPE UEFI System Utilities and Shell Release Notes for HPE ProLiant Gen9 Servers</a> 提到了支持，但是该文档最新2021年版本已经找不到这项说明了。</p>
<p>柳暗花明又一村...</p>
<p>我在DL360 Gen9服务器上安装 <a class="reference internal" href="../../../../machine_learning/hardware/nvidia_gpu/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a> 启动时遇到需要 <a class="reference internal" href="dl360_gen9_large_bar_memory.html#dl360-gen9-large-bar-memory"><span class="std std-ref">HP DL360 Gen9 Large Bar Memory(Tesla P10)</span></a> 问题，HPE DL360 Gen9的 <code class="docutils literal notranslate"><span class="pre">PCI</span> <span class="pre">Express</span> <span class="pre">64-Bit</span> <span class="pre">BAR</span> <span class="pre">Support</span></code> BIOS配置选项隐藏在没有任何提示的 <code class="docutils literal notranslate"><span class="pre">Service</span> <span class="pre">Options</span></code> 菜单中(需要在 <code class="docutils literal notranslate"><span class="pre">ROM-Based</span> <span class="pre">Setup</span> <span class="pre">Utility</span> <span class="pre">(RBSU)</span></code> 界面通过 <code class="docutils literal notranslate"><span class="pre">Ctrl-A</span></code> 激活)，但是没有任何菜单引导。我是通过Google文档才找到方法...</p>
<p>原来在这个隐藏的 <code class="docutils literal notranslate"><span class="pre">Service</span> <span class="pre">Options</span></code> 中提供了很多高级功能，其中就包括了 <code class="docutils literal notranslate"><span class="pre">Primary</span> <span class="pre">Riser</span> <span class="pre">PCIe</span> <span class="pre">x16</span> <span class="pre">Bifurcation</span></code></p>
<section id="hpe-dl360-gen9-biosbifurcatio">
<h4>HPE DL360 Gen9 BIOS设置Bifurcatio<a class="headerlink" href="#hpe-dl360-gen9-biosbifurcatio" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>启动服务器，在BIOS提示时，按下 <code class="docutils literal notranslate"><span class="pre">F9</span></code> 进入 <code class="docutils literal notranslate"><span class="pre">ROM-Based</span> <span class="pre">Setup</span> <span class="pre">Utility</span> <span class="pre">(RBSU)</span></code></p></li>
<li><p>在RBSU中，按下 <code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">A</span></code> ，进入 <code class="docutils literal notranslate"><span class="pre">Service</span> <span class="pre">Options</span></code></p></li>
<li><p>通过上下键移动菜单高亮，选择 <code class="docutils literal notranslate"><span class="pre">Primary</span> <span class="pre">Riser</span> <span class="pre">PCIe</span> <span class="pre">x16</span> <span class="pre">Bifurcation</span></code> ，然后按下回车</p></li>
<li><p>此时可以看到提供了2个选项:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">x16</span> <span class="pre">slot</span></code> 保持默认的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">3.0</span> <span class="pre">x16</span></code> 直接输出</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Dual</span> <span class="pre">PCIe</span> <span class="pre">x8</span> <span class="pre">Slot</span></code> 将 <code class="docutils literal notranslate"><span class="pre">第一个主</span> <span class="pre">PCIe</span> <span class="pre">3.0</span> <span class="pre">x16</span></code> 分成2个 <code class="docutils literal notranslate"><span class="pre">x8</span></code> 通道</p></li>
</ul>
</li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/rbsu_pcie_bifurcation.png"><img alt="../../../../_images/rbsu_pcie_bifurcation.png" src="../../../../_images/rbsu_pcie_bifurcation.png" style="width: 633.6px; height: 469.6px;" /></a>
</figure>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>很不幸，HPE DL360 Gen9的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Bifurcation</span></code> 有很大的限制，不能将 <code class="docutils literal notranslate"><span class="pre">x16</span></code> 切分成 <code class="docutils literal notranslate"><span class="pre">x4x4x4x4</span></code> ，只能对半分成 <code class="docutils literal notranslate"><span class="pre">x8x8</span></code> ；并且 <code class="docutils literal notranslate"><span class="pre">Bifurcation</span></code> 仅限于第一个主 PCIe 插槽。</p>
<p>也就是说，实际上即使使用了第一个插槽的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Bifurcation</span></code> 也就只能增多一个 NVMe SSD存储，实现价值大打了折扣，并没有我最初设想的能够在一个 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">3.0</span> <span class="pre">x16</span></code> 上连接4个NVMe SSD存储实现阵列。</p>
</div>
<p>很遗憾，HP DL360只能实现在第一个PCIe 3.0x16分成2个 <code class="docutils literal notranslate"><span class="pre">x8</span></code> ，所以我最初想通过 <code class="docutils literal notranslate"><span class="pre">佳翼M2X16四盘NVMe扩展卡</span></code> 并行使用 <code class="docutils literal notranslate"><span class="pre">4个</span> <span class="pre">NVMe</span> <span class="pre">SSD</span></code> 的方案并不能实现。通过直通方式只能连接 <code class="docutils literal notranslate"><span class="pre">2个</span> <span class="pre">NVMe</span> <span class="pre">SSD</span></code> 使得这个方案非常鸡肋(不过也许性能可以较好)。</p>
<p>出于成本和性能，我还是决定采用此方案:</p>
<ul class="simple">
<li><p>主 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">3.0</span> <span class="pre">x16</span></code> Slot 1 通过DL 360 Gen9内置 PCIe bifurcation 分成 <code class="docutils literal notranslate"><span class="pre">x8</span> <span class="pre">x8</span></code> ，安装 <code class="docutils literal notranslate"><span class="pre">佳翼M2X16四盘NVMe扩展卡</span></code> (沉没成本，虽然不能充分利用4盘位) ，使用 2 块 <a class="reference internal" href="../../../storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">3.0</span> <span class="pre">x8</span></code> Slot 2不支持PCIe bifurcation，所以购买单盘NVMe扩展卡</p></li>
<li><p>主机总共安装3个NVMe SSD:</p>
<ul>
<li><p>由于 Slot 1 和 Slot 2 都是直连在 CPU 1上，所以可以获得极佳的互访性能</p></li>
<li><p>采用 <a class="reference internal" href="../../../../kvm/iommu/index.html#iommu"><span class="std std-ref">IOMMU</span></a> 由第一层 <a class="reference internal" href="../../../../kvm/index.html#kvm"><span class="std std-ref">KVM</span></a> 虚拟机读写，力求能够实现 native 性能</p></li>
<li><p>运行3个 <a class="reference internal" href="../../../../ceph/index.html#ceph"><span class="std std-ref">Ceph</span></a> 虚拟机分别处理 pass-through 的NVMe存储，虚拟机采用cpuset方式绑定到CPU 1上，结合 <a class="reference internal" href="../../../../kernel/memory/numa/index.html#numa"><span class="std std-ref">NUMA架构</span></a> 实现性能最大化</p></li>
</ul>
</li>
</ul>
<p>我有一个疑问，对于4盘位的 <code class="docutils literal notranslate"><span class="pre">佳翼M2X16四盘NVMe扩展卡</span></code> ，BIOS只支持 <code class="docutils literal notranslate"><span class="pre">x8</span> <span class="pre">x8</span></code> ，那么究竟是安装在哪个盘位的磁盘被识别出来呢，实践记录如下:</p>
<ul>
<li><p>按照上文配置好 <code class="docutils literal notranslate"><span class="pre">Primary</span> <span class="pre">Riser</span> <span class="pre">PCIe</span> <span class="pre">x16</span> <span class="pre">Bifurcation</span> <span class="pre">&gt;&gt;</span> <span class="pre">Dual</span> <span class="pre">PCIe</span> <span class="pre">x8</span> <span class="pre">slot</span></code> ，重新启动服务器，登陆系统</p></li>
<li><p>检查磁盘 <code class="docutils literal notranslate"><span class="pre">fdisk</span> <span class="pre">-l</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">nvme</span></code> 可以看到现在识别了2块NVMe SSD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mf">953.89</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024209543168</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000409264</span> <span class="n">sectors</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme1n1</span><span class="p">:</span> <span class="mf">953.89</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024209543168</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000409264</span> <span class="n">sectors</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="plx">
<h3>PLX主控扩展卡<a class="headerlink" href="#plx" title="Link to this heading"></a></h3>
<p>根据网上搜索到到信息了解到，HP gent9 的服务器可以使用PLX主控芯片扩展卡( PLX 是PCIe交换和桥接芯片供应商 )，从淘宝上搜索无需主板支持 <code class="docutils literal notranslate"><span class="pre">bifurcation</span></code> 的扩展卡有两种芯片:</p>
<ul class="simple">
<li><p>ASM2824</p></li>
<li><p>PLX8747 ( <a class="reference external" href="https://www.broadcom.com/products/pcie-switches-bridges/pcie-switches/pex8747">Broadcom PEX8747</a> 就是收购PLX的产品线的PLX8747)</p></li>
</ul>
<p><a class="reference external" href="https://forums.servethehome.com/index.php?threads/multi-nvme-m-2-u-2-adapters-that-do-not-require-bifurcation.31172/">Multi-NVMe (m.2, u.2) adapters that do not require bifurcation</a> 汇总了国外网友搜集的无需主板bifurcation功能就可以支持多个NVMe存储的PCIe扩展卡(aliexpress上由2家中国销售公司售卖的)，主控芯片绝大多数是PLX 8724/8747/8748，少量是ASM芯片。</p>
<p>我购买了 <code class="docutils literal notranslate"><span class="pre">M.2</span> <span class="pre">NVMe</span> <span class="pre">SSD扩展卡</span> <span class="pre">PCIe3.0</span> <span class="pre">X8X16扩2口4口M2</span> <span class="pre">PLX8747</span></code> ：</p>
<ul class="simple">
<li><p>目前google到的英文资料基本都是采用PLX芯片成功的</p></li>
<li><p>PLX是专注于PCIe连接的厂商，被很多NVMe Extend Card采用</p>
<ul>
<li><p><a class="reference external" href="http://www.sunweit.com/product/251-en.html">SUNWEIT PCI-E 3.0 X16 PEX8747 4-M.2 NVMe Extend Card</a></p></li>
<li><p><a class="reference external" href="http://www.asrock.com/news/index.cn.asp?id=2565">华擎X99 WS-E/10G</a> (华擎是从华硕分出的主板制造厂商，售价较低但做工还比较扎实，比不上华硕但是同价位质量较优 <a class="reference external" href="https://www.zhihu.com/question/354822608">感觉华擎的东西做工用料都很扎实呀，为什么都说是二线？</a> ) ，在HP论坛中有信息显示华擎ASrocck的NVMe PLX芯片扩展卡可以在HP gen9服务器上正确工作</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>PLX是半导体行业巨头新博通(Broadcom)旗下企业，原先是安华高公司于2014年收购PLX，2016年安华高公司收购Broadcom后改名Broadcom Limited(新博通)。( <a class="reference external" href="https://zhuanlan.zhihu.com/p/70074321">博通又准备收购芯片公司？|半导体行业观察</a> )</p>
</div>
<ul class="simple">
<li><p>需要注意，接口应该是 PCIe3.0 X16 ，这样拆分4个以后才是 x4x4x4x4 ，可以满足较高速的 NVMe 读写</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/plx8747_pcie_switch_card.jpg"><img alt="../../../../_images/plx8747_pcie_switch_card.jpg" src="../../../../_images/plx8747_pcie_switch_card.jpg" style="width: 320.0px; height: 273.6px;" /></a>
</figure>
<p>既然通过PLX主控芯片实现 <code class="docutils literal notranslate"><span class="pre">bifurcation</span></code> ，所以也就无所谓安装在 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">1</span></code> 还是 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">3</span></code> ；考虑到 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">2</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">3</span></code> 之间空间较大，可以安装2个 PLX主控扩展卡 :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">2</span></code> 是 <code class="docutils literal notranslate"><span class="pre">x8</span></code> 接口，可以安装 双盘位 扩展卡</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">3</span></code> 是 <code class="docutils literal notranslate"><span class="pre">x16</span></code> 接口，可以安装 四盘位 扩展卡</p></li>
<li><p>总共可以扩展安装 <code class="docutils literal notranslate"><span class="pre">6个</span></code> NVMe SSD存储: 需要注意 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">2</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">3</span></code> 分别属于 CPU1 和 CPU2，所以应该分配给不同的虚拟化存储集群:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">2</span></code> 上2个 NVMe SSD 可以组合成 <code class="docutils literal notranslate"><span class="pre">RAID</span> <span class="pre">0</span></code> (性能最强) 或者 <code class="docutils literal notranslate"><span class="pre">RAID</span> <span class="pre">1</span></code> (数据安全性高)；或者分配给2个 <a class="reference internal" href="../../../../gluster/index.html#gluster"><span class="std std-ref">Gluster</span></a> 虚拟机组件镜像模式的GlusterFS集群提供大容量近线数据归档</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">3</span></code> 上4个 NVMe SSD 可以选择3个分配给3个 <a class="reference internal" href="../../../../ceph/index.html#ceph"><span class="std std-ref">Ceph</span></a> 虚拟机组建成 Ceph 高可用高性能虚拟化存储集群；另外1个则分配给物理主机，作为 <a class="reference internal" href="../../../../docker/index.html#docker"><span class="std std-ref">Docker</span></a> 和 <a class="reference internal" href="../../../../kvm/index.html#kvm"><span class="std std-ref">KVM</span></a> 的镜像存储，以及容器和虚拟机本地挂载存储，以获得性能最大化</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>为了降低成本，并且能够使用原生的PCIe NVMe存储访问，所以我最终退掉了新购买的 <code class="docutils literal notranslate"><span class="pre">M.2</span> <span class="pre">NVMe</span> <span class="pre">SSD扩展卡</span> <span class="pre">PCIe3.0</span> <span class="pre">X8X16扩2口4口M2</span> <span class="pre">PLX8747</span></code> 扩展卡，还是采用HP DL360 Gen9直接访问存储。也就是采用前一个方案。</p>
</div>
</section>
</section>
<section id="pcie-switches">
<h2>PCIe switches性能<a class="headerlink" href="#pcie-switches" title="Link to this heading"></a></h2>
<p>Intel的北桥集成在CPU里面，所以原生PCIe通道的数量由CPU决定，主板可以根据需要对这些通道进行重新组合(比方x16 = 1x16 或 1x8+1x8 或 1x8+1x4+1x4)以满足多个pci的需要。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我所使用的二手服务器 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 使用的处理器是 <a class="reference internal" href="../../../../kernel/cpu/intel/xeon_e5/xeon_e5-2670_v3.html#xeon-e5-2670-v3"><span class="std std-ref">Intel Xeon E5-2670 v3处理器</span></a> ，每个处理器提供了 40 个PCIe Lanes</p>
</div>
<p>PCIE Switch (pcie扩充器/转换器/桥) 提供了通道数扩充以及拆分功能，例如 PLX 8747 就可以将一组x16扩充成两组x16，也可以拆分成 x8x8 或者 x4x4x4x4。网上资料显示两路扩展(两组x16)性能可能有损失。</p>
<p>注意配置的拓扑 <a class="reference external" href="https://link.zhihu.com/?target=http%3A//www.cirrascale.com/blog/index.php/exploring-the-pcie-bus-routes/">Exploring the PCIe Bus Routes</a> :</p>
<ul class="simple">
<li><p>如果主板使用PLX芯片，则应该将需要通讯的两个GPU位于同一个PLX芯片下面</p></li>
<li><p>如果两个gpu位于不同的PLX芯片下, 但位于同一个cpu下, 性能次之: 有7%的带宽损失(9.8 vs 10.6 gb/s) 和 7.9 vs 7.7微秒的延迟</p></li>
<li><p>两个gpu位于不同cpu下(自然也不同plx下)性能最次: 有62%的带宽损失和316%的延迟增加 (4 vs 10.6 gb/s, 32.1 vs 7.7)</p></li>
</ul>
<p>我的连接构思:</p>
<ul class="simple">
<li><p>由于 Slot1 和 Slot2 是连接在CPU 1上的PCIe，所以如果考虑多个GPU，可以在Slot1和Slot2上安装2块PGU卡，在Slot 3上安装NVMe存储卡，这样确保GPU之间通讯快速。</p></li>
<li><p>如果使用1个GPU卡 <a class="reference internal" href="../../../../machine_learning/hardware/nvidia_gpu/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a> ，则安装在 Slot 3上，在Slot 1 和 Slot 2上安装NVMe存储扩展开(我就采用这个模式)</p></li>
</ul>
</section>
<section id="pcienvme">
<h2>神奇PCIe拆分NVMe存储<a class="headerlink" href="#pcienvme" title="Link to this heading"></a></h2>
<p>在服务器领域，例如 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 提供了SFF安装模式 <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">SAS/SATA</span> <span class="pre">(Drive</span> <span class="pre">1-4)+6</span> <span class="pre">NVMe</span> <span class="pre">(Drive</span> <span class="pre">5-10)</span></code> ，可以将主机最后6个盘位替换成U.2接口的NVMe SSD磁盘。在 <a class="reference external" href="https://mp.weixin.qq.com/s?__biz=MzAwODExNjI3NA==&amp;mid=2649776369&amp;idx=1&amp;sn=6d90101ad858822ee1ce42db2560edea&amp;chksm=837701acb40088ba205a9d1f29c19ae62dea57bccd1c60e5b36ba67b02181e953827bb290ed8&amp;token=511876318&amp;lang=zh_CN&amp;scene=21#wechat_redirect">Dell PowerEdge R640：NVMe直连、NDC网卡、PERC10一览</a> 可以看到Dell服务器也是通过将 Xeon 处理器内置的 PCIe lanes 分出一部分专用于连接 NVMe SSD。这种模式节约了宝贵的PCIe插槽，同时又提供了满足大量NVMe存储分别连接不同的PCIe lanes的需求，可以实现直通连接，在 <a class="reference internal" href="../../../../kvm/iommu/iommu_infra.html#iommu-infra"><span class="std std-ref">IOMMU架构</span></a> 实现pass-through给虚拟机，实现高性能虚拟化存储。</p>
<p><a class="reference internal" href="../chipset/pcie.html#pcie"><span class="std std-ref">PCIe</span></a> :</p>
<ul class="simple">
<li><p>3.0 的单通道性能是传输速率 984.6MB/s ，使用 ×4 规格已经达到 3.938GB/s ，可以满足 PCIe 3.0 NVMe 的带宽需求</p></li>
<li><p>4.0 的单通道性能是传输速率 1.969GB/s ，使用 ×4 规格达到 7.877GB/s ，可以满足最快的PCIe 4.0 NVMe <a class="reference internal" href="../../../storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> 以及对应企业级 980 Pro的带宽</p></li>
</ul>
<p>传统的RAID技术，在不断推陈出新的NVMe存储技术发展下，也出现了NVMe RAID卡，通过NVMe switch可以实现更多的NVMe设备直连。如果HBA卡没有提供内置的RAID功能，可以采用 <a class="reference internal" href="../../../../kernel/cpu/intel/intel_vroc/index.html#intel-vroc"><span class="std std-ref">Intel Virtual RAID on CPU (Intel VROC)</span></a> 技术，实现全速率的NVMe组件RAID。在使用PEX88048主控芯片的NVMe Switch Adapter (Broadcom P411W-32P)，默认将PCIe 4.0 x16拆分成 4个x8 SFF-8654接口:</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/p411w-32p_8sff.png"><img alt="../../../../_images/p411w-32p_8sff.png" src="../../../../_images/p411w-32p_8sff.png" style="width: 560.0px; height: 430.5px;" /></a>
</figure>
<p>在不集联下一级PCIe Switch情况下，Broadcom P411W-32最多可拆分为32个PCIex1来连接SSD(牺牲了单盘带宽)，可以想象一下使用32个NVMe组建的阵列。</p>
</section>
<section id="id8">
<h2>参考<a class="headerlink" href="#id8" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://zhuanlan.zhihu.com/p/219831641">PCIe Switch Adapter：不只是NVMe HBA？</a></p></li>
<li><p><a class="reference external" href="https://zhuanlan.zhihu.com/p/103929939">硬件杂谈：关于pcie拆分与plx芯片</a></p></li>
<li><p><a class="reference external" href="https://www.zhihu.com/question/50238393/answer/120399606">请问pcie x16/x8以及sli/cfx对运算卡性能的影响?</a></p></li>
<li><p><a class="reference external" href="https://mp.weixin.qq.com/s?__biz=MzAwODExNjI3NA==&amp;mid=2649780116&amp;idx=1&amp;sn=a833bb9ffcb9b95b1b081321412e50f0&amp;chksm=83770ec9b40087dfa2f3ac411bd66698e73580df088f5b40e9a6a25c814e41264bf2b7dd9133&amp;token=934250801&amp;lang=zh_CN&amp;scene=21#wechat_redirect">PCIe 4.0 SAS+NVMe RAID/HBA卡：最高读IOPS 300万、写24万</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="dl360_config_mem.html" class="btn btn-neutral float-left" title="HPE DL360 Gen9服务器内存配置" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="plx_8747_pcie_bifurcation.html" class="btn btn-neutral float-right" title="PLX 8747硬件PCIe bifurcation" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../../copyright.html">版权所有</a> 2018 - now, Huatai Huang。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡 👈</a></p>
    <br>
    <p>网站采用 <a href="https://utteranc.es/">utterances</a> 评论系统，所有评论存储在<a href="https://github.com/huataihuang/cloud-atlas/issues">GitHub issues</a> 中，如果你看不到下方的评论框，那么可能需要<a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/security/vpn/index.html">自备梯子</a> 👈</p>
    <div class="articleComments">
        <comments>
  <script src="https://utteranc.es/client.js"
    repo="huataihuang/cloud-atlas"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
    </div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>