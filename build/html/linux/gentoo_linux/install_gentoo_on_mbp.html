<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>在MacBook Pro上安装Gentoo Linux &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="升级Gentoo" href="upgrade_gentoo.html" />
    <link rel="prev" title="Gentoo Linux简介" href="intro_gentoo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes_from_scratch/index.html">Kubernetes From Scratch (KFS) Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rancher/index.html">Rancher Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/index.html">SQLite Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nosql/index.html">NoSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_search/index.html">Search Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info_service/index.html">Info-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../best_linux.html">最佳Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin/index.html">Linux系统管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redhat_linux/index.html">RedHat Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arch_linux/index.html">Arch Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../asahi_linux/index.html">Asahi Linux</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Gentoo Linux</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro_gentoo.html">Gentoo Linux简介</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">在MacBook Pro上安装Gentoo Linux</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#gentoo-linuxu">制作Gentoo Linux安装U盘</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stage">安装stage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">配置编译选项</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chrooting">Chrooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dns">复制DNS信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">挂载必要文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">进入新环境</a></li>
<li class="toctree-l4"><a class="reference internal" href="#boot">挂载boot分区</a></li>
<li class="toctree-l4"><a class="reference internal" href="#portage">配置Portage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#profile">选择正确profile</a></li>
<li class="toctree-l4"><a class="reference internal" href="#world-set">更新 &#64;world set</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use">配置USE变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpu-flags"><code class="docutils literal notranslate"><span class="pre">CPU_FLAGS_*</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#accept-license">(可选)配置 <code class="docutils literal notranslate"><span class="pre">ACCEPT_LICENSE</span></code> 变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">配置时区</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">配置本地化(语言支持)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">选择本地化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">配置内核准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">内核配置和编译</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">配置系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">网络配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">系统信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#init">Init和启动配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">安装工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bootloader">配置bootloader</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">收尾工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">参考</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="upgrade_gentoo.html">升级Gentoo</a></li>
<li class="toctree-l3"><a class="reference internal" href="gentoo_nvidia.html">Gentoo NVIDIA驱动</a></li>
<li class="toctree-l3"><a class="reference internal" href="gentoo_mbp_wifi.html">Gentoo Linux在MacBook Pro配置Wifi</a></li>
<li class="toctree-l3"><a class="reference internal" href="gentoo_kernel.html">Gentoo内核编译</a></li>
<li class="toctree-l3"><a class="reference internal" href="gentoo_mbp_kernel.html">Gentoo内核编译(MacBook Pro Late 2013)</a></li>
<li class="toctree-l3"><a class="reference internal" href="gentoo_initramfs.html">Gentoo initramfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="gentoo_docker.html">Gentoo Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="cross-platform_file_system.html">跨平台文件系统(MAC/Windows/Linux)</a></li>
<li class="toctree-l3"><a class="reference internal" href="pentoo/index.html">Pentoo - 基于Gentoo的Overlay/LiveCD安全渗透测试发行版</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../lfs_linux/index.html">LFS(Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ubuntu_linux/index.html">Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../suse_linux/index.html">SUSE Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kali_linux/index.html">Kali Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tails_linux/index.html">Tails Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postmarketos/index.html">postmarketOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../container_os/index.html">容器化操作系统(Container OS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fedora_coreos/index.html">Fedora CoreOS容器操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chromium_os/index.html">Chromium OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpine_linux/index.html">Alpine Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subgraph_os/index.html">Subgraph OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kaios/index.html">KaiOS - 世界第三手机操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compute/index.html">Linux计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">Linux存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">Linux网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../server/index.html">Linux服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.html">Linux安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../desktop/index.html">Linux桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linux_tablet/index.html">Linux平板</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clang/index.html">C Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ruby/index.html">Ruby Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Linux Atlas</a></li>
          <li class="breadcrumb-item"><a href="index.html">Gentoo Linux</a></li>
      <li class="breadcrumb-item active">在MacBook Pro上安装Gentoo Linux</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/linux/gentoo_linux/install_gentoo_on_mbp.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="macbook-progentoo-linux">
<span id="install-gentoo-on-mbp"></span><h1>在MacBook Pro上安装Gentoo Linux<a class="headerlink" href="#macbook-progentoo-linux" title="此标题的永久链接">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Gentoo Linux安装是一个纯手工一步步完成，需要非常小心谨慎，也非常占用时间。不过，只要安装成功，后续就可以不断滚动升级，并且能够获得很多系统运维的深刻知识，特别是自定义编译内核以及USE优化精简，都能够充分发挥硬件性能。所以还是值得投入时间精力进行实践的。</p>
<p>我大约话费了2~3个晚上来完成初步部署，后续会定制一个精简的 <a class="reference internal" href="../../real/mobile_cloud/mobile_cloud_infra.html#mobile-cloud-infra"><span class="std std-ref">移动云架构</span></a> 来实现开发</p>
</div>
<section id="gentoo-linuxu">
<h2>制作Gentoo Linux安装U盘<a class="headerlink" href="#gentoo-linuxu" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>在OS X 的Terminal终端，使用以下命令将 <code class="docutils literal notranslate"><span class="pre">.iso</span></code> 文件转换成 <code class="docutils literal notranslate"><span class="pre">.img</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">将Gentoo安装镜像.iso文件转换成.img文件</span><a class="headerlink" href="#id23" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hdiutil<span class="w"> </span>convert<span class="w"> </span>-format<span class="w"> </span>UDRW<span class="w"> </span>-o<span class="w"> </span>install-amd64-minimal-20230220T081656Z.img<span class="w"> </span>install-amd64-minimal-20230220T081656Z.iso
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Mac设备需要使用EFI stub loader，但是需要注意EFI限制了boot loaderc参数，所以需要将参数结合到内核中 （ <a class="reference external" href="https://forums.gentoo.org/viewtopic-t-966240-view-previous.html?sid=8ccb81a5f18e9e1f7cb5ab533847ff93">How to install Gentoo ONLY Mid-2012 macbook air</a> ）。</p>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/UEFI_Gentoo_Quick_Install_Guide">UEFI Gentoo Quick Install Guide</a> 指出需要使用 <code class="docutils literal notranslate"><span class="pre">UEFI-enabled</span></code> 启动介质，如LiveDVD或者Gentoo-based <a class="reference external" href="http://www.sysresccd.org/SystemRescueCd_Homepage">SystemRescueCD</a> ，详细参考 <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:Main_Page">Gentoo Handbook</a> 。此外，也可以参考 <a class="reference external" href="https://wiki.archlinux.org/index.php/MacBook">Arch Linux on a MacBook</a></p>
<p>OS X会自动添加 <code class="docutils literal notranslate"><span class="pre">.dmg</span></code> 文件名后缀，所以实际生成的文件名是 <code class="docutils literal notranslate"><span class="pre">install-amd64-minimal-20230220T081656Z.img.dmg</span></code></p>
</div>
<ul class="simple">
<li><p>检查插入U盘对应设备:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">检查U盘设备</span><a class="headerlink" href="#id24" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>diskutil<span class="w"> </span>list
</pre></div>
</div>
</div>
<ul>
<li><p>如果U盘已经被自动挂载，则需要先下载挂载，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">diskutil</span> <span class="n">unmountDisk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk2s2</span>
</pre></div>
</div>
</li>
<li><p>将Gentoo Linux安装镜像写入U盘:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">制作Gentoo Linux安装U盘</span><a class="headerlink" href="#id25" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>install-amd64-minimal-20230220T081656Z.img.dmg<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/rdisk2<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>100m
</pre></div>
</div>
</div>
</section>
<section id="id1">
<h2>安装<a class="headerlink" href="#id1" title="此标题的永久链接">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我采用MacBook的双启动模式: 先安装 <a class="reference internal" href="../../apple/macos/index.html#macos"><span class="std std-ref">macOS</span></a> ，安装时使用macOS内置磁盘工具将磁盘划分为2个分区，保留一个分区给Gentoo Linux使用</p>
<p>早期我安装双启动模式采用了 <code class="docutils literal notranslate"><span class="pre">rEFInd</span></code> 工具(现在依然可以使用):</p>
<ul>
<li><p>下载 <a class="reference external" href="http://www.rodsbooks.com/refind/getting.html">rEFInd二进制.zip文件</a> 并解压缩</p></li>
<li><p>按住 <code class="docutils literal notranslate"><span class="pre">Command+R</span></code> 开机（进入Mac的recovery模式）</p></li>
<li><p>当OS启动后，选择 Utilities -&gt; Terminal</p></li>
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">rEFInd</span></code> 安装程序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">refind</span><span class="o">-</span><span class="nb">bin</span><span class="o">-</span><span class="mf">0.10.2</span>
<span class="o">./</span><span class="n">refind</span><span class="o">-</span><span class="n">install</span>
</pre></div>
</div>
</li>
</ul>
<p>再次启动系统</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我现在为了简化，采用启动时安装 <code class="docutils literal notranslate"><span class="pre">option</span></code> 键，利用硬件内置的磁盘分区选择来启动不同操作系统。所以可以不用安装 <code class="docutils literal notranslate"><span class="pre">rEFInd</span></code> ，不过安装 <code class="docutils literal notranslate"><span class="pre">rEFIne</span></code> 可以方便自动启动选择界面。</p>
</div>
<ul class="simple">
<li><p>启动LiveCD，进入安装过程(需要连接一个有线网络，通过DHCP获取IP连接Internet)</p></li>
<li><p>登陆是root用户身份，执行以下命令启动 <code class="docutils literal notranslate"><span class="pre">sshd</span></code> 并设置好root用户密码，这样就方便我远程登陆到主机上进行下一步安装:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">启动Gentoo Linux安装的sshd服务</span><a class="headerlink" href="#id26" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 启动ssh服务</span>
ssh-keygen<span class="w"> </span>-A
/usr/sbin/sshd

<span class="c1"># 设置root用户密码</span>
passwd
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>磁盘分区:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">对NVMe磁盘进行分区检查</span><a class="headerlink" href="#id27" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>livecd<span class="w"> </span>~<span class="w"> </span><span class="c1"># parted -a optimal /dev/nvme0n1</span>
GNU<span class="w"> </span>Parted<span class="w"> </span><span class="m">3</span>.5
Using<span class="w"> </span>/dev/nvme0n1
Welcome<span class="w"> </span>to<span class="w"> </span>GNU<span class="w"> </span>Parted!<span class="w"> </span>Type<span class="w"> </span><span class="s1">&#39;help&#39;</span><span class="w"> </span>to<span class="w"> </span>view<span class="w"> </span>a<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>commands.
<span class="o">(</span>parted<span class="o">)</span><span class="w"> </span>print
Model:<span class="w"> </span>SAMSUNG<span class="w"> </span>MZVL21T0HCLR-00B00<span class="w"> </span><span class="o">(</span>nvme<span class="o">)</span>
Disk<span class="w"> </span>/dev/nvme0n1:<span class="w"> </span>1024GB
Sector<span class="w"> </span>size<span class="w"> </span><span class="o">(</span>logical/physical<span class="o">)</span>:<span class="w"> </span>512B/512B
Partition<span class="w"> </span>Table:<span class="w"> </span>gpt
Disk<span class="w"> </span>Flags:

Number<span class="w">  </span>Start<span class="w">   </span>End<span class="w">     </span>Size<span class="w">   </span>File<span class="w"> </span>system<span class="w">  </span>Name<span class="w">                  </span>Flags
<span class="w"> </span><span class="m">1</span><span class="w">      </span><span class="m">20</span>.5kB<span class="w">  </span>210MB<span class="w">   </span>210MB<span class="w">  </span>fat32<span class="w">        </span>EFI<span class="w"> </span>System<span class="w"> </span>Partition<span class="w">  </span>boot,<span class="w"> </span>esp
<span class="w"> </span><span class="m">2</span><span class="w">      </span>210MB<span class="w">   </span>256GB<span class="w">   </span>256GB
<span class="hll"><span class="w"> </span><span class="m">3</span><span class="w">      </span>256GB<span class="w">   </span>1024GB<span class="w">  </span>768GB<span class="w">  </span>fat32<span class="w">                              </span>msftdata
</span>
<span class="o">(</span>parted<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>只有分区3是可以删除(之前安装macOS保留的空白分区)，我将创建一个50G磁盘分区用于操作系统</p>
</div>
<ul class="simple">
<li><p>创建一个名为 <code class="docutils literal notranslate"><span class="pre">rootfs</span></code> 分区，格式化成 <code class="docutils literal notranslate"><span class="pre">xfs</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">rootfs</span></code> 分区</span><a class="headerlink" href="#id28" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="o">(</span>parted<span class="o">)</span><span class="w"> </span>rm<span class="w"> </span><span class="m">3</span>
</span><span class="hll"><span class="o">(</span>parted<span class="o">)</span><span class="w"> </span>mkpart<span class="w"> </span>primary<span class="w"> </span>xfs<span class="w"> </span>256GB<span class="w"> </span>320GB
</span><span class="hll"><span class="o">(</span>parted<span class="o">)</span><span class="w"> </span>name<span class="w"> </span><span class="m">3</span><span class="w"> </span>rootfs
</span><span class="hll"><span class="o">(</span>parted<span class="o">)</span><span class="w"> </span>print
</span><span class="hll">Model:<span class="w"> </span>SAMSUNG<span class="w"> </span>MZVL21T0HCLR-00B00<span class="w"> </span><span class="o">(</span>nvme<span class="o">)</span>
</span>Disk<span class="w"> </span>/dev/nvme0n1:<span class="w"> </span>1024GB
Sector<span class="w"> </span>size<span class="w"> </span><span class="o">(</span>logical/physical<span class="o">)</span>:<span class="w"> </span>512B/512B
Partition<span class="w"> </span>Table:<span class="w"> </span>gpt
Disk<span class="w"> </span>Flags:

Number<span class="w">  </span>Start<span class="w">   </span>End<span class="w">    </span>Size<span class="w">    </span>File<span class="w"> </span>system<span class="w">  </span>Name<span class="w">                  </span>Flags
<span class="w"> </span><span class="m">1</span><span class="w">      </span><span class="m">20</span>.5kB<span class="w">  </span>210MB<span class="w">  </span>210MB<span class="w">   </span>fat32<span class="w">        </span>EFI<span class="w"> </span>System<span class="w"> </span>Partition<span class="w">  </span>boot,<span class="w"> </span>esp
<span class="w"> </span><span class="m">2</span><span class="w">      </span>210MB<span class="w">   </span>256GB<span class="w">  </span>256GB
<span class="w"> </span><span class="m">3</span><span class="w">      </span>256GB<span class="w">   </span>320GB<span class="w">  </span><span class="m">63</span>.8GB<span class="w">  </span>xfs<span class="w">          </span>rootfs
<span class="hll">
</span><span class="hll"><span class="o">(</span>parted<span class="o">)</span>
</span></pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于UEFI启动，磁盘上必须有一个分区是系统的EFI启动分区，并且是 <code class="docutils literal notranslate"><span class="pre">vfat</span></code> 文件系统</p>
<p>为什么我没有创建这个 EFI 系统分区呢？ 原因是系统磁盘上已经有一个Apple的 <a class="reference internal" href="../../apple/macos/index.html#macos"><span class="std std-ref">macOS</span></a> 操作系统，已经构建了 <code class="docutils literal notranslate"><span class="pre">分区1</span></code> ，这个分区已经是 <code class="docutils literal notranslate"><span class="pre">boot,</span> <span class="pre">esp</span></code> 标记。只需要将这个分区挂载为Linux的 <code class="docutils literal notranslate"><span class="pre">/boot/EFI</span></code> 目录就可以。</p>
<p>当然，如果是整个磁盘作为Linux使用，则可以抹掉整个磁盘所有分区，然后单独为Linux创建一个 <code class="docutils literal notranslate"><span class="pre">boot,</span> <span class="pre">esp</span></code> 标记的 <code class="docutils literal notranslate"><span class="pre">vfat32</span></code> 分区，挂载到 <code class="docutils literal notranslate"><span class="pre">/boot/EFI</span></code> 。</p>
</div>
<ul class="simple">
<li><p>创建文件系统 - 将分区3格式化成 <code class="docutils literal notranslate"><span class="pre">xfs</span></code> 文件系统( 使用了 <code class="docutils literal notranslate"><span class="pre">-f</span></code> 强制参数，因为需要覆盖之前的分区信息 ):</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">格式化 <code class="docutils literal notranslate"><span class="pre">rootfs</span></code> 分区，创建XFS文件系统</span><a class="headerlink" href="#id29" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkfs.xfs<span class="w"> </span>-f<span class="w"> </span>/dev/nvme0n1p3
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>挂载 root 分区文件系统:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">挂载文件系统</span><a class="headerlink" href="#id30" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mount<span class="w"> </span>/dev/nvme0n1p3<span class="w"> </span>/mnt/gentoo
</pre></div>
</div>
</div>
</section>
<section id="stage">
<h2>安装stage<a class="headerlink" href="#stage" title="此标题的永久链接">¶</a></h2>
<p>Gentoo Linux提供了 Multilib (32和64位)，也提供了纯64位的 No-Multilib 。通常建议使用 <code class="docutils literal notranslate"><span class="pre">Multilib</span></code> ，因为这个选项的 stage tarball兼容性最好，系统会尽可能使用64位库，只有需要兼容性的时候才会回退到32位版本。这为将来的定制提供了很大的灵活性。</p>
<p>如果选择 <code class="docutils literal notranslate"><span class="pre">no-multilib</span></code> tarball，则会构建完全的64位操作系统环境。但是后续要切换到 <code class="docutils literal notranslate"><span class="pre">Multilib</span></code> 变得不可能，尽管在技术上依然是可能的。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>除非绝对必要，刚开始使用Gentoo的用户不应该选择 <code class="docutils literal notranslate"><span class="pre">no-Multilib</span></code> tarball。因为从 <code class="docutils literal notranslate"><span class="pre">no-multilib</span></code> 迁移到 <code class="docutils literal notranslate"><span class="pre">multilib</span></code> 需要对Gentoo 和较低级别的工具链有非常好的知识(对于Toolchain developers也是非常困难的)。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Gentoo Linux默认使用 <code class="docutils literal notranslate"><span class="pre">OpenRC</span></code> 作为init，而不是复杂的 <a class="reference internal" href="../redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> (可选)</p>
</div>
<ul class="simple">
<li><p>下载 <code class="docutils literal notranslate"><span class="pre">stage</span> <span class="pre">tarball</span></code> 并解压缩:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">下载 <code class="docutils literal notranslate"><span class="pre">stage</span> <span class="pre">tarball</span></code> 解压缩</span><a class="headerlink" href="#id31" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/mnt/gentoo

<span class="c1"># stage3-amd64-openrc-20230220T081656Z.tar.xz 已经存放到这个目录下</span>
tar<span class="w"> </span>xpvf<span class="w"> </span>stage3-*.tar.xz<span class="w"> </span>--xattrs-include<span class="o">=</span><span class="s1">&#39;*.*&#39;</span><span class="w"> </span>--numeric-owner
</pre></div>
</div>
</div>
</section>
<section id="id2">
<h2>配置编译选项<a class="headerlink" href="#id2" title="此标题的永久链接">¶</a></h2>
<p>为了优化系统，可以设置影响 Gentoo 官方支持的包管理器 Portage 行为的变量。 所有这些变量都可以设置为环境变量（使用 <code class="docutils literal notranslate"><span class="pre">export</span></code> ），但通过 <code class="docutils literal notranslate"><span class="pre">export</span></code> 设置不是永久的。</p>
<p>Portage 在运行时读取 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 文件，这将根据文件中保存的值更改运行时行为。 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 可以被认为是 Portage 的主要配置文件，所以要小心对待它的内容。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vi</span> <span class="pre">/mnt/gentoo/etc/portage/make.conf</span></code> 编辑配置</p></li>
</ul>
<section id="cflags-cxxflags">
<h3><code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> 和 <code class="docutils literal notranslate"><span class="pre">CXXFLAGS</span></code><a class="headerlink" href="#cflags-cxxflags" title="此标题的永久链接">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> 和 <code class="docutils literal notranslate"><span class="pre">CXXFLAGS</span></code> 变量分别定义了 GCC C 和 C++ 编译器的优化标志。 虽然这些是在这里一般定义的，但为了获得最佳性能，需要分别为每个程序优化这些标志。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 中，应该定义优化标志，使系统通常响应最快。 不要在这个变量中放置实验设置； 过多的优化会使程序行为异常（崩溃，故障）。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于优化选项，请参考GNU在线手册或gcc信息页面。 <code class="docutils literal notranslate"><span class="pre">make.conf.example</span></code> 也包含了很多示例和信息。</p>
</div>
<ul class="simple">
<li><p>修订 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 配置添加 <code class="docutils literal notranslate"><span class="pre">-march=native</span></code> (通常已足够)，可以以本机处理器最佳原生优化进行编译:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">make.conf</span><a class="headerlink" href="#id32" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># These settings were set by the catalyst build script that automatically</span>
<span class="c1"># built this stage.</span>
<span class="c1"># Please consult /usr/share/portage/config/make.conf.example for a more</span>
<span class="c1"># detailed example.</span>
<span class="hll"><span class="nv">COMMON_FLAGS</span><span class="o">=</span><span class="s2">&quot;-march=native -O2 -pipe&quot;</span>
</span><span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">COMMON_FLAGS</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">CXXFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">COMMON_FLAGS</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">FCFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">COMMON_FLAGS</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">FFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">COMMON_FLAGS</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># If left undefined, Portage&#39;s default behavior is to set the MAKEOPTS value to the same number of threads returned by `nproc` </span>
<span class="hll"><span class="nv">MAKEOPTS</span><span class="o">=</span><span class="s2">&quot;-j8&quot;</span>
</span>
<span class="c1"># NOTE: This stage was built with the bindist Use flag enabled</span>

<span class="c1"># This sets the language of build output to English.</span>
<span class="c1"># Please keep this setting intact when reporting bugs.</span>
<span class="nv">LC_MESSAGES</span><span class="o">=</span>C
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">MAKEOPTS=&quot;-j4&quot;</span></code> 现在不是必须的，因为 <code class="docutils literal notranslate"><span class="pre">nproc</span></code> 返回的就是本机处理器核心数量</p>
</div>
</section>
</section>
<section id="chrooting">
<h2>Chrooting<a class="headerlink" href="#chrooting" title="此标题的永久链接">¶</a></h2>
<section id="id3">
<h3>(可选):选择镜像网站<a class="headerlink" href="#id3" title="此标题的永久链接">¶</a></h3>
<ul class="simple">
<li><p>执行选择最佳镜像网站:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">在make.conf配置中添加最佳镜像网站配置</span><a class="headerlink" href="#id33" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mirrorselect<span class="w"> </span>-i<span class="w"> </span>-o<span class="w"> </span>&gt;&gt;<span class="w"> </span>/mnt/gentoo/etc/portage/make.conf
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当使用 <code class="docutils literal notranslate"><span class="pre">emerge</span></code> 进行软件安装(源代码编译)，下载源代码包的配置就是由 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 指定的。非常不幸，由于GFW阻塞，现在(2023)几乎无法访问Gentoo官网以及默认下载网站，并且 <code class="docutils literal notranslate"><span class="pre">mirrorselect</span></code> 也无法运行(因为首先需要从官网拉取 <code class="docutils literal notranslate"><span class="pre">mirrorlist</span></code> 就是失败的)。参考 <a class="reference external" href="https://github.com/gentoo/portage/blob/master/cnf/make.conf.example">make.conf.example</a> ，实际上 <code class="docutils literal notranslate"><span class="pre">mirrorselect</span></code> 在 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 配置中添加了如下类似内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 建议最后保留默认配置</span>
<span class="n">GENTOO_MIRRORS</span><span class="o">=</span><span class="s2">&quot;&lt;your_mirror_here&gt; http://distfiles.gentoo.org http://www.ibiblio.org/pub/Linux/distributions/gentoo&quot;</span>
</pre></div>
</div>
<p>在国内可以参考Gentoo官方文档 <a class="reference external" href="https://www.gentoo.org/downloads/mirrors/">Gentoo source mirrors</a> 选择国内镜像网站，例如阿里云提供的镜像网站:</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">在make.conf配置中添加阿里云国内镜像网</span><a class="headerlink" href="#id34" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">GENTOO_MIRRORS</span><span class="o">=</span><span class="s2">&quot;http://mirrors.aliyun.com/gentoo http://distfiles.gentoo.org http://www.ibiblio.org/pub/Linux/distributions/gentoo&quot;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">/etc/portage/repos.conf/gentoo.conf</span></code> Gentoo ebuild存储库:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">创建 /etc/portage/repos.conf/gentoo.conf</span><a class="headerlink" href="#id35" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>--parents<span class="w"> </span>/mnt/gentoo/etc/portage/repos.conf
cp<span class="w"> </span>/mnt/gentoo/usr/share/portage/config/repos.conf<span class="w"> </span>/mnt/gentoo/etc/portage/repos.conf/gentoo.conf
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>可以参考 <a class="reference external" href="https://www.gentoo.org/support/rsync-mirrors/">Gentoo rsync mirrors</a> 配置 <code class="docutils literal notranslate"><span class="pre">gentoo.conf</span></code> ，例如选择中国的rsync镜像网站</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">/etc/portage/repos.conf/gentoo.conf 配置国内sync-url</span><a class="headerlink" href="#id36" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sync-uri<span class="w"> </span><span class="o">=</span><span class="w"> </span>rsync://rsync.cn.gentoo.org/gentoo-portage
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="dns">
<h2>复制DNS信息<a class="headerlink" href="#dns" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>将本机的DNS配置信息复制到 Gentoo 安装目录:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-text">复制DNS配置信息</span><a class="headerlink" href="#id37" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>--dereference<span class="w"> </span>/etc/resolv.conf<span class="w"> </span>/mnt/gentoo/etc/
</pre></div>
</div>
</div>
</section>
<section id="id4">
<h2>挂载必要文件系统<a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>挂载文件系统:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-text">挂载文件系统</span><a class="headerlink" href="#id38" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mount<span class="w"> </span>--types<span class="w"> </span>proc<span class="w"> </span>/proc<span class="w"> </span>/mnt/gentoo/proc
mount<span class="w"> </span>--rbind<span class="w"> </span>/sys<span class="w"> </span>/mnt/gentoo/sys
mount<span class="w"> </span>--make-rslave<span class="w"> </span>/mnt/gentoo/sys
mount<span class="w"> </span>--rbind<span class="w"> </span>/dev<span class="w"> </span>/mnt/gentoo/dev
mount<span class="w"> </span>--make-rslave<span class="w"> </span>/mnt/gentoo/dev
mount<span class="w"> </span>--bind<span class="w"> </span>/run<span class="w"> </span>/mnt/gentoo/run
mount<span class="w"> </span>--make-slave<span class="w"> </span>/mnt/gentoo/run
</pre></div>
</div>
</div>
</section>
<section id="id5">
<h2>进入新环境<a class="headerlink" href="#id5" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>进入Gentoo新环境:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id39">
<div class="code-block-caption"><span class="caption-text">进入Gentoo新环境</span><a class="headerlink" href="#id39" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chroot<span class="w"> </span>/mnt/gentoo<span class="w"> </span>/bin/bash
<span class="nb">source</span><span class="w"> </span>/etc/profile
<span class="nb">export</span><span class="w"> </span><span class="nv">PS1</span><span class="o">=</span><span class="s2">&quot;(chroot) </span><span class="si">${</span><span class="nv">PS1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="boot">
<h2>挂载boot分区<a class="headerlink" href="#boot" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>挂载boot分区(这个分区是MacBook的macos和gentoo公用的):</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id40">
<div class="code-block-caption"><span class="caption-text">挂载 /boot</span><a class="headerlink" href="#id40" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mount<span class="w"> </span>/dev/nvme0n1p1<span class="w"> </span>/boot
</pre></div>
</div>
</div>
</section>
<section id="portage">
<h2>配置Portage<a class="headerlink" href="#portage" title="此标题的永久链接">¶</a></h2>
<p>如果服务器位于限制性防火墙后面(使用HTTP/HTTPS协议下载快照)，则使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span><span class="o">-</span><span class="n">webrsync</span>
</pre></div>
</div>
<p>如果没有网络限制，则可以使用传统的rsync方式同步:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">sync</span>
</pre></div>
</div>
</section>
<section id="profile">
<h2>选择正确profile<a class="headerlink" href="#profile" title="此标题的永久链接">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">Desktop</span> <span class="pre">profiles</span></code> 并非专用于桌面环境。 它们仍然适用于像 i3 或 sway 这样的最小窗口管理器。</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">profile</span></code> 是任何 Gentoo 系统的构建块(building block)。它不仅为 <code class="docutils literal notranslate"><span class="pre">USE</span></code> 、 <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> 和其他重要变量指定默认值，还将系统锁定在特定范围的包版本。 这些设置都由 Gentoo 的 Portage 开发人员维护。</p>
<ul class="simple">
<li><p>查看系统当前使用的 <code class="docutils literal notranslate"><span class="pre">profile</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id41">
<div class="code-block-caption"><span class="caption-text">检查当前使用的 <code class="docutils literal notranslate"><span class="pre">profile</span></code></span><a class="headerlink" href="#id41" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eselect<span class="w"> </span>profile<span class="w"> </span>list
</pre></div>
</div>
</div>
<p>输出显示:</p>
<div class="literal-block-wrapper docutils container" id="id42">
<div class="code-block-caption"><span class="caption-text">检查当前使用的 <code class="docutils literal notranslate"><span class="pre">profile</span></code></span><a class="headerlink" href="#id42" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Available<span class="w"> </span>profile<span class="w"> </span>symlink<span class="w"> </span>targets:
<span class="w">  </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span><span class="w"> </span>*
<span class="w">  </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/selinux<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/hardened<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/hardened/selinux<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">5</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/desktop<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">6</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/desktop/gnome<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">7</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/desktop/gnome/systemd<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">8</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/desktop/gnome/systemd/merged-usr<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">9</span><span class="o">]</span><span class="w">   </span>default/linux/amd64/17.1/desktop/plasma<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span><span class="o">[</span><span class="m">10</span><span class="o">]</span><span class="w">  </span>default/linux/amd64/17.1/desktop/plasma/systemd<span class="w"> </span><span class="o">(</span>stable<span class="o">)</span>
<span class="w">  </span>...
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当使用 <a class="reference internal" href="../redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 时，请确保 <code class="docutils literal notranslate"><span class="pre">profile</span></code> 名称中包含 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> ，否则请确保 <strong>不包含</strong> <code class="docutils literal notranslate"><span class="pre">systemd</span></code></p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p><code class="docutils literal notranslate"><span class="pre">profile</span></code> 升级不能掉以轻心: 选择初始配置文件时，请确保使用与 stage3 最初使用的版本相同的配置文件</p>
<p>选择初始 <code class="docutils literal notranslate"><span class="pre">profile</span></code> 文件时，请确保使用与 stage3 最初使用的版本相同的配置文件</p>
</div>
<ul class="simple">
<li><p>设置profile:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id43">
<div class="code-block-caption"><span class="caption-text">设置 <code class="docutils literal notranslate"><span class="pre">profile</span></code></span><a class="headerlink" href="#id43" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eselect<span class="w"> </span>profile<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="m">5</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我准备采用 <a class="reference internal" href="../desktop/sway/index.html#sway"><span class="std std-ref">sway - i3兼容Wayland compositor</span></a> 最小化窗口管理器，所以选择 <code class="docutils literal notranslate"><span class="pre">default/linux/amd64/17.1/desktop</span></code> ( <code class="docutils literal notranslate"><span class="pre">5</span></code> )</p>
</div>
</section>
<section id="world-set">
<h2>更新 &#64;world set<a class="headerlink" href="#world-set" title="此标题的永久链接">¶</a></h2>
<p>此时，明智的做法是更新系统的 <code class="docutils literal notranslate"><span class="pre">&#64;world</span> <span class="pre">set</span></code> ，以便建立 <code class="docutils literal notranslate"><span class="pre">base</span></code> 。</p>
<p>以下步骤是必要的，以便系统可以应用自构建 <code class="docutils literal notranslate"><span class="pre">stage3</span></code> 以来出现的任何更新或 <code class="docutils literal notranslate"><span class="pre">USE</span> <span class="pre">flag</span></code> 更改以及任何配置文件选择:</p>
<div class="literal-block-wrapper docutils container" id="id44">
<div class="code-block-caption"><span class="caption-text">更新 &#64;world set</span><a class="headerlink" href="#id44" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>--verbose<span class="w"> </span>--update<span class="w"> </span>--deep<span class="w"> </span>--newuse<span class="w"> </span>@world
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>简单来说，配置文件名称越短，系统的 <code class="docutils literal notranslate"><span class="pre">&#64;world</span> <span class="pre">set</span></code> 就越不具体； <code class="docutils literal notranslate"><span class="pre">&#64;world</span> <span class="pre">set</span></code> 不具体，系统需要的包就越少：</p>
<p>例如,  <code class="docutils literal notranslate"><span class="pre">default/linux/amd64/17.1</span></code> 只需要更新很少的包；而 <code class="docutils literal notranslate"><span class="pre">default/linux/amd64/17.1/desktop/gnome/systemd</span></code> 就会更新很多包，因为 <code class="docutils literal notranslate"><span class="pre">init</span></code> 系统从 OpenRC 切换到 <a class="reference internal" href="../redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 并且会安装GNOME桌面环境框架。</p>
</div>
</section>
<section id="use">
<h2>配置USE变量<a class="headerlink" href="#use" title="此标题的永久链接">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">USE</span></code> 是Gentoo为用户 提供的最强大的变量之一，可以配置支持或不支持某些选项来编译多个程序。例如有些程序可以支持 <code class="docutils literal notranslate"><span class="pre">GTK+</span></code> 或 <code class="docutils literal notranslate"><span class="pre">Qt</span></code> 情况下编译，或者支持 <code class="docutils literal notranslate"><span class="pre">SSL</span></code> ，有些程序甚至可以使用帧缓冲( <code class="docutils literal notranslate"><span class="pre">svgalib</span></code> )而不是X11支持来完成编译。</p>
<p>大多数Linux发行版为了能够尽可能多支持不同环境(软件和硬件)，采用了最大化的编译参数，这导致增加了程序大小以及启动时间，而且会导致大量的依赖。使用Gentoo的用户可以通过定义编译选项来精简系统，使得硬件发挥更大功效。</p>
<p>默认的 <code class="docutils literal notranslate"><span class="pre">USE</span></code> 设置使用Gentoo配置文件 <code class="docutils literal notranslate"><span class="pre">make.defaults</span></code> 。Gentoo使用了一个(复杂的)继承系统。检查当前的USE配置最简单的方法是:</p>
<div class="literal-block-wrapper docutils container" id="id45">
<div class="code-block-caption"><span class="caption-text">使用 <code class="docutils literal notranslate"><span class="pre">emerge</span> <span class="pre">--info</span></code> 获取USE配置</span><a class="headerlink" href="#id45" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--info<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>^USE
</pre></div>
</div>
</div>
<p>完整的 <code class="docutils literal notranslate"><span class="pre">USE</span></code> flags 可以在 <code class="docutils literal notranslate"><span class="pre">/var/db/repos/gentoo/profiles/use.desc</span></code> 查看</p>
</section>
<section id="cpu-flags">
<h2><code class="docutils literal notranslate"><span class="pre">CPU_FLAGS_*</span></code><a class="headerlink" href="#cpu-flags" title="此标题的永久链接">¶</a></h2>
<p>某些架构(包括 AMD64/X86, ARM, PPC)有一个名为 <code class="docutils literal notranslate"><span class="pre">CPU_FLAGS_ARCH</span></code> 的 <code class="docutils literal notranslate"><span class="pre">USE_EXPAND</span></code> 变量(视情况用相应的架构替换 <code class="docutils literal notranslate"><span class="pre">ARCH</span></code> )。这个变量将构建配置为特定的汇编代码或者其他内部函数中的编译，通常是 <code class="docutils literal notranslate"><span class="pre">硬编码</span></code> (hand-written) 或者其他扩展，并且与要求编译器为特定CPU功能(例如 <code class="docutils literal notranslate"><span class="pre">march=</span></code> )输出的优化代码不同。</p>
<p>除了根据需要配置其 <code class="docutils literal notranslate"><span class="pre">COMMON_FLAGS</span></code> 之外，用户还应设置此变量。</p>
<ul class="simple">
<li><p>安装工具包:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id46">
<div class="code-block-caption"><span class="caption-text">安装 <code class="docutils literal notranslate"><span class="pre">cpuid2cpuflags</span></code> 工具包</span><a class="headerlink" href="#id46" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>app-portage/cpuid2cpuflags
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>执行:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id47">
<div class="code-block-caption"><span class="caption-text">运行 <code class="docutils literal notranslate"><span class="pre">cpuid2cpuflags</span></code></span><a class="headerlink" href="#id47" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cpuid2cpuflags
</pre></div>
</div>
</div>
<p>在我的 MacBook 2013上输出:</p>
<div class="literal-block-wrapper docutils container" id="id48">
<div class="code-block-caption"><span class="caption-text">运行 <code class="docutils literal notranslate"><span class="pre">cpuid2cpuflags</span></code> 输出</span><a class="headerlink" href="#id48" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>CPU_FLAGS_X86:<span class="w"> </span>aes<span class="w"> </span>avx<span class="w"> </span>avx2<span class="w"> </span>f16c<span class="w"> </span>fma3<span class="w"> </span>mmx<span class="w"> </span>mmxext<span class="w"> </span>pclmul<span class="w"> </span>popcnt<span class="w"> </span>rdrand<span class="w"> </span>sse<span class="w"> </span>sse2<span class="w"> </span>sse3<span class="w"> </span>sse4_1<span class="w"> </span>sse4_2<span class="w"> </span>ssse3
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>将输出结果添加到 <code class="docutils literal notranslate"><span class="pre">package.use</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id49">
<div class="code-block-caption"><span class="caption-text">运行 <code class="docutils literal notranslate"><span class="pre">cpuid2cpuflags</span></code> 输出添加到 <code class="docutils literal notranslate"><span class="pre">package.use</span></code></span><a class="headerlink" href="#id49" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*/* </span><span class="k">$(</span>cpuid2cpuflags<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/portage/package.use/00cpu-flags
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我记得大约20年前，我在使用Gentoo Linux在我的一台联想笔记本上编译Gentoo Linux。那时候还没有 <code class="docutils literal notranslate"><span class="pre">cpuid2cpuflags</span></code> ，是手工查CPU型号然后猜测哪些CPU相关的 Flags 需要配置，为 <code class="docutils literal notranslate"><span class="pre">make.conf</span></code> 添加类似 <code class="docutils literal notranslate"><span class="pre">mmx</span> <span class="pre">sse2</span></code> 这样的优化参数。现在都有工具可以代劳了…</p>
</div>
</section>
<section id="accept-license">
<h2>(可选)配置 <code class="docutils literal notranslate"><span class="pre">ACCEPT_LICENSE</span></code> 变量<a class="headerlink" href="#accept-license" title="此标题的永久链接">¶</a></h2>
<p>Gentoo包的licenses存储在ebuild的 <code class="docutils literal notranslate"><span class="pre">LICENCE</span></code> 变量中。系统接受的特定licenses可以在以下文件定义:</p>
<ul class="simple">
<li><p>/etc/portage/make.conf 文件中的系统范围。</p></li>
<li><p>/etc/portage/package.license 文件中的每个包。</p></li>
<li><p>/etc/portage/package.license/ 文件目录中的每个包。</p></li>
</ul>
<p>Portage 在 <code class="docutils literal notranslate"><span class="pre">ACCEPT_LICENSE</span></code> 中查找允许安装的包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">portageq</span> <span class="n">envvar</span> <span class="n">ACCEPT_LICENSE</span>
</pre></div>
</div>
<p>默认输出是:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@FREE</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>需要修订Licenses，添加 <code class="docutils literal notranslate"><span class="pre">&#64;BINARY-REDISTRIBUTABLE</span></code> ，否则无法安装下文的 <code class="docutils literal notranslate"><span class="pre">sys-kernel/linux-firmware</span></code></p>
</div>
<ul>
<li><p>简单的方法是修改 <code class="docutils literal notranslate"><span class="pre">/etc/portage/make.conf</span></code> 添加可以接受的licenses:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ACCEPT_LICENSE</span><span class="o">=</span><span class="s2">&quot;-* @FREE @BINARY-REDISTRIBUTABLE&quot;</span>
</pre></div>
</div>
</li>
<li><p>另外一种方法是为每个软件包配置licenses，也就是创建 <code class="docutils literal notranslate"><span class="pre">/etc/portage/package.license</span></code> 目录，然后创建一个为每个软件包配置licences的文件，如 <code class="docutils literal notranslate"><span class="pre">/etc/portage/package.license/kernel</span></code> 内容案例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">-</span><span class="n">arch</span><span class="o">/</span><span class="n">unrar</span> <span class="n">unRAR</span>
<span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">firmware</span> <span class="nd">@BINARY</span><span class="o">-</span><span class="n">REDISTRIBUTABLE</span>
<span class="n">sys</span><span class="o">-</span><span class="n">firmware</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">microcode</span> <span class="n">intel</span><span class="o">-</span><span class="n">ucode</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id6">
<h2>配置时区<a class="headerlink" href="#id6" title="此标题的永久链接">¶</a></h2>
<p>所有的时区信息可以从 <code class="docutils literal notranslate"><span class="pre">/usr/share/zoneinfo/</span></code> 目录下查找，我使用 <code class="docutils literal notranslate"><span class="pre">Asia/Shanghai</span></code></p>
<p>对于使用默认的 OpenRC ，配置时区写在 <code class="docutils literal notranslate"><span class="pre">/etc/timezone</span></code> 文件:</p>
<div class="literal-block-wrapper docutils container" id="id50">
<div class="code-block-caption"><span class="caption-text">配置OpenRC的timezone配置</span><a class="headerlink" href="#id50" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Asia/Shanghai&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/timezone
</pre></div>
</div>
</div>
<p>然后重新配置 <code class="docutils literal notranslate"><span class="pre">sys-libs/timezone-data</span></code> 软件包，这个软件包会更新 <code class="docutils literal notranslate"><span class="pre">/etc/localtime</span></code> :</p>
<div class="literal-block-wrapper docutils container" id="id51">
<div class="code-block-caption"><span class="caption-text">重新配置 sys-libs/timezone-data</span><a class="headerlink" href="#id51" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--config<span class="w"> </span>sys-libs/timezone-data
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">sys-libs/timezone-data</span></code> 是将 <code class="docutils literal notranslate"><span class="pre">/usr/share/zoneinfo/Asia/Shanghai</span></code> 复制为 <code class="docutils literal notranslate"><span class="pre">/etc/localtime</span></code> 。这和我之前在 <a class="reference internal" href="../../infra_service/ntp/deploy_ntp.html#deploy-ntp"><span class="std std-ref">部署NTP服务(集群)</span></a> 采用软连接方法不同</p>
</div>
</section>
<section id="id7">
<h2>配置本地化(语言支持)<a class="headerlink" href="#id7" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>修订 <code class="docutils literal notranslate"><span class="pre">/etc/locale.gen</span></code> (我这里直接添加，原配置文件是一些注释案例):</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id52">
<div class="code-block-caption"><span class="caption-text">在 /etc/locale.gen 中添加 UTF-8 支持</span><a class="headerlink" href="#id52" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;en_US.UTF-8 UTF-8&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/locale.gen
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>根据 <code class="docutils literal notranslate"><span class="pre">/etc/locale.gen</span></code> 生成所有本地化支持:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id53">
<div class="code-block-caption"><span class="caption-text">运行 <code class="docutils literal notranslate"><span class="pre">locale-gen</span></code> 命令，根据 /etc/locale.gen 生成本地化支持</span><a class="headerlink" href="#id53" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>locale-gen
</pre></div>
</div>
</div>
<p>可以看到实际生成了2个本地化支持:</p>
<div class="literal-block-wrapper docutils container" id="id54">
<div class="code-block-caption"><span class="caption-text">运行 <code class="docutils literal notranslate"><span class="pre">locale-gen</span></code> 命令输出，显示支持2个本地化字符集</span><a class="headerlink" href="#id54" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>*<span class="w"> </span>Generating<span class="w"> </span><span class="m">2</span><span class="w"> </span>locales<span class="w"> </span><span class="o">(</span>this<span class="w"> </span>might<span class="w"> </span>take<span class="w"> </span>a<span class="w"> </span><span class="k">while</span><span class="o">)</span><span class="w"> </span>with<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="nb">jobs</span>
<span class="w"> </span>*<span class="w">  </span><span class="o">(</span><span class="m">2</span>/2<span class="o">)</span><span class="w"> </span>Generating<span class="w"> </span>C.UTF-8<span class="w"> </span>...<span class="w">                                         </span><span class="o">[</span><span class="w"> </span>ok<span class="w"> </span><span class="o">]</span>
<span class="w"> </span>*<span class="w">  </span><span class="o">(</span><span class="m">1</span>/2<span class="o">)</span><span class="w"> </span>Generating<span class="w"> </span>en_US.UTF-8<span class="w"> </span>...<span class="w">                                     </span><span class="o">[</span><span class="w"> </span>ok<span class="w"> </span><span class="o">]</span>
<span class="w"> </span>*<span class="w"> </span>Generation<span class="w"> </span><span class="nb">complete</span>
<span class="w"> </span>*<span class="w"> </span>Adding<span class="w"> </span>locales<span class="w"> </span>to<span class="w"> </span>archive<span class="w"> </span>...<span class="w">                                         </span><span class="o">[</span><span class="w"> </span>ok<span class="w"> </span><span class="o">]</span>
</pre></div>
</div>
</div>
</section>
<section id="id8">
<h2>选择本地化<a class="headerlink" href="#id8" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>显示可支持的 <code class="docutils literal notranslate"><span class="pre">lcoale</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id55">
<div class="code-block-caption"><span class="caption-text">查看当前locale</span><a class="headerlink" href="#id55" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eselect<span class="w"> </span>locale<span class="w"> </span>list
</pre></div>
</div>
</div>
<p>输出信息如下:</p>
<div class="literal-block-wrapper docutils container" id="id56">
<div class="code-block-caption"><span class="caption-text">查看当前locale输出</span><a class="headerlink" href="#id56" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Available<span class="w"> </span>targets<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>LANG<span class="w"> </span>variable:
<span class="w">  </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w">   </span>C
<span class="w">  </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">   </span>C.utf8
<span class="w">  </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w">   </span>POSIX
<span class="w">  </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w">   </span>en_US.utf8
<span class="w">  </span><span class="o">[</span><span class="m">5</span><span class="o">]</span><span class="w">   </span>C.UTF8<span class="w"> </span>*
<span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="o">]</span><span class="w">   </span><span class="o">(</span>free<span class="w"> </span>form<span class="o">)</span>
</pre></div>
</div>
</div>
<p>当前是 <code class="docutils literal notranslate"><span class="pre">C.UTF8</span></code></p>
<ul class="simple">
<li><p>可以修订，例如 <code class="docutils literal notranslate"><span class="pre">en_US.utf8</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id57">
<div class="code-block-caption"><span class="caption-text">设置locale</span><a class="headerlink" href="#id57" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eselect<span class="w"> </span>locale<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="m">4</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>重新加载环境:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id58">
<div class="code-block-caption"><span class="caption-text">更新加载环境</span><a class="headerlink" href="#id58" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>env-update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>/etc/profile<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PS1</span><span class="o">=</span><span class="s2">&quot;(chroot) </span><span class="si">${</span><span class="nv">PS1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="id9">
<h2>配置内核准备<a class="headerlink" href="#id9" title="此标题的永久链接">¶</a></h2>
<section id="firmware-microcode">
<h3>(可选)安装firmware 和/或 microcode<a class="headerlink" href="#firmware-microcode" title="此标题的永久链接">¶</a></h3>
<section id="firmware">
<h4>Firmware<a class="headerlink" href="#firmware" title="此标题的永久链接">¶</a></h4>
<p>在开始配置内核并重启系统前，建议安装  <code class="docutils literal notranslate"><span class="pre">sys-kernel/linux-firmware</span></code> !!!</p>
<p>原因是现代很多无限网卡需要Firmware才能正常工作，而AMD/Nvidia/Intel的GPU通常也需要Firmware才能发挥全部功能:</p>
<ul class="simple">
<li><p>安装Fireware:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id59">
<div class="code-block-caption"><span class="caption-text">安装 <code class="docutils literal notranslate"><span class="pre">sys-kernel/linux-firmware</span></code></span><a class="headerlink" href="#id59" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>sys-kernel/linux-firmware
</pre></div>
</div>
</div>
</section>
<section id="microcode">
<h4>Microcode<a class="headerlink" href="#microcode" title="此标题的永久链接">¶</a></h4>
<p>CPU处理器也需要固件更新:</p>
<ul class="simple">
<li><p>AMD处理器: <code class="docutils literal notranslate"><span class="pre">sys-kernel/linux-firmware</span></code></p></li>
<li><p>Intel处理器: <code class="docutils literal notranslate"><span class="pre">sys-firmware/intel-microcode</span></code></p></li>
<li><p>安装intel microcode:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id60">
<div class="code-block-caption"><span class="caption-text">安装 <code class="docutils literal notranslate"><span class="pre">sys-kernel/intel-microcode</span></code></span><a class="headerlink" href="#id60" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>sys-firmware/intel-microcode
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>CPU microcode后续再具体学习实践</p>
</div>
</section>
</section>
</section>
<section id="id10">
<h2>内核配置和编译<a class="headerlink" href="#id10" title="此标题的永久链接">¶</a></h2>
<p><strong>终于来到了最核心的部分</strong></p>
<p>Gentoo提供了三种内核管理方法，并且安装以后任何时候都可以切换到其他新方法: 以下是最简单到最复杂的方法</p>
<ul class="simple">
<li><p>全自动方法: 分发内核</p></li>
</ul>
<p>分发内核用于配置、自动构建和安装 Linux 内核、其相关模块和（可选，但默认启用）initramfs 文件。 未来的内核更新是完全自动化的，因为它们是通过包管理器处理的，就像任何其他系统包一样。 如果需要自定义，可以提供自定义内核配置文件。 这是最少涉及的过程，并且非常适合新的 Gentoo 用户，因为它开箱即用，并且系统管理员的参与最少。</p>
<ul class="simple">
<li><p>混合方法：Genkernel</p></li>
</ul>
<p>新内核源代码通过系统包管理器安装。 系统管理员使用 Gentoo 的 <code class="docutils literal notranslate"><span class="pre">genkernel</span></code> 工具来一般配置、自动构建和安装 Linux 内核、其相关模块和（可选，但默认情况下未启用）initramfs 文件。 如果需要自定义，可以提供自定义内核配置文件。 未来的内核配置、编译和安装需要系统管理员以运行 eselect kernel、genkernel 和可能的其他命令的形式参与每次更新。</p>
<ul class="simple">
<li><p>全手动方式:</p></li>
</ul>
<p>新内核源代码通过系统包管理器安装。 内核是使用 eselect 内核和一系列 make 命令手动配置、构建和安装的。 未来的内核更新会重复配置、构建和安装内核文件的手动过程。 这是最复杂的过程，但提供了对内核更新过程的最大控制。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>初次安装我采用 <code class="docutils literal notranslate"><span class="pre">分发内核</span></code> (Distribution kernels) ，以便尽快运行。等系统稳定后，在切换到 <code class="docutils literal notranslate"><span class="pre">全手动方式</span></code></p>
</div>
<section id="id11">
<h3>分发内核<a class="headerlink" href="#id11" title="此标题的永久链接">¶</a></h3>
<p>分发内核是涵盖解包、配置、编译和安装内核的完整过程的 <code class="docutils literal notranslate"><span class="pre">ebuild</span></code> 。 这种方法的主要优点是作为 <code class="docutils literal notranslate"><span class="pre">&#64;world</span></code> 升级的一部分，包管理器将内核更新到新版本。 这不需要比运行 emerge 命令更多的参与。 分发内核默认为支持大多数硬件的配置，但是提供了两种自定义机制： <code class="docutils literal notranslate"><span class="pre">savedconfig</span></code> 和 <code class="docutils literal notranslate"><span class="pre">config</span> <span class="pre">snippets</span></code> 。</p>
<ul>
<li><p>在使用分发内核之前，先确保系统安装了正确的 <code class="docutils literal notranslate"><span class="pre">installkernel</span></code> 包 (一种是 <code class="docutils literal notranslate"><span class="pre">systemd-boot</span></code> 一种是 <code class="docutils literal notranslate"><span class="pre">gentoo</span></code> ，我使用后者，默认已经在 stage3 安装好了，所以不用重复):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">ask</span> <span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">installkernel</span><span class="o">-</span><span class="n">gentoo</span>
</pre></div>
</div>
</li>
<li><p>安装分发内核，有两种方式:</p></li>
</ul>
<p>一种是从源代码编译一个Gentoo patches的内核(我采用这个方法):</p>
<div class="literal-block-wrapper docutils container" id="id61">
<div class="code-block-caption"><span class="caption-text">从源代码编译安装Gentoo patches的内核</span><a class="headerlink" href="#id61" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>sys-kernel/gentoo-kernel
</pre></div>
</div>
</div>
<p>另一种是直接安装预先编译好的内核:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">ask</span> <span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">gentoo</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="nb">bin</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>安装内核后，包管理器会自动将其更新到更新的版本。 以前的版本将被保留，直到包管理器被要求清理陈旧的包</p>
<p>如果要清理旧包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">depclean</span>
</pre></div>
</div>
<p>或者指定清理旧内核版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">prune</span> <span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">gentoo</span><span class="o">-</span><span class="n">kernel</span> <span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">gentoo</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="nb">bin</span>
</pre></div>
</div>
</div>
<ul>
<li><p>(无需操作)分发内核安装完成后，能够自动重建由其他软件包安装的内核模块:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">linux-mod.eclass</span></code> 提供 <code class="docutils literal notranslate"><span class="pre">dist-kernel</span></code> USE 标志，它控制对 <code class="docutils literal notranslate"><span class="pre">virtual/dist-kernel</span></code> 的 subslot 依赖性</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sys-fs/zfs</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sys-fs/zfs-kmod</span></code> 等包上使用了 <code class="docutils literal notranslate"><span class="pre">dist-kernel</span></code> USE 标志，所以能够根据更新的内核自动重建，相应地生成 <code class="docutils literal notranslate"><span class="pre">initramfs</span></code></p></li>
</ul>
</li>
<li><p>(一般无需操作)如果需要，也可以在内核升级完成后手工触发 <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> 重建:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">ask</span> <span class="nd">@module</span><span class="o">-</span><span class="n">rebuild</span>
</pre></div>
</div>
</li>
<li><p>如果需要一些内核模块在早期启动时加载(例如ZFS)，则应该通过以下命令重建 <code class="docutils literal notranslate"><span class="pre">initramfs</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emerge</span> <span class="o">--</span><span class="n">config</span> <span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">gentoo</span><span class="o">-</span><span class="n">kernel</span>
<span class="n">emerge</span> <span class="o">--</span><span class="n">config</span> <span class="n">sys</span><span class="o">-</span><span class="n">kernel</span><span class="o">/</span><span class="n">gentoo</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="nb">bin</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>安装内核源代码和手工编译(或者 <code class="docutils literal notranslate"><span class="pre">Genkernel</span></code> )，我准备后续独立搞( <a class="reference internal" href="gentoo_kernel.html#gentoo-kernel"><span class="std std-ref">Gentoo内核编译</span></a> )，这里先忽略</p>
</div>
</section>
</section>
<section id="id12">
<h2>配置系统<a class="headerlink" href="#id12" title="此标题的永久链接">¶</a></h2>
<section id="id13">
<h3>文件系统<a class="headerlink" href="#id13" title="此标题的永久链接">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 提供了文件系统挂载配置(挂载点和选项)。文件系统标签和UUID可以通过 <code class="docutils literal notranslate"><span class="pre">blkid</span></code> 命令查看，对于多磁盘，由于启动系统时识别磁盘可能顺序随机(导致设备识别名变化)，所以建议使用UUID来识别设备进行挂载。但是，需要注意，当分区被擦除，则文件系统label和UUID值将会变化或移除。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>LVM的卷和LVM的snapshot使用相同的UUID，所以如果挂载LVM卷不要使用UUID。</p>
</div>
<ul class="simple">
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">blkid</span></code> 检查磁盘，当前显示主机内部的NVMe设备分区如下:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id62">
<div class="code-block-caption"><span class="caption-text">blkid显示输出内置NVMe设备分区(label和UUID)</span><a class="headerlink" href="#id62" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="hll">/dev/nvme0n1p3:<span class="w"> </span><span class="nv">UUID</span><span class="o">=</span><span class="s2">&quot;4897f75b-f7b4-4c8b-ae8e-e39f923685c1&quot;</span><span class="w"> </span><span class="nv">BLOCK_SIZE</span><span class="o">=</span><span class="s2">&quot;512&quot;</span><span class="w"> </span><span class="nv">TYPE</span><span class="o">=</span><span class="s2">&quot;xfs&quot;</span><span class="w"> </span><span class="nv">PARTLABEL</span><span class="o">=</span><span class="s2">&quot;rootfs&quot;</span><span class="w"> </span><span class="nv">PARTUUID</span><span class="o">=</span><span class="s2">&quot;fbf163f3-a42e-411a-be61-f2ae7b398e61&quot;</span>
</span><span class="hll">/dev/nvme0n1p1:<span class="w"> </span><span class="nv">LABEL_FATBOOT</span><span class="o">=</span><span class="s2">&quot;EFI&quot;</span><span class="w"> </span><span class="nv">LABEL</span><span class="o">=</span><span class="s2">&quot;EFI&quot;</span><span class="w"> </span><span class="nv">UUID</span><span class="o">=</span><span class="s2">&quot;67E3-17ED&quot;</span><span class="w"> </span><span class="nv">BLOCK_SIZE</span><span class="o">=</span><span class="s2">&quot;512&quot;</span><span class="w"> </span><span class="nv">TYPE</span><span class="o">=</span><span class="s2">&quot;vfat&quot;</span><span class="w"> </span><span class="nv">PARTLABEL</span><span class="o">=</span><span class="s2">&quot;EFI System Partition&quot;</span><span class="w"> </span><span class="nv">PARTUUID</span><span class="o">=</span><span class="s2">&quot;6cd70fde-609c-4e2b-aaa1-ab64a4a68ed8&quot;</span>
</span>/dev/nvme0n1p2:<span class="w"> </span><span class="nv">UUID</span><span class="o">=</span><span class="s2">&quot;f3dd09f5-068d-4f9c-b756-e0abe94939e7&quot;</span><span class="w"> </span><span class="nv">BLOCK_SIZE</span><span class="o">=</span><span class="s2">&quot;4096&quot;</span><span class="w"> </span><span class="nv">TYPE</span><span class="o">=</span><span class="s2">&quot;apfs&quot;</span><span class="w"> </span><span class="nv">PARTUUID</span><span class="o">=</span><span class="s2">&quot;1d31b24d-12c5-4bb4-a193-59231dd16665&quot;</span>
</pre></div>
</div>
</div>
<p>其中 分区3 是安装Gentoo Linux的分区，将被挂载到根分区 <code class="docutils literal notranslate"><span class="pre">/</span></code> ; 分区1是原先 <a class="reference internal" href="../../apple/macos/index.html#macos"><span class="std std-ref">macOS</span></a> 安装时已经构建的 <code class="docutils literal notranslate"><span class="pre">vfat32</span></code> 文件系统分区，用于存储EFI启动信息，这个分区也是和 Gentoo Linux 共用的，将被挂载到 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 目录</p>
<ul class="simple">
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-lh</span> <span class="pre">/dev/disk/by-uuid</span></code> 可以看到上述分区信息，这个设备路径可以用于配置 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id63">
<div class="code-block-caption"><span class="caption-text">/dev/disk/by-uuid 目录下文件软连接显示UUID对应设备</span><a class="headerlink" href="#id63" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="hll">lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">15</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">23</span>:03<span class="w"> </span>4897f75b-f7b4-4c8b-ae8e-e39f923685c1<span class="w"> </span>-&gt;<span class="w"> </span>../../nvme0n1p3
</span><span class="hll">lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">15</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">22</span>:56<span class="w"> </span>67E3-17ED<span class="w"> </span>-&gt;<span class="w"> </span>../../nvme0n1p1
</span>lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">15</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">22</span>:56<span class="w"> </span>f3dd09f5-068d-4f9c-b756-e0abe94939e7<span class="w"> </span>-&gt;<span class="w"> </span>../../nvme0n1p2
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 如下:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id64">
<div class="code-block-caption"><span class="caption-text">使用UUID配置 /etc/fstab</span><a class="headerlink" href="#id64" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/dev/disk/by-uuid/4897f75b-f7b4-4c8b-ae8e-e39f923685c1<span class="w">    </span>/<span class="w">    </span>xfs<span class="w">    </span>defaults,noatime<span class="w">    </span><span class="m">0</span><span class="w"> </span><span class="m">1</span>
/dev/disk/by-uuid/67E3-17ED<span class="w">    </span>/boot<span class="w">    </span>vfat<span class="w">    </span>defaults,noatime<span class="w">    </span><span class="m">0</span><span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="id14">
<h2>网络配置<a class="headerlink" href="#id14" title="此标题的永久链接">¶</a></h2>
<section id="id15">
<h3>主机名<a class="headerlink" href="#id15" title="此标题的永久链接">¶</a></h3>
<ul class="simple">
<li><p>主机名配置 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id65">
<div class="code-block-caption"><span class="caption-text">设置主机名</span><a class="headerlink" href="#id65" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;xcloud&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/hostname
</pre></div>
</div>
</div>
</section>
<section id="id16">
<h3>网络<a class="headerlink" href="#id16" title="此标题的永久链接">¶</a></h3>
<ul class="simple">
<li><p>对于动态获取IP地址，可以采用 <code class="docutils literal notranslate"><span class="pre">dhcpcd</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id66">
<div class="code-block-caption"><span class="caption-text">使用dhcpcd动态分配IP</span><a class="headerlink" href="#id66" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>net-misc/dhcpcd
rc-update<span class="w"> </span>add<span class="w"> </span>dhcpcd<span class="w"> </span>default
rc-service<span class="w"> </span>dhcpcd<span class="w"> </span>start
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果使用有线网络，则上述使用dhcpcd就已经足够，甚至无需配置网络。Gentoo使用了自己独特的 <code class="docutils literal notranslate"><span class="pre">netifrc</span></code> 框架来配置和管理网络接口。这个 <code class="docutils literal notranslate"><span class="pre">net-misc/netifrc</span></code> 默认已经安装</p>
</div>
</section>
<section id="hosts">
<h3>hosts文件<a class="headerlink" href="#hosts" title="此标题的永久链接">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 文件帮助解析不能通过DNS服务器解析的服务器，通常要设置本机 <code class="docutils literal notranslate"><span class="pre">hostname</span></code> 对应解析:</p>
<div class="literal-block-wrapper docutils container" id="id67">
<div class="code-block-caption"><span class="caption-text">/etc/hosts 配置主机解析</span><a class="headerlink" href="#id67" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">127</span>.0.0.1<span class="w">    </span>xcloud.cloud-atlas.io<span class="w">    </span>xcloud<span class="w">    </span>localhost
::1<span class="w">          </span>xcloud.cloud-atlas.io<span class="w">    </span>xcloud<span class="w">    </span>localhost<span class="w">  </span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="id17">
<h2>系统信息<a class="headerlink" href="#id17" title="此标题的永久链接">¶</a></h2>
<ul>
<li><p>配置root用户密码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">passwd</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="init">
<h2>Init和启动配置<a class="headerlink" href="#init" title="此标题的永久链接">¶</a></h2>
<section id="openrc">
<h3>OpenRC<a class="headerlink" href="#openrc" title="此标题的永久链接">¶</a></h3>
<p>OpenRC使用 <code class="docutils literal notranslate"><span class="pre">/etc/rc.conf</span></code> 来配置服务的启动和关闭，这个配置文件中有大量的注释来帮助设置. (待实践)</p>
</section>
</section>
<section id="id18">
<h2>安装工具<a class="headerlink" href="#id18" title="此标题的永久链接">¶</a></h2>
<section id="id19">
<h3>系统日志服务<a class="headerlink" href="#id19" title="此标题的永久链接">¶</a></h3>
<p>对于使用OpenRC，当前Gentoo的Stage3压缩包缺少一些工具，原因是有多个软件提供相同功能，所以Gentoo让用户自行选择。而 <a class="reference internal" href="../redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 是集成了日志服务，所以不需要这个安装配置。以下是OpenRC的配置日志服务 <code class="docutils literal notranslate"><span class="pre">sysklogd</span></code> (一个开箱即用的传统系统日志服务，没有采用重量级的 <code class="docutils literal notranslate"><span class="pre">rsyslog</span></code> 或 <code class="docutils literal notranslate"><span class="pre">syslog-ng</span></code> ):</p>
<div class="literal-block-wrapper docutils container" id="id68">
<div class="code-block-caption"><span class="caption-text">安装sysklogd作为日志服务</span><a class="headerlink" href="#id68" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>app-admin/sysklogd
rc-update<span class="w"> </span>add<span class="w"> </span>sysklogd<span class="w"> </span>default
</pre></div>
</div>
</div>
</section>
<section id="id20">
<h3>(可选)工具集合<a class="headerlink" href="#id20" title="此标题的永久链接">¶</a></h3>
<p>安装cron服务/文件索引/ssh服务启用/dos文件系统工具:</p>
<div class="literal-block-wrapper docutils container" id="id69">
<div class="code-block-caption"><span class="caption-text">可选工具配置</span><a class="headerlink" href="#id69" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定时服务</span>
emerge<span class="w"> </span>--ask<span class="w"> </span>sys-process/cronie
rc-update<span class="w"> </span>add<span class="w"> </span>cronie<span class="w"> </span>default

<span class="c1"># 文件索引</span>
emerge<span class="w"> </span>--ask<span class="w"> </span>sys-apps/mlocate

<span class="c1"># 启用ssh远程登陆</span>
rc-update<span class="w"> </span>add<span class="w"> </span>sshd<span class="w"> </span>default

<span class="c1"># dos文件系统工具</span>
emerge<span class="w"> </span>--ask<span class="w"> </span>sys-fs/dosfstools

<span class="c1"># 安装bind(DNS)客户端工具</span>
emerge<span class="w"> </span>--ask<span class="w"> </span>bind-tools

<span class="c1"># 安装无线工具</span>
emerge<span class="w"> </span>--ask<span class="w"> </span>net-wireless/iw<span class="w"> </span>net-wireless/wpa_supplicant

<span class="c1"># USB工具(提供了lsusb)</span>
emerge<span class="w"> </span>--ask<span class="w"> </span>sys-apps/usbutils
</pre></div>
</div>
</div>
</section>
</section>
<section id="bootloader">
<h2>配置bootloader<a class="headerlink" href="#bootloader" title="此标题的永久链接">¶</a></h2>
<p>Gentoo 官方文档 <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Bootloader">Configuring the bootloader</a> 提供了多种bootloader设置方法。对于UEFI系统，例如我的MacBook Pro，我采用之前 <a class="reference internal" href="../arch_linux/archlinux_on_mbp.html#archlinux-on-mbp"><span class="std std-ref">MacBook Pro上运行Arch Linux</span></a> 相同的方法: 采用 <code class="docutils literal notranslate"><span class="pre">efibootmgr</span></code> 来管理UEFI启动顺序，这也是Gentoo官方bootloader文档中介绍的可选方法之一</p>
<ul class="simple">
<li><p>安装:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id70">
<div class="code-block-caption"><span class="caption-text">安装 efibootmgr</span><a class="headerlink" href="#id70" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emerge<span class="w"> </span>--ask<span class="w"> </span>sys-boot/efibootmgr
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>配置启动Gentoo:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id71">
<div class="code-block-caption"><span class="caption-text">设置efibootmgr</span><a class="headerlink" href="#id71" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>efibootmgr<span class="w"> </span>--disk<span class="w"> </span>/dev/nvme0n1<span class="w"> </span>--part<span class="w"> </span><span class="m">1</span><span class="w"> </span>--create<span class="w"> </span>--label<span class="w"> </span><span class="s2">&quot;Gentoo Linux&quot;</span><span class="w"> </span>--loader<span class="w"> </span>/vmlinuz-6.1.12-gentoo-dist<span class="w"> </span>--unicode<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s1">&#39;root=PARTUUID=fbf163f3-a42e-411a-be61-f2ae7b398e61 rw initrd=\initramfs-6.1.12-gentoo-dist.img&#39;</span><span class="w"> </span>--verbose
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--disk</span> <span class="pre">/dev/nvme0n1</span></code> 是指整个磁盘设备</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--part</span> <span class="pre">1</span></code> 是指ESP分区，这个分区是Apple和Gentoo共享的</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">root=PARTUUID=fbf163f3-a42e-411a-be61-f2ae7b398e61</span></code> 这个参数是 <code class="docutils literal notranslate"><span class="pre">PARTUUID</span></code> ，是通过 <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-lh</span> <span class="pre">/dev/disk/by-partuuid/</span></code> 查询得到。注意，不是磁盘UUID(在 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 中使用磁盘UUID)</p></li>
</ul>
</div>
</section>
<section id="id21">
<h2>收尾工作<a class="headerlink" href="#id21" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>添加用户账号(huatai)，并且添加到sudo中:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id72">
<div class="code-block-caption"><span class="caption-text">添加用户账号</span><a class="headerlink" href="#id72" title="此代码块的永久链接">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>useradd<span class="w"> </span>-G<span class="w"> </span>users,wheel,audio<span class="w"> </span>-u<span class="w"> </span><span class="m">502</span><span class="w"> </span>-g<span class="w"> </span><span class="m">20</span><span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>huatai
</pre></div>
</div>
</div>
<ul>
<li><p>重启系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exit</span>
<span class="n">cd</span>
<span class="n">umount</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">gentoo</span><span class="o">/</span><span class="n">dev</span><span class="p">{</span><span class="o">/</span><span class="n">shm</span><span class="p">,</span><span class="o">/</span><span class="n">pts</span><span class="p">,}</span>
<span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">gentoo</span><span class="p">{</span><span class="o">/</span><span class="n">boot</span><span class="p">,</span><span class="o">/</span><span class="n">sys</span><span class="p">,</span><span class="o">/</span><span class="n">proc</span><span class="p">,}</span>
<span class="n">reboot</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id22">
<h2>参考<a class="headerlink" href="#id22" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://www.gentoo-wiki.info/Apple_MacBook">Apple MacBook</a> - 早期版本MacBook的安装</p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/MacBook#MacBook_Pro_with_Retina_display">ArchLinux MacBook</a> - 在MacBook上运行Arch Linux，文档较为全面</p></li>
<li><p><a class="reference external" href="https://wiki.gentoo.org/wiki/Apple_Macbook_Pro_Retina">Apple Macbook Pro Retina</a> - 在Retina版本的MacBook Pro上安装Gentoo</p></li>
<li><p><a class="reference external" href="http://pjq.me/wiki/doku.php?id=linux:gentoo-prefix">Install Gentoo Prefix on MacBook Pro</a> - 在OS X系统中运行Gentoo Prefix获得Gentoo Linux体验</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="intro_gentoo.html" class="btn btn-neutral float-left" title="Gentoo Linux简介" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="upgrade_gentoo.html" class="btn btn-neutral float-right" title="升级Gentoo" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>