<!DOCTYPE html>
<html class="writer-html5" lang="zh" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacBook Pro上运行Arch Linux &mdash; Cloud Atlas: Discovery beta 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8534f863"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="ThinkPad X220上运行Arch Linux" href="archlinux_on_thinkpad_x220.html" />
    <link rel="prev" title="最佳Arch Linux发行版" href="best_archlinux.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Cloud Atlas: Discovery
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvm/index.html">KVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../k8s_dev/index.html">Kubernetes Develop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rancher/index.html">Rancher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/index.html">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgsql/index.html">PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nosql/index.html">NoSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/index.html">Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_service/index.html">Infra-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_search/index.html">Infra-Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info_service/index.html">Info-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drone/index.html">Drone</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../best_linux.html">最佳Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin/index.html">Linux系统管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redhat_linux/index.html">RedHat Linux</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Arch Linux</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro_archlinux.html">Arch Linux简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="best_archlinux.html">最佳Arch Linux发行版</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MacBook Pro上运行Arch Linux</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arch-linux">安装arch linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">配制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uefi">UEFI启动</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nvidia">Nvidia显卡</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">图形桌面</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">屏幕亮度</a></li>
<li class="toctree-l4"><a class="reference internal" href="#suspend">Suspend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">内核参数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">屏幕分辨率相关设置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">参考</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_on_thinkpad_x220.html">ThinkPad X220上运行Arch Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_on_thinkpad_x220_u_disk.html">ThinkPad X220上运行Arch Linux(U盘)</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_on_mba.html">MacBook Air上运行Arch Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="kinto.html">Kinto.sh - 为Linux/Windows提供 <code class="docutils literal notranslate"><span class="pre">Mac风格快捷键</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_init.html">Arch Linux精简系统初始化</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_chinese_mirrorlist.html">arch linux添加国内源(mirrorlist)</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_config_ip.html">arch linux配置IP(静态或动态)</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_wpa_supplicant.html">arch linux使用wpa_supplicant连接无线网络</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_sway.html">archlinux Sway图形桌面</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_chinese.html">arch linux中文环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_sway_chinese.html">archlinux Sway图形桌面和中文环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_ms_fonts.html">Arch Linux Windows字体</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_vultr.html">在Vultr VPS中运行Arch Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="pacman.html">Pacman</a></li>
<li class="toctree-l3"><a class="reference internal" href="pacman_proxy.html">pacman使用代理服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_downgrade_package.html">arch linux降级软件包</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_aur.html">Arch Linux AUR</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_snap.html">Arch Linux运行snap</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_alsa.html">Arch Linux ALSA声音系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_hibernates.html">Arch Linux Hibernates</a></li>
<li class="toctree-l3"><a class="reference internal" href="alien_convert_package.html">alien转换安装包</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_developer.html">Arch Linux开发环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="xmodmap.html">Xmodmap修改键盘映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="dropbox.html">Arch Linux上使用Dropbox</a></li>
<li class="toctree-l3"><a class="reference internal" href="cross_compile.html">交叉编译</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_makepkg.html">Arch Linux makepkg</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_wine.html">ArchLinux平台wine环境运行Windows程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_build_kernel.html">Arch Linux编译内核</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_kernel.html">Arch Linux 内核</a></li>
<li class="toctree-l3"><a class="reference internal" href="archlinux_novnc.html">在浏览器中访问arch linux(noVNC)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../asahi_linux/index.html">Asahi Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gentoo_linux/index.html">Gentoo Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lfs/index.html">LFS(Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blfs/index.html">BLFS(Beyond Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alfs/index.html">ALFS(Automated Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pilfs/index.html">PiLFS(Automated Linux from scratch on the Raspberry Pi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../yocto/index.html">Yocto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ubuntu_linux/index.html">Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../suse_linux/index.html">SUSE Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kali_linux/index.html">Kali Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tails_linux/index.html">Tails Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qubes_os/index.html">Qubes OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postmarketos/index.html">postmarketOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../container_os/index.html">容器化操作系统(Container OS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fedora_coreos/index.html">Fedora CoreOS容器操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chromeos/index.html">ChromeOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpine_linux/index.html">Alpine Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subgraph_os/index.html">Subgraph OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kaios/index.html">KaiOS - 世界第三手机操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compute/index.html">Linux计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">Linux存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">Linux网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../server/index.html">Linux服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.html">Linux安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../desktop/index.html">Linux桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linux_tablet/index.html">Linux平板</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell/index.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/index.html">JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nodejs/index.html">Node.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clang/index.html">C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../golang/index.html">Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swift/index.html">Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ruby/index.html">Ruby</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lua/index.html">Lua</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../raspberry_pi/index.html">Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsd/index.html">BSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../freebsd/index.html">FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apple/index.html">Apple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../real/index.html">Real</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life/index.html">Life</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas: Discovery</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Linux</a></li>
          <li class="breadcrumb-item"><a href="index.html">Arch Linux</a></li>
      <li class="breadcrumb-item active">MacBook Pro上运行Arch Linux</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/linux/arch_linux/archlinux_on_mbp.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="macbook-proarch-linux">
<span id="archlinux-on-mbp"></span><h1>MacBook Pro上运行Arch Linux<a class="headerlink" href="#macbook-proarch-linux" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>本文实践是在 <a class="reference internal" href="../../apple/macos/mbp15_late_2013.html#mbp15-late-2013"><span class="std std-ref">MacBook Pro 15&quot; Late 2013</span></a> 完成的，这款MBP硬件是早期的X86架构，通用性较好(除了WiFi模块)</p>
<p>对于 <a class="reference internal" href="../../apple/macos/mbp15_2018.html#mbp15-2018"><span class="std std-ref">MacBook Pro 2018</span></a> 则由于苹果引入了Touch Bar以及指纹识别和T2安全芯片，安装Linux系统就很复杂。我还没有尝试过这种特殊硬件的Linux安装，根据资料:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://gist.github.com/TRPB/437f663b545d23cc8a2073253c774be3">GitHub: TRPB/arch-macbook2018.md</a></p></li>
<li><p><a class="reference external" href="https://wiki.t2linux.org/">t2linux wiki</a> 面向T2芯片的Mac安装Linux</p></li>
</ul>
<p>确实比较折腾，暂时还没有实践。</p>
<p>目前我主要采用在 <a class="reference internal" href="../../raspberry_pi/index.html#raspberry-pi"><span class="std std-ref">Raspberry Pi</span></a> 构建的 <a class="reference internal" href="../../raspberry_pi/pi_cluster/pi_soft_storage_cluster.html#pi-soft-storage-cluster"><span class="std std-ref">树莓派软件定义存储集群</span></a> 实践 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes</span></a> 技术，暂时放弃MacBook上直接运行Linux，改为纯净 <a class="reference internal" href="../../apple/macos/index.html#macos"><span class="std std-ref">macOS</span></a> 结合 <a class="reference internal" href="../../apple/virtualization/lima/index.html#lima"><span class="std std-ref">Lima: Linux Machines</span></a> / <a class="reference internal" href="../../docker/colima/index.html#colima"><span class="std std-ref">Colima</span></a> 来运行虚拟机和容器，以便专注于后端技术。</p>
</div>
<section id="id1">
<h2>安装<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>MacBook Pro上先安装macOS，然后调整磁盘，空出空间给Arch Linux安装。安装完成后，实现双启动。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Mac设备的Firemware update依赖macOS的系统更新，所以如果完全铲除了macOS系统只保留Linux，则无法更新firmware。我保留了128G空间给macOS一方面能够及时更新firmware，另一方面也能够随时切换回macOS系统做iOS/macOS开发。</p>
</div>
<section id="macos">
<h3>安装macOS<a class="headerlink" href="#macos" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>重命名U盘:</p></li>
</ul>
<p>可以使用Disk Utility工具将U盘格式化成一个命名为`CatalinaInstaller`的U盘符</p>
<ul>
<li><p>输入以下命令创建macOS安装U盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">Install</span>\ <span class="n">macOS</span>\ <span class="n">Catalina</span><span class="o">.</span><span class="n">app</span><span class="o">/</span><span class="n">Contents</span><span class="o">/</span><span class="n">Resources</span><span class="o">/</span><span class="n">createinstallmedia</span> <span class="o">--</span><span class="n">volume</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">CatalinaInstaller</span> <span class="o">--</span><span class="n">nointeraction</span>
</pre></div>
</div>
</li>
<li><p>macOS安装非常直观，只需要插入U盘，按住command键，然后按电源键启动，就可以选择从U盘启动，然后格式化磁盘，将mcaOS安装到MacBook Pro上。</p></li>
</ul>
<section id="id2">
<h4>macOS分区调整<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>默认安装的macOS会占据整个磁盘，为了能够安装Linux，我们需要收缩macOS分区。使用的工具就是macOS的Disk Utilities。</p>
<ul class="simple">
<li><p>添加新的分区</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../_images/diskutil_partition.png"><img alt="../../_images/diskutil_partition.png" src="../../_images/diskutil_partition.png" style="width: 720.0px; height: 443.7px;" /></a>
</figure>
<p>注意一定要添加分区，不能添加卷。添加卷实际上是macOS APFS文件系统内部的子卷，只有添加分区才能收缩现有的macOS所在分区。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../_images/diskutil_partition_1.png"><img alt="../../_images/diskutil_partition_1.png" src="../../_images/diskutil_partition_1.png" style="width: 720.0px; height: 409.5px;" /></a>
</figure>
<ul class="simple">
<li><p>点击 <code class="docutils literal notranslate"><span class="pre">+</span></code> 按钮添加一个分区，然后按住以下截图中饼图上箭头所指的调整分区的圆点旋转调整两个分区的大小。例如，我调整Linux分区到400G，保留Mac分区100G。</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../_images/diskutil_partition_2.png"><img alt="../../_images/diskutil_partition_2.png" src="../../_images/diskutil_partition_2.png" style="width: 720.0px; height: 442.8px;" /></a>
</figure>
<p>新创建的分区格式可以任选，反正安装Linux时候还会删除重新创建。</p>
</section>
</section>
<section id="u">
<h3>安装U盘制作<a class="headerlink" href="#u" title="Link to this heading"></a></h3>
<p>如果是macOS平台制作启动U盘，则执行如下命令创建安装U盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hdiutil</span> <span class="n">convert</span> <span class="o">-</span><span class="nb">format</span> <span class="n">UDRW</span> <span class="o">-</span><span class="n">o</span> <span class="n">archlinux</span><span class="o">-</span><span class="mf">2019.10.01</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">img</span> <span class="n">archlinux</span><span class="o">-</span><span class="mf">2019.10.01</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">iso</span>
<span class="n">sudo</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">archlinux</span><span class="o">-</span><span class="mf">2019.10.01</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">dmg</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">rdisk3</span> <span class="n">bs</span><span class="o">=</span><span class="mi">10</span><span class="n">m</span>
</pre></div>
</div>
<p>如果是Linux平台制作启动U盘，则执行如下命令创建安装U盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">archlinux</span><span class="o">-</span><span class="mf">2019.10.01</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">dmg</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span> <span class="n">bs</span><span class="o">=</span><span class="mi">10</span><span class="n">M</span>
</pre></div>
</div>
</section>
</section>
<section id="arch-linux">
<h2>安装arch linux<a class="headerlink" href="#arch-linux" title="Link to this heading"></a></h2>
<p>在MacBook Pro上安装arch linux遇到的第一个问题是无线网卡无法识别。类似 <a class="reference internal" href="../ubuntu_linux/ubuntu_on_mbp.html#ubuntu-on-mbp"><span class="std std-ref">MacBook Pro上运行Ubuntu</span></a> 由于Broadcom的授权限制，发行版不能携带Broadcom BCM4360 802.11ac无线网卡设备驱动。</p>
<p>解决方法是先采用USB网卡连接Internet，先完成操作系统安装，然后再安装 <code class="docutils literal notranslate"><span class="pre">broadcom-wl-dkms</span></code> 软件包来支持无线网卡。</p>
<ul>
<li><p>更新时钟:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timedatectl</span> <span class="nb">set</span><span class="o">-</span><span class="n">ntp</span> <span class="n">true</span>
</pre></div>
</div>
</li>
<li><p>磁盘分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span>
</pre></div>
</div>
</li>
</ul>
<p>此时 <code class="docutils literal notranslate"><span class="pre">print</span></code> 显示分区还是之前在macOS下划分的分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">ATA</span> <span class="n">APPLE</span> <span class="n">SSD</span> <span class="n">SM0512</span> <span class="p">(</span><span class="n">scsi</span><span class="p">)</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="mi">500</span><span class="n">GB</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span><span class="n">B</span><span class="o">/</span><span class="mi">4096</span><span class="n">B</span>
<span class="n">Partition</span> <span class="n">Table</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">Flags</span><span class="p">:</span>

<span class="n">Number</span>  <span class="n">Start</span>   <span class="n">End</span>    <span class="n">Size</span>   <span class="n">File</span> <span class="n">system</span>  <span class="n">Name</span>                  <span class="n">Flags</span>
 <span class="mi">1</span>      <span class="mf">20.5</span><span class="n">kB</span>  <span class="mi">210</span><span class="n">MB</span>  <span class="mi">210</span><span class="n">MB</span>  <span class="n">fat32</span>        <span class="n">EFI</span> <span class="n">System</span> <span class="n">Partition</span>  <span class="n">boot</span><span class="p">,</span> <span class="n">esp</span>
 <span class="mi">2</span>      <span class="mi">210</span><span class="n">MB</span>   <span class="mi">100</span><span class="n">GB</span>  <span class="mi">100</span><span class="n">GB</span>
 <span class="mi">3</span>      <span class="mi">100</span><span class="n">GB</span>   <span class="mi">500</span><span class="n">GB</span>  <span class="mi">400</span><span class="n">GB</span>                                     <span class="n">msftdata</span>
</pre></div>
</div>
<p>删除分区3:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="mi">3</span>
</pre></div>
</div>
<p>重新创建分区3，分区大小50GB:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkpart</span> <span class="n">primary</span> <span class="n">ext4</span> <span class="mi">100</span><span class="n">GB</span> <span class="mi">150</span><span class="n">GB</span>
<span class="n">name</span> <span class="mi">3</span> <span class="n">arch_linux</span>
</pre></div>
</div>
<ul>
<li><p>格式化文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda3</span>
</pre></div>
</div>
</li>
<li><p>挂载文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda3</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
</pre></div>
</div>
</li>
<li><p>选择镜像网站</p></li>
</ul>
<p>arch linux的镜像网站定义在 <code class="docutils literal notranslate"><span class="pre">/etc/pacman.d/mirrorlist</span></code> 。在这个定义文件中，越靠前的网站优先级越高，所以建议将地理位置最近的网站列到最前面。例如，在中国，可以选择163镜像网站。</p>
<ul>
<li><p>安装基本软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacstrap</span> <span class="o">/</span><span class="n">mnt</span> <span class="n">base</span> <span class="n">linux</span> <span class="n">linux</span><span class="o">-</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
</ul>
<section id="id3">
<h3>安装20221101<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>2022年11月1日，我再次在MacBook Pro上安装arch linux，有以下这些区别:</p>
<ul>
<li><p>内置硬盘替换为NVME磁盘，所以磁盘命名不同</p></li>
<li><p>没有再为macOS保留分区，我准备全程使用Linux系统</p></li>
<li><p>使用 <a class="reference internal" href="../storage/disk/parted.html#parted"><span class="std std-ref">parted分区工具</span></a> 对磁盘分区(重建):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 初始化磁盘分区表(擦除原先的所有数据)</span>
<span class="n">parted</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mklabel</span> <span class="n">gpt</span>

<span class="c1"># 创建第一个 分区，用于EFI启动</span>
<span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mkpart</span> <span class="n">ESP</span> <span class="n">fat32</span> <span class="mi">0</span><span class="o">%</span> <span class="mi">256</span><span class="n">MB</span>
<span class="n">parted</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="nb">set</span> <span class="mi">1</span> <span class="n">esp</span> <span class="n">on</span>

<span class="c1"># 创建第二个 分区，用于操作系统部署(剩余空间使用 :ref:`zfs` 卷)</span>
<span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="n">mkpart</span> <span class="n">primary</span> <span class="n">xfs</span> <span class="mi">256</span><span class="n">MB</span> <span class="mi">64</span><span class="n">GB</span>

<span class="c1"># 格式化文件系统</span>
<span class="n">mkdosfs</span> <span class="o">-</span><span class="n">F</span> <span class="mi">32</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">xfs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span>
</pre></div>
</div>
</li>
<li><p>挂载文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
</pre></div>
</div>
</li>
<li><p>选择镜像网站并安装基本软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacstrap</span> <span class="o">-</span><span class="n">K</span> <span class="o">/</span><span class="n">mnt</span> <span class="n">base</span> <span class="n">linux</span> <span class="n">linux</span><span class="o">-</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这次我选择了XFS作为根文件系统，但是安装过程似乎没有包含xfsprogs，导致有fsck报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>==&gt; ERROR: file not found: `fsck.xfs&#39;
==&gt; ERROR: file not found: `xfs_repair&#39;
==&gt; WARNING: No fsck helpers found. fsck will not be run on boot.
</pre></div>
</div>
<p>暂时忽略，等后续系统运行起来再补安装</p>
</div>
</section>
</section>
<section id="id4">
<h2>配制<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>fstab: 生成fstab文件(这里 <code class="docutils literal notranslate"><span class="pre">-U</span></code> 或 <code class="docutils literal notranslate"><span class="pre">-L</span></code> 定义UUID或labels):</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">生成fstab文件</span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">genfstab</span> <span class="o">-</span><span class="n">U</span> <span class="o">/</span><span class="n">mnt</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>chroot 将根修改到新系统:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">chroot进入安装的arch linux系统</span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>arch-chroot<span class="w"> </span>/mnt
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>设置时区:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">设置上海时区</span><a class="headerlink" href="#id13" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ln<span class="w"> </span>-sf<span class="w"> </span>/usr/share/zoneinfo/Asia/Shanghai<span class="w"> </span>/etc/localtime
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>运行 <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> 生成 <code class="docutils literal notranslate"><span class="pre">/etc/cadjtime</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">同步校正时间到硬件时钟</span><a class="headerlink" href="#id14" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hwclock<span class="w"> </span>--systohc
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>本地化语言支持 - 只需要UTF支持就可以，所以修改 <code class="docutils literal notranslate"><span class="pre">/etc/locale.gen</span></code> 保留 <code class="docutils literal notranslate"><span class="pre">en_US.UTF-8</span> <span class="pre">UTF-8</span></code> 然后执行:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">本地化语言支持 UTF</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>locale-gen
</pre></div>
</div>
</div>
<p>创建 <code class="docutils literal notranslate"><span class="pre">locale.conf</span></code> 设置如下:</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">/etc/locale.conf</span></code> 配置</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
</pre></div>
</div>
</div>
<ul>
<li><p>创建 <code class="docutils literal notranslate"><span class="pre">/etc/hostname</span></code> 内容是主机名:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xcloud</span>
</pre></div>
</div>
</li>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">127.0.0.1</span>    <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>    <span class="n">xcloud</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>  <span class="n">xcloud</span>
</pre></div>
</div>
</li>
<li><p>设置root密码:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">设置root密码</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>passwd
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>创建日常账号( <code class="docutils literal notranslate"><span class="pre">admin</span></code> )并设置sudo:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">设置admin账号并设置sudo</span><a class="headerlink" href="#id18" title="Link to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># arch linux使用wheel组，debian则使用sudo组</span>
groupadd<span class="w"> </span>-g<span class="w"> </span><span class="m">505</span><span class="w"> </span>admin
useradd<span class="w"> </span>-g<span class="w"> </span><span class="m">505</span><span class="w"> </span>-u<span class="w"> </span><span class="m">505</span><span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-d<span class="w"> </span>/home/admin<span class="w"> </span>-m<span class="w"> </span>admin
usermod<span class="w"> </span>-aG<span class="w"> </span>wheel<span class="w"> </span>admin
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;%wheel        ALL=(ALL)       NOPASSWD: ALL&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/sudoers
<span class="c1"># 必须设置admin密码，默认root用户无法ssh登陆，需要使用admin账号</span>
passwd<span class="w"> </span>admin
</pre></div>
</div>
</div>
<ul>
<li><p>之前在 <a class="reference internal" href="archlinux_on_thinkpad_x220.html#archlinux-on-thinkpad-x220"><span class="std std-ref">ThinkPad X220上运行Arch Linux</span></a> 遇到默认内核没有加载Vfat模块导致无法读取EFI分区,编辑 <code class="docutils literal notranslate"><span class="pre">/etc/mkinitcpio.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MODULES</span><span class="o">=</span><span class="p">(</span><span class="n">vfat</span> <span class="n">xfs</span><span class="p">)</span>
<span class="n">BINARIES</span><span class="o">=</span><span class="p">(</span><span class="n">fsck</span> <span class="n">fsck</span><span class="o">.</span><span class="n">ext2</span> <span class="n">fsck</span><span class="o">.</span><span class="n">ext3</span> <span class="n">fsck</span><span class="o">.</span><span class="n">ext4</span> <span class="n">e2fsck</span> <span class="n">fsck</span><span class="o">.</span><span class="n">vfat</span> <span class="n">fsck</span><span class="o">.</span><span class="n">msdos</span> <span class="n">fsck</span><span class="o">.</span><span class="n">fat</span> <span class="n">fsck</span><span class="o">.</span><span class="n">xfs</span> <span class="n">xfs_repair</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>然后安装软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">dosfstools</span> <span class="n">xfsprogs</span>
</pre></div>
</div>
<p>再重新生成initramfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkinitcpio</span> <span class="o">-</span><span class="n">P</span>
</pre></div>
</div>
<section id="id5">
<h3>安装必要软件包<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<ul>
<li><p>使用pacman安装必要软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">vim</span> <span class="n">which</span> <span class="n">mlocate</span> <span class="n">oepnssh</span>
</pre></div>
</div>
</li>
<li><p><a class="reference internal" href="archlinux_config_ip.html#archlinux-config-ip"><span class="std std-ref">arch linux配置IP(静态或动态)</span></a> : 配置USB网卡，先确保能够通过有闲网络连接互联网，之后可以再安装无线</p></li>
</ul>
</section>
</section>
<section id="uefi">
<h2>UEFI启动<a class="headerlink" href="#uefi" title="Link to this heading"></a></h2>
<p>在EFI系统中，实际上并不需要安装Grub这样的启动管理系统就可以启动Linux，只需要在EFI中设置启动顺序。</p>
<ul>
<li><p>安装 efibootmgr</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">efibootmgr</span>
</pre></div>
</div>
</li>
</ul>
<p>参考 <a class="reference external" href="https://wiki.archlinux.org/index.php/EFISTUB#Using_UEFI_directly">EFISTUB - Using UEFI directly</a> 执行如下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">efibootmgr</span> <span class="o">--</span><span class="n">disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">DISK</span> <span class="o">--</span><span class="n">part</span> <span class="n">Y</span> <span class="o">--</span><span class="n">create</span> <span class="o">--</span><span class="n">label</span> <span class="s2">&quot;Arch Linux&quot;</span> <span class="o">--</span><span class="n">loader</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span> <span class="o">--</span><span class="n">unicode</span> <span class="s1">&#39;root=PARTUUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX rw initrd=\initramfs-linux.img&#39;</span> <span class="o">--</span><span class="n">verbose</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>这里 <code class="docutils literal notranslate"><span class="pre">--disk</span> <span class="pre">/dev/DISK</span></code> 是指整个磁盘</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--part</span> <span class="pre">Y</span></code> 是指ESP所在分区</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PARTUUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</span></code> 设置PARTUUID参数请检查 <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-lh</span> <span class="pre">/dev/disk/by-partuuid/</span></code> 目录下设备文件的软链接，可以找到对应 <code class="docutils literal notranslate"><span class="pre">根文件系统</span></code> 的 PARTUUID。请注意，PARTUUID和磁盘UUID不同，在 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 中使用的是UUID。</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于2022年11月1日重新在NVME设备上安装，执行 <code class="docutils literal notranslate"><span class="pre">efibootmgr</span></code> 如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">efibootmgr</span> <span class="o">--</span><span class="n">disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span> <span class="o">--</span><span class="n">part</span> <span class="mi">1</span> <span class="o">--</span><span class="n">create</span> <span class="o">--</span><span class="n">label</span> <span class="s2">&quot;Arch Linux&quot;</span> <span class="o">--</span><span class="n">loader</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span> <span class="o">--</span><span class="n">unicode</span> <span class="s1">&#39;root=PARTUUID=5c7afe7a-b41f-415b-9f12-129c3014293a rw initrd=\initramfs-linux.img&#39;</span> <span class="o">--</span><span class="n">verbose</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>默认安装的arch linux内核不支持vfat文件系统，而EFI分区就是vfat，所以在前面重新构建initfs，将vfat支持加入。这个步骤非常重要，否则系统启动时会报错 <code class="docutils literal notranslate"><span class="pre">mount:</span> <span class="pre">/new_root:</span> <span class="pre">unknown</span> <span class="pre">filesystem</span> <span class="pre">type</span> <span class="pre">'vfat'</span></code> 。</p>
</div>
<ul>
<li><p>设置启动顺序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">efibootmgr</span> <span class="o">--</span><span class="n">bootorder</span> <span class="n">XXXX</span><span class="p">,</span><span class="n">XXXX</span> <span class="o">--</span><span class="n">verbose</span>
</pre></div>
</div>
</li>
</ul>
<p>这里 <code class="docutils literal notranslate"><span class="pre">xxxx,xxxx</span></code> 是刚才 <code class="docutils literal notranslate"><span class="pre">efibootmgr</span> <span class="pre">--verbose</span></code> 输出的每个启动项的编号。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这里不设置启动顺序也行，默认就是先启动刚才安装的Arch Linux</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>现在重启操作系统，则立即进入Arch Linux系统。那么如何启动macOS呢？</p>
<p>Mac硬件系统有一个 <code class="docutils literal notranslate"><span class="pre">option</span></code> 键提供了EFI启动选择，在按下电源键同时安装 <code class="docutils literal notranslate"><span class="pre">option</span></code> 键，就会出现启动操作系统的选项。不过Mac的 <code class="docutils literal notranslate"><span class="pre">option</span></code> 键启动看不到Linux分区，所以这里只能作为重新启动macOS的方法。</p>
<p>以上就可以满足macOS和Arch Linux的双启动设置需求。</p>
</div>
</section>
<section id="nvidia">
<h2>Nvidia显卡<a class="headerlink" href="#nvidia" title="Link to this heading"></a></h2>
<p>我的笔记本MacBook 是 2013年底版本，属于 MacBook Pro 11,x 系列。从 <code class="docutils literal notranslate"><span class="pre">dmidecode</span></code> 可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">System</span> <span class="n">Information</span>
     <span class="n">Manufacturer</span><span class="p">:</span> <span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span>
     <span class="n">Product</span> <span class="n">Name</span><span class="p">:</span> <span class="n">MacBookPro11</span><span class="p">,</span><span class="mi">3</span>
</pre></div>
</div>
<ul>
<li><p>检查显卡:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span> <span class="o">-</span><span class="n">k</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">A</span> <span class="mi">2</span> <span class="o">-</span><span class="n">E</span> <span class="s2">&quot;(VGA|3D)&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">01</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">VGA</span> <span class="n">compatible</span> <span class="n">controller</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">GK107M</span> <span class="p">[</span><span class="n">GeForce</span> <span class="n">GT</span> <span class="mi">750</span><span class="n">M</span> <span class="n">Mac</span> <span class="n">Edition</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
 <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">GK107M</span> <span class="p">[</span><span class="n">GeForce</span> <span class="n">GT</span> <span class="mi">750</span><span class="n">M</span> <span class="n">Mac</span> <span class="n">Edition</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">nouveau</span>
</pre></div>
</div>
<p>当前是开源驱动 <code class="docutils literal notranslate"><span class="pre">nouveau</span></code> ，性能较差。</p>
<ul>
<li><p>(旧方法，2022年已废弃)对于 GeForce 600-900 以及 Quadro/Tesla/Tegra K系列显卡，或者更新的显卡(2010-2019年)，安装 <code class="docutils literal notranslate"><span class="pre">nvidia</span></code> 或 <code class="docutils literal notranslate"><span class="pre">nvidia-lts</span></code> 驱动包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">nvidia</span>
</pre></div>
</div>
</li>
</ul>
<p>安装完成后需要重启系统，因为 <code class="docutils literal notranslate"><span class="pre">nvidia</span></code> 软件包包含屏蔽 <code class="docutils literal notranslate"><span class="pre">nouveau</span></code> 模块配置，所以需要重启。</p>
<ul>
<li><p>(新方法，2022年) 由于NVIDIA已经不再最新的驱动中支持 <code class="docutils literal notranslate"><span class="pre">GeForce</span> <span class="pre">GT</span> <span class="pre">750M</span></code> ，所以默认 <code class="docutils literal notranslate"><span class="pre">pacman</span> <span class="pre">-S</span> <span class="pre">nvidia</span></code> 安装的NVIDIA驱动v520版本过高会无法使用。所以根据启动提示，需要使用 <a class="reference internal" href="archlinux_aur.html#archlinux-aur"><span class="std std-ref">Arch Linux AUR</span></a> 安装 <code class="docutils literal notranslate"><span class="pre">nvidia-470xx-dkms</span></code> 软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yay</span> <span class="o">-</span><span class="n">S</span> <span class="n">nvidia</span><span class="o">-</span><span class="mi">470</span><span class="n">xx</span><span class="o">-</span><span class="n">dkms</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id6">
<h2>图形桌面<a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<p>2022年11月重新安装arch linux，选择 <a class="reference internal" href="../desktop/lxqt/index.html#lxqt"><span class="std std-ref">LXQt</span></a> 作为轻量级桌面</p>
</section>
<section id="id7">
<h2>屏幕亮度<a class="headerlink" href="#id7" title="Link to this heading"></a></h2>
<p>对于 <a class="reference internal" href="archlinux_on_thinkpad_x220.html#archlinux-on-thinkpad-x220"><span class="std std-ref">ThinkPad X220上运行Arch Linux</span></a> 是默认就可以通过屏幕亮度调节键直接调整亮度，这个屏幕亮度值是通过设置 <code class="docutils literal notranslate"><span class="pre">/sys/class/backlight/gmux_backlight/brightness</span></code> 来调整的。不过，对于Nvidia显卡，直接调整这个值不生效，需要以 <code class="docutils literal notranslate"><span class="pre">root</span></code> 身份执行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setpci</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">H1</span> <span class="o">-</span><span class="n">s</span> <span class="mi">00</span><span class="p">:</span><span class="mf">01.00</span> <span class="n">BRIDGE_CONTROL</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>然后调整就能够生效。</p>
<p>通过 <a class="reference internal" href="archlinux_aur.html#archlinux-aur"><span class="std std-ref">Arch Linux AUR</span></a> 安装 <code class="docutils literal notranslate"><span class="pre">gmux_backlight</span></code> 软件包之后，就可以以普通用户身份调整屏幕亮度，即修改 <code class="docutils literal notranslate"><span class="pre">/sys/class/backlight/gmux_backlight/brightness</span></code> 。</p>
</section>
<section id="suspend">
<h2>Suspend<a class="headerlink" href="#suspend" title="Link to this heading"></a></h2>
<p>从 Linux Kernel 3.13 开始支持 Suspend(内核 3.12 从suspend唤醒时屏幕没有背光，只能使用 hibernate)，但是需要禁止USB唤醒功能，否则会导致suspend之后立即又恢复工作。执行以下命令将 <code class="docutils literal notranslate"><span class="pre">XHC1</span></code> 设置到 <code class="docutils literal notranslate"><span class="pre">/proc/acpi/wakeup</span></code> 就可以关闭:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">XHC1</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">acpi</span><span class="o">/</span><span class="n">wakeup</span>
</pre></div>
</div>
<p>这个内核proc在设置之后， <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/proc/acpi/wakeup</span></code> 输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DeviceS</span><span class="o">-</span><span class="n">state</span>  <span class="n">Status</span>   <span class="n">Sysfs</span> <span class="n">node</span>
<span class="o">...</span>
<span class="n">XHC1</span>  <span class="n">S3</span><span class="o">*</span><span class="n">disabled</span>  <span class="n">pci</span><span class="p">:</span><span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">14.0</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>不过，依然需要关闭蓝牙鼠标连接，否则鼠标移动还是可能会唤醒系统。但至少不再无法suspend了。</p>
</div>
</section>
<section id="id8">
<h2>内核参数<a class="headerlink" href="#id8" title="Link to this heading"></a></h2>
<p>参考 <a class="reference external" href="https://wiki.archlinux.org/index.php/MacBookPro11,x#Kernel_parameters">Arch Linux社区文档 - MacBookPro11,x#Kernel parameters</a> ，实际上要设置 <a class="reference internal" href="archlinux_hibernates.html#archlinux-hibernates"><span class="std std-ref">Arch Linux Hibernates</span></a>  还需要传递参数 <code class="docutils literal notranslate"><span class="pre">acpi_osi=Darwin</span></code> 。这是因为从内核 4.17.2-1 开始，增加了 <code class="docutils literal notranslate"><span class="pre">acpi_osi</span></code> 参数空值会导致电池无法检测到。此外，添加了 <code class="docutils literal notranslate"><span class="pre">acpi_osi</span></code> 内核参数还可以增加电池寿命。</p>
<p>由于需要传递 <code class="docutils literal notranslate"><span class="pre">acpi_mask_gpe=0x06</span></code> 内核参数避免有时候迅速增加的终端寄存器值导致某个CPU核心达到100%。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>确实我发现 <code class="docutils literal notranslate"><span class="pre">dmesg</span> <span class="pre">-T</span></code> 现实启动有Apple相关的ACPI报错，并且我也遇到过莫名其妙的系统负载极高现象，应该和上述内核参数相关。</p>
</div>
<p>完整 <code class="docutils literal notranslate"><span class="pre">efi</span></code> 命令如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">efibootmgr</span> <span class="o">--</span><span class="n">disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span> <span class="o">--</span><span class="n">part</span> <span class="mi">1</span> <span class="o">--</span><span class="n">create</span> <span class="o">--</span><span class="n">label</span> <span class="s2">&quot;Arch Linux&quot;</span> <span class="o">--</span><span class="n">loader</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span> <span class="o">--</span><span class="n">unicode</span> <span class="s1">&#39;root=PARTUUID=c31f68cd-97f7-4471-93c7-adb62b22a17b rw initrd=\initramfs-linux.img resume=UUID=e38d80cc-4044-4d34-b730-1f0c874ad765 swap_file_offset=7798784 acpi_osi=Darwin acpi_mask_gpe=0x06&#39;</span> <span class="o">--</span><span class="n">verbose</span>
</pre></div>
</div>
</section>
<section id="id9">
<h2>屏幕分辨率相关设置<a class="headerlink" href="#id9" title="Link to this heading"></a></h2>
<p>MacBook Pro的屏幕分辨率极高，默认情况下Linux运行时字体都显示过小，在xfce桌面上主要调整如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Settings</span> <span class="pre">=&gt;</span> <span class="pre">Appearance</span> <span class="pre">=&gt;</span> <span class="pre">Fonts</span></code> (默认编辑区域文字)
- 设置 <code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">Font</span></code> 为 <code class="docutils literal notranslate"><span class="pre">WenQuanYi</span> <span class="pre">Micro</span> <span class="pre">Hei</span> <span class="pre">Regular</span> <span class="pre">13</span></code>
- 设置 <code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">Monospace</span> <span class="pre">Font</span></code> 为 <code class="docutils literal notranslate"><span class="pre">WenQuanYi</span> <span class="pre">Micro</span> <span class="pre">Hei</span> <span class="pre">Regular</span> <span class="pre">13</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Settings</span> <span class="pre">=&gt;</span> <span class="pre">Windows</span> <span class="pre">Manager</span> <span class="pre">=&gt;</span> <span class="pre">Style</span> <span class="pre">=&gt;</span> <span class="pre">Theme</span> <span class="pre">=&gt;</span> <span class="pre">Default</span></code>
- 设置 <code class="docutils literal notranslate"><span class="pre">Title</span> <span class="pre">font</span></code> 为 <code class="docutils literal notranslate"><span class="pre">Sans</span> <span class="pre">Bold</span> <span class="pre">13</span></code></p></li>
</ul>
<p>以上设置之后，基本图形功能都可以非常舒畅使用。但是，Firefox浏览器默认显示的自体过小，调整：</p>
<ul class="simple">
<li><p>菜单 <code class="docutils literal notranslate"><span class="pre">Preferences</span> <span class="pre">=&gt;</span> <span class="pre">Language</span> <span class="pre">and</span> <span class="pre">Appearance</span> <span class="pre">=&gt;</span> <span class="pre">Fonts</span> <span class="pre">and</span> <span class="pre">Colors</span></code>
- 设置 <code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">front</span></code> 为 <code class="docutils literal notranslate"><span class="pre">Default(FreeSerif)</span> <span class="pre">16</span></code></p></li>
</ul>
<p>但是，上述设置对于WEB页面已经通过CSS设置字体无效，除非你在 <code class="docutils literal notranslate"><span class="pre">Advanced...</span></code> 选项中 <code class="docutils literal notranslate"><span class="pre">去除</span></code> 选择 <code class="docutils literal notranslate"><span class="pre">Allow</span> <span class="pre">pages</span> <span class="pre">to</span> <span class="pre">choose</span> <span class="pre">their</span> <span class="pre">own</span> <span class="pre">fonts,</span> <span class="pre">instead</span> <span class="pre">of</span> <span class="pre">your</span> <span class="pre">selections</span> <span class="pre">above</span></code> 。不过，用自己定义的字体强制覆盖WEB页面自体会导致页面风格破坏。</p>
<p>解决方法是调整Firefox默认页面缩放比例，这个设置没有提供UI菜单，需要在地址栏输入 <code class="docutils literal notranslate"><span class="pre">about:config</span></code> 并回车，然后点击 <code class="docutils literal notranslate"><span class="pre">I</span> <span class="pre">accept</span> <span class="pre">the</span> <span class="pre">risk!</span></code> 按钮进入配置。搜索 <code class="docutils literal notranslate"><span class="pre">layout.css.devPixelsPerPx</span></code> ，这个选项默认设置值是 <code class="docutils literal notranslate"><span class="pre">1.0</span></code> ，表示页面显示比例是 100% 。可以调整这个数值，例如 <code class="docutils literal notranslate"><span class="pre">1.5</span></code> 表示显示比例 150%
，以此类推。不过，这个页面显示比例是全局影响，也会导致Firefox的菜单和工具条同步放大，所以也不宜调整过大，我在MacBook Pro上设置 <code class="docutils literal notranslate"><span class="pre">1.5</span></code> 基本已经满足大多数页面浏览。少数页面字体实在过小，只能通过 <code class="docutils literal notranslate"><span class="pre">ctrl</span></code> 加 <code class="docutils literal notranslate"><span class="pre">+</span></code> 按钮临时调整。</p>
</section>
<section id="id10">
<h2>参考<a class="headerlink" href="#id10" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/MacBookPro11,x">Arch Linux社区文档 - MacBookPro11,x</a></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/NVIDIA">Arch Linux社区文档 - NVIDIA</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="best_archlinux.html" class="btn btn-neutral float-left" title="最佳Arch Linux发行版" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="archlinux_on_thinkpad_x220.html" class="btn btn-neutral float-right" title="ThinkPad X220上运行Arch Linux" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">版权所有</a> 2018 - now, Huatai Huang。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡 👈</a></p>
    <br>
    <p>网站采用 <a href="https://utteranc.es/">utterances</a> 评论系统，所有评论存储在<a href="https://github.com/huataihuang/cloud-atlas/issues">GitHub issues</a> 中，如果你看不到下方的评论框，那么可能需要<a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/security/vpn/index.html">自备梯子</a> 👈</p>
    <div class="articleComments">
        <comments>
  <script src="https://utteranc.es/client.js"
    repo="huataihuang/cloud-atlas"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
    </div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>