<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>私有云监控 &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/documentation_options.js?v=7c91f8fd"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="私有云数据层 ZData Ceph" href="zdata_ceph.html" />
    <link rel="prev" title="私有云SSH访问" href="priv_ssh.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes_from_scratch/index.html">Kubernetes From Scratch (KFS) Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rancher/index.html">Rancher Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/index.html">SQLite Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clickhouse/index.html">ClickHouse Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nosql/index.html">NoSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_search/index.html">Search Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info_service/index.html">Info-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flask/index.html">Flask Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clang/index.html">C Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ruby/index.html">Ruby Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Real Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../real_think/index.html">真实世界的技术思考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prepare/index.html">真实云计算的构建准备</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">私有云计算构建</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="priv_cloud_infra.html">私有云架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_ntp.html">私有云NTP服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_dnsmasq_ics.html">私有云DNS服务(dnsmasq)和共享因特网(ICS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_kvm.html">私有云KVM环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-dev.html">开发环境z-dev</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_ssh.html">私有云SSH访问</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">私有云监控</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">物理主机监控</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prometheus">部署Prometheus</a></li>
<li class="toctree-l4"><a class="reference internal" href="#grafana">部署Grafana</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">反向代理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node-exporter">Node Exporter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pcm">PCM监控</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="zdata_ceph.html">私有云数据层 ZData Ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_lvm.html">私有云数据层LVM卷管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="zdata_ceph_rbd_libvirt.html">私有云基于 ZData Ceph 运行虚拟机</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_kvm_sr-iov.html">私有云KVM网络虚拟化sr-iov</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_env.html">构建Kubernetes云计算环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_etcd.html">私有云etcd服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_runtime.html">准备Kubernetes集群(z-k8s)容器运行时</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_kubeadm.html">Kubernetes集群(z-k8s)kubeadm</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s.html">Kubernetes集群(z-k8s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_cilium_kubeproxy_free.html">Kubernetes集群(z-k8s)配置Cilium完全取代kube-proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_cilium_istio.html">Kubernetes集群(z-k8s)配置Cilium结合Istio</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_cilium_metallb.html">Kubernetes集群(z-k8s)配置Cilium集成MetalLB</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_nerdctl.html">Kubernetes集群(z-k8s)使用nerdctl</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_cilium_ingress.html">Kubernetes集群(z-k8s)部署Cilium Ingress</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_docker_registry.html">Kubernetes集群(z-k8s)部署镜像Redgistry</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_nvidia_gpu_operator.html">Kubernetes集群(z-k8s)部署NVIDIA GPU Operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_prometheus-stack.html">Kubernetes集群(z-k8s)部署Prometheus-stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_docker.html">私有云docker环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_k8s_docker_centos.html">私有云Kubernetes和docker环境(CentOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="real_unattended_upgrade.html">真实(模拟)自动系统更新</a></li>
<li class="toctree-l3"><a class="reference internal" href="y-k8s.html">Kubernetes集群(y-k8s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="y-k8s_vgpu.html">y-k8s集群vGPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="y-k8s_nvidia_gpu_operator.html">y-k8s集群通过 <span class="xref std std-ref">nvidia_gpu_operator</span> 部署 <span class="xref std std-ref">gpu_k8s</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="y-k8s_kube-prometheus-stack.html">y-k8s集群部署kube-prometheus-stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="y-k8s_signoz.html">y-k8s集群部署SigNoz监控</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../edge_cloud/index.html">边缘云计算构建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">真实荒漠</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mobile_work/index.html">移动工作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mobile_cloud/index.html">移动云计算构建</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Real Atlas</a></li>
          <li class="breadcrumb-item"><a href="index.html">私有云计算构建</a></li>
      <li class="breadcrumb-item active">私有云监控</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/real/priv_cloud/priv_monitor.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="priv-monitor">
<span id="id1"></span><h1>私有云监控<a class="headerlink" href="#priv-monitor" title="Link to this heading">¶</a></h1>
<p>虽然是在一台二手服务器上通过 <a class="reference internal" href="../../kvm/index.html#kvm"><span class="std std-ref">KVM Atlas</span></a> 虚拟化出云计算集群，但是随着服务器增多和架构部署的复杂化，我渐渐发现，没有一个完善的监控，是很难排查出系统问题和及时发现故障的:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../infra_service/ntp/index.html#ntp"><span class="std std-ref">ntp服务</span></a> 异常会导致分布式集群出现很多意想不到的错误，例如 <a class="reference internal" href="../../web/proxy/squid/squid_ssh_proxy.html#squid-ssh-proxy"><span class="std std-ref">Squid SSH代理</span></a> 遇到 <code class="docutils literal notranslate"><span class="pre">kex_exchange_identification:</span> <span class="pre">Connection</span> <span class="pre">closed</span></code> 异常</p></li>
<li><p><a class="reference internal" href="../../infra_service/dns/index.html#dns"><span class="std std-ref">DNS服务</span></a> 异常会导致服务调用失败</p></li>
</ul>
<section id="id2">
<h2>物理主机监控<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>采用 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> 能够对 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 集群进行监控，也能够通过 <a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_exporters/ipmi_exporter.html#ipmi-exporter"><span class="std std-ref">IPMI Exporter</span></a> 采集物理主机的温度、主频等基础数据，所以在物理主机中:</p>
<ul class="simple">
<li><p>物理主机部署 <a class="reference internal" href="../../linux/server/cockpit/index.html#cockpit"><span class="std std-ref">Cockpit服务器统一管理平台</span></a> ，通过 <a class="reference internal" href="../../performance/pcp/index.html#pcp"><span class="std std-ref">Performance Co-Pilot</span></a> 集成插件方式来实现底层系统的性能数据采集和分析</p></li>
<li><p>(可选)物理主机独立部署 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> 和 <a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_exporters/ipmi_exporter.html#ipmi-exporter"><span class="std std-ref">IPMI Exporter</span></a> (采用 <a class="reference internal" href="../../linux/redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 运行)，这样可以持续采集监控数据</p></li>
<li><p>物理主机上部署一个独立 <a class="reference internal" href="../../kubernetes/monitor/grafana/index.html#grafana"><span class="std std-ref">Grafana通用可视分析平台</span></a> 来汇总基础运行监控，将 <a class="reference internal" href="../../performance/pcp/index.html#pcp"><span class="std std-ref">Performance Co-Pilot</span></a> 数据可视化，例如底层的 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> <a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a> <a class="reference internal" href="../../linux/storage/zfs/index.html#zfs"><span class="std std-ref">ZFS</span></a> 等监控数据</p></li>
<li><p>通过 <a class="reference internal" href="../../kubernetes/monitor/alertmanager/webhook_receiver/prometheus-webhook-dingtalk.html#prometheus-webhook-dingtalk"><span class="std std-ref">prometheus-webhook-dingtalk</span></a> 发送钉钉消息，也通过 微信 来发送通知，此外还可以尝试自己接入一个短信、语音网关来实现通知</p></li>
</ul>
<p>另外一个轻量级的主机监控是 <a class="reference internal" href="../../linux/server/cockpit/index.html#cockpit"><span class="std std-ref">Cockpit服务器统一管理平台</span></a> ，发行版已经提供了集成，并且可以快速激活，也可以尝试实现上述 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> 的监控服务，同时提供对服务器的配置管理:</p>
<ul class="simple">
<li><p>通过激活 <a class="reference internal" href="../../linux/server/cockpit/cockpit-pcp.html#cockpit-pcp"><span class="std std-ref">cockpit-pcp</span></a> 可以监控 <a class="reference internal" href="../../kubernetes/monitor/metrics/index.html#metrics"><span class="std std-ref">Metrics</span></a> 实现服务器的温度监控</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>最优的监控解决方案是 <a class="reference internal" href="../../kubernetes/monitor/opentelemetry/index.html#opentelemetry"><span class="std std-ref">OpenTelemetry</span></a> : <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> 和 <a class="reference internal" href="../../performance/pcp/index.html#pcp"><span class="std std-ref">Performance Co-Pilot</span></a> 仅提供了 <a class="reference internal" href="../../kubernetes/monitor/metrics/index.html#metrics"><span class="std std-ref">Metrics</span></a> 监控，两者的层次和功能其实非常类似，而 <a class="reference internal" href="../../kubernetes/monitor/opentelemetry/index.html#opentelemetry"><span class="std std-ref">OpenTelemetry</span></a> 集成了 Traces, Metrics, Logs 实现了完整的软件堆栈分析，当然这也更为复杂，更适合分布式集群的深入分析。不过，OpenTelemetry专注于数据生成、采集和管理，实际完整产品化方案可以采用 <a class="reference internal" href="../../kubernetes/monitor/signoz/index.html#signoz"><span class="std std-ref">SigNoz监控</span></a> ，或者结合 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> + <a class="reference internal" href="../../kubernetes/monitor/jaeger/index.html#jaeger"><span class="std std-ref">Jaeger分布式跟踪系统</span></a> + <a class="reference internal" href="../../big_data/fluentd/index.html#fluentd"><span class="std std-ref">Fluentd日志采集系统</span></a> 来构建解决方案</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>经过对比不同的主机监控方案，我在 <a class="reference internal" href="../../linux/server/hardware/hpe/hpe_server_monitor.html#hpe-server-monitor"><span class="std std-ref">HPE服务器监控</span></a> 方案中筛选了上述几个方案综合监控服务器集群</p>
</div>
<p>物理主机部署 Prometheus 软件堆栈非常简便，采用 <a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_startup.html#prometheus-startup"><span class="std std-ref">Prometheus快速起步</span></a> 简单步骤就能初步完成部署</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于生产环境，如果服务器操作系统是CentOS7 则采用以下组合:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_startup_centos7.html#prometheus-startup-centos7"><span class="std std-ref">CentOS 7环境Prometheus快速起步</span></a></p></li>
<li><p><a class="reference internal" href="../../kubernetes/monitor/grafana/install_grafana_centos7.html#install-grafana-centos7"><span class="std std-ref">CentOS 7安装Grafana</span></a></p></li>
<li><p><a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_exporters/node_exporter.html#node-exporter"><span class="std std-ref">Node Exporter</span></a></p></li>
</ul>
</div>
</section>
<section id="prometheus">
<h2>部署Prometheus<a class="headerlink" href="#prometheus" title="Link to this heading">¶</a></h2>
<p>除了在 <a class="reference internal" href="y-k8s.html#y-k8s"><span class="std std-ref">Kubernetes集群(y-k8s)</span></a> 采用 <a class="reference internal" href="y-k8s_kube-prometheus-stack.html#y-k8s-kube-prometheus-stack"><span class="std std-ref">y-k8s集群部署kube-prometheus-stack</span></a> 部署Kubernetes集群内的 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> 监控外，在物理主机上直接部署一套 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> + <a class="reference internal" href="../../kubernetes/monitor/grafana/index.html#grafana"><span class="std std-ref">Grafana通用可视分析平台</span></a> ，以提供基础监控并集成 <a class="reference internal" href="../../performance/pcp/index.html#pcp"><span class="std std-ref">Performance Co-Pilot</span></a> 来实现集成性能监控，并且将 <a class="reference internal" href="../../performance/intel_pcm/index.html#intel-pcm"><span class="std std-ref">Intel® Performance Counter Monitor (Intel® PCM)</span></a> 集成在监控中，对物理主机的 <a class="reference internal" href="../../kernel/cpu/intel/index.html#intel-cpu"><span class="std std-ref">Intel CPU架构</span></a> 进行深入的性能分析。</p>
<ul class="simple">
<li><p>准备用户账号:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">在操作系统中添加 prometheus 用户</span><a class="headerlink" href="#id4" title="Link to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>groupadd<span class="w"> </span>--system<span class="w"> </span>prometheus
sudo<span class="w"> </span>useradd<span class="w"> </span>-s<span class="w"> </span>/sbin/nologin<span class="w"> </span>--system<span class="w"> </span>-g<span class="w"> </span>prometheus<span class="w"> </span>prometheus
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>创建配置目录和数据目录:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">在操作系统中创建prometheus目录</span><a class="headerlink" href="#id5" title="Link to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/var/lib/prometheus
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span>rules<span class="w"> </span>rules.d<span class="w"> </span>files_sd<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/prometheus/<span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>下载最新prometheus二进制程序:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">在Ubuntu环境安装Prometheus</span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/prometheus<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/tmp/prometheus
curl<span class="w"> </span>-s<span class="w"> </span>https://api.github.com/repos/prometheus/prometheus/releases/latest<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>browser_download_url<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>linux-amd64<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wget<span class="w"> </span>-qi<span class="w"> </span>-
tar<span class="w"> </span>xvf<span class="w"> </span>prometheus*.tar.gz
<span class="nb">cd</span><span class="w"> </span>prometheus*/
sudo<span class="w"> </span>mv<span class="w"> </span>prometheus<span class="w"> </span>promtool<span class="w"> </span>/usr/local/bin/
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>在解压缩的Prometheus软件包目录下有配置案例以及 console libraries :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">简单配置</span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/prometheus
sudo<span class="w"> </span>mv<span class="w"> </span>consoles/<span class="w"> </span>console_libraries/<span class="w"> </span>/etc/prometheus/
sudo<span class="w"> </span>mv<span class="w"> </span>prometheus.yml<span class="w"> </span>/etc/prometheus/prometheus.yml
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>创建 Prometheus 的 <a class="reference internal" href="../../linux/redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 服务管理配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/prometheus.service</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Prometheus <a class="reference internal" href="../../linux/redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 服务管理配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/prometheus.service</span></code></span><a class="headerlink" href="#id8" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Prometheus</span>
<span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>

<span class="n">StartLimitIntervalSec</span><span class="o">=</span><span class="mi">500</span>
<span class="n">StartLimitBurst</span><span class="o">=</span><span class="mi">5</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">prometheus</span>
<span class="n">Group</span><span class="o">=</span><span class="n">prometheus</span>
<span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">on</span><span class="o">-</span><span class="n">failure</span>
<span class="n">RestartSec</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">prometheus</span> \
  <span class="o">--</span><span class="n">config</span><span class="o">.</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span> \
  <span class="o">--</span><span class="n">storage</span><span class="o">.</span><span class="n">tsdb</span><span class="o">.</span><span class="n">path</span><span class="o">=/</span><span class="n">data</span> \
  <span class="o">--</span><span class="n">web</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">templates</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">consoles</span> \
  <span class="o">--</span><span class="n">web</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">libraries</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">console_libraries</span> \
  <span class="o">--</span><span class="n">web</span><span class="o">.</span><span class="n">listen</span><span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">9090</span> \
  <span class="o">--</span><span class="n">web</span><span class="o">.</span><span class="n">enable</span><span class="o">-</span><span class="n">lifecycle</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>启动服务:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">启动Prometheus</span><a class="headerlink" href="#id9" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">prometheus</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">prometheus</span>
</pre></div>
</div>
</div>
</section>
<section id="grafana">
<h2>部署Grafana<a class="headerlink" href="#grafana" title="Link to this heading">¶</a></h2>
<p>由于物理主机使用的是 <a class="reference internal" href="../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 22.04，Grafana提供了非常方便的软件仓库安装方式，可以快速完成 <a class="reference internal" href="../../kubernetes/monitor/grafana/install_grafana.html#install-grafana"><span class="std std-ref">安装Grafana</span></a></p>
<ul class="simple">
<li><p>安装社区版APT源:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">在Ubuntu中安装Grafana</span><a class="headerlink" href="#id10" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span> <span class="n">wget</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">grafana</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">gpg</span><span class="o">.</span><span class="n">key</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">-</span>

<span class="n">echo</span> <span class="s2">&quot;deb https://packages.grafana.com/oss/deb stable main&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">grafana</span><span class="o">.</span><span class="n">list</span>

<span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">grafana</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>启动服务:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">启动Grafana</span><a class="headerlink" href="#id11" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">grafana</span><span class="o">-</span><span class="n">server</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">grafana</span><span class="o">-</span><span class="n">server</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">grafana</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
</section>
<section id="id3">
<h2>反向代理<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> (端口9090) 和 <a class="reference internal" href="../../kubernetes/monitor/grafana/index.html#grafana"><span class="std std-ref">Grafana通用可视分析平台</span></a> (端口3000)都内置提供了 <a class="reference internal" href="../../web/index.html#web"><span class="std std-ref">Web Atlas</span></a> 服务，为了方便访问，采用 <a class="reference internal" href="../../web/nginx/index.html#nginx"><span class="std std-ref">Nginx</span></a> 反向代理 <a class="reference internal" href="../../kubernetes/monitor/grafana/grafana_behind_reverse_proxy.html#grafana-behind-reverse-proxy"><span class="std std-ref">在反向代理后面运行Grafana</span></a> :</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">NGINX 反向代理 <code class="docutils literal notranslate"><span class="pre">alertmanager</span></code> 配置</span><a class="headerlink" href="#id12" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>upstream alertmanager {
    server 192.168.6.115:30903;
}

server {
    listen 9093;
    #listen [::]:80;

    server_name alertmanager alertmanager.cloud-atlas.io;

    location / {
        proxy_set_header Host $http_host;
	proxy_pass http://alertmanager;
    }
}
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">NGINX 反向代理 <code class="docutils literal notranslate"><span class="pre">grafana</span></code> 配置</span><a class="headerlink" href="#id13" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>upstream grafana {
    server 192.168.6.115:30080;
}

server {
    listen 80;
    #listen [::]:80;

    server_name grafana grafana.cloud-atlas.io;

    location / {
        proxy_set_header Host $http_host;
	proxy_pass http://grafana;
    }
}
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">NGINX 反向代理 <code class="docutils literal notranslate"><span class="pre">prometheus</span></code> 配置</span><a class="headerlink" href="#id14" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>upstream prometheus {
    server 192.168.6.115:30090;
}

server {
    listen 9092;
    #listen [::]:80;

    server_name prometheus prometheus.cloud-atlas.io;

    location / {
        proxy_set_header Host $http_host;
	proxy_pass http://prometheus;
    }
}
</pre></div>
</div>
</div>
<p>启动 NGINX 后，通过域名访问:</p>
<ul class="simple">
<li><p>grafana.cloud-atlas.io</p></li>
<li><p>prometheus.cloud-atlas.io</p></li>
<li><p>alertmanager.cloud-atlas.io</p></li>
</ul>
<p>安装 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> / <a class="reference internal" href="../../kubernetes/monitor/grafana/index.html#grafana"><span class="std std-ref">Grafana通用可视分析平台</span></a> / <a class="reference internal" href="../../kubernetes/monitor/alertmanager/index.html#alertmanager"><span class="std std-ref">Alertmanager</span></a> 只是提供了运行监控运行框架，我们需要通过丰富的 <a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_exporters/index.html#prometheus-exporters"><span class="std std-ref">Prometheus Exporters</span></a> 以及第三方exporter来实现全面的系统监控:</p>
</section>
<section id="node-exporter">
<h2>Node Exporter<a class="headerlink" href="#node-exporter" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_exporters/node_exporter.html#node-exporter"><span class="std std-ref">Node Exporter</span></a> 是首先需要部署的重要Exporter</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我的 <a class="reference internal" href="y-k8s.html#y-k8s"><span class="std std-ref">Kubernetes集群(y-k8s)</span></a> 采用了 <a class="reference internal" href="../../machine_learning/hardware/nvidia_gpu/index.html#nvidia-gpu"><span class="std std-ref">NVIDIA GPU</span></a> 的 <a class="reference internal" href="../../kvm/vgpu/index.html#vgpu"><span class="std std-ref">NVIDIA Virtual GPU (vGPU)</span></a> 构建模拟 <a class="reference internal" href="../../kubernetes/gpu/index.html#gpu-k8s"><span class="std std-ref">GPU Kubernetes</span></a> ，NVIDIA官方提供了 <a class="reference internal" href="../../kubernetes/gpu/dcgm-exporter.html#dcgm-exporter"><span class="std std-ref">DCGM-Exporter</span></a> 可以实现GPU的全面监控。不过，由于GPU是结合 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 部署，所以我仅在 <a class="reference internal" href="y-k8s.html#y-k8s"><span class="std std-ref">Kubernetes集群(y-k8s)</span></a> 中通过 <a class="reference internal" href="../../kubernetes/monitor/prometheus/helm3_prometheus_grafana.html#helm3-prometheus-grafana"><span class="std std-ref">使用Helm 3在Kubernetes集群部署Prometheus和Grafana</span></a> 部署整个GPU管理组件以及结合 <a class="reference internal" href="../../kubernetes/gpu/dcgm-exporter.html#dcgm-exporter"><span class="std std-ref">DCGM-Exporter</span></a> 的监控，在物理服务器上就不再部署。</p>
</div>
<ul class="simple">
<li><p>下载安装 Node Exporter 执行程序:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">安装Node Exporter执行程序</span><a class="headerlink" href="#id15" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>version=1.6.1
wget https://github.com/prometheus/node_exporter/releases/download/v${version}/node_exporter-${version}.linux-amd64.tar.gz
tar xvfz node_exporter-${version}.linux-amd64.tar.gz
cd node_exporter-${version}.linux-amd64/
sudo mv node_exporter /usr/local/bin/

# 直接运行
#/usr/local/bin/node_exporter
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/node_exporter.service</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">配置 Node Exporter 服务，通过 <a class="reference internal" href="../../linux/redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 运行</span><a class="headerlink" href="#id16" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">node_exporter</span>
<span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>

<span class="n">StartLimitIntervalSec</span><span class="o">=</span><span class="mi">500</span>
<span class="n">StartLimitBurst</span><span class="o">=</span><span class="mi">5</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">prometheus</span>
<span class="n">Group</span><span class="o">=</span><span class="n">prometheus</span>
<span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">on</span><span class="o">-</span><span class="n">failure</span>
<span class="n">RestartSec</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">node_exporter</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>启动:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">通过 <a class="reference internal" href="../../linux/redhat_linux/systemd/systemctl.html#systemctl"><span class="std std-ref">systemctl</span></a> 启动 <code class="docutils literal notranslate"><span class="pre">node_exporter</span></code> 服务</span><a class="headerlink" href="#id17" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">node_exporter</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">node_exporter</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/prometheus/prometheus.yaml</span></code> 添加监控目标服务器 <a class="reference internal" href="../../kubernetes/monitor/prometheus/prometheus_exporters/node_exporter.html#node-exporter"><span class="std std-ref">Node Exporter</span></a> 数据抓取:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">在 <code class="docutils literal notranslate"><span class="pre">/etc/prometheus/prometheus.yml</span></code> 中添加抓取node配置任务</span><a class="headerlink" href="#id18" title="Link to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">...</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="nn">...</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;node&quot;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost:9100</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.6.11:9100</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.6.12:9100</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>在 Grafana Dashboard 搜索添加 <code class="docutils literal notranslate"><span class="pre">1860</span></code> ID 的Dashboard ( <a class="reference external" href="https://grafana.com/grafana/dashboards/1860-node-exporter-full/">Node Exporter Full</a> )</p></li>
</ul>
</section>
<section id="pcm">
<h2>PCM监控<a class="headerlink" href="#pcm" title="Link to this heading">¶</a></h2>
<p>对于 <a class="reference internal" href="../../kernel/cpu/intel/index.html#intel-cpu"><span class="std std-ref">Intel CPU架构</span></a> 可以采用 <a class="reference internal" href="../../performance/intel_pcm/pcm-exporter.html#pcm-exporter"><span class="std std-ref">pcm-exporter :Intel Performance Counter Monitor (Intel PCM) Prometheus exporter</span></a> 提供详细的CPU监控，结合 <a class="reference internal" href="../../performance/intel_pcm/pcm-grafana.html#pcm-grafana"><span class="std std-ref">Intel PCM Grafana</span></a> 可以在日常生产中帮助我们定位CPU相关故障和异常:</p>
<ul class="simple">
<li><p>大多数最新的主流发行版都包含了 Intel PCM 安装包，例如 <a class="reference internal" href="../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 安装 <code class="docutils literal notranslate"><span class="pre">pcm</span></code> 之后就具备了 <code class="docutils literal notranslate"><span class="pre">pcm-sensor-server</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">在Ubuntu安装Intel PCM</span><a class="headerlink" href="#id19" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">pcm</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>虽然可以直接运行 <code class="docutils literal notranslate"><span class="pre">pcm-sensor-server</span></code> ，但是为了方便维护，采用 <a class="reference internal" href="../../linux/redhat_linux/systemd/index.html#systemd"><span class="std std-ref">Systemd进程管理器</span></a> 服务配置 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/pcm-exporter.service</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/pcm-exporter.service</span></code></span><a class="headerlink" href="#id20" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">pcm</span><span class="o">-</span><span class="n">exporter</span>
<span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>

<span class="n">StartLimitIntervalSec</span><span class="o">=</span><span class="mi">500</span>
<span class="n">StartLimitBurst</span><span class="o">=</span><span class="mi">5</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">root</span>
<span class="n">Group</span><span class="o">=</span><span class="n">root</span>
<span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">on</span><span class="o">-</span><span class="n">failure</span>
<span class="n">RestartSec</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">pcm</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">server</span> \
  <span class="o">-</span><span class="n">p</span> <span class="mi">9738</span> \
  <span class="o">--</span><span class="n">real</span><span class="o">-</span><span class="n">time</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>启动 <code class="docutils literal notranslate"><span class="pre">pcm-exporter</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">启动 <code class="docutils literal notranslate"><span class="pre">pcm-exporter</span></code> 服务</span><a class="headerlink" href="#id21" title="Link to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">pcm</span><span class="o">-</span><span class="n">server</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">pcm</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>在 Grafana Dashboard 搜索添加 <code class="docutils literal notranslate"><span class="pre">17108</span></code> ID 的Dashboard ( <a class="reference external" href="https://grafana.com/grafana/dashboards/17108-processor-counter-monitor-pcm-dashboard/">Grafana Dashboard 17108: Processor Counter Monitor (PCM) Dashboard</a> )</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="priv_ssh.html" class="btn btn-neutral float-left" title="私有云SSH访问" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="zdata_ceph.html" class="btn btn-neutral float-right" title="私有云数据层 ZData Ceph" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>