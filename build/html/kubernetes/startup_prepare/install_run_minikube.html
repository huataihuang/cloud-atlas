<!DOCTYPE html>
<html class="writer-html5" lang="zh" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>minikube &mdash; Cloud Atlas: Discovery beta 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8534f863"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="安装和设置kubectl" href="install_setup_kubectl.html" />
    <link rel="prev" title="Kubernetes起步准备" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Cloud Atlas: Discovery
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvm/index.html">KVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Kubernetes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../think_k8s.html">Kubernetes的思考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kubernetes_overview.html">Kubernetes概览</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Kubernetes起步准备</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">minikube</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">安装Minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">启动minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">使用minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">停止和再次启动minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">minikube异常排查</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">操作系统启动时启动minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dashboard">启动dashboard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">离线安装minikube</a></li>
<li class="toctree-l4"><a class="reference internal" href="#docker-in-docker">Docker in Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">参考</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="install_setup_kubectl.html">安装和设置kubectl</a></li>
<li class="toctree-l3"><a class="reference internal" href="remote_minikube.html">远程访问minikube</a></li>
<li class="toctree-l3"><a class="reference internal" href="ubuntu_in_kubernetes.html">在Kubernetes中运行Ubuntu</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../startup/index.html">Kubernetes快速起步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/index.html">Kubernetes CLI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kind/index.html">kind(本地docker模拟k8s集群)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/index.html">Kubernetes概念辨析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy/index.html">Kubernetes部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy_app/index.html">Kubernetes部署应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../manage_object/index.html">Kubernetes管理对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administer/index.html">Kubernetes管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../access_application/index.html">Kubernetes访问应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../container_runtimes/index.html">容器运行时(Container Runtimes)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configure/index.html">Kubernetes 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">Kubernetes网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../in_action/index.html">Kubernetes实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../numa/index.html">Kubernetes NUMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backup/index.html">Kubernetes备份与恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">Kubernetes存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../production/index.html">Kubernetes生产环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../service_mesh/index.html">Service Mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../istio/index.html">Istio服务网格</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serverless/index.html">Kubernetes Severless</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci_cd/index.html">Kubernetes持续集成和持续部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitor/index.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="../self_healing/index.html">Kubernetes 自愈</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debug/index.html">Kubernetes排查</a></li>
<li class="toctree-l2"><a class="reference internal" href="../knative/index.html">Knative - Serverless计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.html">Kubernetes安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virtual/index.html">Kubernetes结合虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arm/index.html">ARM架构Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu/index.html">GPU Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kubeflow/index.html">Kubeflow - Kubernetes机器学习工作流平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="../argo/index.html">Argo - 基于Kubernetes的持续集成和工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kueue/index.html">Kueue - K8s原生批处理调度</a></li>
<li class="toctree-l2"><a class="reference internal" href="../k8s_android/index.html">Kubernetes运行Android</a></li>
<li class="toctree-l2"><a class="reference internal" href="../k3s/index.html">K3s - 轻量级Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../k0s/index.html">K0s - 轻量级Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platform/index.html">Kubernetes之上的平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud/index.html">Kubernetes云厂商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cncf/index.html">CNCF(Cloud Native Computing Foudation)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../k8s_dev/index.html">Kubernetes Develop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rancher/index.html">Rancher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/index.html">SQLite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgsql/index.html">PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nosql/index.html">NoSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/index.html">Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_service/index.html">Infra-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_search/index.html">Infra-Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info_service/index.html">Info-Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drone/index.html">Drone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell/index.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/index.html">JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nodejs/index.html">Node.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clang/index.html">C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../golang/index.html">Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swift/index.html">Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ruby/index.html">Ruby</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lua/index.html">Lua</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../raspberry_pi/index.html">Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsd/index.html">BSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../freebsd/index.html">FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apple/index.html">Apple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../real/index.html">Real</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life/index.html">Life</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas: Discovery</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Kubernetes</a></li>
          <li class="breadcrumb-item"><a href="index.html">Kubernetes起步准备</a></li>
      <li class="breadcrumb-item active">minikube</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/kubernetes/startup_prepare/install_run_minikube.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="minikube">
<span id="install-run-minikube"></span><h1>minikube<a class="headerlink" href="#minikube" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>本章节因为是综合了我在多个平台部署minikube的实践，所以比较繁杂。实际上在Linux平台上部署minikube默认配置（使用虚拟机）非常简单。但是，如果使用了一些非标准配置，例如，btrfs作为存储驱动，裸物理机运行minikube则略微复杂。</p>
</div>
<section id="id1">
<span id="id2"></span><h2>minikube<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>最简单体验完整的Kubernetes集群功能是使用 <a class="reference external" href="https://github.com/kubernetes/minikube">minikube GitHub官网</a> ，这是一个在单个节点上运行Kubernetes的方式，可以用于测试Kubernetes以及本地开发应用。</p>
<p>minikube是通常通过虚拟机来运行的，也就是说必须在主机上运行Hypervisor，可以是Virtualbox (跨平台) 也可以是 KVM (Linux) 或者 Hyper-V (Windows)，甚至可以使用非常小众的 HyperKit (macOS)。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>之所以minikube通常需要在虚拟机中运行，是因为minikube是基于Docker容器运行的，Docker容器需要在Linux上运行，所以会先要求运行一个Linux虚拟机，然后才能在虚拟机中运行Docker以满足运行minikube的条件。</p>
<p>如果你是在Linux主机上，由于Linux可以直接运行Docker，所以甚至可以不需要Hypervisor的虚拟机，直接运行在Linux物理主机的Docker中。此时使用参数 <code class="docutils literal notranslate"><span class="pre">--vm-driver=none</span></code> 来运行。</p>
</div>
</section>
<section id="id3">
<h2>安装Minikube<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<section id="ubuntuminikube">
<h3>Ubuntu平台安装MiniKube<a class="headerlink" href="#ubuntuminikube" title="Link to this heading"></a></h3>
<ul>
<li><p>安装命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">minikube</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">minikube</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">install</span> <span class="n">minikube</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">minikube</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="linuxminikube">
<h3>Linux裸机直接部署minikube(快速起步)<a class="headerlink" href="#linuxminikube" title="Link to this heading"></a></h3>
<p>为了追求性能，在我的测试环境(Linux)采用了裸物理主机直接运行minikube，并且采用了btrfs作为存储驱动，所以配置略有复杂。详情请见下文。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>为了快速起步，简述方法如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">minikube</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">minikube</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">install</span> <span class="n">minikube</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">minikube</span>
<span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">none</span>
<span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">SystemVerification</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">kubelet</span><span class="o">.</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">kubelet</span><span class="o">.</span><span class="n">resolv</span><span class="o">-</span><span class="n">conf</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">resolve</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>上述安装步骤只需要具备两个前提条件就可以完成:</p>
<ul class="simple">
<li><p>安装好Docker CE: 请参考 <a class="reference internal" href="../../studio/kvm_docker_in_studio.html#install-docker-in-studio"><span class="std std-ref">Docker</span></a>
- 注意，需要配置项 <code class="docutils literal notranslate"><span class="pre">&quot;exec-opts&quot;:</span> <span class="pre">[&quot;native.cgroupdriver=systemd&quot;]</span></code></p></li>
<li><p>架好翻墙的梯子: 请参考 <a class="reference internal" href="../../linux/security/vpn/ocserv/openconnect_vpn.html#openconnect-vpn"><span class="std std-ref">OpenConnect VPN</span></a></p></li>
</ul>
<p>启动参数说明：</p>
<ul class="simple">
<li><p>由于我采用btrfs，默认minikube启动验证storage driver会失败，所以添加参数 kubeadm.ignore-preflight-errors=SystemVerification</p></li>
<li><p>由于docker配置cgroupdriver=systemd，所以对应配置参数 kubelet.cgroup-driver=systemd</p></li>
<li><p>对于Ubuntu 18.04默认启用了 <code class="docutils literal notranslate"><span class="pre">systemd-resolv</span></code> ，需要绕过默认的 <code class="docutils literal notranslate"><span class="pre">resolv.conf</span></code> ，所以使用参数 <code class="docutils literal notranslate"><span class="pre">kubelet.resolv-conf=/run/systemd/resolve/resolv.conf</span></code></p></li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>根据 minikube文档 <a class="reference external" href="https://github.com/kubernetes/minikube/blob/master/docs/vmdriver-none.md">vm-driver=none</a> ，实际上裸物理机运行minikube有一些已知问题需要注意规避。</p>
</div>
</section>
<section id="macosminikube">
<h3>macOS平台安装MiniKube<a class="headerlink" href="#macosminikube" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>macOS的minikube可以选择virtualbox作为后端，也可以选择 <a class="reference external" href="https://github.com/moby/hyperkit">xhyve</a> 作为后端，另外也可以使用VMware Fusion。我分别尝试过使用 xhyve 和 vmware 作为Hypervisor。</p>
</div>
<section id="macoshyperkit">
<h4>macOS安装hyperkit<a class="headerlink" href="#macoshyperkit" title="Link to this heading"></a></h4>
<p>请参考 <a class="reference external" href="https://github.com/moby/hyperkit">GitHub上hyperkit项目</a> 以及我的实践记录： <a class="reference internal" href="../../docker/moby/hyperkit/run_hyperkit.html#build-hyperkit"><span class="std std-ref">编译HyperKit</span></a> 。</p>
</section>
<section id="macosvmware-fusion">
<h4>macOS安装VMware Fusion<a class="headerlink" href="#macosvmware-fusion" title="Link to this heading"></a></h4>
<p>请参考 <a class="reference internal" href="../../apple/vmware/vmware_fusion.html#vmware-fusion"><span class="std std-ref">Studio环境中的VMware Fusion</span></a> ，我安装了VMware Fusion。使用 <code class="docutils literal notranslate"><span class="pre">vmrun</span> <span class="pre">list</span></code> 可以检查当前运行的VMware虚拟机。</p>
</section>
<section id="id4">
<h4>macOS安装minikube<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<ul>
<li><p>通过brew安装minikube(我没有使用这个方法):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brew</span> <span class="n">cask</span> <span class="n">install</span> <span class="n">minikube</span>
</pre></div>
</div>
</li>
<li><p>直接安装罪行版本minikube（我使用这个方法）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="n">minikube</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">minikube</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">v0</span><span class="mf">.35.0</span><span class="o">/</span><span class="n">minikube</span><span class="o">-</span><span class="n">darwin</span><span class="o">-</span><span class="n">amd64</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">minikube</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">cp</span> <span class="n">minikube</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span> <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="n">minikube</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>每次启动minikube默认会检查是否有可用最新版本</p>
</div>
</section>
</section>
</section>
<section id="id5">
<h2>启动minikube<a class="headerlink" href="#id5" title="Link to this heading"></a></h2>
<ul>
<li><p>（不推荐直接）启动minikube集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
<section id="linuxkvm">
<h3>Linux平台使用kvm后端<a class="headerlink" href="#linuxkvm" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>minikube默认使用Virtualbox作为驱动，所以如果简单使用上述命令，会首先下载virtulbox镜像来运行。这可能和你的安装环境不同。所以需要参考 <a class="reference external" href="https://github.com/kubernetes/minikube/blob/master/docs/drivers.md#kvm2-driver">Driver plugin installation</a> 来安装驱动产检，并指定驱动来启动minikube。</p>
<p><code class="docutils literal notranslate"><span class="pre">以下案例将采用KVM作为驱动来运行minikube</span></code></p>
<p>注意：我的实验室环境已经按照 <a class="reference internal" href="../../studio/kvm_docker_in_studio.html#kvm-docker-in-studio"><span class="std std-ref">Studio环境KVM和Docker</span></a> 安装了KVM驱动所需的 <code class="docutils literal notranslate"><span class="pre">libvirt-clients</span> <span class="pre">libvirt-daemon-system</span> <span class="pre">qemu-kvm</span></code> ，所以只需要安装 <code class="docutils literal notranslate"><span class="pre">docker-machine-driver-kvm2</span></code> 就可以。</p>
</div>
<ul>
<li><p>安装 <code class="docutils literal notranslate"><span class="pre">docker-machine-driver-kvm2</span></code> 驱动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">minikube</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">kvm2</span> \
  <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">kvm2</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p>直接使用kvm2驱动启动的命令如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">kvm2</span>
</pre></div>
</div>
</li>
<li><p>不过，更好的方法是先指定默认驱动kvm2，然后再启动就不需要传递参数了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">kvm2</span>
<span class="n">minikube</span> <span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">config</span> <span class="pre">set</span> <span class="pre">PROPERTY_NAME</span></code> 会在用户目录下的 <code class="docutils literal notranslate"><span class="pre">~/.minikube/config/config.json</span></code> 添加对应的驱动配置，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;vm-driver&quot;</span><span class="p">:</span> <span class="s2">&quot;kvm2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>此时会下载minikube的KVM镜像，然后运行这个虚拟机，通过 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">list</span></code> 可以看到系统新启动了一个KVM虚拟机:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Id</span>    <span class="n">Name</span>                           <span class="n">State</span>
<span class="o">----------------------------------------------------</span>
<span class="mi">5</span>     <span class="n">minikube</span>                       <span class="n">running</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>创建的minikube配置: <code class="docutils literal notranslate"><span class="pre">CPUs=2,</span> <span class="pre">Memory=2048MB,</span> <span class="pre">Disk=20000MB</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">start</span></code> 运行指令显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="ow">is</span> <span class="n">now</span> <span class="n">configured</span> <span class="n">to</span> <span class="n">use</span> <span class="s2">&quot;minikube&quot;</span>
</pre></div>
</div>
<p>这表明当前Linux主机的kubectl已经被配置直接使用刚才所安装运行的minikube</p>
</div>
</section>
<section id="id6">
<h3>直接物理主机运行minikube<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p>前面我们在 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> <a class="reference internal" href="../../studio/index.html#studio"><span class="std std-ref">Studio</span></a> 环境中通过KVM虚拟化运行了minikube主机，现在，我们实现一个通过物理主机直接运行minikube，以节约运行损耗。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于已经采用了kvm作为后端的主机，如果使用 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">config</span> <span class="pre">set</span> <span class="pre">vm-driver</span> <span class="pre">none</span></code> 切换后端，会注意到再次运行 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">start</span></code> 会提示由于已经存在一个 &quot;minikube&quot; 虚拟机，所以会忽略参数 <code class="docutils literal notranslate"><span class="pre">--vm-driver=none</span></code> 而依然使用KVM来运行minikube。</p>
<p>要创建第二个minikube并且使用裸机来运行，则第二个minikube需要使用明确的命令来启动另一个命名的minikube:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span> <span class="o">-</span><span class="n">p</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">vm</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">none</span>
</pre></div>
</div>
</div>
<ul>
<li><p>设置裸物理主机运行minikube:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">none</span>
</pre></div>
</div>
</li>
<li><p>启动minikube，命名为 <code class="docutils literal notranslate"><span class="pre">xminikube</span></code> 表示运行在 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 物理主机上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span> <span class="o">-</span><span class="n">p</span> <span class="n">xminikube</span> <span class="o">--</span><span class="n">vm</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">none</span>
</pre></div>
</div>
</li>
</ul>
<p>也可以删除掉之前通过KVM运行的minikube（例如，现在我采用只在裸物理主机运行minikube），则就不需要单独指定新的minikube实例，使用如下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">kvm2</span>  <span class="c1">#切换到KVM后端</span>
<span class="n">minikube</span> <span class="n">delete</span>   <span class="c1">#这里删除了之前我创建的KVM后端的minikube</span>
<span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">none</span>  <span class="c1">#切换到直接使用裸物理机</span>
<span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span>  <span class="c1">#现在创建的minikube采用物理主机引擎</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在物理主机上运行minikube会直接安装 <code class="docutils literal notranslate"><span class="pre">/usr/bin/kubelet</span></code> ，所以需要root权限，这里就需要使用 <code class="docutils literal notranslate"><span class="pre">sudo</span></code> 来执行命令。</p>
<p>通过 <cite>none</cite> 驱动运行minikube会降低系统安全和可靠性，详细说明请参考 <a class="reference external" href="https://github.com/kubernetes/minikube/blob/master/docs/vmdriver-none.md">https://github.com/kubernetes/minikube/blob/master/docs/vmdriver-none.md</a></p>
</div>
</section>
<section id="arch-linuxminikube">
<h3>Arch Linux平台实践物理机运行minikube<a class="headerlink" href="#arch-linuxminikube" title="Link to this heading"></a></h3>
<ul>
<li><p>由于minikube的物理主机运行模式必须以root身份运行，所以先配置驱动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">none</span>
</pre></div>
</div>
</li>
<li><p>配置防火墙允许22端口连接</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我的物理主机采用了 <a class="reference internal" href="../../studio/kvm_docker_in_studio.html#kvm-docker-in-studio"><span class="std std-ref">Studio环境KVM和Docker</span></a> ，所以默认有2个内部NAT网桥 <code class="docutils literal notranslate"><span class="pre">docker0</span></code> 和 <code class="docutils literal notranslate"><span class="pre">virtbr0</span></code> ，这两个都是内部网段</p>
</div>
</section>
<section id="id7">
<h3>macOS平台使用hyperkit后端<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<ul>
<li><p>安装Hyperkit驱动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brew</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">hyperkit</span>

<span class="c1"># docker-machine-driver-hyperkit need root owner and uid</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">wheel</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">hyperkit</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">hyperkit</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="n">u</span><span class="o">+</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">hyperkit</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">machine</span><span class="o">-</span><span class="n">driver</span><span class="o">-</span><span class="n">hyperkit</span>
</pre></div>
</div>
</li>
<li><p>(建议跳过这步，用下一步采用先配置再启动)使用Hyperkit后端启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">hyperkit</span>
</pre></div>
</div>
</li>
<li><p>使用hyperkit作为默认后端:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">hyperkit</span>
</pre></div>
</div>
</li>
<li><p>启动minikube:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="macosvmware">
<h3>macOS平台使用vmware后端<a class="headerlink" href="#macosvmware" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>安装VMware统一驱动：首先从 <a class="reference external" href="https://github.com/machine-drivers/docker-machine-driver-vmware/releases">https://github.com/machine-drivers/docker-machine-driver-vmware/releases</a> 下载驱动文件 <code class="docutils literal notranslate"><span class="pre">docker-machine-driver-vmware_darwin_amd64</span></code> ，并将其保存到 <code class="docutils literal notranslate"><span class="pre">$PATH</span></code> 目录，例如，我保存到 <code class="docutils literal notranslate"><span class="pre">~/bin</span></code> （这个目录位于环境变量设置文件 <code class="docutils literal notranslate"><span class="pre">~/.bash_profile</span></code> ，并且命名为 <code class="docutils literal notranslate"><span class="pre">docker-machine-driver-vmware</span></code> 。</p></li>
</ul>
<p>也可以直接使用安装命令如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export LATEST_VERSION=$(curl -L -s -H &#39;Accept: application/json&#39; https://github.com/machine-drivers/docker-machine-driver-vmware/releases/latest | sed -e &#39;s/.*&quot;tag_name&quot;:&quot;\([^&quot;]*\)&quot;.*/\1/&#39;) \
&amp;&amp; curl -L -o docker-machine-driver-vmware https://github.com/machine-drivers/docker-machine-driver-vmware/releases/download/$LATEST_VERSION/docker-machine-driver-vmware_darwin_amd64 \
&amp;&amp; chmod +x docker-machine-driver-vmware \
&amp;&amp; mv docker-machine-driver-vmware /usr/local/bin/
</pre></div>
</div>
<ul>
<li><p>(建议跳过这步，用下一步采用先配置再启动)使用Vmware后端启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">vmware</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>根据minikube提示，今后将使用 <a class="reference external" href="https://github.com/kubernetes/minikube/blob/master/docs/drivers.md#vmware-unified-driver">统一的vmware驱动</a> 来替代vmwarefusion，所以这里设置 <code class="docutils literal notranslate"><span class="pre">--vm-driver</span> <span class="pre">vmware</span></code></p>
</div>
<ul>
<li><p>使用VMware fussion作为默认后端:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">vm</span><span class="o">-</span><span class="n">driver</span> <span class="n">vmware</span>
</pre></div>
</div>
</li>
<li><p>启动minikube:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="id8">
<h2>使用minikube<a class="headerlink" href="#id8" title="Link to this heading"></a></h2>
<ul>
<li><p>ssh登陆minikub方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">ssh</span>
</pre></div>
</div>
</li>
</ul>
<p>minikube虚拟机默认root没有密码，从虚拟机终端可以登陆。</p>
</section>
<section id="id9">
<h2>停止和再次启动minikube<a class="headerlink" href="#id9" title="Link to this heading"></a></h2>
<p>安装了minikube之后，通过 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">stop</span></code> 可以停止，然后通过 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">start</span></code> 可以再次启动。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>每次启动minikube，系统都会尝试重新连接Google仓库更新镜像，所以需要先搭好梯子</p>
</div>
</section>
<section id="id10">
<h2>minikube异常排查<a class="headerlink" href="#id10" title="Link to this heading"></a></h2>
<section id="minikube-cri">
<span id="minikube-debug-cri-install"></span><h3>minikube CRI安装排查<a class="headerlink" href="#minikube-cri" title="Link to this heading"></a></h3>
<p>重新在 <a class="reference internal" href="../../linux/ubuntu_linux/ubuntu_on_mbp.html#ubuntu-on-mbp"><span class="std std-ref">MacBook Pro上运行Ubuntu</span></a> (重装了Ubuntu 18.04 LTS Server版本) 之后，我重新部署了 <a class="reference internal" href="../../linux/storage/btrfs/btrfs_in_studio.html#btrfs-in-studio"><span class="std std-ref">Studio环境的Btrfs存储</span></a> 并设置 <a class="reference internal" href="../../docker/storage/docker_btrfs_driver.html#docker-btrfs-driver"><span class="std std-ref">Docker btrfs 存储驱动</span></a> 。首次在裸主机上部署minikube，启动遇到报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">Launching</span> <span class="n">Kubernetes</span> <span class="o">...</span>

<span class="n">X</span> <span class="n">Error</span> <span class="n">starting</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">cmd</span> <span class="n">failed</span><span class="p">:</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">config</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">yaml</span>  <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">DirAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="p">,</span><span class="n">DirAvailable</span><span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">minikube</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">etcd</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">Port</span><span class="o">-</span><span class="mi">10250</span><span class="p">,</span><span class="n">Swap</span>

<span class="p">:</span> <span class="n">running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">config</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">yaml</span>  <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">DirAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="p">,</span><span class="n">DirAvailable</span><span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">minikube</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">FileAvailable</span><span class="o">--</span><span class="n">etc</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">manifests</span><span class="o">-</span><span class="n">etcd</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span><span class="n">Port</span><span class="o">-</span><span class="mi">10250</span><span class="p">,</span><span class="n">Swap</span>
 <span class="n">output</span><span class="p">:</span> <span class="p">[</span><span class="n">init</span><span class="p">]</span> <span class="n">Using</span> <span class="n">Kubernetes</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="mf">.14.3</span>
<span class="p">[</span><span class="n">preflight</span><span class="p">]</span> <span class="n">Running</span> <span class="n">pre</span><span class="o">-</span><span class="n">flight</span> <span class="n">checks</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">IsDockerSystemdCheck</span><span class="p">]:</span> <span class="n">detected</span> <span class="s2">&quot;cgroupfs&quot;</span> <span class="k">as</span> <span class="n">the</span> <span class="n">Docker</span> <span class="n">cgroup</span> <span class="n">driver</span><span class="o">.</span> <span class="n">The</span> <span class="n">recommended</span> <span class="n">driver</span> <span class="ow">is</span> <span class="s2">&quot;systemd&quot;</span><span class="o">.</span> <span class="n">Please</span> <span class="n">follow</span> <span class="n">the</span> <span class="n">guide</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">setup</span><span class="o">/</span><span class="n">cri</span><span class="o">/</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Swap</span><span class="p">]:</span> <span class="n">running</span> <span class="k">with</span> <span class="n">swap</span> <span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">supported</span><span class="o">.</span> <span class="n">Please</span> <span class="n">disable</span> <span class="n">swap</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">FileExisting</span><span class="o">-</span><span class="n">socat</span><span class="p">]:</span> <span class="n">socat</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">system</span> <span class="n">path</span>
</pre></div>
</div>
<p>这说明默认的 <a class="reference internal" href="../../studio/kvm_docker_in_studio.html#install-docker-in-studio"><span class="std std-ref">Docker</span></a> 存在环境缺陷，需要参考Kubernetes官方 <a class="reference external" href="https://kubernetes.io/docs/setup/cri/">CRI installation</a> 文档进行修正。</p>
<ul>
<li><p>修正cgroupfs通过systemd管理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup daemon</span>
<span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">daemon</span><span class="o">.</span><span class="n">json</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">{</span>
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">],</span>
  <span class="s2">&quot;log-driver&quot;</span><span class="p">:</span> <span class="s2">&quot;json-file&quot;</span><span class="p">,</span>
  <span class="s2">&quot;log-opts&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;max-size&quot;</span><span class="p">:</span> <span class="s2">&quot;100m&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;storage-driver&quot;</span><span class="p">:</span> <span class="s2">&quot;btrfs&quot;</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">d</span>
</pre></div>
</div>
</li>
</ul>
<p>然后重启docker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Restart docker.</span>
<span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
</pre></div>
</div>
<ul>
<li><p>关闭swap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swapoff</span> <span class="o">/</span><span class="n">swap</span><span class="o">.</span><span class="n">img</span>
<span class="c1"># 删除 /etc/fstab 中swap配置</span>
</pre></div>
</div>
</li>
<li><p>修订 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 添加 <code class="docutils literal notranslate"><span class="pre">minikube</span></code> 的地址解析:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168.101.81</span>  <span class="n">minikube</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>添加IP解析可能不需要，待测试。不过默认 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">start</span></code> 有 WARNING 关于不能解析 minikube 提示</p>
</div>
<ul>
<li><p>然后重新执行一次minikube安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">delete</span>
<span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="minikube-btrfs">
<span id="minikube-debug-btrfs"></span><h3>minikube btrfs安装排查<a class="headerlink" href="#minikube-btrfs" title="Link to this heading"></a></h3>
<p>再次启动minikube出现报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[WARNING Hostname]: hostname &quot;minikube&quot; could not be reached
[WARNING Hostname]: hostname &quot;minikube&quot;: lookup minikube on 8.8.8.8:53: no such host
[WARNING Service-Kubelet]: kubelet service is not enabled, please run &#39;systemctl enable kubelet.service&#39;
error execution phase preflight: [preflight] Some fatal errors occurred:
[ERROR SystemVerification]: unsupported graph driver: btrfs
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
: running command: sudo /usr/bin/kubeadm init --config /var/lib/kubeadm.yaml  --ignore-preflight-errors=DirAvailable--etc-kubernetes-manifests,DirAvailable--data-minikube,FileAvailable--etc-kubernetes-manifests-kube-scheduler.yaml,FileAvailable--etc-kubernetes-manifests-kube-apiserver.yaml,FileAvailable--etc-kubernetes-manifests-kube-controller-manager.yaml,FileAvailable--etc-kubernetes-manifests-etcd.yaml,Port-10250,Swap
.: exit status 1
</pre></div>
</div>
<p>这里可以参考 <a class="reference external" href="https://marc.wäckerlin.ch/computer/kubernetes-on-ubuntu-16-04">Kubernetes on Ubuntu 16.04</a> 增加一个启动参数 <code class="docutils literal notranslate"><span class="pre">--skip-preflight-checks</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">checks</span>
</pre></div>
</div>
<p>参考 <a class="reference external" href="https://github.com/kairen/kubeadm-ansible/issues/42">Support for 1.12.1 #42</a> 对于minikube传递参数是 <code class="docutils literal notranslate"><span class="pre">--ignore-preflight-errors</span></code> 就对等于 kubeadmin 参数 <code class="docutils literal notranslate"><span class="pre">--skip-preflight-checks</span></code></p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>参考minikube文档 <a class="reference external" href="https://github.com/kubernetes/minikube/blob/master/docs/vmdriver-none.md">vm-driver=none</a> :</p>
<p>Some versions of Linux have a version of docker that is newer then what Kubernetes expects. To overwrite this, run minikube with the following parameters: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-E</span> <span class="pre">minikube</span> <span class="pre">start</span> <span class="pre">--vm-driver=none</span> <span class="pre">--kubernetes-version</span> <span class="pre">v1.11.8</span> <span class="pre">--extra-config</span> <span class="pre">kubeadm.ignore-preflight-errors=SystemVerification</span></code></p>
</div>
<p>即执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubeadm</span><span class="o">.</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">SystemVerification</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我为了能够免去这个参数输入，参考 <a class="reference internal" href="../../studio/kvm_docker_in_studio.html#install-docker-in-studio"><span class="std std-ref">Docker</span></a> 中 <code class="docutils literal notranslate"><span class="pre">/etc/docker/dameon.json</span></code> 配置方法，尝试修订 <code class="docutils literal notranslate"><span class="pre">~/.minikube/config/config.json</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;extra-config&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;kubeadm.ignore-preflight-errors=SystemVerification&quot;</span><span class="p">],</span>
    <span class="s2">&quot;vm-driver&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>但是，这个方法无效。参考 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">config</span> <span class="pre">-h</span></code> 输出提示可用的 <code class="docutils literal notranslate"><span class="pre">Configurable</span> <span class="pre">fields</span></code> 并没有包含 <code class="docutils literal notranslate"><span class="pre">extra-config</span></code> 。</p>
<p>参考 <a class="reference external" href="https://medium.com/faun/using-minikube-profiles-def2477e968a">On Minikube Profiles</a> ，可以minikube的profile是 <code class="docutils literal notranslate"><span class="pre">~/.minikube/profiles/minikube/config.json</span></code> ，这个配置是minikube初始化根据系统环境自动配置的环境变量。例如，包含了检测出我的主机的网卡接口IP地址是 <code class="docutils literal notranslate"><span class="pre">192.168.101.81</span></code> 。</p>
<p>根据上述信息启发，搜索看到 <code class="docutils literal notranslate"><span class="pre">~/.minikube/machines/minikube/config.json</span></code> 包含了主机的配置信息，其中包含了 <code class="docutils literal notranslate"><span class="pre">HostOptions</span></code> 中就有一个配置项是 <code class="docutils literal notranslate"><span class="pre">&quot;StorageDriver&quot;:</span> <span class="pre">&quot;&quot;,</span></code> ，会不会这个配置项就是可以设置 <code class="docutils literal notranslate"><span class="pre">btrfs</span></code> 呢？</p>
<p>但是这个 <code class="docutils literal notranslate"><span class="pre">~/.minikube/machines/minikube/config.json</span></code> 每次 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">delete</span></code> 会清理掉。实在没有办法，只好老老实实按照官方文档操作。</p>
</div>
</section>
<section id="kubelet">
<h3>启动kubelet失败<a class="headerlink" href="#kubelet" title="Link to this heading"></a></h3>
<ul>
<li><p>在忽略了 SystemVerification 之后，启动发现 kubelet 失败:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wait</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">boot</span> <span class="n">up</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="k">as</span> <span class="n">static</span> <span class="n">Pods</span> <span class="kn">from</span> <span class="nn">directory</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span><span class="o">.</span> <span class="n">This</span> <span class="n">can</span> <span class="n">take</span> <span class="n">up</span> <span class="n">to</span> <span class="mi">4</span><span class="n">m0s</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">Initial</span> <span class="n">timeout</span> <span class="n">of</span> <span class="mi">40</span><span class="n">s</span> <span class="n">passed</span><span class="o">.</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">It</span> <span class="n">seems</span> <span class="n">like</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">isn</span><span class="s1">&#39;t running or healthy.</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">The</span> <span class="n">HTTP</span> <span class="n">call</span> <span class="n">equal</span> <span class="n">to</span> <span class="s1">&#39;curl -sSL http://localhost:10248/healthz&#39;</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">error</span><span class="p">:</span> <span class="n">Get</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">10248</span><span class="o">/</span><span class="n">healthz</span><span class="p">:</span> <span class="n">dial</span> <span class="n">tcp</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">10248</span><span class="p">:</span> <span class="n">connect</span><span class="p">:</span> <span class="n">connection</span> <span class="n">refused</span><span class="o">.</span>
</pre></div>
</div>
</li>
</ul>
<p>检查kubelet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">status</span> <span class="n">kubelet</span>
<span class="n">journalctl</span> <span class="o">-</span><span class="n">xeu</span> <span class="n">kubelet</span>
</pre></div>
</div>
<p>关键报错如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jun</span> <span class="mi">11</span> <span class="mi">14</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">52</span> <span class="n">xcloud</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">21142</span><span class="p">]:</span> <span class="n">F0611</span> <span class="mi">14</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">52.353546</span>   <span class="mi">21142</span> <span class="n">server</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">266</span><span class="p">]</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">run</span> <span class="n">Kubelet</span><span class="p">:</span>
<span class="n">failed</span> <span class="n">to</span> <span class="n">create</span> <span class="n">kubelet</span><span class="p">:</span>
<span class="n">misconfiguration</span><span class="p">:</span> <span class="n">kubelet</span> <span class="n">cgroup</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;cgroupfs&quot;</span> <span class="ow">is</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">docker</span> <span class="n">cgroup</span> <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;systemd&quot;</span>
</pre></div>
</div>
<p>参考 <a class="reference external" href="https://stackoverflow.com/questions/45708175/kubelet-failed-with-kubelet-cgroup-driver-cgroupfs-is-different-from-docker-c">kubelet failed with kubelet cgroup driver: “cgroupfs” is different from docker cgroup driver: “systemd”</a>  只需要再增加一个参数 <code class="docutils literal notranslate"><span class="pre">--extra-config=kubelet.cgroup-driver=systemd</span></code> 来启动 minikube 就可以:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubeadm</span><span class="o">.</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">SystemVerification</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span>
</pre></div>
</div>
<p>也可以修订 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></code> 将 <code class="docutils literal notranslate"><span class="pre">ExecStart=</span></code> 启动行配置 中的 <code class="docutils literal notranslate"><span class="pre">--cgroup-driver=cgroupfs</span></code> 修改成 <code class="docutils literal notranslate"><span class="pre">--cgroup-driver=systemd</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kubelet</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">privileged</span><span class="o">=</span><span class="n">true</span> <span class="o">--</span><span class="n">authorization</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">Webhook</span> <span class="o">--</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">kubeconfig</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">kubelet</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">minikube</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">dns</span><span class="o">=</span><span class="mf">10.96.0.10</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">domain</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span> <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="n">docker</span> <span class="o">--</span><span class="n">fail</span><span class="o">-</span><span class="n">swap</span><span class="o">-</span><span class="n">on</span><span class="o">=</span><span class="n">false</span> <span class="o">--</span><span class="n">hostname</span><span class="o">-</span><span class="n">override</span><span class="o">=</span><span class="n">minikube</span> <span class="o">--</span><span class="n">kubeconfig</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">kubelet</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">manifest</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">manifests</span>
</pre></div>
</div>
<p>然后再次执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>就能启动 kubelet 成功。</p>
<p>不过，请注意，由于 <code class="docutils literal notranslate"><span class="pre">minikube</span> <span class="pre">start</span></code> 首次初始化时候会重新生成新的 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></code> ，所以第一次启动还是需要传递参数的，即:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubeadm</span><span class="o">.</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">SystemVerification</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span>
</pre></div>
</div>
</section>
<section id="systemd-resolv">
<h3>使用 <code class="docutils literal notranslate"><span class="pre">systemd-resolv</span></code> 配置传递<a class="headerlink" href="#systemd-resolv" title="Link to this heading"></a></h3>
<p>根据 minikube文档 <a class="reference external" href="https://github.com/kubernetes/minikube/blob/master/docs/vmdriver-none.md">vm-driver=none</a> 说明，运行在 Ubuntu 18.04 或其他默认配置了 <code class="docutils literal notranslate"><span class="pre">systemd-resolve</span></code> 的系统，需要绕过默认的 <code class="docutils literal notranslate"><span class="pre">resolv.conf</span></code> ，所以启动参数需要增加 <code class="docutils literal notranslate"><span class="pre">--extra-config=kubelet.resolv-conf=/run/systemd/resolve/resolv.conf</span></code> 。</p>
<p>完整启动命令修订成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubeadm</span><span class="o">.</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">SystemVerification</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">kubelet</span><span class="o">.</span><span class="n">resolv</span><span class="o">-</span><span class="n">conf</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">resolve</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</section>
</section>
<section id="id13">
<h2>操作系统启动时启动minikube<a class="headerlink" href="#id13" title="Link to this heading"></a></h2>
<p>安装了minikube的系统，默认会激活 <code class="docutils literal notranslate"><span class="pre">kubelet.service</span></code> ，即在启动操作系统时会自动启动服务器上所有kubernetes的容器，也就是自动启动minikube。但是，由于我们上述配置的裸物理机运行minikube，并且使用btrfs文件系统，所以需要定制一些参数传递给kubelet，否则启动后会发现自动启动的minikube无法工作。</p>
<p>参考 <a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#configure-kubelets-using-kubeadm">Cconfigure kubelets using kubeadm</a> 修订kubelet配置文件 <code class="docutils literal notranslate"><span class="pre">/var/lib/kubelet/kubeadm-flags.env</span></code> ，将默认的配置内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KUBELET_KUBEADM_ARGS</span><span class="o">=--</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span> <span class="o">--</span><span class="n">hostname</span><span class="o">-</span><span class="n">override</span><span class="o">=</span><span class="n">minikube</span> <span class="o">--</span><span class="n">network</span><span class="o">-</span><span class="n">plugin</span><span class="o">=</span><span class="n">cni</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">infra</span><span class="o">-</span><span class="n">container</span><span class="o">-</span><span class="n">image</span><span class="o">=</span><span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pause</span><span class="p">:</span><span class="mf">3.1</span> <span class="o">--</span><span class="n">resolv</span><span class="o">-</span><span class="n">conf</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">resolve</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>修订成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KUBELET_KUBEADM_ARGS</span><span class="o">=--</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">systemd</span> <span class="o">--</span><span class="n">hostname</span><span class="o">-</span><span class="n">override</span><span class="o">=</span><span class="n">minikube</span> <span class="o">--</span><span class="n">network</span><span class="o">-</span><span class="n">plugin</span><span class="o">=</span><span class="n">cni</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">infra</span><span class="o">-</span><span class="n">container</span><span class="o">-</span><span class="n">image</span><span class="o">=</span><span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pause</span><span class="p">:</span><span class="mf">3.1</span> <span class="o">--</span><span class="n">resolv</span><span class="o">-</span><span class="n">conf</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">resolve</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">preflight</span><span class="o">-</span><span class="n">errors</span><span class="o">=</span><span class="n">SystemVerification</span>
</pre></div>
</div>
<p>然后重启系统就可以看到随着操作系统启动，systemd可以正确启动minikube。</p>
</section>
<section id="dashboard">
<span id="minikube-dashboard"></span><h2>启动dashboard<a class="headerlink" href="#dashboard" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="../administer/k8s_dashboard.html#k8s-dashboard"><span class="std std-ref">Kubernetes仪表盘</span></a> 可以帮助我们管理集群，在minikube上也可以启用方便管理。</p>
<ul>
<li><p>执行以下命令启用dashboard:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">dashboard</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>出现报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  ...
  Verifying proxy health ...
  http://127.0.0.1:49983/api/v1/namespaces/kube-system/services/http:kubernetes-dashboard:/proxy/ is not responding properly: Temporary Error: unexpected response code: 503
  ...

这个报错是因为没有启动代理导致的，所以在执行 ``minikube dashboard`` 之前，需要先执行 ``kubectl proxy`` 指令，这样就能打开正确的监控页面。
</pre></div>
</div>
</div>
</section>
<section id="id14">
<h2>离线安装minikube<a class="headerlink" href="#id14" title="Link to this heading"></a></h2>
<p>通常我们安装minikube都是需要连接internet并且从google的仓库安装。但是有时候无法连接网络，需要离线在内网安装，则参考 <a class="reference external" href="https://blog.zhoulouzi.com/2017/10/minikube/">minikube install offline step by step</a> 实施安装：</p>
<ul>
<li><p>kubectl 的二进制文件 官网下载 放到 <code class="docutils literal notranslate"><span class="pre">/usr/local/bin/</span></code></p></li>
<li><p>minikube 的二进制文件 官网下载放到 <code class="docutils literal notranslate"><span class="pre">/usr/local/bin/</span></code> 下</p></li>
<li><p>docker的离线安装包 docker 离线安装</p></li>
<li><p>minikube要跑起来所需要的docker镜像:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gcr.io/google_containers/kubernetes-dashboard-amd64 v1.6.3
gcr.io/google_containers/k8s-dns-sidecar-amd64 1.14.5
gcr.io/google_containers/k8s-dns-kube-dns-amd64 1.14.5
gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64 1.14.5
gcr.io/google-containers/kube-addon-manager v6.4-beta.2
gcr.io/google_containers/pause-amd64 3.0
docker image save 导出tar包，方便随时在离线环境使用
</pre></div>
</div>
</li>
<li><p>minikue.iso 下载地址：<a class="reference external" href="https://storage.googleapis.com/minikube/iso/minikube-v0.23.5.iso">minikube.iso</a></p></li>
<li><p>执行以下命令启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">vm</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">none</span> <span class="o">--</span><span class="n">iso</span><span class="o">-</span><span class="n">url</span> <span class="n">file</span><span class="p">:</span><span class="o">//</span><span class="n">tmp</span><span class="o">/</span><span class="n">minikube</span><span class="o">-</span><span class="n">v0</span><span class="mf">.23.5</span><span class="o">.</span><span class="n">iso</span> <span class="o">--</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">version</span> <span class="n">v1</span><span class="mf">.7.5</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">apiserver</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">NodePortRange</span><span class="o">=</span><span class="mi">0</span><span class="o">-</span><span class="mi">60000</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>目前我还没有实际验证，不过这个安装方法应该可行，有待遇到需要时实际验证再做调整优化。</p>
</div>
</section>
<section id="docker-in-docker">
<h2>Docker in Docker<a class="headerlink" href="#docker-in-docker" title="Link to this heading"></a></h2>
<p>在运行单节点的minikube确实能够体验和测试Kubernetes基本功能，但是你也可能不满足这种简单而单调的单节点部署。如果你想要实现一个完整Kubernetes集群，一种方式是采用多个KVM虚拟机实现 <a class="reference internal" href="../deploy/k8s_hosts_in_mbp/k8s_hosts.html#k8s-hosts"><span class="std std-ref">Kubernetes部署服务器</span></a> ，另一种方式是采用 <a class="reference internal" href="../kind/index.html#kind"><span class="std std-ref">kind(本地docker模拟k8s集群)</span></a> 实现单一物理服务器部署Kubernetes集群。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>除了minikube，Docker公司也推出了一个集成standalone Kubernetes，包含了服务器和客户端，也是一个不能配置，并且单节点的Kubernetes集群。如果你和我一样使用 <a class="reference internal" href="../../docker/admin/docker_studio.html#docker-studio"><span class="std std-ref">Docker运行Studio容器</span></a> ，并且只做开发不关心部署，并且不想由于VirtualBox虚拟化白白消耗系统资源，则可以尝试Docker Desktop集成的Kubernetes。（这个系统采用了macOS集成的 <a class="reference internal" href="../../apple/virtualization/xhyve.html#xhyve"><span class="std std-ref">xhyve - macOS平台的KVM</span></a> 所以性能损耗较少)</p>
</div>
</section>
<section id="id15">
<h2>参考<a class="headerlink" href="#id15" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://minikube.sigs.k8s.io/docs/start/">minikube官方文档startup</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="index.html" class="btn btn-neutral float-left" title="Kubernetes起步准备" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="install_setup_kubectl.html" class="btn btn-neutral float-right" title="安装和设置kubectl" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">版权所有</a> 2018 - now, Huatai Huang。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡 👈</a></p>
    <br>
    <p>网站采用 <a href="https://utteranc.es/">utterances</a> 评论系统，所有评论存储在<a href="https://github.com/huataihuang/cloud-atlas/issues">GitHub issues</a> 中，如果你看不到下方的评论框，那么可能需要<a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/security/vpn/index.html">自备梯子</a> 👈</p>
    <div class="articleComments">
        <comments>
  <script src="https://utteranc.es/client.js"
    repo="huataihuang/cloud-atlas"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
    </div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>